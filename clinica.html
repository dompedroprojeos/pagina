<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fisio Cl√≠nica Dra Tha√≠s Xavier - Sistema Completo</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #2d3748;
}

/* HEADER */
header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.logo-icon {
    font-size: 3.5rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

header h1 {
    font-size: 2rem;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

/* SCROLL BUTTONS */
.scroll-buttons {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.scroll-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.scroll-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

/* DASHBOARD MENU */
.dashboard-menu {
    position: fixed;
    left: 20px;
    top: 120px;
    z-index: 998;
    background: white;
    border-radius: 15px;
    padding: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 250px;
}

.menu-title {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: #2d3748;
    border-bottom: 2px solid #4facfe;
    padding-bottom: 0.5rem;
}

.menu-item {
    padding: 0.8rem;
    margin: 0.5rem 0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    background: #f7fafc;
}

.menu-item:hover {
    background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    transform: translateX(5px);
}

.menu-item i {
    font-size: 1.2rem;
}

/* MAIN CONTAINER */
main {
    max-width: 1400px;
    margin: 2rem auto;
    margin-left: 300px;
    background: white;
    padding: 2.5rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.section {
    display: none;
}

.section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 3px solid #4facfe;
}

.section-header i {
    font-size: 2rem;
    color: #4facfe;
}

.section-header h2 {
    font-size: 1.8rem;
    color: #2d3748;
}

/* FORM STYLES */
form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.form-group {
    position: relative;
}

label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #4a5568;
    font-size: 0.95rem;
}

input, select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    background: #f7fafc;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
}

input:focus, select:focus {
    border-color: #4facfe;
    background: white;
    outline: none;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
}

/* BUTTONS */
button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    padding: 0.9rem 2rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.05rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.btn-success {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.btn-danger {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.btn-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.btn-secondary {
    background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
}

/* TABLE */
.table-container {
    overflow-x: auto;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin: 2rem 0;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 1rem;
    text-align: left;
}

th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
}

tbody tr {
    border-bottom: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

tbody tr:hover {
    background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
    transform: scale(1.01);
}

.action-btn {
    width: 35px;
    height: 35px;
    border: none;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 0 3px;
}

.action-btn:hover {
    transform: scale(1.15);
}

.btn-edit {
    background: #3b82f6;
    color: white;
}

.btn-delete {
    background: #ef4444;
    color: white;
}

/* PACIENTES SECTION */
.patients-toggle-btn {
    margin: 1rem 0;
}

.patients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.patient-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    padding: 1.5rem;
    border-radius: 12px;
    border-left: 4px solid #4facfe;
    transition: all 0.3s ease;
}

.patient-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.patient-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 1rem;
}

.patient-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.9rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4facfe;
}

.stat-label {
    color: #718096;
    font-size: 0.8rem;
}

/* MESSAGES */
.message {
    padding: 1rem;
    border-radius: 12px;
    margin: 1rem 0;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.success {
    background: #c6f6d5;
    color: #22543d;
    border: 2px solid #9ae6b4;
    display: block;
}

.message.error {
    background: #fed7d7;
    color: #742a2a;
    border: 2px solid #fc8181;
    display: block;
}

.message.warning {
    background: #fef3c7;
    color: #78350f;
    border: 2px solid #fbbf24;
    display: block;
}

/* CALENDAR STYLES */
.calendar-container {
    margin: 2rem 0;
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.calendar-nav {
    display: flex;
    gap: 1rem;
}

.calendar-nav button {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #4a5568;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 0.5rem;
    border-radius: 10px;
    background: #f7fafc;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    min-height: 80px;
}

.calendar-day:hover {
    background: #e2e8f0;
}

.calendar-day.current-month {
    background: white;
}

.calendar-day.today {
    background: #e0f2fe;
    border: 2px solid #4facfe;
}

.calendar-day-number {
    font-weight: 600;
    margin-bottom: 5px;
}

.calendar-appointments {
    width: 100%;
    max-height: 60px;
    overflow-y: auto;
    font-size: 0.7rem;
}

.appointment-badge {
    background: #4facfe;
    color: white;
    padding: 2px 5px;
    border-radius: 4px;
    margin: 1px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.appointment-badge.particular {
    background: #f59e0b;
}

/* MODAL STYLES */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #718096;
}

.modal-close:hover {
    color: #2d3748;
}

/* RODAP√â DOS RELAT√ìRIOS */
.report-footer {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 2px solid #e2e8f0;
    text-align: center;
    color: #718096;
    font-size: 0.9rem;
}

/* PRINT STYLES */
@media print {
    body * {
        visibility: hidden;
    }
   
    #printArea, #printArea * {
        visibility: visible;
    }
   
    #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
   
    .print-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 3px solid #000;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
   
    .print-logo {
        display: flex;
        align-items: center;
        gap: 10px;
    }
   
    .print-logo i {
        font-size: 2.5rem;
        color: #4facfe;
    }
   
    .print-title {
        font-size: 18pt;
        font-weight: bold;
    }
   
    .print-subtitle {
        font-size: 14pt;
        margin: 10px 0;
        text-align: center;
        font-weight: bold;
    }
   
    .print-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
   
    .print-table th,
    .print-table td {
        border: 1.5px solid #000;
        padding: 8px;
        text-align: left;
    }
   
    .print-table th {
        background: #e0e0e0;
        font-weight: bold;
    }
   
    .print-footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 15px;
        border-top: 2px solid #000;
    }
   
    .signature-area {
        display: flex;
        justify-content: space-around;
        margin-top: 50px;
    }
   
    .signature-box {
        text-align: center;
        width: 200px;
    }
   
    .signature-line {
        border-top: 2px solid #000;
        margin-bottom: 5px;
    }
   
    .stamp-area {
        width: 150px;
        height: 150px;
        border: 2px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px auto;
        transform: rotate(-10deg);
        position: relative;
    }
   
    .stamp-text {
        font-size: 10pt;
        color: #999;
        text-align: center;
    }
   
    @page {
        size: A4 landscape;
        margin: 1cm;
    }
}

/* RESPONSIVIDADE */
@media (max-width: 1024px) {
    .dashboard-menu {
        display: none;
    }
   
    main {
        margin-left: auto;
        margin-right: auto;
    }
}

@media (max-width: 768px) {
    main {
        margin: 1rem;
        padding: 1.5rem;
    }
   
    .scroll-buttons {
        right: 10px;
    }
   
    .scroll-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
   
    form {
        grid-template-columns: 1fr;
    }
    
    .calendar-days {
        gap: 2px;
    }
    
    .calendar-day {
        min-height: 60px;
        padding: 0.25rem;
    }
    
    .appointment-badge {
        font-size: 0.6rem;
        padding: 1px 3px;
    }
}
</style>
</head>
<body>

<header>
    <div class="header-content">
        <i class="fas fa-user-md logo-icon"></i>
        <div>
            <h1>Fisio Cl√≠nica Dra Tha√≠s Xavier</h1>
            <div style="font-size: 0.9rem; opacity: 0.95;">
                CNPJ: 21.719.507/0001-70
            </div>
        </div>
    </div>
</header>

<div class="scroll-buttons">
    <button class="scroll-btn" onclick="scrollToTop()" title="Ir para o topo">
        <i class="fas fa-chevron-up"></i>
    </button>
    <button class="scroll-btn" onclick="scrollToBottom()" title="Ir para o fim">
        <i class="fas fa-chevron-down"></i>
    </button>
</div>

<div class="dashboard-menu">
    <div class="menu-title">
        <i class="fas fa-th-large"></i> Menu Principal
    </div>
    <div class="menu-item" onclick="showSection('cadastro')">
        <i class="fas fa-calendar-plus"></i>
        <span>Cadastro de Sess√µes</span>
    </div>
    <div class="menu-item" onclick="showSection('agenda')">
        <i class="fas fa-calendar-alt"></i>
        <span>Agenda</span>
    </div>
    <div class="menu-item" onclick="showSection('pacientes')">
        <i class="fas fa-users"></i>
        <span>Pacientes</span>
    </div>
    <div class="menu-item" onclick="showSection('pagamentos')">
        <i class="fas fa-money-bill-wave"></i>
        <span>Pagamentos</span>
    </div>
    <div class="menu-item" onclick="showSection('relatorios')">
        <i class="fas fa-chart-bar"></i>
        <span>Relat√≥rios</span>
    </div>
    <div class="menu-item" onclick="showSection('backup')">
        <i class="fas fa-database"></i>
        <span>Backup</span>
    </div>
    <div class="menu-item" onclick="showSection('faturas')">
        <i class="fas fa-receipt"></i>
        <span>Faturas Fechadas</span>
    </div>
</div>

<main>
    <!-- SE√á√ÉO CADASTRO -->
    <div id="cadastro" class="section active">
        <div class="section-header">
            <i class="fas fa-calendar-plus"></i>
            <h2>Cadastro de Sess√µes</h2>
        </div>
       
        <form id="sessionForm">
            <div class="form-group">
                <label><i class="fas fa-calendar-day"></i> Data</label>
                <input type="date" id="inputDia" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-clock"></i> Hor√°rio</label>
                <input type="time" id="inputHorario" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> Paciente</label>
                <input type="text" id="inputNome" list="pacientesList" required>
                <datalist id="pacientesList"></datalist>
            </div>
            <div class="form-group">
                <label><i class="fas fa-tag"></i> Tipo</label>
                <select id="inputTipo" required>
                    <option value="Plano" selected>Plano</option>
                    <option value="Particular">Particular</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-hashtag"></i> Sess√µes Liberadas</label>
                <input type="number" id="inputSessoesLiberadas" min="1" value="20">
            </div>
            <div class="form-group">
                <label><i class="fas fa-calendar"></i> M√™s de Refer√™ncia</label>
                <select id="inputMes" required>
                    <option value="">Selecione</option>
                    <option value="Janeiro">Janeiro</option>
                    <option value="Fevereiro">Fevereiro</option>
                    <option value="Mar√ßo">Mar√ßo</option>
                    <option value="Abril">Abril</option>
                    <option value="Maio">Maio</option>
                    <option value="Junho">Junho</option>
                    <option value="Julho">Julho</option>
                    <option value="Agosto">Agosto</option>
                    <option value="Setembro">Setembro</option>
                    <option value="Outubro">Outubro</option>
                    <option value="Novembro">Novembro</option>
                    <option value="Dezembro">Dezembro</option>
                </select>
            </div>
            <input type="hidden" id="editIndex" value="-1">
            <div style="grid-column: 1 / -1; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button type="submit" class="btn-success">
                    <i class="fas fa-save"></i> Cadastrar
                </button>
                <button type="button" class="btn-danger" onclick="limparSessoes()">
                    <i class="fas fa-trash"></i> Limpar Sess√µes
                </button>
            </div>
        </form>
       
        <div id="message" class="message"></div>
       
        <div style="margin: 2rem 0;">
            <input type="text" id="searchInput" placeholder="üîç Buscar paciente..." style="max-width: 400px;">
        </div>
       
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Hor√°rio</th>
                        <th>Paciente</th>
                        <th>Tipo</th>
                        <th>N¬∫ Sess√£o</th>
                        <th>Sess√µes Lib.</th>
                        <th>M√™s</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="sessionsTableBody"></tbody>
            </table>
        </div>
    </div>
    
    <!-- SE√á√ÉO AGENDA -->
    <div id="agenda" class="section">
        <div class="section-header">
            <i class="fas fa-calendar-alt"></i>
            <h2>Agenda</h2>
        </div>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <div>
                    <h3 id="currentMonthYear"></h3>
                </div>
                <div class="calendar-nav">
                    <button class="btn-secondary" onclick="changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i> M√™s Anterior
                    </button>
                    <button class="btn-info" onclick="showToday()">
                        <i class="fas fa-calendar-day"></i> Hoje
                    </button>
                    <button class="btn-secondary" onclick="changeMonth(1)">
                        Pr√≥ximo M√™s <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="calendar-weekdays">
                <div>Dom</div>
                <div>Seg</div>
                <div>Ter</div>
                <div>Qua</div>
                <div>Qui</div>
                <div>Sex</div>
                <div>S√°b</div>
            </div>
            
            <div class="calendar-days" id="calendarDays">
                <!-- Os dias ser√£o preenchidos via JavaScript -->
            </div>
        </div>
        
        <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn-info" onclick="abrirModalDiaAtual()">
                <i class="fas fa-eye"></i> Ver Atendimentos de Hoje
            </button>
            <button class="btn-warning" onclick="filtrarPorDiaSemana('todos')">
                <i class="fas fa-filter"></i> Todos os Dias
            </button>
            <button class="btn-secondary" onclick="filtrarPorDiaSemana('segunda')">
                <i class="fas fa-filter"></i> Segunda
            </button>
            <button class="btn-secondary" onclick="filtrarPorDiaSemana('terca')">
                <i class="fas fa-filter"></i> Ter√ßa
            </button>
            <button class="btn-secondary" onclick="filtrarPorDiaSemana('quarta')">
                <i class="fas fa-filter"></i> Quarta
            </button>
            <button class="btn-secondary" onclick="filtrarPorDiaSemana('quinta')">
                <i class="fas fa-filter"></i> Quinta
            </button>
            <button class="btn-secondary" onclick="filtrarPorDiaSemana('sexta')">
                <i class="fas fa-filter"></i> Sexta
            </button>
        </div>
    </div>
   
    <!-- SE√á√ÉO PACIENTES -->
    <div id="pacientes" class="section">
        <div class="section-header">
            <i class="fas fa-users"></i>
            <h2>Pacientes Cadastrados</h2>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <button class="btn-success" onclick="abrirModalCadastroPaciente()">
                <i class="fas fa-plus"></i> Cadastrar Novo Paciente
            </button>
        </div>
       
        <button class="patients-toggle-btn btn-info" onclick="togglePatientsView()">
            <i class="fas fa-eye"></i> <span id="toggleText">Ocultar Pacientes</span>
        </button>
       
        <div id="patientsGrid" class="patients-grid"></div>
       
        <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn-info" onclick="backupPacientes()">
                <i class="fas fa-download"></i> Backup de Pacientes
            </button>
            <button class="btn-success" onclick="document.getElementById('restorePacientes').click()">
                <i class="fas fa-upload"></i> Restaurar Pacientes
            </button>
            <input type="file" id="restorePacientes" style="display: none;" accept=".json" onchange="importPacientes(event)">
        </div>
    </div>
   
    <!-- SE√á√ÉO PAGAMENTOS -->
    <div id="pagamentos" class="section">
        <div class="section-header">
            <i class="fas fa-money-bill-wave"></i>
            <h2>Controle de Pagamentos</h2>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <button class="btn-success" onclick="abrirModalRegistroPagamento()">
                <i class="fas fa-plus"></i> Registrar Pagamento
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-wallet"></i> Saldo Atual</h3>
                <div style="font-size: 2rem; font-weight: 700; color: #4facfe;" id="saldoAtual">R$ 0,00</div>
            </div>
            <div style="background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #38a169;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Total Recebido</h3>
                <div style="font-size: 2rem; font-weight: 700; color: #38a169;" id="totalRecebido">R$ 0,00</div>
            </div>
            <div style="background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #e53e3e;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-exclamation-circle"></i> Total em Aberto</h3>
                <div style="font-size: 2rem; font-weight: 700; color: #e53e3e;" id="totalAberto">R$ 0,00</div>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Paciente</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Forma de Pagamento</th>
                        <th>Descri√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="pagamentosTableBody"></tbody>
            </table>
        </div>
    </div>
   
    <!-- SE√á√ÉO RELAT√ìRIOS -->
    <div id="relatorios" class="section">
        <div class="section-header">
            <i class="fas fa-chart-bar"></i>
            <h2>Relat√≥rios</h2>
        </div>
       
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <button class="btn-info" onclick="gerarFichaPaciente()">
                <i class="fas fa-id-card"></i> Ficha do Paciente
            </button>
            <button class="btn-info" onclick="gerarRelatorioConsolidado()">
                <i class="fas fa-file-alt"></i> Relat√≥rio Consolidado
            </button>
            <button class="btn-warning" onclick="abrirModalFecharFatura()">
                <i class="fas fa-receipt"></i> Fechar Fatura do M√™s
            </button>
            <button class="btn-info" onclick="gerarRelatorioAtendimentosNaoFaturados()">
                <i class="fas fa-list"></i> Atendimentos N√£o Faturados
            </button>
            <button class="btn-info" onclick="gerarRelatorioSessoesRestantes()">
                <i class="fas fa-chart-line"></i> Sess√µes Realizadas x Restantes
            </button>
            <button class="btn-info" onclick="gerarFichaControlePaciente()">
                <i class="fas fa-file-contract"></i> Ficha de Controle
            </button>
            <button class="btn-success" onclick="gerarRelatorioContasPagas()">
                <i class="fas fa-check-circle"></i> Contas Pagas
            </button>
            <button class="btn-warning" onclick="gerarRelatorioContasAbertas()">
                <i class="fas fa-exclamation-circle"></i> Contas em Aberto
            </button>
            <button class="btn-info" onclick="gerarRelatorioFluxoCaixa()">
                <i class="fas fa-chart-line"></i> Fluxo de Caixa
            </button>
        </div>
       
        <div style="margin-top: 2rem;">
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                Selecione o Paciente para Relat√≥rios:
            </label>
            <select id="selectPacienteRelatorio" style="max-width: 400px;">
                <option value="">Todos os Pacientes</option>
            </select>
        </div>
       
        <div id="relatorioContainer" style="margin-top: 2rem;"></div>
    </div>
   
    <!-- SE√á√ÉO BACKUP -->
    <div id="backup" class="section">
        <div class="section-header">
            <i class="fas fa-database"></i>
            <h2>Backup e Restaura√ß√£o</h2>
        </div>
       
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <button class="btn-success" onclick="backupCompleto()">
                <i class="fas fa-download"></i> Backup Completo
            </button>
            <button class="btn-warning" onclick="document.getElementById('restoreCompleto').click()">
                <i class="fas fa-upload"></i> Restaurar Backup
            </button>
            <input type="file" id="restoreCompleto" style="display: none;" accept=".json" onchange="importBackup(event)">
        </div>
       
        <div style="margin-top: 2rem; padding: 1.5rem; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Informa√ß√µes</h3>
            <ul style="padding-left: 1.5rem; line-height: 2;">
                <li>O backup completo inclui todas as sess√µes, faturas fechadas e pagamentos</li>
                <li>Fa√ßa backup regularmente para evitar perda de dados</li>
                <li>O backup de pacientes salva apenas a lista de pacientes √∫nicos</li>
                <li>Todos os dados s√£o armazenados localmente no seu navegador</li>
            </ul>
        </div>
    </div>
   
    <!-- SE√á√ÉO FATURAS FECHADAS -->
    <div id="faturas" class="section">
        <div class="section-header">
            <i class="fas fa-receipt"></i>
            <h2>Faturas Fechadas</h2>
        </div>
       
        <div id="faturasContainer"></div>
    </div>
</main>

<!-- MODAL PARA FECHAR FATURA -->
<div id="modalFecharFatura" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-receipt"></i> Fechar Fatura - Per√≠odo
            </h3>
            <button class="modal-close" onclick="fecharModalFecharFatura()">
                <i class="fas fa-times"></i>
            </button>
        </div>
       
        <div style="display: grid; gap: 1rem;">
            <div class="form-group">
                <label><i class="fas fa-calendar-day"></i> Data Inicial</label>
                <input type="date" id="inputDataInicial" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-calendar-day"></i> Data Final</label>
                <input type="date" id="inputDataFinal" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-tag"></i> Descri√ß√£o do Per√≠odo</label>
                <input type="text" id="inputDescricaoFatura" placeholder="Ex: Janeiro 2024" required>
            </div>
        </div>
       
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn-danger" onclick="fecharModalFecharFatura()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-success" onclick="fecharFatura()">
                <i class="fas fa-check"></i> Fechar Fatura
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA ATENDIMENTOS DO DIA -->
<div id="modalAtendimentosDia" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalAtendimentosTitulo" style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-day"></i> Atendimentos do Dia
            </h3>
            <button class="modal-close" onclick="fecharModalAtendimentosDia()">
                <i class="fas fa-times"></i>
            </button>
        </div>
       
        <div id="modalAtendimentosConteudo">
            <!-- Conte√∫do ser√° preenchido via JavaScript -->
        </div>
       
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn-info" onclick="fecharModalAtendimentosDia()">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA CADASTRO DE PACIENTE -->
<div id="modalCadastroPaciente" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-plus"></i> Cadastrar Novo Paciente
            </h3>
            <button class="modal-close" onclick="fecharModalCadastroPaciente()">
                <i class="fas fa-times"></i>
            </button>
        </div>
       
        <form id="formCadastroPaciente">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Nome Completo</label>
                <input type="text" id="inputNomeCompleto" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-phone"></i> Telefone</label>
                <input type="text" id="inputTelefone" placeholder="(00) 00000-0000" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-map-marker-alt"></i> Bairro</label>
                <input type="text" id="inputBairro" required>
            </div>
        </form>
       
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn-danger" onclick="fecharModalCadastroPaciente()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-success" onclick="cadastrarPaciente()">
                <i class="fas fa-check"></i> Cadastrar
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA REGISTRO DE PAGAMENTO -->
<div id="modalRegistroPagamento" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-money-bill-wave"></i> Registrar Pagamento
            </h3>
            <button class="modal-close" onclick="fecharModalRegistroPagamento()">
                <i class="fas fa-times"></i>
            </button>
        </div>
       
        <form id="formRegistroPagamento">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Paciente (Particular)</label>
                <select id="selectPacientePagamento" required>
                    <option value="">Selecione um paciente</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-calendar-day"></i> Data da Sess√£o</label>
                <select id="selectDataSessao" required>
                    <option value="">Selecione uma data</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-clock"></i> Hor√°rio da Sess√£o</label>
                <select id="selectHorarioSessao" required>
                    <option value="">Selecione um hor√°rio</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-dollar-sign"></i> Valor da Sess√£o</label>
                <input type="number" id="inputValorSessao" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-check-circle"></i> Status do Pagamento</label>
                <select id="selectStatusPagamento" required>
                    <option value="Pago">Pago</option>
                    <option value="Em Aberto">Em Aberto</option>
                </select>
            </div>
            <div class="form-group" id="formaPagamentoGroup">
                <label><i class="fas fa-credit-card"></i> Forma de Pagamento</label>
                <select id="selectFormaPagamento">
                    <option value="Pix">Pix</option>
                    <option value="Dinheiro">Dinheiro</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-sticky-note"></i> Descri√ß√£o (Opcional)</label>
                <input type="text" id="inputDescricaoPagamento" placeholder="Ex: Pagamento da sess√£o">
            </div>
        </form>
       
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn-danger" onclick="fecharModalRegistroPagamento()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-success" onclick="registrarPagamento()">
                <i class="fas fa-check"></i> Registrar
            </button>
        </div>
    </div>
</div>

<div id="printArea" style="display:none;"></div>

<script>
// DADOS GLOBAIS
let sessions = [];
let closedInvoices = [];
let patientsVisible = true;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let pacientesCadastrados = [];
let pagamentos = [];

// INICIALIZA√á√ÉO
function init() {
    loadData();
    renderTable();
    updatePatientsGrid();
    updateSelectPacientes();
    renderFaturasContainer();
    updatePacientesDatalist();
    renderCalendar();
    renderPagamentosTable();
    updateSaldo();
    
    // Formata√ß√£o autom√°tica do telefone
    document.getElementById('inputTelefone').addEventListener('input', function(e) {
        formatarTelefone(e.target);
    });
    
    // Event listeners para pagamentos
    document.getElementById('selectPacientePagamento').addEventListener('change', atualizarSessoesPaciente);
    document.getElementById('selectDataSessao').addEventListener('change', atualizarHorariosSessao);
    document.getElementById('selectStatusPagamento').addEventListener('change', function() {
        document.getElementById('formaPagamentoGroup').style.display = 
            this.value === 'Pago' ? 'block' : 'none';
    });
}

// CARREGAR DADOS
function loadData() {
    const sessionsData = localStorage.getItem('fisioSessions');
    const invoicesData = localStorage.getItem('fisioClosedInvoices');
    const pacientesData = localStorage.getItem('fisioPacientesCadastrados');
    const pagamentosData = localStorage.getItem('fisioPagamentos');
    
    sessions = sessionsData ? JSON.parse(sessionsData) : [];
    closedInvoices = invoicesData ? JSON.parse(invoicesData) : [];
    pacientesCadastrados = pacientesData ? JSON.parse(pacientesData) : [];
    pagamentos = pagamentosData ? JSON.parse(pagamentosData) : [];
    
    sessions.sort((a, b) => new Date(a.dia) - new Date(b.dia));
}

// SALVAR DADOS
function saveData() {
    localStorage.setItem('fisioSessions', JSON.stringify(sessions));
    localStorage.setItem('fisioClosedInvoices', JSON.stringify(closedInvoices));
    localStorage.setItem('fisioPacientesCadastrados', JSON.stringify(pacientesCadastrados));
    localStorage.setItem('fisioPagamentos', JSON.stringify(pagamentos));
}

// NAVEGA√á√ÉO
function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    scrollToTop();
    
    if (sectionId === 'agenda') {
        renderCalendar();
    } else if (sectionId === 'pagamentos') {
        renderPagamentosTable();
        updateSaldo();
    }
}

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function scrollToBottom() {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// FORMATA√á√ÉO
function formatDate(dateStr) {
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

function formatarTelefone(input) {
    let value = input.value.replace(/\D/g, '');
    
    if (value.length > 11) {
        value = value.substring(0, 11);
    }
    
    if (value.length > 6) {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (value.length > 2) {
        value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
    } else if (value.length > 0) {
        value = value.replace(/(\d{0,2})/, '($1');
    }
    
    input.value = value;
}

// FUN√á√ïES DE SESS√ÉO
function getSessionNumber(pacienteNome, dia) {
    const pacienteSessions = sessions
        .filter(s => s.nome === pacienteNome)
        .sort((a, b) => new Date(a.dia) - new Date(b.dia));
    const targetDate = new Date(dia);
    const sessionIndex = pacienteSessions.findIndex(s => {
        const sessionDate = new Date(s.dia);
        return sessionDate.getTime() === targetDate.getTime();
    });
    return sessionIndex >= 0 ? (sessionIndex + 1).toString().padStart(2, '0') : '01';
}

function getSessoesLiberadas(pacienteNome) {
    const pacienteSession = sessions.find(s => s.nome === pacienteNome);
    return pacienteSession ? pacienteSession.sessoesLiberadas || 20 : 20;
}

function getSessoesRealizadas(pacienteNome) {
    return sessions.filter(s => s.nome === pacienteNome).length;
}

// VALIDA√á√ïES
function validarDisponibilidadeHorario(dia, horario, tipo, pacienteAtual = null) {
    const sessoesNoMesmoHorario = sessions.filter(s =>
        s.dia === dia &&
        s.horario === horario &&
        s.nome !== pacienteAtual // Exclui a sess√£o atual em caso de edi√ß√£o
    );
    
    // Se for particular, pode ter m√∫ltiplos no mesmo hor√°rio
    if (tipo === 'Particular') {
        return true;
    }
    
    // Se for plano, verifica se j√° existe algum plano no mesmo hor√°rio
    const sessoesPlanoNoMesmoHorario = sessoesNoMesmoHorario.filter(s => s.tipo === 'Plano');
    return sessoesPlanoNoMesmoHorario.length < 2; // Permite at√© 2 pacientes de plano
}

// RENDERIZAR TABELA - MOSTRA APENAS SESS√ïES N√ÉO FECHADAS
function renderTable(filter = '') {
    const tbody = document.getElementById('sessionsTableBody');
    tbody.innerHTML = '';
   
    // Obter IDs de todas as sess√µes que est√£o em faturas fechadas
    const sessoesFechadasIds = new Set();
    closedInvoices.forEach(fatura => {
        fatura.sessoes.forEach(sessao => {
            sessoesFechadasIds.add(sessao.id || `${sessao.dia}-${sessao.horario}-${sessao.nome}`);
        });
    });
   
    // Filtrar apenas sess√µes n√£o fechadas
    const sessoesNaoFechadas = sessions.filter(s => {
        const sessaoId = s.id || `${s.dia}-${s.horario}-${s.nome}`;
        return !sessoesFechadasIds.has(sessaoId);
    });
   
    const filtered = sessoesNaoFechadas.filter(s =>
        s.nome.toLowerCase().includes(filter.toLowerCase())
    );
   
    filtered.forEach((sess, i) => {
        const realIndex = sessions.findIndex(s => s === sess);
        const sessionNumber = getSessionNumber(sess.nome, sess.dia);
        const sessoesLiberadas = getSessoesLiberadas(sess.nome);
        const sessoesRealizadas = getSessoesRealizadas(sess.nome);
        const sessoesFaltantes = sessoesLiberadas - sessoesRealizadas;
       
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDate(sess.dia)}</td>
            <td>${sess.horario}</td>
            <td>${sess.nome}</td>
            <td>${sess.tipo}</td>
            <td><strong style="color: #4facfe;">${sessionNumber}</strong></td>
            <td>
                <div style="font-size: 0.85rem;">
                    <div>Liberadas: ${sessoesLiberadas}</div>
                    <div style="color: #10b981;">Realizadas: ${sessoesRealizadas}</div>
                    <div style="color: #f59e0b;">Faltantes: ${sessoesFaltantes}</div>
                </div>
            </td>
            <td>${sess.mes}</td>
            <td>
                <button class="action-btn btn-edit" onclick="editSession(${realIndex})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn btn-delete" onclick="deleteSession(${realIndex})" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// EDITAR E DELETAR SESS√ïES
function editSession(index) {
    const sess = sessions[index];
    document.getElementById('inputDia').value = sess.dia;
    document.getElementById('inputHorario').value = sess.horario;
    document.getElementById('inputNome').value = sess.nome;
    document.getElementById('inputTipo').value = sess.tipo;
    document.getElementById('inputSessoesLiberadas').value = sess.sessoesLiberadas || 20;
    document.getElementById('inputMes').value = sess.mes;
    document.getElementById('editIndex').value = index;
   
    // MUDAR TEXTO DO BOT√ÉO
    const btnSubmit = document.querySelector('#sessionForm button[type="submit"]');
    btnSubmit.innerHTML = '<i class="fas fa-save"></i> Atualizar';
   
    showSection('cadastro');
    showMessage('Editando sess√£o. Fa√ßa as altera√ß√µes e clique em Atualizar.', 'warning');
}

function deleteSession(index) {
    if (confirm('Deseja realmente excluir esta sess√£o permanentemente?')) {
        const deleted = sessions.splice(index, 1)[0];
        saveData();
        renderTable(document.getElementById('searchInput').value);
        updatePatientsGrid();
        updateSelectPacientes();
        renderCalendar();
        showMessage(`Sess√£o de ${deleted.nome} exclu√≠da permanentemente!`, 'success');
    }
}

// LIMPAR APENAS SESS√ïES (mant√©m pacientes)
function limparSessoes() {
    if (confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso ir√° excluir TODAS as sess√µes, mas manter√° os pacientes cadastrados. Deseja continuar?')) {
        sessions = [];
        saveData();
        renderTable();
        updatePatientsGrid();
        updatePacientesDatalist();
        renderCalendar();
        showMessage('Todas as sess√µes foram exclu√≠das! Os pacientes foram preservados.', 'success');
    }
}

// ATUALIZAR DATALIST DE PACIENTES
function updatePacientesDatalist() {
    const datalist = document.getElementById('pacientesList');
    const pacientesSessoes = [...new Set(sessions.map(s => s.nome))];
    const uniquePatients = [...new Set([...pacientesSessoes, ...pacientesCadastrados.map(p => p.nome)])].sort();
   
    datalist.innerHTML = '';
    uniquePatients.forEach(p => {
        const option = document.createElement('option');
        option.value = p;
        datalist.appendChild(option);
    });
}

// FORM SUBMIT
document.getElementById('sessionForm').addEventListener('submit', (e) => {
    e.preventDefault();
   
    const dia = document.getElementById('inputDia').value;
    const horario = document.getElementById('inputHorario').value;
    const nome = document.getElementById('inputNome').value.trim();
    const tipo = document.getElementById('inputTipo').value;
    const sessoesLiberadas = parseInt(document.getElementById('inputSessoesLiberadas').value) || 20;
    const mes = document.getElementById('inputMes').value;
    const editIndex = parseInt(document.getElementById('editIndex').value);
   
    // VALIDA√á√ïES
    // VALIDA√á√ÉO DE DIA DA SEMANA (segunda a sexta)
    const dataObj = new Date(dia);
    const diaSemana = dataObj.getDay(); // 0 = domingo, 1 = segunda, ..., 6 = s√°bado
   
    if (diaSemana === 0 || diaSemana === 6) {
        showMessage('‚ö†Ô∏è As marca√ß√µes s√≥ podem ser feitas de segunda a sexta-feira.', 'error');
        return;
    }
   
    // VALIDA√á√ÉO DE HOR√ÅRIO DUPLICADO
    const pacienteAtual = editIndex >= 0 ? sessions[editIndex].nome : null;
    if (!validarDisponibilidadeHorario(dia, horario, tipo, pacienteAtual)) {
        showMessage('‚ùå Limite atingido! J√° existem dois pacientes de plano marcados para este hor√°rio.', 'error');
        return;
    }
   
    // Gerar ID √∫nico para a sess√£o
    const sessionId = `${dia}-${horario}-${nome}`;
   
    const session = { dia, horario, nome, tipo, sessoesLiberadas, mes, id: sessionId };
   
    if (editIndex >= 0) {
        sessions[editIndex] = session;
        showMessage(`Sess√£o de ${nome} atualizada com sucesso!`, 'success');
    } else {
        sessions.push(session);
        showMessage(`Sess√£o de ${nome} cadastrada com sucesso!`, 'success');
    }
   
    sessions.sort((a, b) => new Date(a.dia) - new Date(b.dia));
    saveData();
    renderTable(document.getElementById('searchInput').value);
    updatePatientsGrid();
    updateSelectPacientes();
    updatePacientesDatalist();
    renderCalendar();
   
    document.getElementById('sessionForm').reset();
    document.getElementById('inputTipo').value = 'Plano';
    document.getElementById('inputSessoesLiberadas').value = 20;
    document.getElementById('editIndex').value = '-1';
   
    // RESETAR TEXTO DO BOT√ÉO
    const btnSubmit = document.querySelector('#sessionForm button[type="submit"]');
    btnSubmit.innerHTML = '<i class="fas fa-save"></i> Cadastrar';
});

// BUSCA
document.getElementById('searchInput').addEventListener('input', (e) => {
    renderTable(e.target.value);
});

// MENSAGENS
function showMessage(text, type = 'success') {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = `message ${type}`;
    msg.style.display = 'block';
    setTimeout(() => {
        msg.style.display = 'none';
    }, 5000);
}

function togglePatientsView() {
    const grid = document.getElementById('patientsGrid');
    const text = document.getElementById('toggleText');
    patientsVisible = !patientsVisible;
    grid.style.display = patientsVisible ? 'grid' : 'none';
    text.textContent = patientsVisible ? 'Ocultar Pacientes' : 'Mostrar Pacientes';
}

function buscarPaciente(nome) {
    document.getElementById('searchInput').value = nome;
    renderTable(nome);
    showSection('cadastro');
}

// PACIENTES
function updatePatientsGrid() {
    const grid = document.getElementById('patientsGrid');
    const pacientesSessoes = [...new Set(sessions.map(s => s.nome))];
    const uniquePatients = [...new Set([...pacientesSessoes, ...pacientesCadastrados.map(p => p.nome)])].sort();
   
    grid.innerHTML = '';
   
    if (uniquePatients.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">Nenhum paciente cadastrado.</p>';
        return;
    }
   
    uniquePatients.forEach(paciente => {
        const realizadas = getSessoesRealizadas(paciente);
        const liberadas = getSessoesLiberadas(paciente);
        const faltantes = liberadas - realizadas;
        
        // Buscar dados completos do paciente
        const pacienteData = pacientesCadastrados.find(p => p.nome === paciente) || { nome: paciente };
       
        const card = document.createElement('div');
        card.className = 'patient-card';
        card.innerHTML = `
            <div class="patient-name">${paciente}</div>
            <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #4a5568;">
                ${pacienteData.telefone ? `<div><i class="fas fa-phone"></i> ${pacienteData.telefone}</div>` : ''}
                ${pacienteData.bairro ? `<div><i class="fas fa-map-marker-alt"></i> ${pacienteData.bairro}</div>` : ''}
            </div>
            <div class="patient-stats">
                <div class="stat-item">
                    <div class="stat-value">${liberadas}</div>
                    <div class="stat-label">Liberadas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${realizadas}</div>
                    <div class="stat-label">Realizadas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${faltantes}</div>
                    <div class="stat-label">Faltantes</div>
                </div>
            </div>
            <button class="btn-info" style="margin-top: 1rem; width: 100%;" onclick="buscarPaciente('${paciente}')">
                <i class="fas fa-search"></i> Ver Sess√µes
            </button>
        `;
        grid.appendChild(card);
    });
}

// UPDATE SELECT PACIENTES
function updateSelectPacientes() {
    const select = document.getElementById('selectPacienteRelatorio');
    const pacientesSessoes = [...new Set(sessions.map(s => s.nome))];
    const uniquePatients = [...new Set([...pacientesSessoes, ...pacientesCadastrados.map(p => p.nome)])].sort();
   
    select.innerHTML = '<option value="">Todos os Pacientes</option>';
    uniquePatients.forEach(p => {
        const option = document.createElement('option');
        option.value = p;
        option.textContent = p;
        select.appendChild(option);
    });
}

// CADASTRO DE PACIENTES
function abrirModalCadastroPaciente() {
    document.getElementById('modalCadastroPaciente').style.display = 'flex';
    document.getElementById('formCadastroPaciente').reset();
}

function fecharModalCadastroPaciente() {
    document.getElementById('modalCadastroPaciente').style.display = 'none';
}

function cadastrarPaciente() {
    const nome = document.getElementById('inputNomeCompleto').value.trim();
    const telefone = document.getElementById('inputTelefone').value.trim();
    const bairro = document.getElementById('inputBairro').value.trim();
    
    if (!nome || !telefone || !bairro) {
        showMessage('Por favor, preencha todos os campos.', 'error');
        return;
    }
    
    // Verificar se o paciente j√° existe
    if (pacientesCadastrados.some(p => p.nome === nome)) {
        showMessage('J√° existe um paciente cadastrado com este nome.', 'error');
        return;
    }
    
    pacientesCadastrados.push({ nome, telefone, bairro });
    saveData();
    updatePatientsGrid();
    updateSelectPacientes();
    updatePacientesDatalist();
    fecharModalCadastroPaciente();
    showMessage(`Paciente ${nome} cadastrado com sucesso!`, 'success');
}

// CALEND√ÅRIO
function renderCalendar() {
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthYear = document.getElementById('currentMonthYear');
    
    // Atualizar t√≠tulo do m√™s/ano
    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    currentMonthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    
    // Obter primeiro e √∫ltimo dia do m√™s
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    
    // Obter o dia da semana do primeiro dia (0 = domingo, 1 = segunda, etc.)
    const firstDayOfWeek = firstDay.getDay();
    
    // Obter o n√∫mero de dias no m√™s
    const daysInMonth = lastDay.getDate();
    
    // Limpar calend√°rio
    calendarDays.innerHTML = '';
    
    // Adicionar dias vazios no in√≠cio (para alinhar corretamente)
    for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarDays.appendChild(emptyDay);
    }
    
    // Adicionar os dias do m√™s
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const currentDate = new Date(currentYear, currentMonth, day);
        
        dayElement.className = 'calendar-day current-month';
        
        // Verificar se √© hoje
        if (currentDate.getTime() === today.getTime()) {
            dayElement.classList.add('today');
        }
        
        // Adicionar n√∫mero do dia
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        // Adicionar marca√ß√µes de atendimentos
        const appointmentsContainer = document.createElement('div');
        appointmentsContainer.className = 'calendar-appointments';
        
        // Formatar data para compara√ß√£o
        const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        
        // Buscar sess√µes para este dia
        const daySessions = sessions.filter(s => s.dia === dateStr);
        
        // Adicionar badges para cada sess√£o
        daySessions.forEach(session => {
            const badge = document.createElement('div');
            badge.className = `appointment-badge ${session.tipo === 'Particular' ? 'particular' : ''}`;
            
            // Mostrar apenas primeiro nome, mas incluir sobrenome se houver nomes iguais
            const nomeCompleto = session.nome;
            const partesNome = nomeCompleto.split(' ');
            let nomeExibicao = partesNome[0];
            
            // Verificar se h√° outros pacientes com o mesmo primeiro nome
            const pacientesMesmoPrimeiroNome = sessions.filter(s => 
                s.nome.split(' ')[0] === partesNome[0] && s.dia === dateStr
            );
            
            if (pacientesMesmoPrimeiroNome.length > 1 && partesNome.length > 1) {
                nomeExibicao += ' ' + partesNome[partesNome.length - 1];
            }
            
            badge.textContent = `${session.horario} - ${nomeExibicao}`;
            appointmentsContainer.appendChild(badge);
        });
        
        dayElement.appendChild(appointmentsContainer);
        
        // Adicionar evento de clique para abrir modal com detalhes do dia
        dayElement.addEventListener('click', () => {
            abrirModalAtendimentosDia(dateStr);
        });
        
        calendarDays.appendChild(dayElement);
    }
}

function changeMonth(direction) {
    currentMonth += direction;
    
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    
    renderCalendar();
}

function showToday() {
    const today = new Date();
    currentMonth = today.getMonth();
    currentYear = today.getFullYear();
    renderCalendar();
}

function filtrarPorDiaSemana(dia) {
    // Esta fun√ß√£o pode ser expandida para filtrar a visualiza√ß√£o do calend√°rio
    // Por enquanto, apenas mostra uma mensagem
    if (dia === 'todos') {
        showMessage('Mostrando todos os dias da semana.', 'success');
    } else {
        const dias = {
            'segunda': 'Segunda-feira',
            'terca': 'Ter√ßa-feira',
            'quarta': 'Quarta-feira',
            'quinta': 'Quinta-feira',
            'sexta': 'Sexta-feira'
        };
        showMessage(`Filtrando por ${dias[dia]}.`, 'success');
    }
}

// MODAL ATENDIMENTOS DO DIA
function abrirModalAtendimentosDia(data) {
    const modal = document.getElementById('modalAtendimentosDia');
    const titulo = document.getElementById('modalAtendimentosTitulo');
    const conteudo = document.getElementById('modalAtendimentosConteudo');
    
    // Formatar data para exibi√ß√£o
    const dataObj = new Date(data);
    const dataFormatada = dataObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    titulo.innerHTML = `<i class="fas fa-calendar-day"></i> Atendimentos - ${dataFormatada}`;
    
    // Buscar sess√µes para este dia
    const daySessions = sessions.filter(s => s.dia === data);
    
    if (daySessions.length === 0) {
        conteudo.innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">Nenhum atendimento agendado para este dia.</p>';
    } else {
        let html = '<div style="display: grid; gap: 1rem;">';
        
        daySessions.sort((a, b) => a.horario.localeCompare(b.horario)).forEach(session => {
            html += `
                <div style="padding: 1rem; border-radius: 8px; border-left: 4px solid ${session.tipo === 'Particular' ? '#f59e0b' : '#4facfe'}; background: #f7fafc;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">${session.nome}</h4>
                            <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: #4a5568;">
                                <div><i class="fas fa-clock"></i> ${session.horario}</div>
                                <div><i class="fas fa-tag"></i> ${session.tipo}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: #4a5568;">Sess√£o ${getSessionNumber(session.nome, session.dia)}</div>
                            <div style="font-size: 0.8rem; color: #718096;">${session.mes}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        conteudo.innerHTML = html;
    }
    
    modal.style.display = 'flex';
}

function abrirModalDiaAtual() {
    const hoje = new Date();
    const hojeStr = hoje.toISOString().split('T')[0];
    abrirModalAtendimentosDia(hojeStr);
}

function fecharModalAtendimentosDia() {
    document.getElementById('modalAtendimentosDia').style.display = 'none';
}

// BACKUP PACIENTES
function backupPacientes() {
    const backupData = {
        pacientes: pacientesCadastrados,
        metadata: {
            exportDate: new Date().toISOString(),
            totalPacientes: pacientesCadastrados.length
        }
    };
   
    const dataStr = JSON.stringify(backupData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
   
    const date = new Date();
    const fileName = `backup_pacientes_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}.json`;
   
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
   
    showMessage(`Backup de ${pacientesCadastrados.length} pacientes exportado: ${fileName}`, 'success');
}

function importPacientes(event) {
    const file = event.target.files[0];
    if (!file) return;
   
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.pacientes && Array.isArray(data.pacientes)) {
                const todosPacientes = [...new Set([...pacientesCadastrados, ...data.pacientes])];
                pacientesCadastrados = todosPacientes;
                saveData();
                updatePacientesDatalist();
                updatePatientsGrid();
                updateSelectPacientes();
                showMessage(`${data.pacientes.length} pacientes importados. Total: ${todosPacientes.length} pacientes.`, 'success');
            } else {
                showMessage('Formato de arquivo inv√°lido.', 'error');
            }
        } catch (error) {
            showMessage('Erro ao importar backup de pacientes.', 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// BACKUP COMPLETO
function backupCompleto() {
    const backupData = {
        sessions: sessions,
        closedInvoices: closedInvoices,
        pacientesCadastrados: pacientesCadastrados,
        pagamentos: pagamentos,
        metadata: {
            exportDate: new Date().toISOString(),
            totalSessions: sessions.length,
            totalInvoices: closedInvoices.length,
            totalPacientes: pacientesCadastrados.length,
            totalPagamentos: pagamentos.length
        }
    };
   
    const dataStr = JSON.stringify(backupData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
   
    const date = new Date();
    const fileName = `backup_completo_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}.json`;
   
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
   
    showMessage(`Backup completo exportado: ${fileName}`, 'success');
}

function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
   
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.sessions) {
                const sessionsCount = data.sessions.length;
                const invoicesCount = data.closedInvoices?.length || 0;
                const pacientesCount = data.pacientesCadastrados?.length || 0;
                const pagamentosCount = data.pagamentos?.length || 0;
               
                if (confirm(`Restaurar ${sessionsCount} sess√µes, ${invoicesCount} faturas, ${pacientesCount} pacientes e ${pagamentosCount} pagamentos?`)) {
                    sessions = data.sessions;
                    closedInvoices = data.closedInvoices || [];
                    pacientesCadastrados = data.pacientesCadastrados || [];
                    pagamentos = data.pagamentos || [];
                   
                    saveData();
                    renderTable();
                    updatePatientsGrid();
                    updateSelectPacientes();
                    updatePacientesDatalist();
                    renderFaturasContainer();
                    renderCalendar();
                    renderPagamentosTable();
                    updateSaldo();
                    showMessage('Backup restaurado com sucesso!', 'success');
                }
            } else {
                showMessage('Formato de arquivo inv√°lido.', 'error');
            }
        } catch (error) {
            showMessage('Erro ao importar backup: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// MODAL PARA FECHAR FATURA
function abrirModalFecharFatura() {
    const modal = document.getElementById('modalFecharFatura');
    modal.style.display = 'flex';
   
    // Definir datas padr√£o
    const hoje = new Date();
    const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
   
    document.getElementById('inputDataInicial').value = primeiroDiaMes.toISOString().split('T')[0];
    document.getElementById('inputDataFinal').value = ultimoDiaMes.toISOString().split('T')[0];
   
    // Descri√ß√£o autom√°tica
    const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    document.getElementById('inputDescricaoFatura').value = `${meses[hoje.getMonth()]} ${hoje.getFullYear()}`;
}

function fecharModalFecharFatura() {
    document.getElementById('modalFecharFatura').style.display = 'none';
}

function fecharFatura() {
    const dataInicial = document.getElementById('inputDataInicial').value;
    const dataFinal = document.getElementById('inputDataFinal').value;
    const descricao = document.getElementById('inputDescricaoFatura').value.trim();
   
    if (!dataInicial || !dataFinal || !descricao) {
        showMessage('Por favor, preencha todas as informa√ß√µes do per√≠odo.', 'warning');
        return;
    }
   
    // Filtrar sess√µes pelo per√≠odo
    const sessoesPeriodo = sessions.filter(s => {
        const dataSessao = new Date(s.dia);
        const dataIni = new Date(dataInicial);
        const dataFim = new Date(dataFinal);
        return dataSessao >= dataIni && dataSessao <= dataFim;
    });
   
    if (sessoesPeriodo.length === 0) {
        showMessage(`Nenhuma sess√£o encontrada para o per√≠odo de ${formatDate(dataInicial)} a ${formatDate(dataFinal)}.`, 'warning');
        return;
    }
   
    // Verificar se j√° existe fatura para este per√≠odo
    const faturaExistente = closedInvoices.find(f => f.descricao === descricao);
   
    if (faturaExistente) {
        if (!confirm(`J√° existe uma fatura fechada para "${descricao}". Deseja substitu√≠-la?`)) {
            return;
        }
    }
   
    // Calcular totais
    const pacientesUnicos = [...new Set(sessoesPeriodo.map(s => s.nome))];
    const totalSessoes = sessoesPeriodo.length;
   
    const novaFatura = {
        descricao: descricao,
        dataInicial: dataInicial,
        dataFinal: dataFinal,
        dataFechamento: new Date().toISOString(),
        totalSessoes: totalSessoes,
        totalPacientes: pacientesUnicos.length,
        sessoes: sessoesPeriodo
    };
   
    // Remover fatura existente se houver
    if (faturaExistente) {
        const index = closedInvoices.findIndex(f => f.descricao === descricao);
        closedInvoices.splice(index, 1);
    }
   
    closedInvoices.push(novaFatura);
    saveData();
    renderFaturasContainer();
    fecharModalFecharFatura();
   
    showMessage(`Fatura "${descricao}" fechada com sucesso!`, 'success');
}

// SISTEMA DE PAGAMENTOS
function abrirModalRegistroPagamento() {
    document.getElementById('modalRegistroPagamento').style.display = 'flex';
    document.getElementById('formRegistroPagamento').reset();
    document.getElementById('formaPagamentoGroup').style.display = 'block';
    
    // Atualizar lista de pacientes particulares
    const selectPaciente = document.getElementById('selectPacientePagamento');
    selectPaciente.innerHTML = '<option value="">Selecione um paciente</option>';
    
    // Filtrar apenas pacientes particulares
    const pacientesParticulares = [...new Set(sessions
        .filter(s => s.tipo === 'Particular')
        .map(s => s.nome))].sort();
    
    pacientesParticulares.forEach(paciente => {
        const option = document.createElement('option');
        option.value = paciente;
        option.textContent = paciente;
        selectPaciente.appendChild(option);
    });
}

function fecharModalRegistroPagamento() {
    document.getElementById('modalRegistroPagamento').style.display = 'none';
}

function atualizarSessoesPaciente() {
    const paciente = document.getElementById('selectPacientePagamento').value;
    const selectData = document.getElementById('selectDataSessao');
    const selectHorario = document.getElementById('selectHorarioSessao');
    
    selectData.innerHTML = '<option value="">Selecione uma data</option>';
    selectHorario.innerHTML = '<option value="">Selecione um hor√°rio</option>';
    
    if (!paciente) return;
    
    // Buscar sess√µes do paciente particular
    const sessoesPaciente = sessions.filter(s => 
        s.nome === paciente && s.tipo === 'Particular'
    );
    
    // Adicionar datas √∫nicas
    const datasUnicas = [...new Set(sessoesPaciente.map(s => s.dia))].sort();
    datasUnicas.forEach(data => {
        const option = document.createElement('option');
        option.value = data;
        option.textContent = formatDate(data);
        selectData.appendChild(option);
    });
}

function atualizarHorariosSessao() {
    const paciente = document.getElementById('selectPacientePagamento').value;
    const data = document.getElementById('selectDataSessao').value;
    const selectHorario = document.getElementById('selectHorarioSessao');
    
    selectHorario.innerHTML = '<option value="">Selecione um hor√°rio</option>';
    
    if (!paciente || !data) return;
    
    // Buscar hor√°rios do paciente na data selecionada
    const sessoesPacienteData = sessions.filter(s => 
        s.nome === paciente && s.dia === data && s.tipo === 'Particular'
    );
    
    sessoesPacienteData.forEach(sessao => {
        const option = document.createElement('option');
        option.value = sessao.horario;
        option.textContent = sessao.horario;
        selectHorario.appendChild(option);
    });
}

function registrarPagamento() {
    const paciente = document.getElementById('selectPacientePagamento').value;
    const data = document.getElementById('selectDataSessao').value;
    const horario = document.getElementById('selectHorarioSessao').value;
    const valor = parseFloat(document.getElementById('inputValorSessao').value);
    const status = document.getElementById('selectStatusPagamento').value;
    const formaPagamento = document.getElementById('selectFormaPagamento').value;
    const descricao = document.getElementById('inputDescricaoPagamento').value.trim();
    
    if (!paciente || !data || !horario || !valor || !status) {
        showMessage('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
        return;
    }
    
    // Verificar se j√° existe pagamento para esta sess√£o
    const pagamentoExistente = pagamentos.find(p => 
        p.paciente === paciente && p.data === data && p.horario === horario
    );
    
    if (pagamentoExistente) {
        if (!confirm('J√° existe um pagamento registrado para esta sess√£o. Deseja substitu√≠-lo?')) {
            return;
        }
        // Remover pagamento existente
        const index = pagamentos.findIndex(p => 
            p.paciente === paciente && p.data === data && p.horario === horario
        );
        pagamentos.splice(index, 1);
    }
    
    // Criar ID √∫nico para o pagamento
    const pagamentoId = `${data}-${horario}-${paciente}`;
    
    const novoPagamento = {
        id: pagamentoId,
        paciente: paciente,
        data: data,
        horario: horario,
        valor: valor,
        status: status,
        formaPagamento: status === 'Pago' ? formaPagamento : null,
        descricao: descricao || `Pagamento da sess√£o de ${paciente}`,
        dataRegistro: new Date().toISOString()
    };
    
    pagamentos.push(novoPagamento);
    saveData();
    renderPagamentosTable();
    updateSaldo();
    fecharModalRegistroPagamento();
    
    showMessage(`Pagamento de ${paciente} registrado com sucesso!`, 'success');
}

function renderPagamentosTable() {
    const tbody = document.getElementById('pagamentosTableBody');
    tbody.innerHTML = '';
    
    if (pagamentos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #718096; padding: 2rem;">
                    Nenhum pagamento registrado.
                </td>
            </tr>
        `;
        return;
    }
    
    // Ordenar por data (mais recente primeiro)
    pagamentos.sort((a, b) => new Date(b.dataRegistro) - new Date(a.dataRegistro));
    
    pagamentos.forEach((pagamento, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDate(pagamento.data)}</td>
            <td>${pagamento.paciente}</td>
            <td>${formatCurrency(pagamento.valor)}</td>
            <td>
                <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; 
                    background: ${pagamento.status === 'Pago' ? '#c6f6d5' : '#fed7d7'}; 
                    color: ${pagamento.status === 'Pago' ? '#22543d' : '#742a2a'};">
                    ${pagamento.status}
                </span>
            </td>
            <td>${pagamento.formaPagamento || '-'}</td>
            <td>${pagamento.descricao}</td>
            <td>
                <button class="action-btn btn-edit" onclick="editarPagamento(${index})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn btn-delete" onclick="excluirPagamento(${index})" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editarPagamento(index) {
    const pagamento = pagamentos[index];
    
    // Preencher o modal com os dados do pagamento
    document.getElementById('selectPacientePagamento').value = pagamento.paciente;
    atualizarSessoesPaciente();
    document.getElementById('selectDataSessao').value = pagamento.data;
    atualizarHorariosSessao();
    document.getElementById('selectHorarioSessao').value = pagamento.horario;
    document.getElementById('inputValorSessao').value = pagamento.valor;
    document.getElementById('selectStatusPagamento').value = pagamento.status;
    document.getElementById('selectFormaPagamento').value = pagamento.formaPagamento || 'Pix';
    document.getElementById('inputDescricaoPagamento').value = pagamento.descricao;
    
    // Mostrar/ocultar forma de pagamento conforme o status
    document.getElementById('formaPagamentoGroup').style.display = 
        pagamento.status === 'Pago' ? 'block' : 'none';
    
    // Remover o pagamento atual para evitar duplica√ß√£o
    pagamentos.splice(index, 1);
    
    abrirModalRegistroPagamento();
}

function excluirPagamento(index) {
    if (confirm('Deseja realmente excluir este pagamento permanentemente?')) {
        const excluido = pagamentos.splice(index, 1)[0];
        saveData();
        renderPagamentosTable();
        updateSaldo();
        showMessage(`Pagamento de ${excluido.paciente} exclu√≠do permanentemente!`, 'success');
    }
}

function updateSaldo() {
    const totalRecebido = pagamentos
        .filter(p => p.status === 'Pago')
        .reduce((total, p) => total + p.valor, 0);
    
    const totalAberto = pagamentos
        .filter(p => p.status === 'Em Aberto')
        .reduce((total, p) => total + p.valor, 0);
    
    const saldoAtual = totalRecebido;
    
    document.getElementById('saldoAtual').textContent = formatCurrency(saldoAtual);
    document.getElementById('totalRecebido').textContent = formatCurrency(totalRecebido);
    document.getElementById('totalAberto').textContent = formatCurrency(totalAberto);
}

// RELAT√ìRIOS FINANCEIROS
function gerarRelatorioContasPagas() {
    const contasPagas = pagamentos.filter(p => p.status === 'Pago');
    
    if (contasPagas.length === 0) {
        showMessage('Nenhuma conta paga encontrada.', 'warning');
        return;
    }
    
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">RELAT√ìRIO DE CONTAS PAGAS</div>
       
        <h3>Resumo</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Total de Contas Pagas</th>
                    <th>Valor Total Recebido</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${contasPagas.length}</td>
                    <td>${formatCurrency(contasPagas.reduce((total, p) => total + p.valor, 0))}</td>
                </tr>
            </tbody>
        </table>
       
        <h3>Detalhes das Contas Pagas</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data da Sess√£o</th>
                    <th>Paciente</th>
                    <th>Valor</th>
                    <th>Forma de Pagamento</th>
                    <th>Descri√ß√£o</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    contasPagas.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(pagamento => {
        html += `
            <tr>
                <td>${formatDate(pagamento.data)}</td>
                <td>${pagamento.paciente}</td>
                <td>${formatCurrency(pagamento.valor)}</td>
                <td>${pagamento.formaPagamento}</td>
                <td>${pagamento.descricao}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
    
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Relat√≥rio de Contas Pagas</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
    
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

function gerarRelatorioContasAbertas() {
    const contasAbertas = pagamentos.filter(p => p.status === 'Em Aberto');
    
    if (contasAbertas.length === 0) {
        showMessage('Nenhuma conta em aberto encontrada.', 'warning');
        return;
    }
    
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">RELAT√ìRIO DE CONTAS EM ABERTO</div>
       
        <h3>Resumo</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Total de Contas em Aberto</th>
                    <th>Valor Total Devido</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${contasAbertas.length}</td>
                    <td>${formatCurrency(contasAbertas.reduce((total, p) => total + p.valor, 0))}</td>
                </tr>
            </tbody>
        </table>
       
        <h3>Detalhes das Contas em Aberto</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data da Sess√£o</th>
                    <th>Paciente</th>
                    <th>Valor</th>
                    <th>Descri√ß√£o</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    contasAbertas.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(pagamento => {
        html += `
            <tr>
                <td>${formatDate(pagamento.data)}</td>
                <td>${pagamento.paciente}</td>
                <td>${formatCurrency(pagamento.valor)}</td>
                <td>${pagamento.descricao}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
    
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-exclamation-circle"></i> Relat√≥rio de Contas em Aberto</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
    
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

function gerarRelatorioFluxoCaixa() {
    // Agrupar pagamentos por data
    const pagamentosPorData = {};
    
    pagamentos.forEach(pagamento => {
        const data = pagamento.data;
        if (!pagamentosPorData[data]) {
            pagamentosPorData[data] = {
                data: data,
                creditos: 0,
                debitos: 0,
                detalhes: []
            };
        }
        
        if (pagamento.status === 'Pago') {
            pagamentosPorData[data].creditos += pagamento.valor;
            pagamentosPorData[data].detalhes.push({
                tipo: 'Cr√©dito',
                paciente: pagamento.paciente,
                valor: pagamento.valor,
                formaPagamento: pagamento.formaPagamento,
                descricao: pagamento.descricao,
                horario: pagamento.horario
            });
        } else {
            pagamentosPorData[data].debitos += pagamento.valor;
            pagamentosPorData[data].detalhes.push({
                tipo: 'D√©bito',
                paciente: pagamento.paciente,
                valor: pagamento.valor,
                descricao: pagamento.descricao,
                horario: pagamento.horario
            });
        }
    });
    
    // Converter para array e ordenar por data
    const fluxoCaixa = Object.values(pagamentosPorData).sort((a, b) => 
        new Date(a.data) - new Date(b.data)
    );
    
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">RELAT√ìRIO DE FLUXO DE CAIXA</div>
       
        <h3>Resumo por Data</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cr√©ditos (Recebidos)</th>
                    <th>D√©bitos (Em Aberto)</th>
                    <th>Saldo do Dia</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalCreditos = 0;
    let totalDebitos = 0;
    
    fluxoCaixa.forEach(dia => {
        const saldoDia = dia.creditos - dia.debitos;
        totalCreditos += dia.creditos;
        totalDebitos += dia.debitos;
        
        html += `
            <tr>
                <td>${formatDate(dia.data)}</td>
                <td>${formatCurrency(dia.creditos)}</td>
                <td>${formatCurrency(dia.debitos)}</td>
                <td>${formatCurrency(saldoDia)}</td>
            </tr>
        `;
    });
    
    const saldoTotal = totalCreditos - totalDebitos;
    
    html += `
            </tbody>
            <tfoot>
                <tr>
                    <td><strong>TOTAIS</strong></td>
                    <td><strong>${formatCurrency(totalCreditos)}</strong></td>
                    <td><strong>${formatCurrency(totalDebitos)}</strong></td>
                    <td><strong>${formatCurrency(saldoTotal)}</strong></td>
                </tr>
            </tfoot>
        </table>
       
        <h3>Detalhamento por Sess√£o</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Paciente</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Forma de Pagamento</th>
                    <th>Descri√ß√£o</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    fluxoCaixa.forEach(dia => {
        dia.detalhes.sort((a, b) => a.horario.localeCompare(b.horario)).forEach(detalhe => {
            html += `
                <tr>
                    <td>${formatDate(dia.data)}</td>
                    <td>${detalhe.horario}</td>
                    <td>${detalhe.paciente}</td>
                    <td>${detalhe.tipo}</td>
                    <td>${formatCurrency(detalhe.valor)}</td>
                    <td>${detalhe.formaPagamento || '-'}</td>
                    <td>${detalhe.descricao}</td>
                </tr>
            `;
        });
    });
    
    html += `
            </tbody>
        </table>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
    
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> Relat√≥rio de Fluxo de Caixa</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
    
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

// FUN√á√ïES DE RELAT√ìRIOS EXISTENTES (mantidas para compatibilidade)
function gerarFichaPaciente() {
    const pacienteSelecionado = document.getElementById('selectPacienteRelatorio').value;
   
    if (!pacienteSelecionado) {
        showMessage('Por favor, selecione um paciente para gerar a ficha.', 'warning');
        return;
    }
   
    const pacienteSessoes = sessions.filter(s => s.nome === pacienteSelecionado);
   
    if (pacienteSessoes.length === 0) {
        showMessage('Nenhuma sess√£o encontrada para este paciente.', 'warning');
        return;
    }
   
    const sessoesLiberadas = getSessoesLiberadas(pacienteSelecionado);
    const sessoesRealizadas = getSessoesRealizadas(pacienteSelecionado);
    const sessoesFaltantes = sessoesLiberadas - sessoesRealizadas;
   
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">FICHA DO PACIENTE</div>
       
        <div style="margin-bottom: 20px;">
            <h3>Dados do Paciente</h3>
            <p><strong>Nome:</strong> ${pacienteSelecionado}</p>
            <p><strong>Sess√µes Liberadas:</strong> ${sessoesLiberadas}</p>
            <p><strong>Sess√µes Realizadas:</strong> ${sessoesRealizadas}</p>
            <p><strong>Sess√µes Faltantes:</strong> ${sessoesFaltantes}</p>
        </div>
       
        <h3>Sess√µes Realizadas</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Tipo</th>
                    <th>N¬∫ Sess√£o</th>
                    <th>M√™s</th>
                </tr>
            </thead>
            <tbody>
    `;
   
    pacienteSessoes.sort((a, b) => new Date(a.dia) - new Date(b.dia)).forEach((sess, index) => {
        html += `
            <tr>
                <td>${formatDate(sess.dia)}</td>
                <td>${sess.horario}</td>
                <td>${sess.tipo}</td>
                <td>${(index + 1).toString().padStart(2, '0')}</td>
                <td>${sess.mes}</td>
            </tr>
        `;
    });
   
    html += `
            </tbody>
        </table>
       
        <div class="signature-area">
            <div class="signature-box">
                <div class="signature-line"></div>
                <div>Assinatura do Respons√°vel</div>
            </div>
        </div>
       
        <div class="stamp-area">
            <img src="carimbo.png" alt="Carimbo" style="max-width: 120px; max-height: 120px;">
        </div>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
   
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-file-alt"></i> Ficha do Paciente - ${pacienteSelecionado}</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn-success" onclick="salvarRelatorio()">
                    <i class="fas fa-download"></i> Salvar PDF
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
   
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

function gerarRelatorioConsolidado() {
    const pacienteSelecionado = document.getElementById('selectPacienteRelatorio').value;
    const sessoesFiltradas = pacienteSelecionado
        ? sessions.filter(s => s.nome === pacienteSelecionado)
        : sessions;
   
    if (sessoesFiltradas.length === 0) {
        showMessage('Nenhuma sess√£o encontrada para o filtro selecionado.', 'warning');
        return;
    }
   
    // Agrupar por m√™s
    const sessoesPorMes = {};
    sessoesFiltradas.forEach(sess => {
        if (!sessoesPorMes[sess.mes]) {
            sessoesPorMes[sess.mes] = [];
        }
        sessoesPorMes[sess.mes].push(sess);
    });
   
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">RELAT√ìRIO CONSOLIDADO ${pacienteSelecionado ? `- ${pacienteSelecionado}` : ''}</div>
    `;
   
    // Resumo por m√™s
    html += '<h3>Resumo por M√™s</h3>';
    html += '<table class="print-table">';
    html += '<thead><tr><th>M√™s</th><th>Sess√µes Realizadas</th><th>Pacientes Atendidos</th></tr></thead><tbody>';
   
    for (const mes in sessoesPorMes) {
        const sessoesMes = sessoesPorMes[mes];
        const pacientesUnicos = [...new Set(sessoesMes.map(s => s.nome))];
       
        html += `
            <tr>
                <td>${mes}</td>
                <td>${sessoesMes.length}</td>
                <td>${pacientesUnicos.length}</td>
            </tr>
        `;
    }
   
    html += '</tbody></table>';
   
    // Detalhes das sess√µes
    html += '<h3>Detalhes das Sess√µes</h3>';
    html += '<table class="print-table">';
    html += '<thead><tr><th>Data</th><th>Hor√°rio</th><th>Paciente</th><th>Tipo</th><th>M√™s</th></tr></thead><tbody>';
   
    sessoesFiltradas.sort((a, b) => new Date(a.dia) - new Date(b.dia)).forEach(sess => {
        html += `
            <tr>
                <td>${formatDate(sess.dia)}</td>
                <td>${sess.horario}</td>
                <td>${sess.nome}</td>
                <td>${sess.tipo}</td>
                <td>${sess.mes}</td>
            </tr>
        `;
    });
   
    html += '</tbody></table>';
   
    html += `
        <div class="signature-area">
            <div class="signature-box">
                <div class="signature-line"></div>
                <div>Assinatura do Respons√°vel</div>
            </div>
        </div>
       
        <div class="stamp-area">
            <img src="carimbo.png" alt="Carimbo" style="max-width: 120px; max-height: 120px;">
        </div>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
            <p>Total de sess√µes: ${sessoesFiltradas.length}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
   
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Relat√≥rio Consolidado</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn-success" onclick="salvarRelatorio()">
                    <i class="fas fa-download"></i> Salvar PDF
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
   
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

function gerarRelatorioAtendimentosNaoFaturados() {
    // Obter IDs de todas as sess√µes que est√£o em faturas fechadas
    const sessoesFechadasIds = new Set();
    closedInvoices.forEach(fatura => {
        fatura.sessoes.forEach(sessao => {
            sessoesFechadasIds.add(sessao.id || `${sessao.dia}-${sessao.horario}-${sessao.nome}`);
        });
    });
   
    // Filtrar apenas sess√µes n√£o fechadas
    const sessoesNaoFechadas = sessions.filter(s => {
        const sessaoId = s.id || `${s.dia}-${s.horario}-${s.nome}`;
        return !sessoesFechadasIds.has(sessaoId);
    });
   
    if (sessoesNaoFechadas.length === 0) {
        showMessage('Nenhum atendimento n√£o faturado encontrado.', 'warning');
        return;
    }
   
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">RELAT√ìRIO DE ATENDIMENTOS N√ÉO FATURADOS</div>
       
        <h3>Resumo por Paciente</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Paciente</th>
                    <th>Sess√µes Liberadas</th>
                    <th>Sess√µes Realizadas</th>
                    <th>Sess√µes Restantes</th>
                </tr>
            </thead>
            <tbody>
    `;
   
    // Agrupar por paciente
    const pacientes = {};
    sessoesNaoFechadas.forEach(sess => {
        if (!pacientes[sess.nome]) {
            pacientes[sess.nome] = {
                liberadas: getSessoesLiberadas(sess.nome),
                realizadas: 0,
                sessoes: []
            };
        }
        pacientes[sess.nome].realizadas++;
        pacientes[sess.nome].sessoes.push(sess);
    });
   
    for (const paciente in pacientes) {
        const dados = pacientes[paciente];
        const restantes = dados.liberadas - dados.realizadas;
       
        html += `
            <tr>
                <td>${paciente}</td>
                <td>${dados.liberadas}</td>
                <td>${dados.realizadas}</td>
                <td>${restantes}</td>
            </tr>
        `;
    }
   
    html += `
            </tbody>
        </table>
       
        <div style="margin-top: 20px; font-style: italic;">
            * As sess√µes restantes devem ser passadas para controle no pr√≥ximo m√™s
        </div>
       
        <h3>Detalhes dos Atendimentos</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Paciente</th>
                    <th>Tipo</th>
                    <th>M√™s</th>
                </tr>
            </thead>
            <tbody>
    `;
   
    sessoesNaoFechadas.sort((a, b) => new Date(a.dia) - new Date(b.dia)).forEach(sess => {
        html += `
            <tr>
                <td>${formatDate(sess.dia)}</td>
                <td>${sess.horario}</td>
                <td>${sess.nome}</td>
                <td>${sess.tipo}</td>
                <td>${sess.mes}</td>
            </tr>
        `;
    });
   
    html += `
            </tbody>
        </table>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
            <p>Total de atendimentos n√£o faturados: ${sessoesNaoFechadas.length}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
   
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-list"></i> Atendimentos N√£o Faturados</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
   
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

function gerarRelatorioSessoesRestantes() {
    const pacienteSelecionado = document.getElementById('selectPacienteRelatorio').value;
    const sessoesFiltradas = pacienteSelecionado
        ? sessions.filter(s => s.nome === pacienteSelecionado)
        : sessions;
   
    if (sessoesFiltradas.length === 0) {
        showMessage('Nenhuma sess√£o encontrada para o filtro selecionado.', 'warning');
        return;
    }
   
    // Agrupar por paciente
    const pacientes = {};
    sessoesFiltradas.forEach(sess => {
        if (!pacientes[sess.nome]) {
            pacientes[sess.nome] = {
                liberadas: getSessoesLiberadas(sess.nome),
                realizadas: 0,
                sessoes: []
            };
        }
        pacientes[sess.nome].realizadas++;
        pacientes[sess.nome].sessoes.push(sess);
    });
   
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">RELAT√ìRIO DE SESS√ïES REALIZADAS X RESTANTES ${pacienteSelecionado ? `- ${pacienteSelecionado}` : ''}</div>
       
        <h3>Resumo Consolidado</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Paciente</th>
                    <th>Sess√µes Liberadas</th>
                    <th>Sess√µes Realizadas</th>
                    <th>Sess√µes Restantes</th>
                </tr>
            </thead>
            <tbody>
    `;
   
    for (const paciente in pacientes) {
        const dados = pacientes[paciente];
        const restantes = dados.liberadas - dados.realizadas;
       
        html += `
            <tr>
                <td>${paciente}</td>
                <td>${dados.liberadas}</td>
                <td>${dados.realizadas}</td>
                <td>${restantes}</td>
            </tr>
        `;
    }
   
    html += `
            </tbody>
        </table>
       
        <h3>Detalhes das Sess√µes Realizadas</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Paciente</th>
                    <th>Tipo</th>
                    <th>M√™s</th>
                </tr>
            </thead>
            <tbody>
    `;
   
    sessoesFiltradas.sort((a, b) => new Date(a.dia) - new Date(b.dia)).forEach(sess => {
        html += `
            <tr>
                <td>${formatDate(sess.dia)}</td>
                <td>${sess.horario}</td>
                <td>${sess.nome}</td>
                <td>${sess.tipo}</td>
                <td>${sess.mes}</td>
            </tr>
        `;
    });
   
    html += `
            </tbody>
        </table>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
   
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> Sess√µes Realizadas x Restantes</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
   
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
}

function gerarFichaControlePaciente() {
    const pacienteSelecionado = document.getElementById('selectPacienteRelatorio').value;
   
    if (!pacienteSelecionado) {
        showMessage('Por favor, selecione um paciente para gerar a ficha de controle.', 'warning');
        return;
    }
   
    const sessoesPaciente = sessions.filter(s => s.nome === pacienteSelecionado);
    const sessoesLiberadas = getSessoesLiberadas(pacienteSelecionado);
   
    let html = `
        <div style="page-break-after: always;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <tr>
                    <td style="width: 40%; vertical-align: top;">
                        <img src="logo.png" alt="Logo" style="max-width: 150px; height: auto;">
                        <div style="margin-top: 10px; font-weight: bold;">
                            Dra Thais Pereira Xavier<br>
                            Crefito - 4/93256F
                        </div>
                    </td>
                    <td style="width: 60%; vertical-align: top; text-align: right;">
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            <i class="fab fa-whatsapp"></i> (35)98402-0761
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Quantidade Liberadas:</strong> ${sessoesLiberadas}
                        </div>
                        <div style="border: 1px solid #000; padding: 5px; text-align: center;">
                            <strong>Controle de Sess√µes</strong><br>
                            Fisio Cl√≠nica / Thais Pereira Xavier - ME<br>
                            CNPJ: 21.719.507/0001-70<br>
                            Contrato Administrativo n¬∫03/2025<br>
                            <strong>M√™s de Refer√™ncia:</strong> ________________
                        </div>
                    </td>
                </tr>
            </table>
           
            <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 16pt;">
                FICHA DE CONTROLE - ${pacienteSelecionado}
            </div>
           
            <table class="print-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 10%;">Qtd</th>
                        <th style="width: 20%;">Data</th>
                        <th style="width: 15%;">Hora</th>
                        <th style="width: 25%;">Paciente</th>
                        <th style="width: 30%;">Assinatura</th>
                    </tr>
                </thead>
                <tbody>
    `;
   
    // Adicionar 10 linhas para preenchimento
    for (let i = 1; i <= 10; i++) {
        const sessao = sessoesPaciente[i - 1];
        html += `
            <tr style="height: 40px;">
                <td>${i}</td>
                <td>${sessao ? formatDate(sessao.dia) : ''}</td>
                <td>${sessao ? sessao.horario : ''}</td>
                <td>${i === 1 ? pacienteSelecionado : ''}</td>
                <td></td>
            </tr>
        `;
    }
   
    html += `
                </tbody>
            </table>
           
           
            
            <!-- RODAP√â ADICIONADO -->
            <div class="report-footer">
                <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
                <div style="margin-top: 30px; text-align: center; font-size: 10pt;">
                Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000<br>
                fisioclinicaestiva@gmail.com
            </div>
            </div>
        </div>
    `;
   
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-file-contract"></i> Ficha de Controle - ${pacienteSelecionado}</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirFichaControle()">
                    <i class="fas fa-print"></i> Imprimir Ficha
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
   
    // Armazenar HTML para impress√£o espec√≠fico da ficha
    localStorage.setItem('fichaControleHtml', html);
}

function imprimirFichaControle() {
    const fichaHtml = localStorage.getItem('fichaControleHtml');
    if (!fichaHtml) {
        showMessage('Nenhuma ficha para imprimir.', 'warning');
        return;
    }
   
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Ficha de Controle - Fisio Cl√≠nica</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0.5cm;
                    transform: rotate(90deg);
                    transform-origin: left top;
                    width: 29.7cm;
                    height: 21cm;
                    position: absolute;
                    top: 0;
                    left: 21cm;
                }
                .print-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 10px 0;
                }
                .print-table th, .print-table td {
                    border: 1px solid #000;
                    padding: 8px;
                    text-align: center;
                }
                .print-table th {
                    background: #f0f0f0;
                    font-weight: bold;
                }
                .report-footer {
                    margin-top: 2rem;
                    padding-top: 1rem;
                    border-top: 2px solid #e2e8f0;
                    text-align: center;
                    color: #718096;
                    font-size: 0.9rem;
                }
                @media print {
                    body { margin: 0.5cm; }
                }
            </style>
        </head>
        <body>
            ${fichaHtml}
        </body>
        </html>
    `);
    printWindow.document.close();
   
    // Aguardar o conte√∫do carregar antes de imprimir
    printWindow.onload = function() {
        printWindow.print();
        printWindow.onafterprint = function() {
            printWindow.close();
        };
    };
}

function imprimirRelatorio() {
    const printHtml = localStorage.getItem('printHtml');
    if (!printHtml) {
        showMessage('Nenhum relat√≥rio para imprimir.', 'warning');
        return;
    }
   
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Impress√£o - Fisio Cl√≠nica</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .print-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
                .print-logo { display: flex; align-items: center; gap: 10px; }
                .print-title { font-size: 18pt; font-weight: bold; }
                .print-subtitle { font-size: 14pt; margin: 10px 0; text-align: center; font-weight: bold; }
                .print-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; }
                .print-table th { background: #f0f0f0; font-weight: bold; }
                .print-footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #000; }
                .signature-area { display: flex; justify-content: space-around; margin-top: 50px; }
                .signature-box { text-align: center; width: 200px; }
                .signature-line { border-top: 2px solid #000; margin-bottom: 5px; }
                .stamp-area { text-align: center; margin: 20px auto; }
                .report-footer {
                    margin-top: 2rem;
                    padding-top: 1rem;
                    border-top: 2px solid #e2e8f0;
                    text-align: center;
                    color: #718096;
                    font-size: 0.9rem;
                }
                @media print {
                    body { margin: 0; }
                    .print-header { margin-bottom: 15px; }
                }
            </style>
        </head>
        <body>
            ${printHtml}
        </body>
        </html>
    `);
    printWindow.document.close();
   
    // Aguardar o conte√∫do carregar antes de imprimir
    printWindow.onload = function() {
        printWindow.print();
        printWindow.onafterprint = function() {
            printWindow.close();
        };
    };
}

function salvarRelatorio() {
    showMessage('Funcionalidade de salvar PDF ser√° implementada em breve.', 'info');
}

function visualizarFatura(index) {
    const fatura = closedInvoices[index];
   
    let html = `
        <div class="print-header">
            <div class="print-logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <div class="print-title">Fisio Cl√≠nica Dra Tha√≠s Xavier</div>
                    <div>CNPJ: 21.719.507/0001-70</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div>Data: ${new Date().toLocaleDateString('pt-BR')}</div>
                <div>Hora: ${new Date().toLocaleTimeString('pt-BR')}</div>
            </div>
        </div>
       
        <div class="print-subtitle">FATURA FECHADA - ${fatura.descricao}</div>
       
        <div style="margin-bottom: 20px;">
            <p><strong>Per√≠odo:</strong> ${formatDate(fatura.dataInicial)} a ${formatDate(fatura.dataFinal)}</p>
            <p><strong>Data de Fechamento:</strong> ${new Date(fatura.dataFechamento).toLocaleDateString('pt-BR')}</p>
            <p><strong>Total de Pacientes:</strong> ${fatura.totalPacientes}</p>
            <p><strong>Total de Sess√µes:</strong> ${fatura.totalSessoes}</p>
        </div>
       
        <h3>Detalhes das Sess√µes</h3>
        <table class="print-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Paciente</th>
                    <th>Tipo</th>
                </tr>
            </thead>
            <tbody>
    `;
   
    fatura.sessoes.sort((a, b) => new Date(a.dia) - new Date(b.dia)).forEach(sess => {
        html += `
            <tr>
                <td>${formatDate(sess.dia)}</td>
                <td>${sess.horario}</td>
                <td>${sess.nome}</td>
                <td>${sess.tipo}</td>
            </tr>
        `;
    });
   
    html += `
            </tbody>
        </table>
       
        <div class="signature-area">
            <div class="signature-box">
                <div class="signature-line"></div>
                <div>Assinatura do Respons√°vel</div>
            </div>
        </div>
       
        <div class="stamp-area">
            <img src="carimbo.png" alt="Carimbo" style="max-width: 120px; max-height: 120px;">
        </div>
       
        <div class="print-footer">
            <p>Documento gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
        
        <!-- RODAP√â ADICIONADO -->
        <div class="report-footer">
            <p>Fisio Cl√≠nica Dra Tha√≠s Xavier - CNPJ: 21.719.507/0001-70</p>
            <p>Rua Vereador Ernesto Ramalho Gomes, 36 - Estiva-MG 37542-000</p>
        </div>
    `;
   
    // Exibir preview
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4facfe;">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-receipt"></i> Fatura Fechada - ${fatura.descricao}</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn-info" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                ${html}
            </div>
        </div>
    `;
   
    // Armazenar HTML para impress√£o
    localStorage.setItem('printHtml', html);
    showSection('relatorios');
}

function imprimirFatura(index) {
    visualizarFatura(index);
    setTimeout(() => {
        imprimirRelatorio();
    }, 500);
}

function excluirFatura(index) {
    if (confirm('Deseja realmente excluir esta fatura permanentemente?')) {
        closedInvoices.splice(index, 1);
        saveData();
        renderFaturasContainer();
        showMessage('Fatura exclu√≠da com sucesso!', 'success');
    }
}

function renderFaturasContainer() {
    const container = document.getElementById('faturasContainer');
   
    if (closedInvoices.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">Nenhuma fatura fechada.</p>';
        return;
    }
   
    container.innerHTML = '';
   
    closedInvoices.sort((a, b) => new Date(b.dataFechamento) - new Date(a.dataFechamento)).forEach((fatura, index) => {
        const card = document.createElement('div');
        card.className = 'patient-card';
        card.innerHTML = `
            <div class="patient-name">${fatura.descricao}</div>
            <div class="patient-stats">
                <div class="stat-item">
                    <div class="stat-value">${fatura.totalPacientes}</div>
                    <div class="stat-label">Pacientes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${fatura.totalSessoes}</div>
                    <div class="stat-label">Sess√µes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${formatDate(fatura.dataInicial)}</div>
                    <div class="stat-label">In√≠cio</div>
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn-info" onclick="visualizarFatura(${index})">
                    <i class="fas fa-eye"></i> Visualizar
                </button>
                <button class="btn-warning" onclick="imprimirFatura(${index})">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn-danger" onclick="excluirFatura(${index})">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// INICIALIZAR
window.onload = init;
</script>
</body>
</html>
