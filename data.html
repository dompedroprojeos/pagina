<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Relatórios - Rede de Postos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 2600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #2d3748;
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            animation: shimmer 3s infinite linear;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-container {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .logo-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .logo-container img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            position: relative;
            z-index: 1;
        }
        
        .logo-placeholder {
            font-size: 40px;
            color: white;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 16px;
            color: #718096;
            font-weight: 500;
        }
        
        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .input-section {
            flex: 1;
            min-width: 300px;
        }
        
        .output-section {
            flex: 2;
            min-width: 700px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            height: 100%;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2),
                        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top right, rgba(102, 126, 234, 0.05), transparent 60%);
            pointer-events: none;
        }
        
        .card-title {
            font-size: 22px;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            position: relative;
        }
        
        .card-title i {
            font-size: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        textarea {
            width: 100%;
            height: 400px;
            padding: 18px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-size: 15px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn i {
            position: relative;
            z-index: 1;
        }
        
        .btn span {
            position: relative;
            z-index: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(17, 153, 142, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(235, 51, 73, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(235, 51, 73, 0.4);
        }
        
        .btn-excel {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }
        
        .btn-excel:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(40, 167, 69, 0.4);
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        
        th:last-child {
            border-right: none;
        }
        
        tbody tr {
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        tbody tr:hover {
            background: rgba(102, 126, 234, 0.08);
            transform: scale(1.01);
        }
        
        tbody tr:nth-child(even) {
            background-color: rgba(102, 126, 234, 0.03);
        }
        
        td {
            padding: 12px 10px;
            border-right: 1px solid rgba(102, 126, 234, 0.1);
            font-size: 14px;
        }
        
        td:last-child {
            border-right: none;
        }
        
        .text-right {
            text-align: right !important;
        }
        
        .summary-table {
            margin-top: 30px;
        }
        
        .summary-table thead {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .client-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(102, 126, 234, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 700;
            color: #667eea;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 15px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .info-value:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .totals {
            display: flex;
            justify-content: flex-end;
            gap: 25px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .total-item {
            text-align: right;
            padding: 20px 25px;
            background: rgba(102, 126, 234, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            min-width: 220px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .total-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #667eea, #764ba2);
        }
        
        .total-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
            background: rgba(102, 126, 234, 0.12);
        }
        
        .total-label {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .total-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #2d3748;
            border-radius: 20px;
            font-size: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        .developer {
            font-weight: 700;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .date-time-separated {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .date-cell {
            font-weight: 600;
            color: #667eea;
        }
        
        .time-cell {
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }
        
        .total-client-row {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.15), rgba(102, 126, 234, 0.08)) !important;
            font-weight: bold;
            border-top: 3px solid #667eea !important;
        }
        
        .total-client-row td {
            padding-top: 18px;
            padding-bottom: 18px;
            font-weight: bold;
            color: #667eea;
            font-size: 15px;
        }
        
        .summary-totals {
            background: linear-gradient(90deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.08)) !important;
            font-weight: bold;
            border-top: 3px solid #11998e !important;
        }
        
        .summary-totals td {
            padding-top: 18px;
            padding-bottom: 18px;
            font-weight: bold;
            color: #11998e;
            font-size: 15px;
        }
        
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body {
                background-color: white !important;
                font-size: 11pt;
                line-height: 1.3;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body::before {
                display: none !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            header, footer, .input-section, .button-group, .btn {
                display: none !important;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
            }
            
            .content-wrapper {
                flex-direction: column;
                gap: 0;
                margin-bottom: 0;
            }
            
            .output-section {
                min-width: 100% !important;
                width: 100% !important;
            }
            
            .card {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                page-break-inside: avoid;
                background: white !important;
                border: none !important;
            }
            
            .card::before {
                display: none !important;
            }
            
            .card-title {
                color: #000 !important;
                font-size: 16pt !important;
                border-bottom: 2px solid #000 !important;
                margin-bottom: 15px !important;
            }
            
            .table-container {
                overflow: visible !important;
                border: 1px solid #000 !important;
                border-radius: 0 !important;
                margin-top: 10px !important;
                background: white !important;
                box-shadow: none !important;
            }
            
            table {
                min-width: 100% !important;
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: auto;
            }
            
            th, td {
                border: 1px solid #000 !important;
                padding: 6px 4px !important;
                font-size: 10pt !important;
            }
            
            thead {
                background-color: #fff !important;
                color: #000 !important;
            }
            
            th {
                background-color: #f2f2f2 !important;
                font-weight: bold !important;
                border-bottom: 2px solid #000 !important;
            }
            
            .text-right {
                text-align: right !important;
            }
            
            .client-info {
                border: 1px solid #000 !important;
                background: #fff !important;
                margin-bottom: 15px !important;
                padding: 10px !important;
                page-break-inside: avoid;
            }
            
            .info-label {
                color: #000 !important;
                font-size: 10pt !important;
            }
            
            .info-value {
                border: 1px solid #000 !important;
                font-size: 10pt !important;
                background: white !important;
            }
            
            .totals {
                justify-content: space-between;
                margin-top: 15px !important;
                padding-top: 15px !important;
                border-top: 2px solid #000 !important;
                page-break-inside: avoid;
            }
            
            .total-item {
                border: 1px solid #000 !important;
                padding: 6px 10px !important;
                background: white !important;
            }
            
            .total-item::before {
                display: none !important;
            }
            
            .total-label {
                color: #000 !important;
                font-size: 11pt !important;
            }
            
            .total-value {
                color: #000 !important;
                font-size: 12pt !important;
                background: none !important;
                -webkit-text-fill-color: #000 !important;
            }
            
            .summary-table {
                margin-top: 20px !important;
                page-break-inside: avoid;
            }
            
            .summary-table th {
                background-color: #f2f2f2 !important;
                color: #000 !important;
            }
            
            .total-client-row {
                background-color: #f2f2f2 !important;
                border-top: 2px solid #000 !important;
            }
            
            .summary-totals {
                background-color: #f2f2f2 !important;
                border-top: 2px solid #000 !important;
            }
            
            td, th {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            table {
                page-break-inside: auto;
            }
            
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #000;
            }
            
            .print-header h2 {
                font-size: 18pt;
                margin-bottom: 5px;
            }
            
            .print-date {
                font-size: 10pt;
                color: #666;
            }
            
            .print-footer {
                display: block !important;
                text-align: center;
                margin-top: 20px;
                padding-top: 10px;
                border-top: 1px solid #000;
                font-size: 9pt;
                color: #666;
            }
        }
        
        .print-header, .print-footer {
            display: none;
        }
        
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .input-section, .output-section {
                min-width: 100%;
            }
        }

        /* Animações de entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header, .card {
            animation: fadeInUp 0.6s ease-out backwards;
        }

        .card:nth-child(2) {
            animation-delay: 0.1s;
        }

        footer {
            animation: fadeInUp 0.6s ease-out 0.2s backwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="no-print">
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo.png" alt="Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <i class="fas fa-gas-pump logo-placeholder" style="display: none;"></i>
                </div>
                <div>
                    <h1>Sistema de Relatórios - Rede de Postos</h1>
                    <p class="subtitle">Processamento e visualização de dados de consumo por cliente</p>
                </div>
            </div>
        </header>
        
        <div class="content-wrapper">
            <section class="input-section no-print">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-upload"></i> Inserir Dados do Relatório</h2>
                    <p style="margin-bottom: 15px; color: #718096;">Cole os dados do relatório no campo abaixo:</p>
                    <textarea id="dataInput" placeholder="Cole os dados do relatório aqui..."></textarea>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="processBtn">
                            <i class="fas fa-cogs"></i>
                            <span>Processar Dados</span>
                        </button>
                        <button class="btn btn-danger" id="clearBtn">
                            <i class="fas fa-trash"></i>
                            <span>Limpar</span>
                        </button>
                        <button class="btn btn-excel" id="exportFormattedBtn">
                            <i class="fas fa-file-excel"></i>
                            <span>Exportar Formatado</span>
                        </button>
                    </div>
                </div>
            </section>
            
            <section class="output-section">
                <div class="card">
                    <div class="print-header">
                        <h2>Relatório de Consumo por Cliente</h2>
                        <div class="print-date" id="printDate"></div>
                    </div>
                    
                    <h2 class="card-title no-print"><i class="fas fa-table"></i> Relatório Processado</h2>
                    
                    <div class="client-info" id="clientInfo">
                        <!-- Informações do cliente serão inseridas aqui -->
                    </div>
                    
                    <div class="button-group no-print">
                        <button class="btn btn-excel" id="exportFormattedBtn2">
                            <i class="fas fa-file-excel"></i>
                            <span>Exportar Formatado</span>
                        </button>
                        <button class="btn btn-success" id="printBtn">
                            <i class="fas fa-print"></i>
                            <span>Imprimir Relatório</span>
                        </button>
                    </div>
                    
                    <h3 style="margin-top: 30px; color: #667eea; font-weight: 700; font-size: 20px;">Detalhamento das Transações</h3>
                    <div class="table-container">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Hora</th>
                                    <th>Placa</th>
                                    <th>KM</th>
                                    <th>CP / NF</th>
                                    <th>Doc pgto</th>
                                    <th>Descrição</th>
                                    <th class="text-right">Quantidade</th>
                                    <th>Un.</th>
                                    <th class="text-right">Preço unit.</th>
                                    <th class="text-right">Valor</th>
                                    <th class="text-right">Desc.</th>
                                    <th class="text-right">Valor final</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody">
                                <!-- Dados das transações serão inseridos aqui -->
                            </tbody>
                            <tfoot id="transactionsFooter">
                                <!-- Total do cliente será inserido aqui -->
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="totals">
                        <div class="total-item">
                            <div class="total-label">Total Quantidade</div>
                            <div class="total-value" id="totalQuantity">0,00</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Total Valor</div>
                            <div class="total-value" id="totalValue">R$ 0,00</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Total Valor Final</div>
                            <div class="total-value" id="totalFinalValue">R$ 0,00</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 40px; color: #11998e; font-weight: 700; font-size: 20px;">Resumo por Produto</h3>
                    <div class="table-container summary-table">
                        <table id="summaryTable">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th class="text-right">Quantidade</th>
                                    <th class="text-right">Preço unitário</th>
                                    <th class="text-right">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="summaryBody">
                                <!-- Dados do resumo serão inseridos aqui -->
                            </tbody>
                            <tfoot id="summaryFooter">
                                <!-- Totais do resumo serão inseridos aqui -->
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="print-footer">
                        Sistema desenvolvido por Waldeci Ramos &copy; 2025 | Página <span class="page-number"></span>
                    </div>
                </div>
            </section>
        </div>
        
        <footer class="no-print">
            <p>Sistema desenvolvido por <span class="developer">Waldeci Ramos</span> &copy; 2025</p>
        </footer>
    </div>

 <!-- Biblioteca para exportação em Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual para impressão
            const now = new Date();
            const printDate = document.getElementById('printDate');
            printDate.textContent = `Gerado em: ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
            
            // Botão para processar dados
            document.getElementById('processBtn').addEventListener('click', processData);
            
            // Botão para limpar dados
            document.getElementById('clearBtn').addEventListener('click', function() {
                document.getElementById('dataInput').value = '';
                clearOutput();
            });
            
            // Botões para exportar formatado
            document.getElementById('exportFormattedBtn').addEventListener('click', exportToExcelWithFormatting);
            document.getElementById('exportFormattedBtn2').addEventListener('click', exportToExcelWithFormatting);
            
            // Botão para imprimir
            document.getElementById('printBtn').addEventListener('click', function() {
                // Atualizar data da impressão
                const now = new Date();
                document.getElementById('printDate').textContent = `Gerado em: ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
                
                window.print();
            });
        });
        
        function processData() {
            const inputData = document.getElementById('dataInput').value;
            if (!inputData.trim()) {
                alert('Por favor, cole os dados do relatório no campo de entrada.');
                return;
            }
            
            // Limpar saída anterior
            clearOutput();
            
            // Dividir os dados em linhas
            const lines = inputData.split('\n');
            
            // Variáveis para armazenar informações
            let rede = '';
            let empresa = '';
            let cliente = '';
            let periodo = '';
            let cnpj = '';
            let uf = '';
            let municipio = '';
            
            // Arrays para armazenar dados das tabelas
            const transactions = [];
            const summary = [];
            
            // Variáveis para armazenar totais da linha "Total do cliente"
            let totalClienteQuantidade = '0,00';
            let totalClienteValor = '0,00';
            let totalClienteDesc = '0,00';
            let totalClienteValorFinal = '0,00';
            
            // Variáveis para armazenar totais do resumo
            let totalResumoQuantidade = '0,00';
            let totalResumoValor = '0,00';
            
            // Flags para controle de leitura
            let readingTransactions = false;
            let readingSummary = false;
            let foundClientInfo = false;
            let firstLine = true;
            
            // Processar cada linha
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                if (!line) continue;
                
                // Extrair nome da rede (primeira linha)
                if (firstLine) {
                    // Remover data/hora/página do final
                    const padraoData = /\s+\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s+Pág\.:\s+\d+\s+\d+$/;
                    rede = line.replace(padraoData, '').trim();
                    firstLine = false;
                }
                
                // Extrair informações do cabeçalho
                if (line.includes('Empresa:')) {
                    empresa = line.replace('Empresa:', '').trim();
                } else if (line.includes('Cliente:') && !line.includes('CPF/CNPJ')) {
                    cliente = line.replace('Cliente:', '').trim();
                } else if (line.includes('Período:')) {
                    periodo = line.replace('Período:', '').trim();
                } else if (line.includes('CPF/CNPJ:')) {
                    // Esta linha contém várias informações do cliente
                    const clienteMatch = line.match(/Cliente:\s*(.+?)\s*CPF\/CNPJ:/);
                    if (clienteMatch && clienteMatch[1]) {
                        cliente = clienteMatch[1].trim();
                    }
                    
                    const cnpjMatch = line.match(/CPF\/CNPJ:\s*([\d.\/-]+)/);
                    if (cnpjMatch && cnpjMatch[1]) {
                        cnpj = cnpjMatch[1].trim();
                    }
                    
                    const ufMatch = line.match(/UF:\s*([A-Z]{2})/);
                    if (ufMatch && ufMatch[1]) {
                        uf = ufMatch[1].trim();
                    }
                    
                    const municipioMatch = line.match(/Município:\s*(.+)/);
                    if (municipioMatch && municipioMatch[1]) {
                        municipio = municipioMatch[1].trim();
                    }
                    
                    foundClientInfo = true;
                }
                
                // Detectar início da tabela de transações
                if (line.includes('Data/Hora') && line.includes('Placa') && line.includes('KM')) {
                    readingTransactions = true;
                    readingSummary = false;
                    continue;
                }
                
                // Detectar linha "Total do cliente"
                if (line.includes('Total do cliente')) {
                    // Esta linha geralmente tem o formato: | Total do cliente | quantidade | | | valor | desc | valorFinal |
                    const parts = line.split('|').map(p => p.trim()).filter(p => p);
                    
                    if (parts.length >= 7) {
                        // Partes: [0]="Total do cliente", [1]=quantidade, [4]=valor, [5]=desc, [6]=valorFinal
                        totalClienteQuantidade = cleanNumber(parts[1] || '0,00');
                        totalClienteValor = cleanNumber(parts[4] || '0,00');
                        totalClienteDesc = cleanNumber(parts[5] || '0,00');
                        totalClienteValorFinal = cleanNumber(parts[6] || '0,00');
                    } else {
                        // Tentar extrair números da linha diretamente
                        const numeros = line.match(/[\d.,]+/g);
                        if (numeros && numeros.length >= 4) {
                            totalClienteQuantidade = cleanNumber(numeros[0]);
                            totalClienteValor = cleanNumber(numeros[1]);
                            totalClienteDesc = cleanNumber(numeros[2]);
                            totalClienteValorFinal = cleanNumber(numeros[3]);
                        }
                    }
                    
                    readingTransactions = false;
                    continue;
                }
                
                // Detectar início da tabela de resumo
                if (line.includes('Descrição') && line.includes('Quantidade') && line.includes('Preço unitário')) {
                    readingSummary = true;
                    readingTransactions = false;
                    continue;
                }
                
                // Detectar linha "Total" no resumo
                if (readingSummary && line.includes('Total') && !line.includes('Descrição')) {
                    const parts = line.split('|').map(p => p.trim()).filter(p => p);
                    
                    if (parts.length >= 4) {
                        totalResumoQuantidade = cleanNumber(parts[1] || '0,00');
                        totalResumoValor = cleanNumber(parts[3] || '0,00');
                    } else {
                        // Tentar extrair números da linha diretamente
                        const numeros = line.match(/[\d.,]+/g);
                        if (numeros && numeros.length >= 2) {
                            totalResumoQuantidade = cleanNumber(numeros[0]);
                            totalResumoValor = cleanNumber(numeros[1]);
                        }
                    }
                    continue;
                }
                
                // Processar linhas da tabela de transações
                if (readingTransactions && line.includes('|')) {
                    const parts = line.split('|').map(p => p.trim()).filter(p => p);
                    
                    // Verificar se tem o número mínimo de colunas e começa com data
                    if (parts.length >= 11 && parts[0].match(/\d{2}\/\d{2}\/\d{4}/)) {
                        const dataHora = parts[0].split(' ');
                        const data = dataHora[0] || '';
                        const hora = dataHora[1] || '';
                        
                        transactions.push({
                            data: data,
                            hora: hora,
                            placa: parts[1] || '',
                            km: parts[2] || '',
                            cpNf: parts[3] || '',
                            docPgto: parts[4] || '',
                            descricao: parts[5] || '',
                            quantidade: cleanNumber(parts[6] || '0,00'),
                            un: parts[7] || '',
                            precoUnit: cleanNumber(parts[8] || '0,00'),
                            valor: cleanNumber(parts[9] || '0,00'),
                            desc: cleanNumber(parts[10] || '0,00'),
                            valorFinal: cleanNumber(parts[11] || '0,00')
                        });
                    }
                }
                
                // Processar linhas da tabela de resumo
                if (readingSummary && line.includes('|')) {
                    const parts = line.split('|').map(p => p.trim()).filter(p => p);
                    
                    // Verificar se é uma linha de produto (não é cabeçalho nem total)
                    if (parts.length >= 4 && !parts[0].includes('Total') && !parts[0].includes('Descrição') 
                        && parts[0] !== 'Resumo' && !parts[0].includes('+') && parts[0] !== '' 
                        && !parts[0].match(/^-+$/)) {
                        summary.push({
                            descricao: parts[0] || '',
                            quantidade: cleanNumber(parts[1] || '0,00'),
                            precoUnit: cleanNumber(parts[2] || '0,00'),
                            valor: cleanNumber(parts[3] || '0,00')
                        });
                    }
                }
            }
            
            // Exibir informações do cliente
            displayClientInfo(empresa, cliente, periodo, cnpj, uf, municipio, rede);
            
            // Exibir transações
            displayTransactions(transactions, totalClienteQuantidade, totalClienteValor, totalClienteDesc, totalClienteValorFinal);
            
            // Exibir resumo
            displaySummary(summary, totalResumoQuantidade, totalResumoValor);
            
            // Calcular e exibir totais das transações
            calculateTransactionTotals(transactions);
        }
        
        function displayClientInfo(empresa, cliente, periodo, cnpj, uf, municipio, rede) {
            const clientInfoDiv = document.getElementById('clientInfo');
            
            let html = '';
            if (rede) html += `<div class="info-item"><span class="info-label">Rede:</span><span class="info-value">${rede}</span></div>`;
            if (empresa) html += `<div class="info-item"><span class="info-label">Empresa:</span><span class="info-value">${empresa}</span></div>`;
            if (cliente) html += `<div class="info-item"><span class="info-label">Cliente:</span><span class="info-value">${cliente}</span></div>`;
            if (periodo) html += `<div class="info-item"><span class="info-label">Período:</span><span class="info-value">${periodo}</span></div>`;
            if (cnpj) html += `<div class="info-item"><span class="info-label">CNPJ:</span><span class="info-value">${cnpj}</span></div>`;
            if (uf || municipio) {
                const localizacao = (uf && municipio) ? `${uf} - ${municipio}` : (uf || municipio);
                html += `<div class="info-item"><span class="info-label">Localização:</span><span class="info-value">${localizacao}</span></div>`;
            }
            
            clientInfoDiv.innerHTML = html;
        }
        
        function displayTransactions(transactions, totalQuantidade, totalValor, totalDesc, totalValorFinal) {
            const transactionsBody = document.getElementById('transactionsBody');
            const transactionsFooter = document.getElementById('transactionsFooter');
            
            if (transactions.length === 0) {
                transactionsBody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px;">Nenhuma transação encontrada</td></tr>';
                return;
            }
            
            let html = '';
            for (const trans of transactions) {
                html += `
                <tr>
                    <td class="date-cell">${trans.data}</td>
                    <td class="time-cell">${trans.hora}</td>
                    <td>${trans.placa}</td>
                    <td>${trans.km}</td>
                    <td>${trans.cpNf}</td>
                    <td>${trans.docPgto}</td>
                    <td>${trans.descricao}</td>
                    <td class="text-right">${formatNumber(trans.quantidade)}</td>
                    <td>${trans.un}</td>
                    <td class="text-right">${formatCurrency(trans.precoUnit)}</td>
                    <td class="text-right">${formatCurrency(trans.valor)}</td>
                    <td class="text-right">${formatCurrency(trans.desc)}</td>
                    <td class="text-right"><strong>${formatCurrency(trans.valorFinal)}</strong></td>
                </tr>
                `;
            }
            
            transactionsBody.innerHTML = html;
            
            // Verificar se temos totais válidos
            if (totalQuantidade !== '0,00' || totalValor !== 'R$ 0,00' || totalValorFinal !== 'R$ 0,00') {
                let footerHtml = `
                    <tr class="total-client-row">
                        <td colspan="7" style="text-align: right; font-weight: bold;">Total do cliente:</td>
                        <td class="text-right">${formatNumber(totalQuantidade)}</td>
                        <td></td>
                        <td></td>
                        <td class="text-right">${formatCurrency(totalValor)}</td>
                        <td class="text-right">${formatCurrency(totalDesc)}</td>
                        <td class="text-right"><strong>${formatCurrency(totalValorFinal)}</strong></td>
                    </tr>
                `;
                transactionsFooter.innerHTML = footerHtml;
            }
        }
        
        function displaySummary(summary, totalQuantidade, totalValor) {
            const summaryBody = document.getElementById('summaryBody');
            const summaryFooter = document.getElementById('summaryFooter');
            
            if (summary.length === 0) {
                summaryBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum item no resumo</td></tr>';
                return;
            }
            
            let html = '';
            for (const item of summary) {
                html += `
                <tr>
                    <td>${item.descricao}</td>
                    <td class="text-right">${formatNumber(item.quantidade)}</td>
                    <td class="text-right">${formatCurrency(item.precoUnit)}</td>
                    <td class="text-right"><strong>${formatCurrency(item.valor)}</strong></td>
                </tr>
                `;
            }
            
            summaryBody.innerHTML = html;
            
            // Verificar se temos totais válidos
            if (totalQuantidade !== '0,00' || totalValor !== 'R$ 0,00') {
                let footerHtml = `
                    <tr class="summary-totals">
                        <td style="text-align: right; font-weight: bold;">Total Resumo:</td>
                        <td class="text-right">${formatNumber(totalQuantidade)}</td>
                        <td></td>
                        <td class="text-right"><strong>${formatCurrency(totalValor)}</strong></td>
                    </tr>
                `;
                summaryFooter.innerHTML = footerHtml;
            }
        }
        
        function calculateTransactionTotals(transactions) {
            let totalQuantity = 0;
            let totalValue = 0;
            let totalFinalValue = 0;
            
            // Calcular somatórios das transações
            for (const trans of transactions) {
                totalQuantity += parseBrazilianNumber(trans.quantidade);
                totalValue += parseBrazilianNumber(trans.valor);
                totalFinalValue += parseBrazilianNumber(trans.valorFinal);
            }
            
            // Formatar e exibir os totais
            document.getElementById('totalQuantity').textContent = formatNumber(totalQuantity);
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalFinalValue').textContent = formatCurrency(totalFinalValue);
        }
        
        function clearOutput() {
            document.getElementById('clientInfo').innerHTML = '';
            document.getElementById('transactionsBody').innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px;">Os dados processados aparecerão aqui</td></tr>';
            document.getElementById('transactionsFooter').innerHTML = '';
            document.getElementById('summaryBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">O resumo aparecerá aqui</td></tr>';
            document.getElementById('summaryFooter').innerHTML = '';
            document.getElementById('totalQuantity').textContent = '0,00';
            document.getElementById('totalValue').textContent = 'R$ 0,00';
            document.getElementById('totalFinalValue').textContent = 'R$ 0,00';
        }
        
        function cleanNumber(numStr) {
            if (!numStr || numStr.trim() === '') return '0,00';
            
            let cleaned = numStr.toString().trim();
            
            // Remover espaços
            cleaned = cleaned.replace(/\s/g, '');
            
            // Se já está no formato brasileiro com vírgula decimal
            if (cleaned.includes(',')) {
                // Remover pontos de milhar se existirem
                if (cleaned.includes('.')) {
                    // Formato: 1.230,18 -> remover pontos
                    cleaned = cleaned.replace(/\./g, '');
                }
                
                // Garantir duas casas decimais
                const parts = cleaned.split(',');
                if (parts.length === 2) {
                    let intPart = parts[0];
                    let decPart = parts[1];
                    
                    // Se parte decimal tem apenas 1 dígito, adicionar zero
                    if (decPart.length === 1) {
                        decPart += '0';
                    }
                    
                    return intPart + ',' + decPart;
                }
                
                return cleaned;
            }
            
            // Se não tem vírgula, assumir que é número inteiro
            return cleaned + ',00';
        }
        
        function parseBrazilianNumber(numStr) {
            if (!numStr || numStr.trim() === '') return 0;
            
            // Se já for número, retornar
            if (typeof numStr === 'number') return numStr;
            
            let str = numStr.toString().trim();
            
            // Remover R$ se existir
            str = str.replace('R$', '').trim();
            
            // Remover pontos de milhar e converter vírgula para ponto
            str = str.replace(/\./g, '').replace(',', '.');
            
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }
        
        function formatNumber(num) {
            if (typeof num === 'string') {
                num = parseBrazilianNumber(num);
            }
            
            if (isNaN(num) || num === 0) return '0,00';
            
            // Formatar com 2 casas decimais e vírgula
            return num.toFixed(2).replace('.', ',');
        }
        
        function formatCurrency(value) {
            if (typeof value === 'string') {
                value = parseBrazilianNumber(value);
            }
            
            if (isNaN(value) || value === 0) return 'R$ 0,00';
            
            // Formatar com separadores de milhar
            const formatted = value.toFixed(2).replace('.', ',');
            const parts = formatted.split(',');
            
            // Adicionar separadores de milhar à parte inteira
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            return 'R$ ' + parts.join(',');
        }
        
      function exportToExcelWithFormatting() {
    // Verificar se há dados processados
    const clientInfoDiv = document.getElementById('clientInfo');
    const infoItems = clientInfoDiv.querySelectorAll('.info-item');
    
    if (infoItems.length === 0) {
        alert('Por favor, processe os dados primeiro antes de exportar.');
        return;
    }
    
    // Criar um workbook do Excel
    const wb = XLSX.utils.book_new();
    
    // Dados para a planilha
    const excelData = [];
    
    // 1. Cabeçalho
    const now = new Date();
    excelData.push(["RELATÓRIO DE CONSUMO POR CLIENTE"]);
    excelData.push([`Gerado em: ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`]);
    excelData.push([]);
    
    // 2. Informações do cliente
    excelData.push(["INFORMAÇÕES DO CLIENTE"]);
    excelData.push([]);
    
    infoItems.forEach(item => {
        const label = item.querySelector('.info-label').textContent;
        const value = item.querySelector('.info-value').textContent;
        excelData.push([label, value]);
    });
    
    excelData.push([]);
    excelData.push([]);
    
    // 3. Tabela de transações - cabeçalho
    excelData.push(["DETALHAMENTO DAS TRANSAÇÕES"]);
    excelData.push([]);
    
    const transactionHeaders = ['Data', 'Hora', 'Placa', 'KM', 'CP/NF', 'Doc pgto', 'Descrição', 'Quantidade', 'Un.', 'Preço unit.', 'Valor', 'Desc.', 'Valor final'];
    excelData.push(transactionHeaders);
    
    // 4. Dados das transações - converter valores numéricos para números
    const transactionRows = document.querySelectorAll('#transactionsBody tr');
    transactionRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            let rowData = [];
            cells.forEach((cell, index) => {
                let cellText = cell.textContent.trim();
                
                // Converter colunas numéricas para números (sem aspas)
                if (index === 7 || index === 9 || index === 10 || index === 11 || index === 12) {
                    // Remover formatação de moeda e converter para número
                    if (cellText.includes('R$')) {
                        cellText = cellText.replace('R$', '').trim();
                    }
                    
                    // Converter formato brasileiro para número
                    const numValue = parseBrazilianNumber(cellText);
                    if (!isNaN(numValue)) {
                        rowData.push(numValue);
                    } else {
                        rowData.push(cellText);
                    }
                } else {
                    rowData.push(cellText);
                }
            });
            excelData.push(rowData);
        }
    });
    
    // 5. Total do cliente - também converter valores numéricos
    const totalRow = document.querySelector('#transactionsFooter tr');
    if (totalRow) {
        let totalData = [];
        const cells = totalRow.querySelectorAll('td');
        cells.forEach((cell, index) => {
            let cellText = cell.textContent.trim();
            
            // As colunas 7, 10, 11, 12 são numéricas (ajustado para considerar colspan)
            // Como temos 13 colunas totais, precisamos mapear corretamente
            if (index >= 7) {
                // Converter para números as colunas de valores
                if (cellText.includes('R$')) {
                    cellText = cellText.replace('R$', '').trim();
                }
                
                const numValue = parseBrazilianNumber(cellText);
                if (!isNaN(numValue)) {
                    totalData.push(numValue);
                } else {
                    totalData.push(cellText);
                }
            } else {
                totalData.push(cellText);
            }
        });
        excelData.push(totalData);
    }
    
    excelData.push([]);
    excelData.push([]);
    
    // 6. Totais gerais - converter para números
    excelData.push(["TOTAIS DAS TRANSAÇÕES"]);
    excelData.push([]);
    
    const totalQuantity = parseBrazilianNumber(document.getElementById('totalQuantity').textContent);
    const totalValue = parseBrazilianNumber(document.getElementById('totalValue').textContent.replace('R$', '').trim());
    const totalFinalValue = parseBrazilianNumber(document.getElementById('totalFinalValue').textContent.replace('R$', '').trim());
    
    excelData.push(['Total Quantidade:', totalQuantity]);
    excelData.push(['Total Valor:', totalValue]);
    excelData.push(['Total Valor Final:', totalFinalValue]);
    
    excelData.push([]);
    excelData.push([]);
    
    // 7. Resumo por produto
    excelData.push(["RESUMO POR PRODUTO"]);
    excelData.push([]);
    
    const summaryHeaders = ['Descrição', 'Quantidade', 'Preço unitário', 'Valor'];
    excelData.push(summaryHeaders);
    
    const summaryRows = document.querySelectorAll('#summaryBody tr');
    summaryRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            let rowData = [];
            cells.forEach((cell, index) => {
                let cellText = cell.textContent.trim();
                
                // Converter colunas numéricas (índices 1, 2, 3)
                if (index === 1 || index === 2 || index === 3) {
                    if (cellText.includes('R$')) {
                        cellText = cellText.replace('R$', '').trim();
                    }
                    
                    const numValue = parseBrazilianNumber(cellText);
                    if (!isNaN(numValue)) {
                        rowData.push(numValue);
                    } else {
                        rowData.push(cellText);
                    }
                } else {
                    rowData.push(cellText);
                }
            });
            excelData.push(rowData);
        }
    });
    
    // 8. Total do resumo
    const summaryTotalRow = document.querySelector('#summaryFooter tr');
    if (summaryTotalRow) {
        let totalData = [];
        const cells = summaryTotalRow.querySelectorAll('td');
        cells.forEach((cell, index) => {
            let cellText = cell.textContent.trim();
            
            // Converter valores numéricos (colunas 1 e 3)
            if (index === 1 || index === 3) {
                if (cellText.includes('R$')) {
                    cellText = cellText.replace('R$', '').trim();
                }
                
                const numValue = parseBrazilianNumber(cellText);
                if (!isNaN(numValue)) {
                    totalData.push(numValue);
                } else {
                    totalData.push(cellText);
                }
            } else {
                totalData.push(cellText);
            }
        });
        excelData.push(totalData);
    }
    
    excelData.push([]);
    excelData.push([]);
    
    // 9. Rodapé
    excelData.push(["Sistema desenvolvido por Waldeci Ramos © 2025"]);
    
    // Criar worksheet
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Definir larguras de coluna
    const colWidths = [
        { wch: 10 },  // Data
        { wch: 8 },   // Hora
        { wch: 10 },  // Placa
        { wch: 10 },  // KM
        { wch: 10 },  // CP/NF
        { wch: 10 },  // Doc pgto
        { wch: 25 },  // Descrição
        { wch: 12 },  // Quantidade
        { wch: 6 },   // Un.
        { wch: 12 },  // Preço unit.
        { wch: 12 },  // Valor
        { wch: 10 },  // Desc.
        { wch: 15 }   // Valor final
    ];
    
    ws['!cols'] = colWidths;
    
    // Adicionar merges para formatação
    const merges = [
        // Título principal
        { s: { r: 0, c: 0 }, e: { r: 0, c: 12 } },
        // Data de geração
        { s: { r: 1, c: 0 }, e: { r: 1, c: 12 } },
        // Informações do cliente
        { s: { r: 3, c: 0 }, e: { r: 3, c: 12 } },
        // Tabela de transações
        { s: { r: infoItems.length + 7, c: 0 }, e: { r: infoItems.length + 7, c: 12 } },
        // Totais das transações
        { s: { r: infoItems.length + transactionRows.length + 11, c: 0 }, e: { r: infoItems.length + transactionRows.length + 11, c: 12 } },
        // Tabela de resumo
        { s: { r: infoItems.length + transactionRows.length + 19, c: 0 }, e: { r: infoItems.length + transactionRows.length + 19, c: 3 } },
        // Rodapé
        { s: { r: excelData.length - 1, c: 0 }, e: { r: excelData.length - 1, c: 12 } }
    ];
    
    ws['!merges'] = merges;
    
    // Adicionar formatação numérica para as colunas de valores
    // Para isso, precisamos percorrer as células e definir o tipo correto
    
    // Primeiro, vamos definir o intervalo de células
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    // Formatar colunas numéricas da tabela de transações
    const transactionStartRow = infoItems.length + 9; // Linha onde começam os dados de transação
    for (let row = transactionStartRow; row <= range.e.r; row++) {
        // Colunas numéricas: 7 (Quantidade), 9 (Preço unit), 10 (Valor), 11 (Desc), 12 (Valor final)
        const numericCols = [7, 9, 10, 11, 12];
        
        numericCols.forEach(col => {
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
            if (ws[cellAddress] && typeof ws[cellAddress].v === 'number') {
                // Formatar números para exibir com 2 casas decimais
                ws[cellAddress].z = '#,##0.00';
            }
        });
    }
    
    // Formatar totais das transações
    const totalRowIndex = transactionStartRow + transactionRows.length;
    if (totalRow) {
        [7, 10, 11, 12].forEach(col => {
            const cellAddress = XLSX.utils.encode_cell({ r: totalRowIndex, c: col });
            if (ws[cellAddress] && typeof ws[cellAddress].v === 'number') {
                ws[cellAddress].z = '#,##0.00';
            }
        });
    }
    
    // Formatar colunas da tabela de resumo
    const summaryStartRow = infoItems.length + transactionRows.length + 21;
    for (let row = summaryStartRow; row <= range.e.r; row++) {
        // Colunas numéricas: 1 (Quantidade), 2 (Preço unit), 3 (Valor)
        const numericCols = [1, 2, 3];
        
        numericCols.forEach(col => {
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
            if (ws[cellAddress] && typeof ws[cellAddress].v === 'number') {
                // Para preços unitários e valores, usar formato de moeda
                if (col === 2 || col === 3) {
                    ws[cellAddress].z = '"R$"#,##0.00';
                } else {
                    // Para quantidades
                    ws[cellAddress].z = '#,##0.00';
                }
            }
        });
    }
    
    // Adicionar worksheet ao workbook
    XLSX.utils.book_append_sheet(wb, ws, "Relatório Completo");
    
    // Gerar arquivo Excel
    XLSX.writeFile(wb, `relatorio_formatado_${new Date().getTime()}.xlsx`);
}



        // Função alternativa para exportar com formatação HTML (preserva cores e formatação)
        function exportToExcelWithHTMLFormatting() {
            // Verificar se há dados processados
            const clientInfoDiv = document.getElementById('clientInfo');
            const infoItems = clientInfoDiv.querySelectorAll('.info-item');
            
            if (infoItems.length === 0) {
                alert('Por favor, processe os dados primeiro antes de exportar.');
                return;
            }
            
            // Criar um clone do conteúdo para exportação
            const exportContainer = document.createElement('div');
            exportContainer.style.width = '210mm';
            exportContainer.style.padding = '20px';
            exportContainer.style.fontFamily = 'Arial, sans-serif';
            
            // Adicionar cabeçalho
            const now = new Date();
            const header = document.createElement('div');
            header.innerHTML = `
                <h2 style="text-align: center; color: #2a5298; margin-bottom: 10px;">RELATÓRIO DE CONSUMO POR CLIENTE</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Gerado em: ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                </p>
            `;
            exportContainer.appendChild(header);
            
            // Adicionar informações do cliente
            const clientInfoExport = document.createElement('div');
            clientInfoExport.innerHTML = `
                <h3 style="color: #2a5298; margin-bottom: 10px; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">INFORMAÇÕES DO CLIENTE</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
            `;
            
            infoItems.forEach(item => {
                const label = item.querySelector('.info-label').textContent;
                const value = item.querySelector('.info-value').textContent;
                clientInfoExport.innerHTML += `
                    <div style="margin-bottom: 8px;">
                        <div style="font-weight: bold; color: #2a5298; font-size: 12px;">${label}</div>
                        <div style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">${value}</div>
                    </div>
                `;
            });
            
            clientInfoExport.innerHTML += '</div>';
            exportContainer.appendChild(clientInfoExport);
            
            // Adicionar tabela de transações
            const transactionsTable = document.getElementById('transactionsTable').cloneNode(true);
            transactionsTable.style.width = '100%';
            transactionsTable.style.borderCollapse = 'collapse';
            transactionsTable.style.marginTop = '20px';
            transactionsTable.style.marginBottom = '30px';
            
            // Aplicar estilos à tabela clonada
            const thElements = transactionsTable.querySelectorAll('th');
            thElements.forEach(th => {
                th.style.backgroundColor = '#2a5298';
                th.style.color = 'white';
                th.style.padding = '8px';
                th.style.border = '1px solid #ddd';
                th.style.textAlign = 'left';
            });
            
            const tdElements = transactionsTable.querySelectorAll('td');
            tdElements.forEach((td, index) => {
                td.style.padding = '6px';
                td.style.border = '1px solid #ddd';
                td.style.fontSize = '12px';
                
                // Aplicar cor de fundo alternada
                const rowIndex = Math.floor(index / 13); // 13 colunas por linha
                if (rowIndex % 2 === 1) {
                    td.style.backgroundColor = '#f9f9f9';
                }
            });
            
            // Estilizar a linha de total
            const totalRow = transactionsTable.querySelector('.total-client-row');
            if (totalRow) {
                const totalCells = totalRow.querySelectorAll('td');
                totalCells.forEach(td => {
                    td.style.backgroundColor = '#e8f4ff';
                    td.style.fontWeight = 'bold';
                    td.style.color = '#2a5298';
                    td.style.borderTop = '3px solid #2a5298';
                });
            }
            
            exportContainer.appendChild(transactionsTable);
            
            // Adicionar totais
            const totalsDiv = document.createElement('div');
            totalsDiv.innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eaeaea;">
                    <div style="text-align: right; padding: 10px 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; min-width: 180px;">
                        <div style="font-weight: bold; color: #2a5298; font-size: 14px; margin-bottom: 5px;">Total Quantidade</div>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745;">${document.getElementById('totalQuantity').textContent}</div>
                    </div>
                    <div style="text-align: right; padding: 10px 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; min-width: 180px;">
                        <div style="font-weight: bold; color: #2a5298; font-size: 14px; margin-bottom: 5px;">Total Valor</div>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745;">${document.getElementById('totalValue').textContent}</div>
                    </div>
                    <div style="text-align: right; padding: 10px 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; min-width: 180px;">
                        <div style="font-weight: bold; color: #2a5298; font-size: 14px; margin-bottom: 5px;">Total Valor Final</div>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745;">${document.getElementById('totalFinalValue').textContent}</div>
                    </div>
                </div>
            `;
            exportContainer.appendChild(totalsDiv);
            
            // Adicionar resumo
            const summaryTable = document.getElementById('summaryTable').cloneNode(true);
            summaryTable.style.width = '100%';
            summaryTable.style.borderCollapse = 'collapse';
            summaryTable.style.marginTop = '40px';
            
            // Aplicar estilos à tabela de resumo
            const summaryThElements = summaryTable.querySelectorAll('th');
            summaryThElements.forEach(th => {
                th.style.backgroundColor = '#28a745';
                th.style.color = 'white';
                th.style.padding = '8px';
                th.style.border = '1px solid #ddd';
                th.style.textAlign = 'left';
            });
            
            const summaryTdElements = summaryTable.querySelectorAll('td');
            summaryTdElements.forEach((td, index) => {
                td.style.padding = '6px';
                td.style.border = '1px solid #ddd';
                td.style.fontSize = '12px';
                
                // Aplicar cor de fundo alternada
                const rowIndex = Math.floor(index / 4); // 4 colunas por linha
                if (rowIndex % 2 === 1) {
                    td.style.backgroundColor = '#f9f9f9';
                }
            });
            
            // Estilizar a linha de total do resumo
            const summaryTotalRow = summaryTable.querySelector('.summary-totals');
            if (summaryTotalRow) {
                const totalCells = summaryTotalRow.querySelectorAll('td');
                totalCells.forEach(td => {
                    td.style.backgroundColor = '#e8f4ff';
                    td.style.fontWeight = 'bold';
                    td.style.color = '#28a745';
                    td.style.borderTop = '3px solid #28a745';
                });
            }
            
            exportContainer.appendChild(document.createElement('h3').textContent = 'RESUMO POR PRODUTO');
            exportContainer.appendChild(summaryTable);
            
            // Adicionar rodapé
            const footer = document.createElement('div');
            footer.innerHTML = `
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
                    Sistema desenvolvido por Waldeci Ramos &copy; 2025
                </div>
            `;
            exportContainer.appendChild(footer);
            
            // Converter HTML para Excel
            const htmlContent = exportContainer.outerHTML;
            const blob = new Blob([`
                <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                      xmlns:x="urn:schemas-microsoft-com:office:excel" 
                      xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <!--[if gte mso 9]>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Relatório Completo</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <![endif]-->
                </head>
                <body>
                    ${htmlContent}
                </body>
                </html>
            `], { type: 'application/vnd.ms-excel' });
            
            // Criar link de download
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_completo_${new Date().getTime()}.xls`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

