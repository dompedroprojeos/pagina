<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedrinho - Sistema de Rotinas</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1a2b4a;
    --accent: #f97316;
    --accent2: #0ea5e9;
    --accent3: #10b981;
    --danger: #ef4444;
    --warn: #f59e0b;
    --bg: #0f172a;
    --card: #1e293b;
    --card2: #263352;
    --border: #334155;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --success: #22c55e;
    --header-h: 70px;
    --footer-h: 45px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Sora',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }

  /* HEADER */
  header {
    height:var(--header-h); background:linear-gradient(135deg,#1a2b4a 0%,#0c1a36 100%);
    border-bottom:2px solid var(--accent); display:flex; align-items:center;
    justify-content:space-between; padding:0 28px; position:sticky; top:0; z-index:100;
    box-shadow:0 4px 30px rgba(0,0,0,0.5);
  }
  .logo { display:flex; align-items:center; gap:12px; }
  .logo-icon {
    width:44px; height:44px; background:linear-gradient(135deg,var(--accent),#fb923c);
    border-radius:12px; display:flex; align-items:center; justify-content:center;
    font-size:22px; font-weight:800; color:#fff; box-shadow:0 0 20px rgba(249,115,22,0.4);
  }
  .logo-text { font-size:22px; font-weight:800; letter-spacing:-0.5px; }
  .logo-text span { color:var(--accent); }
  .header-right { display:flex; align-items:center; gap:16px; }
  #clock { font-family:'JetBrains Mono',monospace; font-size:13px; color:var(--accent2);
    background:rgba(14,165,233,0.1); padding:6px 12px; border-radius:8px; border:1px solid rgba(14,165,233,0.2); }
  #greeting-badge { font-size:12px; color:var(--accent3); background:rgba(16,185,129,0.1);
    padding:6px 12px; border-radius:8px; border:1px solid rgba(16,185,129,0.2); font-weight:500; }
  .header-btn { background:rgba(249,115,22,0.15); border:1px solid rgba(249,115,22,0.3);
    color:var(--accent); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:12px;
    font-family:'Sora',sans-serif; font-weight:600; transition:all .2s; }
  .header-btn:hover { background:var(--accent); color:#fff; }

  /* MAIN LAYOUT */
  main { flex:1; display:grid; grid-template-columns:320px 1fr; gap:0; overflow:hidden; }
  
  /* SIDEBAR */
  .sidebar { background:var(--card); border-right:1px solid var(--border); display:flex;
    flex-direction:column; overflow-y:auto; height:calc(100vh - var(--header-h) - var(--footer-h)); }
  .sidebar-section { padding:18px; border-bottom:1px solid var(--border); }
  .sidebar-title { font-size:11px; text-transform:uppercase; letter-spacing:1.5px;
    color:var(--muted); font-weight:600; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
  .sidebar-title::after { content:''; flex:1; height:1px; background:var(--border); }

  /* MINI CALENDAR */
  .mini-cal-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .mini-cal-nav button { background:none; border:none; color:var(--muted); cursor:pointer; font-size:18px; padding:2px 8px; border-radius:6px; transition:all .2s; }
  .mini-cal-nav button:hover { background:var(--card2); color:var(--text); }
  .mini-cal-month { font-weight:700; font-size:14px; }
  .mini-cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
  .mini-cal-day-header { text-align:center; font-size:10px; color:var(--muted); padding:4px 0; font-weight:600; }
  .mini-cal-day { text-align:center; padding:5px 2px; border-radius:6px; cursor:pointer;
    font-size:12px; transition:all .2s; position:relative; }
  .mini-cal-day:hover { background:var(--card2); }
  .mini-cal-day.today { background:var(--accent); color:#fff; font-weight:700; }
  .mini-cal-day.selected { background:var(--accent2); color:#fff; font-weight:700; }
  .mini-cal-day.has-task::after { content:''; position:absolute; bottom:2px; left:50%;
    transform:translateX(-50%); width:4px; height:4px; background:var(--accent3); border-radius:50%; }
  .mini-cal-day.has-pending::after { background:var(--danger); }
  .mini-cal-day.other-month { color:var(--border); }

  /* ALERTS */
  .alert-card { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3);
    border-radius:10px; padding:12px; margin-bottom:8px; cursor:pointer; transition:all .2s; }
  .alert-card:hover { background:rgba(239,68,68,0.15); }
  .alert-card .alert-title { font-size:12px; font-weight:600; color:#fca5a5; margin-bottom:4px; }
  .alert-card .alert-info { font-size:11px; color:var(--muted); }
  .alert-badge { background:var(--danger); color:#fff; border-radius:50%; width:20px; height:20px;
    display:inline-flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; }

  /* STATS */
  .stats-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
  .stat-box { background:var(--card2); border-radius:10px; padding:10px; text-align:center; }
  .stat-box .num { font-size:22px; font-weight:800; }
  .stat-box .lbl { font-size:10px; color:var(--muted); margin-top:2px; }
  .stat-box.open .num { color:var(--warn); }
  .stat-box.done .num { color:var(--accent3); }
  .stat-box.email .num { color:var(--accent2); }

  /* CONTENT AREA */
  .content { display:flex; flex-direction:column; overflow:hidden; }
  .content-tabs { display:flex; gap:0; border-bottom:2px solid var(--border); background:var(--card); }
  .tab { padding:14px 22px; cursor:pointer; font-size:13px; font-weight:600; color:var(--muted);
    border-bottom:2px solid transparent; margin-bottom:-2px; transition:all .2s; user-select:none; }
  .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
  .tab:hover { color:var(--text); }

  .tab-content { display:none; flex:1; overflow-y:auto; padding:24px; }
  .tab-content.active { display:block; }

  /* CALENDAR VIEW */
  .cal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .cal-header h2 { font-size:20px; font-weight:700; }
  .cal-nav { display:flex; gap:8px; align-items:center; }
  .cal-nav button { background:var(--card); border:1px solid var(--border); color:var(--text);
    padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:all .2s; }
  .cal-nav button:hover { background:var(--card2); border-color:var(--accent); }
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:var(--border); border-radius:12px; overflow:hidden; }
  .cal-day-header { background:var(--card); padding:10px 8px; text-align:center; font-size:11px;
    font-weight:700; text-transform:uppercase; letter-spacing:1px; }
  .cal-day-header:nth-child(1) { color:#ef4444; } /* seg */
  .cal-day-header:nth-child(2) { color:#3b82f6; }
  .cal-day-header:nth-child(3) { color:#8b5cf6; }
  .cal-day-header:nth-child(4) { color:#f97316; }
  .cal-day-header:nth-child(5) { color:#10b981; }
  .cal-day-header:nth-child(6) { color:#64748b; }
  .cal-day-header:nth-child(7) { color:#64748b; }
  
  .cal-cell { background:var(--card); min-height:100px; padding:8px; cursor:pointer;
    transition:all .2s; position:relative; }
  .cal-cell:hover { background:var(--card2); }
  .cal-cell.today { background:rgba(249,115,22,0.08); border:1px solid rgba(249,115,22,0.3); }
  .cal-cell.other-month { opacity:.4; }
  .cal-cell.selected { background:rgba(14,165,233,0.1); border:1px solid rgba(14,165,233,0.4); }
  .cal-day-num { font-size:13px; font-weight:700; margin-bottom:6px; }
  .cal-cell.today .cal-day-num { color:var(--accent); }
  .cal-task-chip { border-radius:5px; padding:2px 6px; font-size:10px; font-weight:600;
    margin-bottom:2px; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .chip-open { background:rgba(239,68,68,0.2); color:#fca5a5; border-left:2px solid #ef4444; }
  .chip-done { background:rgba(34,197,94,0.15); color:#86efac; border-left:2px solid #22c55e; }
  .chip-email { background:rgba(14,165,233,0.15); color:#7dd3fc; border-left:2px solid #0ea5e9; }
  .more-badge { font-size:10px; color:var(--muted); padding:2px 6px; }

  /* TASK LIST */
  .task-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .task-header h3 { font-size:16px; font-weight:700; }
  .btn-primary { background:linear-gradient(135deg,var(--accent),#fb923c); color:#fff;
    border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-size:13px;
    font-family:'Sora',sans-serif; font-weight:600; transition:all .2s; box-shadow:0 4px 15px rgba(249,115,22,0.3); }
  .btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(249,115,22,0.4); }
  .btn-secondary { background:var(--card); border:1px solid var(--border); color:var(--text);
    padding:8px 16px; border-radius:8px; cursor:pointer; font-size:12px; font-family:'Sora',sans-serif;
    font-weight:600; transition:all .2s; }
  .btn-secondary:hover { background:var(--card2); border-color:var(--accent2); }

  .task-card { background:var(--card); border:1px solid var(--border); border-radius:12px;
    padding:16px; margin-bottom:10px; transition:all .2s; position:relative; overflow:hidden; }
  .task-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; }
  .task-card.open::before { background:var(--danger); }
  .task-card.done::before { background:var(--accent3); }
  .task-card.email-type::before { background:var(--accent2); }
  .task-card:hover { border-color:var(--accent2); transform:translateX(2px); }
  .task-row { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .task-info { flex:1; }
  .task-title { font-weight:600; font-size:14px; margin-bottom:4px; }
  .task-meta { display:flex; flex-wrap:wrap; gap:8px; font-size:11px; color:var(--muted); }
  .task-tag { background:var(--card2); padding:2px 8px; border-radius:20px; font-size:10px; font-weight:600; }
  .tag-open { color:var(--danger); border:1px solid rgba(239,68,68,0.3); }
  .tag-done { color:var(--accent3); border:1px solid rgba(34,197,94,0.3); }
  .tag-email { color:var(--accent2); border:1px solid rgba(14,165,233,0.3); }
  .task-actions { display:flex; gap:6px; flex-shrink:0; }
  .icon-btn { background:var(--card2); border:1px solid var(--border); color:var(--muted);
    width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; font-size:14px; transition:all .2s; border:none; }
  .icon-btn:hover { background:var(--card); color:var(--text); }
  .icon-btn.close-btn:hover { background:rgba(34,197,94,0.2); color:var(--accent3); }
  .icon-btn.del-btn:hover { background:rgba(239,68,68,0.2); color:var(--danger); }
  .icon-btn.email-btn:hover { background:rgba(14,165,233,0.2); color:var(--accent2); }
  .email-link { color:var(--accent2); text-decoration:none; font-size:12px; }
  .email-link:hover { text-decoration:underline; }

  /* EMAIL COMPOSE */
  .compose-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; }
  .form-row { margin-bottom:16px; }
  .form-label { font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px; display:block; }
  .form-input { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text);
    padding:10px 14px; border-radius:8px; font-family:'Sora',sans-serif; font-size:13px; transition:all .2s; }
  .form-input:focus { outline:none; border-color:var(--accent2); box-shadow:0 0 0 3px rgba(14,165,233,0.1); }
  .form-textarea { min-height:140px; resize:vertical; }
  .form-select { appearance:none; cursor:pointer; }
  .compose-actions { display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  .greeting-btns { display:flex; gap:8px; margin-bottom:8px; }
  .greeting-btn { background:var(--card2); border:1px solid var(--border); color:var(--muted);
    padding:5px 12px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:600;
    transition:all .2s; font-family:'Sora',sans-serif; }
  .greeting-btn:hover { border-color:var(--accent); color:var(--accent); }
  .greeting-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }

  /* MODALS */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000;
    display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:28px; width:90%; max-width:560px; max-height:85vh; overflow-y:auto;
    box-shadow:0 25px 80px rgba(0,0,0,0.6); animation:slideUp .3s ease; }
  @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; }
  .modal-title { font-size:18px; font-weight:700; }
  .modal-close { background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer;
    width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:8px; transition:all .2s; }
  .modal-close:hover { background:var(--card2); color:var(--text); }

  /* REPORT */
  .report-section { background:var(--bg); border-radius:10px; padding:16px; margin-bottom:14px; }
  .report-section h4 { font-size:12px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:12px; }
  .report-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; }
  .report-item:last-child { border-bottom:none; }

  /* BACKUP */
  .backup-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; }
  .backup-btns { display:flex; gap:10px; flex-wrap:wrap; }
  .backup-info { background:var(--bg); border-radius:8px; padding:12px; font-size:12px; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:14px; }

  /* TOAST */
  #toast { position:fixed; bottom:60px; right:20px; background:var(--card); border:1px solid var(--border);
    border-radius:10px; padding:12px 18px; font-size:13px; font-weight:500; z-index:9999;
    display:none; box-shadow:0 8px 30px rgba(0,0,0,0.4); max-width:300px; }
  #toast.show { display:flex; gap:10px; align-items:center; animation:slideUp .3s ease; }
  #toast.success { border-left:3px solid var(--accent3); }
  #toast.error { border-left:3px solid var(--danger); }
  #toast.info { border-left:3px solid var(--accent2); }

  /* FOOTER */
  footer { height:var(--footer-h); background:var(--card); border-top:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; padding:0 24px; font-size:11px; color:var(--muted); }
  .footer-center { color:var(--accent); font-weight:600; }

  /* EMPTY STATE */
  .empty-state { text-align:center; padding:40px; color:var(--muted); }
  .empty-state .icon { font-size:40px; margin-bottom:12px; }
  .empty-state p { font-size:14px; }

  /* FILTER BAR */
  .filter-bar { display:flex; gap:8px; margin-bottom:18px; flex-wrap:wrap; }
  .filter-btn { background:var(--card); border:1px solid var(--border); color:var(--muted);
    padding:6px 14px; border-radius:20px; cursor:pointer; font-size:11px; font-weight:600;
    transition:all .2s; font-family:'Sora',sans-serif; }
  .filter-btn:hover { border-color:var(--accent2); color:var(--text); }
  .filter-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }

  ::-webkit-scrollbar { width:5px; height:5px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  ::-webkit-scrollbar-thumb:hover { background:var(--muted); }

  @media(max-width:768px) {
    main { grid-template-columns:1fr; }
    .sidebar { height:auto; max-height:300px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">P</div>
    <div class="logo-text"><span>Pedrinho</span> ‚Äî Rotinas</div>
  </div>
  <div class="header-right">
    <span id="greeting-badge">‚òÄÔ∏è Bom dia!</span>
    <span id="clock">00:00:00</span>
    <button class="header-btn" onclick="openReport()">üìä Relat√≥rio</button>
    <button class="header-btn" onclick="showTab('backup')">üíæ Backup</button>
  </div>
</header>

<main>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Calend√°rio</div>
      <div class="mini-cal-nav">
        <button onclick="miniCalPrev()">‚Äπ</button>
        <span class="mini-cal-month" id="miniCalTitle"></span>
        <button onclick="miniCalNext()">‚Ä∫</button>
      </div>
      <div class="mini-cal-grid" id="miniCalGrid"></div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Alertas Pendentes <span class="alert-badge" id="alertCount">0</span></div>
      <div id="alertList"></div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Resumo do M√™s</div>
      <div class="stats-row">
        <div class="stat-box open"><div class="num" id="statOpen">0</div><div class="lbl">Em Aberto</div></div>
        <div class="stat-box done"><div class="num" id="statDone">0</div><div class="lbl">Fechadas</div></div>
        <div class="stat-box email"><div class="num" id="statEmail">0</div><div class="lbl">E-mails</div></div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="content-tabs">
      <div class="tab active" onclick="showTab('calendar')" id="tab-calendar">üìÖ Calend√°rio</div>
      <div class="tab" onclick="showTab('tasks')" id="tab-tasks">‚úÖ Tarefas</div>
      <div class="tab" onclick="showTab('emails')" id="tab-emails">üìß E-mails</div>
      <div class="tab" onclick="showTab('compose')" id="tab-compose">‚úâÔ∏è Redigir</div>
      <div class="tab" onclick="showTab('backup')" id="tab-backup">üíæ Backup</div>
    </div>

    <!-- TAB: CALENDAR -->
    <div class="tab-content active" id="content-calendar">
      <div class="cal-header">
        <h2 id="calTitle">Dezembro 2024</h2>
        <div class="cal-nav">
          <button onclick="calPrev()">‚Äπ Anterior</button>
          <button onclick="calToday()">Hoje</button>
          <button onclick="calNext()">Pr√≥ximo ‚Ä∫</button>
          <button class="btn-primary" onclick="openAddTask()">+ Nova Tarefa</button>
        </div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>

    <!-- TAB: TASKS -->
    <div class="tab-content" id="content-tasks">
      <div class="task-header">
        <h3 id="taskListTitle">Todas as Tarefas</h3>
        <button class="btn-primary" onclick="openAddTask()">+ Nova Tarefa</button>
      </div>
      <div class="filter-bar">
        <button class="filter-btn active" onclick="filterTasks('all',this)">Todas</button>
        <button class="filter-btn" onclick="filterTasks('open',this)">Em Aberto</button>
        <button class="filter-btn" onclick="filterTasks('done',this)">Fechadas</button>
        <button class="filter-btn" onclick="filterTasks('email',this)">Com E-mail</button>
      </div>
      <div id="taskList"></div>
    </div>

    <!-- TAB: EMAILS -->
    <div class="tab-content" id="content-emails">
      <div class="task-header">
        <h3>E-mails Registrados</h3>
        <button class="btn-primary" onclick="showTab('compose')">+ Redigir E-mail</button>
      </div>
      <div class="filter-bar">
        <button class="filter-btn active" onclick="filterEmails('all',this)">Todos</button>
        <button class="filter-btn" onclick="filterEmails('pending',this)">Aguardando Resposta</button>
        <button class="filter-btn" onclick="filterEmails('resolved',this)">Resolvidos</button>
      </div>
      <div id="emailList"></div>
    </div>

    <!-- TAB: COMPOSE -->
    <div class="tab-content" id="content-compose">
      <div class="task-header">
        <h3>‚úâÔ∏è Redigir E-mail</h3>
      </div>
      <div class="compose-card">
        <div class="form-row">
          <label class="form-label">Sauda√ß√£o</label>
          <div class="greeting-btns">
            <button class="greeting-btn" onclick="insertGreeting('Bom dia')">‚òÄÔ∏è Bom dia</button>
            <button class="greeting-btn" onclick="insertGreeting('Boa tarde')">üå§Ô∏è Boa tarde</button>
            <button class="greeting-btn" onclick="insertGreeting('Boa noite')">üåô Boa noite</button>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">Para (e-mail)</label>
          <input type="email" class="form-input" id="emailTo" placeholder="destinatario@empresa.com">
        </div>
        <div class="form-row">
          <label class="form-label">Assunto</label>
          <input type="text" class="form-input" id="emailSubject" placeholder="Ex: Solicita√ß√£o de abertura de per√≠odo para lan√ßamento de NF">
        </div>
        <div class="form-row">
          <label class="form-label">Categoria</label>
          <select class="form-input form-select" id="emailCategory">
            <option value="nf">Lan√ßamento de NF</option>
            <option value="periodo">Abertura de Per√≠odo</option>
            <option value="fornecedor">Fornecedor</option>
            <option value="financeiro">Financeiro</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Corpo do E-mail</label>
          <textarea class="form-input form-textarea" id="emailBody" placeholder="Escreva o corpo do e-mail aqui..."></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">Data de Envio</label>
          <input type="date" class="form-input" id="emailDate">
        </div>
        <div class="form-row">
          <label class="form-label">Criar tarefa vinculada ao e-mail?</label>
          <select class="form-input form-select" id="createTaskWithEmail">
            <option value="yes">Sim ‚Äî Criar tarefa para acompanhar resposta</option>
            <option value="no">N√£o</option>
          </select>
        </div>
        <div class="compose-actions">
          <button class="btn-secondary" onclick="clearCompose()">üóëÔ∏è Limpar</button>
          <button class="btn-secondary" onclick="copyEmailBody()">üìã Copiar corpo</button>
          <button class="btn-primary" onclick="openEmailClient()">üì§ Abrir no cliente de e-mail</button>
          <button class="btn-primary" onclick="saveEmail()">üíæ Salvar registro</button>
        </div>
      </div>
    </div>

    <!-- TAB: BACKUP -->
    <div class="tab-content" id="content-backup">
      <div class="task-header">
        <h3>üíæ Backup e Restaura√ß√£o</h3>
      </div>
      <div class="backup-card">
        <p style="color:var(--muted);font-size:13px;margin-bottom:18px;">Todos os dados s√£o salvos automaticamente no armazenamento local do navegador (JSON). Exporte para manter um backup externo.</p>
        <div class="backup-btns">
          <button class="btn-primary" onclick="doBackup()">‚¨áÔ∏è Exportar Backup (JSON)</button>
          <button class="btn-secondary" onclick="document.getElementById('restoreFile').click()">‚¨ÜÔ∏è Restaurar Backup</button>
          <button class="btn-secondary" onclick="clearAllData()" style="border-color:rgba(239,68,68,0.4);color:#fca5a5;">üóëÔ∏è Limpar Tudo</button>
        </div>
        <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="doRestore(event)">
        <div class="backup-info" id="backupInfo">Carregando informa√ß√µes de armazenamento...</div>
      </div>
    </div>
  </div>
</main>

<!-- FOOTER -->
<footer>
  <span>üóìÔ∏è Sistema de Acompanhamento de Rotinas Di√°rias</span>
  <span class="footer-center">‚ö° Pedrinho Rotinas v2.0</span>
  <span id="footerDate">Carregando...</span>
</footer>

<!-- MODAL: ADD/EDIT TASK -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="taskModalTitle">‚ûï Nova Tarefa</div>
      <button class="modal-close" onclick="closeModal('taskModal')">‚úï</button>
    </div>
    <div class="form-row">
      <label class="form-label">T√≠tulo da Tarefa *</label>
      <input type="text" class="form-input" id="taskTitle" placeholder="Ex: Solicitar abertura de per√≠odo para NF">
    </div>
    <div class="form-row">
      <label class="form-label">Descri√ß√£o</label>
      <textarea class="form-input" style="min-height:80px;resize:vertical" id="taskDesc" placeholder="Detalhes da tarefa..."></textarea>
    </div>
    <div class="form-row">
      <label class="form-label">Data</label>
      <input type="date" class="form-input" id="taskDate">
    </div>
    <div class="form-row">
      <label class="form-label">Categoria</label>
      <select class="form-input form-select" id="taskCategory">
        <option value="geral">Geral</option>
        <option value="nf">Lan√ßamento de NF</option>
        <option value="financeiro">Financeiro</option>
        <option value="fornecedor">Fornecedor</option>
        <option value="email">Acompanhar E-mail</option>
        <option value="outros">Outros</option>
      </select>
    </div>
    <div class="form-row">
      <label class="form-label">E-mail vinculado (destinat√°rio)</label>
      <input type="email" class="form-input" id="taskEmail" placeholder="email@empresa.com (opcional)">
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
      <button class="btn-secondary" onclick="closeModal('taskModal')">Cancelar</button>
      <button class="btn-primary" onclick="saveTask()">üíæ Salvar Tarefa</button>
    </div>
  </div>
</div>

<!-- MODAL: DAY DETAIL -->
<div class="modal-overlay" id="dayModal">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <div class="modal-title" id="dayModalTitle">Tarefas do Dia</div>
      <button class="modal-close" onclick="closeModal('dayModal')">‚úï</button>
    </div>
    <div id="dayModalContent"></div>
    <div style="margin-top:16px;text-align:right">
      <button class="btn-primary" onclick="openAddTaskForDay()">+ Adicionar Tarefa Neste Dia</button>
    </div>
  </div>
</div>

<!-- MODAL: REPORT -->
<div class="modal-overlay" id="reportModal">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <div class="modal-title">üìä Relat√≥rio de Pend√™ncias</div>
      <button class="modal-close" onclick="closeModal('reportModal')">‚úï</button>
    </div>
    <div id="reportContent"></div>
    <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn-secondary" onclick="copyReport()">üìã Copiar Relat√≥rio</button>
      <button class="btn-primary" onclick="closeModal('reportModal')">Fechar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ===================== STORAGE =====================
const STORAGE_KEY = 'pedrinho_data';

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { tasks: [], emails: [], lastBackup: null };
}

function saveData() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
  } catch(e) { showToast('Erro ao salvar dados locais.','error'); }
}

let appData = loadData();
let calYear, calMonth, miniCalYear, miniCalMonth;
let selectedDayStr = null;
let currentFilter = 'all';
let editingTaskId = null;
let editingDayForTask = null;

// ===================== INIT =====================
function init() {
  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth();
  miniCalYear = now.getFullYear();
  miniCalMonth = now.getMonth();
  document.getElementById('emailDate').value = now.toISOString().split('T')[0];
  document.getElementById('taskDate').value = now.toISOString().split('T')[0];
  renderAll();
  startClock();
  updateBackupInfo();
}

function renderAll() {
  renderCal();
  renderMiniCal();
  renderTaskList();
  renderEmailList();
  renderAlerts();
  updateStats();
}

// ===================== CLOCK & GREETING =====================
function startClock() {
  function tick() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('pt-BR');
    const h = now.getHours();
    let gr, ic;
    if (h < 12) { gr = 'Bom dia!'; ic = '‚òÄÔ∏è'; }
    else if (h < 18) { gr = 'Boa tarde!'; ic = 'üå§Ô∏è'; }
    else { gr = 'Boa noite!'; ic = 'üåô'; }
    document.getElementById('greeting-badge').textContent = ic + ' ' + gr;
    const days = ['domingo','segunda','ter√ßa','quarta','quinta','sexta','s√°bado'];
    const months = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    document.getElementById('footerDate').textContent = `${days[now.getDay()]}, ${now.getDate()} de ${months[now.getMonth()]} de ${now.getFullYear()}`;
  }
  tick();
  setInterval(tick, 1000);
}

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'Bom dia';
  if (h < 18) return 'Boa tarde';
  return 'Boa noite';
}

// ===================== CALENDAR =====================
const MONTHS = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const DAYS_SHORT = ['Seg','Ter','Qua','Qui','Sex','S√°b','Dom'];

function renderCal() {
  document.getElementById('calTitle').textContent = `${MONTHS[calMonth]} ${calYear}`;
  const grid = document.getElementById('calGrid');
  const now = new Date();
  
  // Headers
  let html = DAYS_SHORT.map(d => `<div class="cal-day-header">${d}</div>`).join('');
  
  // First day of month (0=Sun,1=Mon...)
  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const adjust = (firstDay === 0) ? 6 : firstDay - 1; // Monday=0
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const daysInPrev = new Date(calYear, calMonth, 0).getDate();
  
  const todayStr = dateStr(now);
  
  let day = 1;
  let nextDay = 1;
  for (let i = 0; i < 42; i++) {
    let d, month, year, cls = 'cal-cell', isOther = false;
    if (i < adjust) {
      d = daysInPrev - adjust + i + 1;
      month = calMonth - 1; year = calYear;
      if (month < 0) { month = 11; year--; }
      isOther = true;
    } else if (day <= daysInMonth) {
      d = day++; month = calMonth; year = calYear;
    } else {
      d = nextDay++; month = calMonth + 1; year = calYear;
      if (month > 11) { month = 0; year++; }
      isOther = true;
    }
    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (isOther) cls += ' other-month';
    if (ds === todayStr) cls += ' today';
    if (ds === selectedDayStr) cls += ' selected';
    
    const dayTasks = getTasksForDay(ds);
    const taskChips = dayTasks.slice(0,3).map(t => {
      const c = t.status === 'done' ? 'chip-done' : (t.emailTo ? 'chip-email' : 'chip-open');
      return `<span class="cal-task-chip ${c}">${t.title}</span>`;
    }).join('');
    const more = dayTasks.length > 3 ? `<span class="more-badge">+${dayTasks.length-3} mais</span>` : '';
    
    html += `<div class="${cls}" onclick="openDay('${ds}')">
      <div class="cal-day-num">${d}</div>
      ${taskChips}${more}
    </div>`;
  }
  grid.innerHTML = html;
}

function getTasksForDay(ds) {
  return appData.tasks.filter(t => t.date === ds);
}

function calPrev() { calMonth--; if(calMonth<0){calMonth=11;calYear--;} renderCal(); }
function calNext() { calMonth++; if(calMonth>11){calMonth=0;calYear++;} renderCal(); }
function calToday() { const n=new Date(); calYear=n.getFullYear(); calMonth=n.getMonth(); renderCal(); }

// ===================== MINI CALENDAR =====================
function renderMiniCal() {
  document.getElementById('miniCalTitle').textContent = `${MONTHS[miniCalMonth].substring(0,3)} ${miniCalYear}`;
  const grid = document.getElementById('miniCalGrid');
  const now = new Date();
  const todayStr = dateStr(now);
  
  let html = DAYS_SHORT.map(d => `<div class="mini-cal-day-header">${d[0]}</div>`).join('');
  
  const firstDay = new Date(miniCalYear, miniCalMonth, 1).getDay();
  const adjust = (firstDay === 0) ? 6 : firstDay - 1;
  const daysInMonth = new Date(miniCalYear, miniCalMonth + 1, 0).getDate();
  const daysInPrev = new Date(miniCalYear, miniCalMonth, 0).getDate();
  
  let day = 1, nextDay = 1;
  for (let i = 0; i < 35; i++) {
    let d, month, year, isOther = false;
    if (i < adjust) {
      d = daysInPrev - adjust + i + 1; month = miniCalMonth - 1; year = miniCalYear;
      if (month < 0) { month = 11; year--; }
      isOther = true;
    } else if (day <= daysInMonth) {
      d = day++; month = miniCalMonth; year = miniCalYear;
    } else {
      d = nextDay++; month = miniCalMonth + 1; year = miniCalYear;
      if (month > 11) { month = 0; year++; }
      isOther = true;
    }
    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayTasks = getTasksForDay(ds);
    const hasPending = dayTasks.some(t => t.status === 'open');
    const hasTask = dayTasks.length > 0;
    
    let cls = 'mini-cal-day';
    if (isOther) cls += ' other-month';
    if (ds === todayStr) cls += ' today';
    if (ds === selectedDayStr) cls += ' selected';
    if (hasPending) cls += ' has-pending';
    else if (hasTask) cls += ' has-task';
    
    html += `<div class="${cls}" onclick="miniDayClick('${ds}')">${d}</div>`;
  }
  grid.innerHTML = html;
}

function miniCalPrev() { miniCalMonth--; if(miniCalMonth<0){miniCalMonth=11;miniCalYear--;} renderMiniCal(); }
function miniCalNext() { miniCalMonth++; if(miniCalMonth>11){miniCalMonth=0;miniCalYear++;} renderMiniCal(); }
function miniDayClick(ds) {
  selectedDayStr = ds;
  const [y,m] = ds.split('-').map(Number);
  calYear = y; calMonth = m - 1;
  renderCal(); renderMiniCal();
  openDay(ds);
}

// ===================== DAY MODAL =====================
function openDay(ds) {
  selectedDayStr = ds;
  const [y,m,d] = ds.split('-').map(Number);
  const dateObj = new Date(y, m-1, d);
  const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric' };
  document.getElementById('dayModalTitle').textContent = 'üìÖ ' + dateObj.toLocaleDateString('pt-BR', opts);
  
  const tasks = getTasksForDay(ds);
  let html = '';
  if (!tasks.length) {
    html = '<div class="empty-state"><div class="icon">üì≠</div><p>Nenhuma tarefa neste dia.</p></div>';
  } else {
    tasks.forEach(t => {
      const statusTag = t.status === 'done' 
        ? '<span class="task-tag tag-done">‚úì Fechada</span>'
        : '<span class="task-tag tag-open">‚ö° Em Aberto</span>';
      const emailInfo = t.emailTo 
        ? `<a href="mailto:${t.emailTo}" class="email-link">üìß ${t.emailTo}</a>` : '';
      html += `<div class="task-card ${t.status === 'done' ? 'done' : 'open'} ${t.emailTo ? 'email-type' : ''}" style="margin-bottom:10px;">
        <div class="task-row">
          <div class="task-info">
            <div class="task-title">${t.title}</div>
            <div class="task-meta">${statusTag} <span class="task-tag">${t.category}</span> ${emailInfo}</div>
            ${t.desc ? `<div style="font-size:12px;color:var(--muted);margin-top:6px;">${t.desc}</div>` : ''}
          </div>
          <div class="task-actions">
            ${t.status === 'open' ? `<button class="icon-btn close-btn" title="Fechar tarefa" onclick="closeTask('${t.id}')">‚úì</button>` : ''}
            <button class="icon-btn del-btn" title="Excluir" onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
          </div>
        </div>
      </div>`;
    });
  }
  document.getElementById('dayModalContent').innerHTML = html;
  editingDayForTask = ds;
  openModal('dayModal');
  renderCal(); renderMiniCal();
}

function openAddTaskForDay() {
  closeModal('dayModal');
  openAddTask(editingDayForTask);
}

// ===================== TASKS =====================
function openAddTask(dateVal) {
  editingTaskId = null;
  document.getElementById('taskModalTitle').textContent = '‚ûï Nova Tarefa';
  document.getElementById('taskTitle').value = '';
  document.getElementById('taskDesc').value = '';
  document.getElementById('taskEmail').value = '';
  document.getElementById('taskCategory').value = 'geral';
  document.getElementById('taskDate').value = dateVal || new Date().toISOString().split('T')[0];
  openModal('taskModal');
}

function saveTask() {
  const title = document.getElementById('taskTitle').value.trim();
  if (!title) { showToast('Informe o t√≠tulo da tarefa.','error'); return; }
  
  const task = {
    id: editingTaskId || Date.now().toString(),
    title,
    desc: document.getElementById('taskDesc').value.trim(),
    date: document.getElementById('taskDate').value,
    category: document.getElementById('taskCategory').value,
    emailTo: document.getElementById('taskEmail').value.trim(),
    status: 'open',
    createdAt: new Date().toISOString()
  };
  
  if (editingTaskId) {
    const idx = appData.tasks.findIndex(t => t.id === editingTaskId);
    if (idx !== -1) { task.status = appData.tasks[idx].status; appData.tasks[idx] = task; }
  } else {
    appData.tasks.unshift(task);
  }
  
  saveData(); renderAll();
  closeModal('taskModal');
  showToast('Tarefa salva com sucesso!','success');
}

function closeTask(id) {
  const t = appData.tasks.find(x => x.id === id);
  if (t) { t.status = 'done'; t.closedAt = new Date().toISOString(); saveData(); renderAll(); showToast('Tarefa fechada!','success'); }
  // refresh day modal
  if (selectedDayStr) openDay(selectedDayStr);
}

function deleteTask(id) {
  appData.tasks = appData.tasks.filter(x => x.id !== id);
  saveData(); renderAll();
  showToast('Tarefa exclu√≠da.','info');
  if (selectedDayStr) setTimeout(() => openDay(selectedDayStr), 50);
}

function renderTaskList(filter) {
  filter = filter || currentFilter;
  const list = document.getElementById('taskList');
  let tasks = [...appData.tasks];
  
  // Sort by date
  tasks.sort((a,b) => new Date(a.date) - new Date(b.date));
  
  if (filter === 'open') tasks = tasks.filter(t => t.status === 'open');
  else if (filter === 'done') tasks = tasks.filter(t => t.status === 'done');
  else if (filter === 'email') tasks = tasks.filter(t => t.emailTo);
  
  if (!tasks.length) {
    list.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>Nenhuma tarefa encontrada.</p></div>';
    return;
  }
  
  list.innerHTML = tasks.map(t => {
    const statusTag = t.status === 'done'
      ? '<span class="task-tag tag-done">‚úì Fechada</span>'
      : '<span class="task-tag tag-open">‚ö° Em Aberto</span>';
    const emailBtn = t.emailTo ? `<button class="icon-btn email-btn" title="Enviar e-mail" onclick="window.location.href='mailto:${t.emailTo}'">üìß</button>` : '';
    const closeBtn = t.status === 'open' ? `<button class="icon-btn close-btn" title="Fechar tarefa" onclick="closeTaskList('${t.id}')">‚úì</button>` : '';
    const dateDisp = t.date ? new Date(t.date + 'T12:00:00').toLocaleDateString('pt-BR') : '';
    return `<div class="task-card ${t.status === 'done' ? 'done' : 'open'} ${t.emailTo ? 'email-type' : ''}">
      <div class="task-row">
        <div class="task-info">
          <div class="task-title">${t.title}</div>
          <div class="task-meta">${statusTag} <span class="task-tag">${t.category}</span> ${dateDisp ? `<span>üìÖ ${dateDisp}</span>` : ''} ${t.emailTo ? `<a href="mailto:${t.emailTo}" class="email-link">üìß ${t.emailTo}</a>` : ''}</div>
          ${t.desc ? `<div style="font-size:12px;color:var(--muted);margin-top:6px;">${t.desc}</div>` : ''}
        </div>
        <div class="task-actions">
          ${closeBtn}${emailBtn}
          <button class="icon-btn del-btn" title="Excluir" onclick="deleteTaskFromList('${t.id}')">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function closeTaskList(id) {
  const t = appData.tasks.find(x => x.id === id);
  if (t) { t.status = 'done'; t.closedAt = new Date().toISOString(); saveData(); renderAll(); showToast('Tarefa fechada!','success'); }
}

function deleteTaskFromList(id) {
  appData.tasks = appData.tasks.filter(x => x.id !== id);
  saveData(); renderAll();
  showToast('Tarefa exclu√≠da.','info');
}

function filterTasks(f, btn) {
  currentFilter = f;
  document.querySelectorAll('#content-tasks .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTaskList(f);
}

// ===================== EMAILS =====================
function saveEmail() {
  const to = document.getElementById('emailTo').value.trim();
  const subj = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();
  const date = document.getElementById('emailDate').value;
  const cat = document.getElementById('emailCategory').value;
  
  if (!to || !subj) { showToast('Preencha o destinat√°rio e o assunto.','error'); return; }
  
  const email = {
    id: Date.now().toString(),
    to, subject: subj, body, date, category: cat,
    status: 'pending',
    createdAt: new Date().toISOString()
  };
  appData.emails.unshift(email);
  
  // Create linked task
  if (document.getElementById('createTaskWithEmail').value === 'yes') {
    const task = {
      id: (Date.now()+1).toString(),
      title: `Aguardar resposta: ${subj}`,
      desc: `E-mail enviado para ${to}`,
      date, category: 'email',
      emailTo: to,
      status: 'open',
      createdAt: new Date().toISOString()
    };
    appData.tasks.unshift(task);
  }
  
  saveData(); renderAll();
  showToast('E-mail salvo e tarefa criada!','success');
  clearCompose();
  showTab('emails');
}

function renderEmailList(filter) {
  const list = document.getElementById('emailList');
  let emails = [...appData.emails];
  
  if (filter === 'pending') emails = emails.filter(e => e.status === 'pending');
  else if (filter === 'resolved') emails = emails.filter(e => e.status === 'resolved');
  
  if (!emails.length) {
    list.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>Nenhum e-mail registrado.</p></div>';
    return;
  }
  
  list.innerHTML = emails.map(e => {
    const statusTag = e.status === 'resolved'
      ? '<span class="task-tag tag-done">‚úì Resolvido</span>'
      : '<span class="task-tag tag-open">‚è≥ Aguardando</span>';
    const dateDisp = e.date ? new Date(e.date + 'T12:00:00').toLocaleDateString('pt-BR') : '';
    const resolveBtn = e.status === 'pending' ? `<button class="icon-btn close-btn" title="Marcar como resolvido" onclick="resolveEmail('${e.id}')">‚úì</button>` : '';
    return `<div class="task-card ${e.status === 'resolved' ? 'done' : 'open'} email-type">
      <div class="task-row">
        <div class="task-info">
          <div class="task-title">üìß ${e.subject}</div>
          <div class="task-meta">${statusTag} <span class="task-tag">${e.category}</span>
            <a href="mailto:${e.to}" class="email-link">‚úâÔ∏è ${e.to}</a>
            ${dateDisp ? `<span>üìÖ ${dateDisp}</span>` : ''}
          </div>
          ${e.body ? `<div style="font-size:12px;color:var(--muted);margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:500px;">${e.body.substring(0,100)}${e.body.length>100?'...':''}</div>` : ''}
        </div>
        <div class="task-actions">
          ${resolveBtn}
          <button class="icon-btn email-btn" title="Abrir cliente de e-mail" onclick="window.location.href='mailto:${e.to}?subject=Re: ${encodeURIComponent(e.subject)}'">üìß</button>
          <button class="icon-btn del-btn" title="Excluir" onclick="deleteEmail('${e.id}')">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function resolveEmail(id) {
  const e = appData.emails.find(x => x.id === id);
  if (e) { e.status = 'resolved'; e.resolvedAt = new Date().toISOString(); saveData(); renderAll(); showToast('E-mail marcado como resolvido!','success'); }
}

function deleteEmail(id) {
  appData.emails = appData.emails.filter(x => x.id !== id);
  saveData(); renderAll();
  showToast('E-mail exclu√≠do.','info');
}

function filterEmails(f, btn) {
  document.querySelectorAll('#content-emails .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderEmailList(f);
}

// ===================== COMPOSE =====================
function insertGreeting(g) {
  const body = document.getElementById('emailBody');
  const existing = body.value;
  // Remove any existing greeting from start
  const cleaned = existing.replace(/^(Bom dia|Boa tarde|Boa noite)[,!.]?\s*/i,'');
  body.value = `${g},\n\n${cleaned}`;
  
  // Active state
  document.querySelectorAll('.greeting-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

function clearCompose() {
  document.getElementById('emailTo').value = '';
  document.getElementById('emailSubject').value = '';
  document.getElementById('emailBody').value = '';
  document.getElementById('emailDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('emailCategory').value = 'nf';
  document.querySelectorAll('.greeting-btn').forEach(b => b.classList.remove('active'));
}

function copyEmailBody() {
  const body = document.getElementById('emailBody').value;
  navigator.clipboard.writeText(body).then(() => showToast('Corpo copiado!','success'));
}

function openEmailClient() {
  const to = document.getElementById('emailTo').value;
  const subj = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  if (!to) { showToast('Informe o destinat√°rio.','error'); return; }
  window.location.href = `mailto:${to}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
}

// ===================== ALERTS =====================
function renderAlerts() {
  const list = document.getElementById('alertList');
  const pending = appData.tasks.filter(t => t.status === 'open' && isPastOrToday(t.date));
  document.getElementById('alertCount').textContent = pending.length;
  
  if (!pending.length) {
    list.innerHTML = '<div style="color:var(--muted);font-size:12px;text-align:center;padding:10px;">‚úÖ Nenhuma pend√™ncia!</div>';
    return;
  }
  
  list.innerHTML = pending.slice(0,5).map(t => {
    const dateDisp = t.date ? new Date(t.date + 'T12:00:00').toLocaleDateString('pt-BR') : '';
    return `<div class="alert-card" onclick="openDay('${t.date}')">
      <div class="alert-title">‚ö†Ô∏è ${t.title}</div>
      <div class="alert-info">${dateDisp} ¬∑ ${t.category} ${t.emailTo ? '¬∑ üìß '+t.emailTo : ''}</div>
    </div>`;
  }).join('');
  
  if (pending.length > 5) list.innerHTML += `<div style="font-size:11px;color:var(--muted);text-align:center;padding:8px;">+${pending.length-5} mais pend√™ncias</div>`;
}

function isPastOrToday(dateStr) {
  if (!dateStr) return false;
  const d = new Date(dateStr + 'T23:59:59');
  return d <= new Date();
}

// ===================== STATS =====================
function updateStats() {
  const open = appData.tasks.filter(t => t.status === 'open').length;
  const done = appData.tasks.filter(t => t.status === 'done').length;
  const emailCount = appData.emails.length;
  document.getElementById('statOpen').textContent = open;
  document.getElementById('statDone').textContent = done;
  document.getElementById('statEmail').textContent = emailCount;
}

// ===================== REPORT =====================
function openReport() {
  const open = appData.tasks.filter(t => t.status === 'open');
  const done = appData.tasks.filter(t => t.status === 'done');
  const pendingEmails = appData.emails.filter(e => e.status === 'pending');
  const now = new Date().toLocaleDateString('pt-BR', { dateStyle:'full' });
  
  let html = `
    <div style="font-size:12px;color:var(--muted);margin-bottom:16px;">Gerado em ${now}</div>
    <div class="report-section">
      <h4>üìä Resumo Geral</h4>
      <div class="report-item"><span>Total de Tarefas</span><strong>${appData.tasks.length}</strong></div>
      <div class="report-item"><span>Em Aberto</span><strong style="color:var(--danger)">${open.length}</strong></div>
      <div class="report-item"><span>Fechadas</span><strong style="color:var(--accent3)">${done.length}</strong></div>
      <div class="report-item"><span>E-mails Registrados</span><strong style="color:var(--accent2)">${appData.emails.length}</strong></div>
      <div class="report-item"><span>E-mails Aguardando Resposta</span><strong style="color:var(--warn)">${pendingEmails.length}</strong></div>
    </div>`;
  
  if (open.length) {
    html += `<div class="report-section"><h4>‚ö° Tarefas em Aberto</h4>`;
    open.slice(0,10).forEach(t => {
      const date = t.date ? new Date(t.date+'T12:00:00').toLocaleDateString('pt-BR') : '';
      html += `<div class="report-item"><span>${t.title}</span><span style="color:var(--muted)">${date}</span></div>`;
    });
    if (open.length > 10) html += `<div style="font-size:11px;color:var(--muted);padding:8px 0;">...e mais ${open.length-10} tarefa(s)</div>`;
    html += '</div>';
  }
  
  if (pendingEmails.length) {
    html += `<div class="report-section"><h4>üìß E-mails Aguardando Resposta</h4>`;
    pendingEmails.forEach(e => {
      html += `<div class="report-item"><span>${e.subject}</span><a href="mailto:${e.to}" class="email-link">${e.to}</a></div>`;
    });
    html += '</div>';
  }
  
  document.getElementById('reportContent').innerHTML = html;
  openModal('reportModal');
}

function copyReport() {
  const open = appData.tasks.filter(t => t.status === 'open');
  const pendingEmails = appData.emails.filter(e => e.status === 'pending');
  let text = `üìä RELAT√ìRIO DE PEND√äNCIAS ‚Äî ${new Date().toLocaleDateString('pt-BR')}\n\n`;
  text += `RESUMO: ${appData.tasks.length} tarefas | ${open.length} em aberto | ${pendingEmails.length} e-mails pendentes\n\n`;
  if (open.length) {
    text += `TAREFAS EM ABERTO:\n`;
    open.forEach(t => text += `  ‚Ä¢ ${t.title} (${t.date||'sem data'})\n`);
  }
  if (pendingEmails.length) {
    text += `\nE-MAILS AGUARDANDO RESPOSTA:\n`;
    pendingEmails.forEach(e => text += `  ‚Ä¢ ${e.subject} ‚Üí ${e.to}\n`);
  }
  navigator.clipboard.writeText(text).then(() => showToast('Relat√≥rio copiado!','success'));
}

// ===================== BACKUP =====================
function doBackup() {
  appData.lastBackup = new Date().toISOString();
  saveData();
  const json = JSON.stringify(appData, null, 2);
  const blob = new Blob([json], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `pedrinho_backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Backup exportado com sucesso!','success');
  updateBackupInfo();
}

function doRestore(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.tasks && data.emails) {
        appData = data;
        saveData(); renderAll();
        showToast(`Backup restaurado! ${data.tasks.length} tarefas, ${data.emails.length} e-mails.`,'success');
        updateBackupInfo();
      } else { showToast('Arquivo inv√°lido.','error'); }
    } catch { showToast('Erro ao restaurar backup.','error'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearAllData() {
  if (!confirm('Tem certeza? Todos os dados ser√£o apagados!')) return;
  appData = { tasks: [], emails: [], lastBackup: null };
  saveData(); renderAll();
  showToast('Dados apagados.','info');
  updateBackupInfo();
}

function updateBackupInfo() {
  const size = (JSON.stringify(appData).length / 1024).toFixed(1);
  const last = appData.lastBackup ? new Date(appData.lastBackup).toLocaleString('pt-BR') : 'Nunca';
  document.getElementById('backupInfo').textContent = 
    `Tarefas: ${appData.tasks.length} | E-mails: ${appData.emails.length} | Tamanho: ~${size}KB | √öltimo backup: ${last}`;
}

// ===================== UI HELPERS =====================
function showTab(name) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('content-'+name).classList.add('active');
  const tabEl = document.getElementById('tab-'+name);
  if (tabEl) tabEl.classList.add('active');
  if (name === 'backup') updateBackupInfo();
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

function showToast(msg, type='info') {
  const t = document.getElementById('toast');
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è' };
  t.className = `show ${type}`;
  t.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.className = '', 3000);
}

function dateStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ===================== START =====================
init();
</script>
</body>
</html>
