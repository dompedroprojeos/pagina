<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Envio de Mensagens - Fisio Clínica</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f5f6fa; margin:0; padding:0; color:#2f3640; }
header, footer { background:#273c75; color:white; text-align:center; padding:15px; }
header h1 { margin:0; font-size:22px; }
footer { font-size:13px; }
main { padding:20px; max-width:900px; margin:auto; }
.form-box { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1); margin-bottom:20px; }
.form-box h2 { margin-top:0; font-size:18px; color:#273c75; }
label { display:block; margin:10px 0 5px; font-weight:500; }
input { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
.btn { display:inline-block; padding:10px 15px; margin-top:10px; border:none; border-radius:6px; background:#273c75; color:white; cursor:pointer; font-size:14px; }
.btn:hover { background:#40739e; }
.btn i { margin-right:6px; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #ddd; padding:10px; text-align:left; }
th { background:#273c75; color:white; }
.actions button { margin-right:5px; }
.sent { color:green; font-weight:bold; }
.report-box { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1); margin-top:20px; }
</style>
</head>
<body>

<header>
<h1><i class="fa-solid fa-hospital-user"></i> Fisio Clínica - Envio de Mensagens</h1>
</header>

<main>
<div class="form-box">
<h2><i class="fa-solid fa-user-plus"></i> Cadastrar Paciente</h2>
<form id="patientForm">
<label>Nome do Paciente:</label>
<input type="text" id="name" required>

<label>Telefone (com DDD):</label>
<input type="tel" id="phone" placeholder="(11) 91234-5678" required>

<label>Data da Marcação:</label>
<input type="date" id="date" required>

<label>Horário da Marcação:</label>
<input type="time" id="time" required>

<button type="submit" class="btn"><i class="fa-solid fa-plus"></i> Adicionar</button>
</form>
</div>

<div class="form-box">
<h2><i class="fa-solid fa-list"></i> Pacientes Cadastrados</h2>
<table id="patientsTable">
<thead>
<tr>
<th>Nome</th>
<th>Telefone</th>
<th>Data</th>
<th>Hora</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="report-box">
<h2><i class="fa-solid fa-file-alt"></i> Relatório de Enviados</h2>
<button class="btn" onclick="generateReport()"><i class="fa-solid fa-file-export"></i> Gerar Relatório</button>
<button class="btn" onclick="clearAll()"><i class="fa-solid fa-trash"></i> Limpar Tudo</button>
<div id="reportContent"></div>
</div>
</main>

<footer>
&copy; 2025 Fisio Clínica - Desenvolvido para agendamento de pacientes
</footer>

<script>
function uid(){ return '_' + Math.random().toString(36).substr(2,9); }
function onlyDigits(str){ return str.replace(/\D/g,''); }
function loadPatients(){ return JSON.parse(localStorage.getItem('patients')||'[]'); }
function savePatients(list){ localStorage.setItem('patients', JSON.stringify(list)); }
function loadSent(){ return JSON.parse(localStorage.getItem('sent')||'[]'); }
function saveSent(list){ localStorage.setItem('sent', JSON.stringify(list)); }

function renderList(){
const patients = loadPatients();
const tbody = document.querySelector("#patientsTable tbody");
tbody.innerHTML = "";
patients.forEach(p=>{
const tr = document.createElement("tr");
tr.innerHTML = `
<td>${p.name}</td>
<td>${p.phone}</td>
<td>${p.date}</td>
<td>${p.time}</td>
<td>${p.sent?'<span class="sent">Enviado</span>':'Pendente'}</td>
<td class="actions">
<button class="btn" onclick="sendPatientMessage('${p.id}')"><i class="fa-brands fa-whatsapp"></i> Enviar</button>
</td>`;
tbody.appendChild(tr);
});
}

document.getElementById("patientForm").addEventListener("submit", e=>{
e.preventDefault();
const name=document.getElementById("name").value.trim();
const phone=document.getElementById("phone").value.trim();
const date=document.getElementById("date").value;
const time=document.getElementById("time").value;
if(!name||!phone||!date||!time){ alert("Preencha todos os campos"); return; }
const patients=loadPatients();
patients.push({id:uid(), name, phone, date, time, sent:false});
savePatients(patients);
renderList();
e.target.reset();
});

function getPhoneForWhatsApp(phone){
let digits=onlyDigits(phone);
if(digits.length===11) return "55"+digits;
else if(digits.length===13 && digits.startsWith("55")) return digits;
else return digits;
}

function buildMessage(patient){
const now = new Date();
const h=now.getHours();
const saudacao=(h<12?"Bom dia":(h<18?"Boa tarde":"Boa noite"));
return `${saudacao} ${patient.name},\n\nSua sessão de fisioterapia está marcada para ${patient.date} às ${patient.time}.\nComparecer no horário e dia da marcação.\n\n📍 Fisio clínica\nRua Vereador Ernesto Ramalho Gomes, 36\n(Em frente ao estacionamento do hospital)\n\nFisioterapeuta: Dra Thais Xavier\n\nObrigada.`;
}

function openWhatsappWindow(url){
if(window.whatsappWindow && !window.whatsappWindow.closed){ window.whatsappWindow.close(); }
window.whatsappWindow=window.open(url,"_blank");
}

function sendPatientMessage(patientId){
const patients=loadPatients();
const patient=patients.find(p=>p.id===patientId);
if(!patient){ alert("Paciente não encontrado"); return; }
const phoneForWA=getPhoneForWhatsApp(patient.phone);
const msg=buildMessage(patient);

let url;
if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
url="https://wa.me/"+encodeURIComponent(phoneForWA)+"?text="+encodeURIComponent(msg);
} else {
url="https://web.whatsapp.com/send?phone="+encodeURIComponent(phoneForWA)+"&text="+encodeURIComponent(msg);
}

openWhatsappWindow(url);

const now=new Date();
const sentList=loadSent();
sentList.unshift({id:uid(), patientId:patient.id, sentAt:now.toISOString(), msg, phone:phoneForWA});
saveSent(sentList);

const newPatients=patients.map(p=>(p.id===patient.id)?{...p,sent:true,lastSentAt:now.toISOString()}:p);
savePatients(newPatients);
renderList();
}

function generateReport(){
const sentList=loadSent();
if(sentList.length===0){ alert("Nenhum envio registrado."); return; }
let html="<h3>Relatório de Mensagens Enviadas</h3><ul>";
sentList.forEach(s=>{
const dt=new Date(s.sentAt);
html+=`<li><b>${s.phone}</b> - ${dt.toLocaleString()}<br><pre>${s.msg}</pre></li>`;
});
html+="</ul>";
document.getElementById("reportContent").innerHTML=html;
}

function clearAll(){
if(confirm("Tem certeza que deseja apagar todos os dados?")){
localStorage.removeItem("patients");
localStorage.removeItem("sent");
renderList();
document.getElementById("reportContent").innerHTML="";
}
}

renderList();
</script>

</body>
</html>
