<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Envio WhatsApp ‚Äî Fisio Cl√≠nica</title>
<style>
:root{
--bg: #f6f7fb;
--card:#ffffff;
--accent:#0b84ff;
--muted:#62727b;
--success:#16a34a;
--danger:#ef4444;
--glass: rgba(255,255,255,0.6);
font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{
margin:0;
min-height:100vh;
display:flex;
flex-direction:column;
background:linear-gradient(180deg,#f6f7fb 0%, #eef3fb 100%);
color:#102027;
font-size:16px;
}
header{
background:linear-gradient(90deg,var(--card), #f9fbff);
padding:18px 20px;
display:flex;
gap:14px;
align-items:center;
box-shadow:0 6px 18px rgba(16,32,39,0.06);
border-bottom:1px solid rgba(16,32,39,0.04);
}
.brand{
display:flex;
gap:12px;
align-items:center;
}
.logo{
width:48px;height:48px;border-radius:12px;
background:linear-gradient(135deg,var(--accent),#5bc0ff);
display:grid;place-items:center;color:white;font-weight:700;
box-shadow:0 6px 18px rgba(11,132,255,0.15);
}
h1{font-size:18px;margin:0}
header .actions{
margin-left:auto;
display:flex;
gap:10px;
align-items:center;
}
.btn{
display:inline-flex;gap:8px;align-items:center;
background:var(--accent);color:white;padding:10px 12px;border-radius:10px;
border:none;cursor:pointer;font-weight:600;
box-shadow:0 6px 14px rgba(11,132,255,0.12);
}
.btn.secondary{
background:transparent;color:var(--accent);border:1px solid rgba(11,132,255,0.12);box-shadow:none;font-weight:600;
}
main{
padding:22px;
width:1100px;
max-width:100%;
margin:18px auto;
display:grid;
grid-template-columns: 420px 1fr;
gap:18px;
align-items:start;
}
.card{
background:var(--card);
border-radius:14px;padding:18px;
box-shadow:0 10px 30px rgba(16,32,39,0.06);
}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
input[type="text"], input[type="tel"], input[type="date"], input[type="time"]{
width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6eef8;background:transparent;
outline:none;font-size:15px;
}
.form-row{display:flex;gap:10px}
.form-row .col{flex:1}
.small{font-size:12px;color:var(--muted)}
.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{
padding:12px;border-radius:10px;border:1px solid #eef6ff;background:linear-gradient(180deg,#fff,#fbfeff);
display:flex;align-items:center;gap:12px;justify-content:space-between;
}
.meta{display:flex;gap:12px;align-items:center}
.avatar{
width:44px;height:44px;border-radius:10px;background:#f1f8ff;display:grid;place-items:center;font-weight:700;color:var(--accent);
}
.info{min-width:0}
.name{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.phone{font-size:13px;color:var(--muted)}
.pill{font-size:12px;padding:6px 8px;border-radius:999px;background:#eef9f3;color:var(--success);border:1px solid rgba(22,163,74,0.08)}
.controls{display:flex;gap:8px;align-items:center}
.icon-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:1px solid transparent;background:transparent;cursor:pointer}
.icon-btn.send{background:linear-gradient(90deg,#09b44a,#10a34a);color:white;border:none}
.icon-btn.edit{border:1px solid rgba(16,32,39,0.04)}
.muted{color:var(--muted);font-size:13px}
footer{
margin-top:14px;padding:18px 22px;border-top:1px solid rgba(16,32,39,0.04);display:flex;justify-content:space-between;align-items:center;
width:1100px;max-width:100%;margin-left:auto;margin-right:auto;border-radius:0 0 14px 14px;background:transparent;
}

/* responsive */
@media (max-width:920px){
main{grid-template-columns:1fr; padding:14px}
footer{width:calc(100% - 28px)}
}

/* small utilities */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.muted-sm{font-size:12px;color:var(--muted)}
.report-table{width:100%;border-collapse:collapse;margin-top:10px}
.report-table th,.report-table td{border:1px solid rgba(16,32,39,0.06);padding:8px;text-align:left;font-size:13px}
.right{display:flex;gap:8px;align-items:center}
/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:60}
.modal{background:white;border-radius:12px;padding:16px;max-width:940px;width:100%;max-height:90vh;overflow:auto}
</style>
</head>
<body>
<header>
<div class="brand">
<div class="logo">FH</div>
<div>
<h1>Fisio Cl√≠nica ‚Äî Envio WhatsApp</h1>
<div class="muted-sm">Agende e envie lembretes pelo WhatsApp Web</div>
</div>
</div>

<div class="actions">
<button class="btn" id="btnReport" title="Gerar relat√≥rio">üìÑ Gerar relat√≥rio</button>
<button class="btn secondary" id="btnClear" title="Limpar tudo">üßπ Limpar tudo</button>
</div>
</header>

<main>
<!-- Form / Cadastro -->
<section class="card" aria-labelledby="formTitle">
<h2 id="formTitle" style="margin:0 0 12px 0">Cadastrar agendamento</h2>

<div>
<label>Nome do paciente</label>
<input id="inputName" type="text" placeholder="Ex: Maria Silva" />
</div>

<div style="margin-top:10px">
<label>Telefone (celular)</label>
<input id="inputPhone" type="tel" placeholder="(99) 9 9999-9999" maxlength="20" />
<div class="small" style="margin-top:6px">Ser√° enviado com DDI 55 automaticamente.</div>
</div>

<div class="form-row" style="margin-top:10px">
<div class="col">
<label>Data da marca√ß√£o</label>
<input id="inputDate" type="date" />
</div>
<div class="col">
<label>Hor√°rio</label>
<input id="inputTime" type="time" />
</div>
</div>

<div style="margin-top:12px;display:flex;gap:10px;">
<button class="btn" id="btnAdd">‚ûï Adicionar</button>
<button class="btn secondary" id="btnPreview">üëÄ Ver mensagem</button>
</div>

<div style="margin-top:14px">
<div class="small">Mensagem padr√£o (sera enviada via WhatsApp):</div>
<div style="margin-top:8px;padding:12px;border-radius:10px;background:#fbfdff;border:1px solid rgba(11,132,255,0.04)">
<div id="previewText" style="white-space:pre-wrap;color:#123;">‚Äî</div>
</div>
</div>
</section>

<!-- Lista -->
<section class="card">
<div style="display:flex;align-items:center;justify-content:space-between">
<h3 style="margin:0">Pacientes cadastrados</h3>
<div class="muted-sm">Toque em enviar para abrir o WhatsApp Web</div>
</div>

<div class="list" id="patientList" style="margin-top:12px">
<!-- items -->
</div>
</section>
</main>

<footer>
<div>
<div style="font-weight:600">Fisio Cl√≠nica ‚Äî Dra Thais Xavier</div>
<div class="muted-sm">Rua Vereador Ernesto Ramalho Gomes, 36 ‚Äî Em frente ao estacionamento do hospital</div>
</div>
<div class="right muted-sm">Desenvolvido para uso interno ‚Ä¢ Local storage (JSON)</div>
</footer>

<!-- modal -->
<div class="modal-backdrop" id="modalBackdrop">
<div class="modal" role="dialog" aria-modal="true">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<h3 id="modalTitle" style="margin:0">Relat√≥rio</h3>
<div style="display:flex;gap:8px">
<button class="btn secondary" id="modalClose">Fechar</button>
<button class="btn" id="modalPrint">Imprimir / Salvar PDF</button>
</div>
</div>
<div id="modalContent"></div>
</div>
</div>

<script>
/* App: armazenamento em localStorage:
- key 'fh_patients' : array de pacientes {id,name,phone,date,time,addedAt, sent:false}
- key 'fh_sent' : array de registros de envio {patientId, sentAt, msg, phone}
*/
const STORAGE_PATIENTS = 'fh_patients_v1';
const STORAGE_SENT = 'fh_sent_v1';

// refer√™ncia para janela do whatsapp que o app controla
let waWindow = null;

function uid(){
return 'id'+Math.random().toString(36).slice(2,9);
}

/* ---------- utilidades de formata√ß√£o ---------- */
function onlyDigits(s){ return (s||'').replace(/\D/g,''); }

function formatPhoneMask(value){
// normalized digits
let d = onlyDigits(value);
// remove leading 55 caso o usu√°rio j√° tenha colocado
if(d.startsWith('55')) d = d.slice(2);
// ensure max 11 digits (2 area + 9)
d = d.slice(0,11);
if(d.length<=2) return '('+d;
if(d.length<=7) return '('+d.slice(0,2)+') '+d.slice(2);
return '('+d.slice(0,2)+') '+d.slice(2,7)+'-'+d.slice(7);
}

function getPhoneForWhatsApp(value){
// return digits with country code 55 + area + number, no symbols
let d = onlyDigits(value);
if(d.startsWith('55')) d = d.slice(2);
// if user provided only 10 digits (without 9), we still send what exists
return '55' + d;
}

function formatDateDisplay(isoDate){
if(!isoDate) return '';
// isoDate like yyyy-mm-dd
const [y,m,d]=isoDate.split('-');
return `${d}/${m}/${y}`;
}

function formatTimeDisplay(time24){
if(!time24) return '';
// time24 like HH:MM
const [hh,mm]=time24.split(':');
return `${hh}:${mm}`;
}

function savePatients(list){
localStorage.setItem(STORAGE_PATIENTS, JSON.stringify(list||[]));
}
function saveSent(list){
localStorage.setItem(STORAGE_SENT, JSON.stringify(list||[]));
}
function loadPatients(){ try{ return JSON.parse(localStorage.getItem(STORAGE_PATIENTS)||'[]') }catch(e){return []}}
function loadSent(){ try{ return JSON.parse(localStorage.getItem(STORAGE_SENT)||'[]') }catch(e){return []}}

/* ---------- mensagem padr√£o ---------- */
function buildMessage(patient){
// greeting according to current local time
const now = new Date();
const h = now.getHours();
let greeting = 'Bom dia';
if(h>=12 && h<18) greeting = 'Boa tarde';
else if(h>=18) greeting = 'Boa noite';

const appointmentDate = formatDateDisplay(patient.date);
const appointmentTime = formatTimeDisplay(patient.time);

return `${greeting} ${patient.name || ''},

Sua sess√£o de fisioterapia est√° marcada: comparecer no hor√°rio e dia da marca√ß√£o.
Data: ${appointmentDate}
Hor√°rio: ${appointmentTime}

Na Fisio cl√≠nica, Rua Vereador Ernesto Ramalho Gomes, 36 (em frente ao estacionamento do hospital).
Fisioterapeuta: Dra Thais Xavier

Obrigada.`;
}

/* ---------- UI: render lista ---------- */
function renderList(){
const list = loadPatients();
const container = document.getElementById('patientList');
container.innerHTML = '';
if(list.length===0){
container.innerHTML = '<div class="muted-sm">Nenhum paciente cadastrado.</div>';
return;
}
list.forEach(p=>{
const el = document.createElement('div');
el.className = 'item';
const left = document.createElement('div');
left.className = 'meta';

const avatar = document.createElement('div');
avatar.className = 'avatar';
avatar.textContent = (p.name||' ').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();

const info = document.createElement('div');
info.className = 'info';
info.innerHTML = `<div class="name">${escapeHtml(p.name||'‚Äî')}</div>
<div class="phone">${escapeHtml(formatPhoneMask(p.phone))} ‚Ä¢ <span class="muted">${formatDateDisplay(p.date)} ${formatTimeDisplay(p.time)}</span></div>`;

left.appendChild(avatar);
left.appendChild(info);

const controls = document.createElement('div');
controls.className = 'controls';

const sentBadge = document.createElement('div');
if(p.sent){
sentBadge.className = 'pill';
sentBadge.textContent = 'Enviado';
controls.appendChild(sentBadge);
}

// send button
const btnSend = document.createElement('button');
btnSend.className = 'icon-btn send';
btnSend.title = 'Enviar pelo WhatsApp';
btnSend.innerHTML = '‚úâÔ∏è Enviar';
btnSend.onclick = ()=> sendPatientMessage(p.id);
controls.appendChild(btnSend);

// edit / remove
const btnRemove = document.createElement('button');
btnRemove.className = 'icon-btn';
btnRemove.title = 'Remover cadastro';
btnRemove.innerHTML = 'üóëÔ∏è';
btnRemove.onclick = ()=>{
if(confirm('Remover este paciente?')) {
const newList = loadPatients().filter(x=>x.id!==p.id);
savePatients(newList);
renderList();
}
};
controls.appendChild(btnRemove);

el.appendChild(left);
el.appendChild(controls);
container.appendChild(el);
});
}

/* ---------- send flow ---------- */
function openWhatsappWindow(url){
// If we already have controlled waWindow, close it then open a new one (requirement)
try{
if(waWindow && !waWindow.closed){
waWindow.close();
waWindow = null;
}
}catch(e){ waWindow = null; }
// open with fixed name 'fh_whatsapp_window' so popup reuse/targetting consistent
waWindow = window.open(url, 'fh_whatsapp_window', 'noopener,noreferrer');
// focus
try{ waWindow && waWindow.focus(); }catch(e){}
}

function sendPatientMessage(patientId){
const patients = loadPatients();
const patient = patients.find(p=>p.id===patientId);
if(!patient){ alert('Paciente n√£o encontrado'); return; }
// validate phone digits
const digits = onlyDigits(patient.phone);
if(digits.length < 10){
alert('Telefone incompleto. Verifique o n√∫mero antes de enviar.');
return;
}
const phoneForWA = getPhoneForWhatsApp(patient.phone);
const msg = buildMessage(patient);
// create url for WhatsApp Web
const url = 'https://web.whatsapp.com/send?phone=' + encodeURIComponent(phoneForWA) + '&text=' + encodeURIComponent(msg);
openWhatsappWindow(url);

// mark sent and log
const now = new Date();
const sentList = loadSent();
sentList.unshift({
id: uid(),
patientId: patient.id,
sentAt: now.toISOString(),
msg,
phone: phoneForWA
});
saveSent(sentList);

// mark patient as sent
const newPatients = patients.map(p=>(p.id===patient.id)?{...p, sent:true, lastSentAt: now.toISOString()}:p);
savePatients(newPatients);
renderList();
}

/* ---------- add patient ---------- */
document.getElementById('inputPhone').addEventListener('input', function(e){
const pos = this.selectionStart;
const old = this.value;
this.value = formatPhoneMask(this.value);
// trying to keep caret near end is complex; this is acceptable for now
});

document.getElementById('btnAdd').addEventListener('click', function(){
const name = document.getElementById('inputName').value.trim();
const phone = document.getElementById('inputPhone').value.trim();
const date = document.getElementById('inputDate').value;
const time = document.getElementById('inputTime').value;
if(!name || !phone || !date || !time){
alert('Preencha nome, telefone, data e hor√°rio.');
return;
}
const digits = onlyDigits(phone);
if(digits.length < 10){
alert('Telefone incompleto.');
return;
}
const list = loadPatients();
const newPatient = {
id: uid(),
name,
phone,
date,
time,
addedAt: new Date().toISOString(),
sent: false
};
list.unshift(newPatient);
savePatients(list);
// clear form (but keep date/time? we'll clear all)
document.getElementById('inputName').value = '';
document.getElementById('inputPhone').value = '';
document.getElementById('inputDate').value = '';
document.getElementById('inputTime').value = '';
renderList();
});

document.getElementById('btnPreview').addEventListener('click', ()=>{
const name = document.getElementById('inputName').value.trim() || 'Nome do paciente';
const phone = document.getElementById('inputPhone').value.trim() || '(99) 9 9999-9999';
const date = document.getElementById('inputDate').value || new Date().toISOString().slice(0,10);
const time = document.getElementById('inputTime').value || '09:00';
const temp = {name,phone,date,time};
document.getElementById('previewText').textContent = buildMessage(temp);
});

/* ---------- relat√≥rio e modal ---------- */
const modalBackdrop = document.getElementById('modalBackdrop');
document.getElementById('btnReport').addEventListener('click', openReport);
document.getElementById('modalClose').addEventListener('click', ()=> modalBackdrop.style.display='none');
document.getElementById('modalPrint').addEventListener('click', ()=>{
// open print on the modal content
window.print();
});

function openReport(){
const patients = loadPatients();
const sent = loadSent();
const content = document.getElementById('modalContent');
let html = '';

// scheduled table
html += '<h4>Pacientes agendados</h4>';
if(patients.length===0) html += '<div class="muted-sm">Nenhum agendamento.</div>';
else {
html += '<table class="report-table"><thead><tr><th>Nome</th><th>Telefone</th><th>Data</th><th>Hor√°rio</th><th>Status</th></tr></thead><tbody>';
patients.forEach(p=>{
html += `<tr>
<td>${escapeHtml(p.name)}</td>
<td>${escapeHtml(formatPhoneMask(p.phone))}</td>
<td>${escapeHtml(formatDateDisplay(p.date))}</td>
<td>${escapeHtml(formatTimeDisplay(p.time))}</td>
<td>${p.sent? 'Enviado' : 'Pendente'}</td>
</tr>`;
});
html += '</tbody></table>';
}

// sent table
html += '<h4 style="margin-top:14px">Registros de envio</h4>';
if(sent.length===0) html += '<div class="muted-sm">Nenhum envio registrado.</div>';
else {
html += '<table class="report-table"><thead><tr><th>Nome</th><th>Telefone</th><th>Quando</th><th>Data agendada</th><th>Hor√°rio agendado</th></tr></thead><tbody>';
sent.forEach(s=>{
const patient = patients.find(p=>p.id===s.patientId) || {name: '‚Äî', phone: s.phone, date:'', time:''};
const when = new Date(s.sentAt);
html += `<tr>
<td>${escapeHtml(patient.name)}</td>
<td>${escapeHtml(formatPhoneMask(patient.phone || s.phone))}</td>
<td>${escapeHtml(when.toLocaleString())}</td>
<td>${escapeHtml(formatDateDisplay(patient.date))}</td>
<td>${escapeHtml(formatTimeDisplay(patient.time))}</td>
</tr>`;
});
html += '</tbody></table>';
}

// download buttons
html += `<div style="margin-top:14px;display:flex;gap:8px">
<button class="btn" id="exportJson">Exportar JSON</button>
<button class="btn secondary" id="exportCsv">Exportar CSV</button>
</div>`;

content.innerHTML = html;
modalBackdrop.style.display = 'flex';

document.getElementById('exportJson').onclick = ()=>{
const data = {patients: loadPatients(), sent: loadSent()};
const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url; a.download = 'relatorio_fisio.json';
document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
document.getElementById('exportCsv').onclick = ()=>{
const patients = loadPatients();
let csv = 'Nome,Telefone,Data,Hor√°rio,Status\n';
patients.forEach(p=>{
csv += `"${p.name}","${formatPhoneMask(p.phone)}","${formatDateDisplay(p.date)}","${formatTimeDisplay(p.time)}","${p.sent? 'Enviado':'Pendente'}"\n`;
});
const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href = url; a.download = 'agendados_fisio.csv';
document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
}

/* ---------- limpar storage ---------- */
document.getElementById('btnClear').addEventListener('click', ()=>{
if(!confirm('Limpar todos os cadastros e registros de envio?')) return;
localStorage.removeItem(STORAGE_PATIENTS);
localStorage.removeItem(STORAGE_SENT);
renderList();
});

/* ---------- helpers ---------- */
function escapeHtml(str){
if(!str) return '';
return String(str)
.replace(/&/g,'&amp;')
.replace(/</g,'&lt;')
.replace(/>/g,'&gt;')
.replace(/"/g,'&quot;')
.replace(/'/g,'&#039;');
}

/* ---------- init ---------- */
(function init(){
// ensure storage initialised
if(!localStorage.getItem(STORAGE_PATIENTS)) savePatients([]);
if(!localStorage.getItem(STORAGE_SENT)) saveSent([]);

renderList();

// preview area initial
document.getElementById('previewText').textContent = 'Preencha os campos e clique em "Ver mensagem" para conferir antes de enviar.';

// accessibility: close modal on backdrop click
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) modalBackdrop.style.display='none' });
})();
</script>
</body>
</html>
