<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Importador EFD-Contribuições</title>
<!-- GovBR-like palette -->
<style>
:root{
--gov-azul:#0070b8;
--gov-azul-escuro:#005288;
--gov-cinza:#f1f1f1;
--gov-cinza-escuro:#6c757d;
--gov-branco:#fff;
--gov-verde:#2e8540;
}
body{
font-family:'Roboto','Helvetica Neue',Arial,sans-serif;
background:var(--gov-cinza);
margin:0;
}
header{
background:var(--gov-azul);
color:var(--gov-branco);
padding:1rem 2rem;
}
h1{margin:0;font-size:1.4rem;}
main{padding:2rem;}
button, input[type="file"]{
background:var(--gov-azul);
color:var(--gov-branco);
border:none;
padding:.6rem 1.2rem;
margin-right:.5rem;
cursor:pointer;
border-radius:4px;
font-size:.9rem;
}
button:hover{background:var(--gov-azul-escuro);}
table{
width:100%;
border-collapse:collapse;
margin-top:1rem;
background:var(--gov-branco);
}
th,td{
padding:.55rem .7rem;
border:1px solid var(--gov-cinza-escuro);
text-align:left;
font-size:.88rem;
}
th{background:var(--gov-azul);color:#fff;}
tfoot td{
font-weight:700;
background:var(--gov-cinza);
}
.search-box{
margin-top:1rem;
}
.search-box input{
padding:.5rem .6rem;
width:200px;
}
fieldset{
border:1px solid var(--gov-azul-escuro);
padding:1rem;
margin-bottom:1rem;
}
legend{font-weight:600;color:var(--gov-azul-escuro);}
</style>
</head>
<body>
<header><h1>Importador EFD-Contribuições (PIS/COFINS)</h1></header>

<main>
<fieldset>
<legend>1. Selecionar arquivo TXT</legend>
<input type="file" id="fileInput" accept=".txt">
</fieldset>

<fieldset>
<legend>2. Filtrar por CNPJ (prefixo 29.415.295/)</legend>
<div class="search-box">
<input type="text" id="cnpjSearch" placeholder="Digite CNPJ completo">
<button id="filterBtn">Filtrar</button>
</div>
</fieldset>

<fieldset>
<legend>3. Resultados por CST</legend>
<button id="exportBtn">Exportar CSV</button>
<table id="resultTable">
<thead><tr>
<th>CNPJ</th><th>CST</th><th>Qtde Registros</th><th>Total R$</th>
</tr></thead>
<tbody></tbody>
<tfoot><tr><td colspan="3">Total Geral</td><td id="grandTotal">0,00</td></tr></tfoot>
</table>
</fieldset>
</main>

<script>
let parsed=[],display=[];

document.getElementById('fileInput').addEventListener('change',e=>{
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=function(){
parsed=parseSped(this.result);
alert('Arquivo importado com sucesso!');
};
reader.readAsText(file);
});

document.getElementById('filterBtn').addEventListener('click',()=>{
const cnpj=document.getElementById('cnpjSearch').value.trim();
display=aggregate(parsed,cnpj);
renderTable(display);
});

document.getElementById('exportBtn').addEventListener('click',()=>{
const csv=toCSV(display);
const blob=new Blob([csv],{type:'text/csv'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download='efd_totais.csv';a.click();
URL.revokeObjectURL(url);
});

// ---- Funções principais ----
function parseSped(text){
const lines=text.split(/\r?\n/);
const data=[];
let cnpjAtual='';
for(const l of lines){
const campos=l.split('|');
const reg=campos[1]; // posição 1 = código do registro
if(reg==='0150'){ // |0150|cod_part|nome|cod_país|CNPJ|...
const cnpj=campos[5]||'';
cnpjAtual=cnpj.startsWith('29.415.295/')?cnpjAtual=cnpj:'';
}
if(cnpjAtual){
if(reg==='C170'||reg==='A170'||reg==='C175'){
const cst=campos[10]||''; // campo CST_PIS
const valor=parseFloat(campos[13]||'0');// campo VL_ITEM
data.push({cnpj:cnpjAtual,reg,cst,valor});
}
}
}
return data;
}

function aggregate(arr,cnpjFilter){
const map=new Map();
let grand=0;
arr.filter(r=>!cnpjFilter||r.cnpj===cnpjFilter)
.forEach(r=>{
if(!map.has(r.cnpj))map.set(r.cnpj,{});
const cmp=map.get(r.cnpj);
if(!cmp[r.cst])cmp[r.cst]={qt:0,vl:0};
cmp[r.cst].qt+=1;
cmp[r.cst].vl+=r.valor;
grand+=r.valor;
});
document.getElementById('grandTotal').textContent=grand.toLocaleString('pt-BR',{minimumFractionDigits:2});
// converte para array tabular
const out=[];
map.forEach((csts,cnpj)=>{
Object.entries(csts).forEach(([cst,obj])=>{
out.push({cnpj,cst,qtde:obj.qt,total:obj.vl});
});
});
return out;
}

function renderTable(rows){
const tbody=document.querySelector('#resultTable tbody');
tbody.innerHTML='';
rows.forEach(r=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${r.cnpj}</td><td>${r.cst}</td><td>${r.qtde}</td>
<td>${r.total.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>`;
tbody.appendChild(tr);
});
}

function toCSV(rows){
let csv='CNPJ,CST,Qtde Registros,Total\n';
rows.forEach(r=>csv+=`${r.cnpj},${r.cst},${r.qtde},${r.total.toFixed(2)}\n`);
return csv;
}
</script>
</body>
</html>
