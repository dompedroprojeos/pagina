<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Perdas - Rede Dom Pedro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.375;
            position: relative;
            min-height: 100vh;
            padding-bottom: 60px;
        }

        /* ESTILOS PARA IMPRESSÃO A4 COMPLETA */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0.5cm;
            }
            
            body {
                background: white !important;
                color: black !important;
                font-size: 9pt !important;
                line-height: 1.2 !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            /* OCULTA TUDO QUE NÃO É RESULTADO */
            header,
            .input-area,
            .btn,
            .button-group,
            .search-container,
            .btn-scroll,
            footer {
                display: none !important;
            }
            
            /* MOSTRA APENAS OS RESULTADOS */
            .table-container {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: white !important;
                page-break-inside: avoid;
            }
            
            /* CABEÇALHO ESPECIAL PARA IMPRESSÃO */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 10px;
                border-bottom: 2px solid #333;
                padding-bottom: 5px;
            }
            
            .print-header h1 {
                font-size: 14pt !important;
                margin: 0 0 3px 0 !important;
                color: black !important;
            }
            
            .print-header .subtitle {
                font-size: 8pt;
                color: #666;
            }
            
            /* AJUSTA TABELAS PARA CABER EM A4 */
            table {
                width: 100% !important;
                max-width: 100% !important;
                font-size: 6.5pt !important;
                border-collapse: collapse;
                page-break-inside: avoid;
                table-layout: fixed;
            }
            
            th, td {
                padding: 2px 1px !important;
                border: 0.5pt solid #999 !important;
                text-align: center;
                word-wrap: break-word;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            th {
                background: #f0f0f0 !important;
                color: black !important;
                font-size: 6pt !important;
                padding: 3px 1px !important;
                font-weight: bold;
            }
            
            /* LARGURAS FIXAS PARA COLUNAS */
            td:nth-child(1) { width: 8% !important; }  /* Data */
            td:nth-child(2), td:nth-child(6) { width: 3% !important; }  /* Med */
            td:nth-child(3), td:nth-child(7) { width: 7% !important; }  /* Litragens */
            td:nth-child(4) { width: 6% !important; }  /* Entrada */
            td:nth-child(5) { width: 6% !important; }  /* Estoque */
            td:nth-child(8), td:nth-child(9) { width: 6% !important; }  /* Saídas */
            td:nth-child(10) { width: 7% !important; } /* Diferença */
            td:nth-child(11), td:nth-child(12) { width: 6% !important; } /* Acumulados */
            td:nth-child(13), td:nth-child(14) { width: 8% !important; } /* Status e Obs */
            
            /* REDUZ ESPAÇAMENTOS */
            .empresa-section {
                margin: 5px 0 !important;
                padding-bottom: 5px !important;
            }
            
            .empresa-section h3 {
                font-size: 10pt !important;
                padding: 4px !important;
                margin: 0 0 3px 0 !important;
                background: #e0e0e0 !important;
                color: black !important;
            }
            
            .info-combustivel {
                padding: 3px !important;
                margin: 2px 0 !important;
                font-size: 7pt !important;
                border-left: 2px solid #999 !important;
            }
            
            .estatisticas {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 4px !important;
                margin: 5px 0 !important;
            }
            
            .estatistica-item {
                padding: 3px !important;
                font-size: 6.5pt !important;
            }
            
            .estatistica-valor {
                font-size: 12px !important;
            }
            
            .estatistica-label {
                font-size: 6pt !important;
            }
            
            /* PAINÉIS DE ALERTA NA IMPRESSÃO */
            .alerta-panel {
                padding: 4px !important;
                margin: 4px 0 !important;
                font-size: 7pt !important;
                border: 0.5pt solid #999 !important;
                page-break-inside: avoid;
            }
            
            .alerta-panel h4 {
                font-size: 8pt !important;
                margin: 0 0 3px 0 !important;
            }
            
            /* CORES PARA IMPRESSÃO PRETO E BRANCO */
            .verde-forte {
                background-color: #e0f0e0 !important;
                color: black !important;
                font-weight: bold;
                border-left: 2px solid #006400 !important;
            }
            
            .vermelho-forte {
                background-color: #f0e0e0 !important;
                color: black !important;
                font-weight: bold;
                border-left: 2px solid #8B0000 !important;
            }
            
            .falta-medida-alerta {
                background-color: #e0f0ff !important;
                color: black !important;
                font-weight: bold;
                border-left: 2px solid #00008B !important;
            }
            
            /* SÍMBOLOS PARA IDENTIFICAR CORES NA IMPRESSÃO */
            .verde-forte::after {
                content: " ▲";
                color: #006400;
                font-size: 5pt;
            }
            
            .vermelho-forte::after {
                content: " ▼";
                color: #8B0000;
                font-size: 5pt;
            }
            
            .falta-medida-alerta::before {
                content: "⚠ ";
                color: #00008B;
            }
            
            .relatorio-perdas {
                font-size: 7pt !important;
                padding: 5px !important;
                margin: 5px 0 !important;
                border: 0.5pt solid #999 !important;
            }
            
            /* EVITA QUEBRAS EM ELEMENTOS IMPORTANTES */
            .total-row,
            .grand-total-row {
                page-break-inside: avoid;
                background-color: #e0e0e0 !important;
            }
            
            /* LIMITA ALTURA MÁXIMA DAS LINHAS */
            tr {
                max-height: 15px !important;
            }
        }

        /* PreLoader */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .loader .progress-bar {
            width: 200px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .loader .progress-bar::after {
            content: '';
            display: block;
            width: 0%;
            height: 100%;
            background: #3498db;
            animation: progress 2s linear forwards;
        }

        @keyframes progress {
            to { width: 100%; }
        }

        .loader .title {
            margin-top: 15px;
            font-size: 20px;
            color: #3498db;
        }

        /* Cabeçalho e Rodapé */
        header, footer {
            background: linear-gradient(135deg, #ff7f50 0%, #ff4500 100%);
            color: #f4f4f9;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }

        header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-container img {
            height: 50px;
            margin-right: 10px;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #f4f4f9;
            text-align: center;
        }

        footer {
            padding: 10px 0;
            position: absolute;
            bottom: 0;
            width: 100%;
            font-size: 12px;
        }

        /* Container principal */
        .container {
            max-width: 1400px;
            margin: 15px auto;
            padding: 15px;
            border-radius: 6px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        /* Campo de busca */
        .search-container {
            margin-bottom: 15px;
            text-align: center;
            position: relative;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-container input {
            padding: 8px 30px 8px 12px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .search-container input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .search-container .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #3498db;
            font-size: 14px;
        }

        /* Área de entrada de dados */
        .input-area {
            margin-bottom: 15px;
            background-color: #f7f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        textarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            transition: border 0.3s;
            resize: vertical;
            font-family: monospace;
        }

        textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Botões */
        .button-group {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
        }

        .btn {
            padding: 8px 12px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 90px;
        }

        .btn-process {
            background-color: #3498db;
        }

        .btn-process:hover {
            background-color: #2980b9;
        }

        .btn-clear {
            background-color: #e74c3c;
        }

        .btn-clear:hover {
            background-color: #c0392b;
        }

        .btn-export {
            background-color: #27ae60;
        }

        .btn-export:hover {
            background-color: #219653;
        }

        .btn-print {
            background-color: #9b59b6;
        }

        .btn-print:hover {
            background-color: #8e44ad;
        }

        .btn-scroll {
            position: fixed;
            right: 15px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .btn-scroll-up {
            bottom: 60px;
        }

        .btn-scroll-down {
            top: 60px;
        }

        /* Tabelas */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            background: white;
            padding: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 11px;
        }

        th, td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #34495e;
            color: white;
            font-weight: 600;
            font-size: 10px;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .total-row {
            font-weight: bold;
            background-color: #e3f2fd;
        }

        .grand-total-row {
            font-weight: bold;
            background-color: #2c3e50;
            color: white;
            font-size: 11px;
        }

        /* Destaque para alertas */
        .verde-forte {
            background-color: #28a745 !important;
            color: white !important;
            font-weight: bold;
        }

        .vermelho-forte {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: bold;
        }

        .falta-medida-alerta {
            background-color: #007bff !important;
            color: white !important;
            font-weight: bold;
        }

        .alerta-normal {
            background-color: #d4edda;
            color: #155724;
        }

        .alerta-atencao {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .alerta-critico {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        /* Cabeçalhos de empresa */
        .empresa-section {
            margin-bottom: 20px;
        }

        .empresa-section h3 {
            margin: 0 0 8px 0;
            padding: 8px 10px;
            background-color: #34495e;
            color: white;
            border-radius: 4px 4px 0 0;
            font-size: 14px;
        }

        .info-combustivel {
            background-color: #f8f9fa;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #3498db;
            font-size: 12px;
            border-radius: 4px;
        }

        /* Painel de alertas */
        .alerta-panel {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .alerta-panel.critico {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .alerta-panel.falta-medida {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .alerta-panel h4 {
            margin: 0 0 8px 0;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .alerta-panel.critico h4 {
            color: #721c24;
        }

        .alerta-panel.falta-medida h4 {
            color: #0c5460;
        }

        /* Estatísticas */
        .estatisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }

        .estatistica-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .estatistica-valor {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .estatistica-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 3px;
        }

        /* Classes para impressão - escondidas na tela */
        .print-header {
            display: none;
        }
    </style>
</head>
<body>
    <!-- PreLoader -->
    <div id="preloader">
        <div class="loader">
            <div class="progress-bar"></div>
            <span class="title">Carregando...</span>
        </div>
    </div>

    <header>
        <div class="logo-container">
            <img src="https://rededompedro.com/wp-content/uploads/2023/08/logo-dom-pedro.png" alt="Logo Rede Dom Pedro">
            <h1><i class="fas fa-gas-pump"></i> Análise de Perdas - Rede Dom Pedro</h1>
        </div>
        <button class="btn-scroll btn-scroll-down" onclick="scrollToBottom()">
            <i class="fas fa-chevron-down"></i>
        </button>
    </header>

    <div class="container">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Buscar por empresa..." onkeyup="filterResults()">
            <i class="fas fa-search search-icon"></i>
        </div>

        <div class="input-area">
            <textarea id="data-input" placeholder="Cole os dados do relatório aqui..."></textarea>
            <div class="button-group">
                <button class="btn btn-process" onclick="processData()">
                    <i class="fas fa-cogs"></i> Analisar Dados
                </button>
                <button class="btn btn-clear" onclick="clearData()">
                    <i class="fas fa-trash-alt"></i> Limpar
                </button>
                <button class="btn btn-print" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn btn-export" onclick="exportData()">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
            </div>
        </div>

        <div id="tabela-container" class="table-container"></div>
    </div>

    <footer>
        <p>&copy; 2023 Rede Dom Pedro - Sistema de Análise de Perdas</p>
        <button class="btn-scroll btn-scroll-up" onclick="scrollToTop()">
            <i class="fas fa-chevron-up"></i>
        </button>
    </footer>

    <script>
        // Dicionário de empresas (mantido igual ao anterior que funcionava)
        const empresasNomes = {
            "50": "DOM PEDRO ITAGUARA",
            "2": "DOM PEDRO 1",
            "3": "DOM PEDRO ITATIAIUÇU",
            "4": "DOM PEDRO LEME",
            "5": "DOM PEDRO PINDA ROTA NORTE",
            "6": "DOM PEDRO 2",
            "7": "DOM PEDRO POUSO ALEGRE",
            "8": "DOM PEDRO ATIBAIA",
            "9": "DOM PEDRO ITAPEVA",
            "10": "DOM PEDRO CAETANÓPOLIS",
            "11": "DOM PEDRO BETIM 1 ROTA SUL",
            "13": "DOM PEDRO TURIM",
            "14": "DOM PEDRO SANTA LUZIA",
            "15": "DOM PEDRO SALINAS",
            "17": "DOM PEDRO APARECIDA",
            "18": "DOM PEDRO MURIAÉ",
            "19": "DOM PEDRO PARAOPEBA",
            "20": "DOM PEDRO CONTAGEM NORTE",
            "21": "DOM PEDRO CONTAGEM SUL",
            "22": "DOM PEDRO CAMBUÍ",
            "24": "DOM PEDRO GUARA RODOV.",
            "25": "DOM PEDRO PINDA ROTA SUL",
            "26": "DOM PEDRO MIRACATU ROTA NORTE",
            "27": "DOM PEDRO JK ESTIVA SUL",
            "28": "DOM PEDRO ALIANÇA",
            "29": "DOM PEDRO OLIVEIRA",
            "30": "DOM PEDRO CAMBUÍ URBANO 1",
            "31": "DOM PEDRO JAGUAQUARA",
            "32": "DOM PEDRO SÃO GONÇALO",
            "33": "DOM PEDRO NOVA SERRANA",
            "34": "DOM PEDRO IGARATINGA",
            "35": "DOM PEDRO CARMÓPOLIS",
            "36": "DOM PEDRO BETIM 2 ROTA SUL",
            "37": "DOM PEDRO PARAGOMINAS",
            "41": "DOM PEDRO DIVISA ALEGRE",
            "42": "DOM PEDRO CAMBUÍ URBANO 2",
            "43": "DOM PEDRO CONTAGEM FERNÃO DIAS",
            "44": "DOM PEDRO CACHOEIRA DE PAJEÚ",
            "45": "DOM PEDRO TOCANTINS",
            "48": "DOM PEDRO SANTO ESTEVÃO",
            "49": "DOM PEDRO SÃO GONÇALO URB.",
            "51": "DOM PEDRO SENADOR AMARAL",
            "54": "DOM PEDRO LORENA",
            "55": "DOM PEDRO DIVISA ALEGRE 2",
            "56": "DOM PEDRO INCONFIDENTES",
            "57": "DOM PEDRO JUIZ DE FORA URBANO",
            "58": "DOM PEDRO BUENO BRANDÃO",
            "59": "DOM PEDRO POUSO ALEGRE URBANO",
            "60": "DOM PEDRO CAMANDUCAIA URBANO 1",
            "61": "DOM PEDRO OURO FINO",
            "63": "DOM PEDRO CAMANDUCAIA URBANO 2",
            "64": "DOM PEDRO GUARÁ URBANO 2",
            "65": "DOM PEDRO GUARÁ URBANO 3",
            "66": "DOM PEDRO BRAGANÇA URBANO",
            "67": "DOM PEDRO JACAREÍ URBANO",
            "68": "DOM PEDRO ATIBAIA URBANO",
            "69": "DOM PEDRO POUSO ALEGRE URB 2",
            "70": "DOM PEDRO EXTREMA URBANO",
            "77": "DOM PEDRO POUSO ALEGRE URB 3",
            "78": "DOM PEDRO SALES OLIVEIRA",
            "79": "DOM PEDRO VITÓRIA DA CONQUISTA",
            "80": "DOM PEDRO JUIZ DE FORA RODOVIA",
            "81": "DOM PEDRO MONTES CLAROS",
            "82": "DOM PEDRO VARGEM",
            "83": "DOM PEDRO SÃO JORGE",
            "86": "DOM PEDRO S. JOSÉ DOS CAMPOS URB",
            "87": "DOM PEDRO FREI INOCÊNCIO",
            "88": "DOM PEDRO BRAGANÇA RODOVIA",
            "89": "DOM PEDRO BARRA MANSA NORTE",
            "90": "DOM PEDRO BARRA MANSA SUL",
            "91": "DOM PEDRO CONSELHEIRA LAFAIETE",
            "92": "DOM PEDRO PLANALTO",
            "93": "DOM PEDRO SANTO ESTEVÃO 2",
            "94": "DOM PEDRO SANTO ESTEVÃO 3",
            "95": "DOM PEDRO SÃO CRISTÓVÃO",
            "96": "DOM PEDRO BARREIRAS",
            "97": "DOM PEDRO DE POSTOS LTDA DP ITABERABA",
            "98": "DOM PEDRO DE POSTOS LTDA DP VALENCA",
            "99": "DOM PEDRO SAO GONCALO RODOVIA 2",
            "100": "DOM PEDRO SAO GONCALO RODOVIA 3",
            "102": "DOM PEDRO RUSSAS",
            "103": "DOM PEDRO INHAPIM",
            "104": "DOM PEDRO LUZ"
        };

        // Esconde o preloader
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
            }, 1000);
        });

        // Variáveis globais
        let dailyData = [];
        let empresaInfo = {};

        // FUNÇÃO PRINCIPAL DE PROCESSAMENTO (igual à anterior que funcionava)
        function processData() {
            console.log('Iniciando processamento...');
            const input = document.getElementById('data-input').value;
            const tabelaContainer = document.getElementById('tabela-container');
            
            // Mostra mensagem de processamento
            tabelaContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Processando dados...</p>';
            
            // Pequeno delay para garantir que a mensagem aparece
            setTimeout(() => {
                try {
                    analisarDadosCorretamente(input);
                } catch (error) {
                    console.error('Erro no processamento:', error);
                    tabelaContainer.innerHTML = `
                        <div class="alerta-panel critico">
                            <h4><i class="fas fa-exclamation-triangle"></i> Erro no Processamento</h4>
                            <p>Ocorreu um erro: ${error.message}</p>
                            <p>Verifique se os dados foram colados corretamente.</p>
                        </div>
                    `;
                }
            }, 100);
        }

        function analisarDadosCorretamente(texto) {
            console.log('Analisando dados...');
            const linhas = texto.split('\n');
            const tabelaContainer = document.getElementById('tabela-container');
            
            // Reset dados
            dailyData = [];
            empresaInfo = {};
            
            let empresaCodigo = null;
            let empresaNome = null;
            let combustivelInfo = null;
            let periodoInfo = null;
            let tanquesVinculados = null;
            let primeiroDia = null;
            let ultimoDia = null;
            
            // Variáveis para estatísticas
            let alertasCriticos = [];
            let alertasFaltaMedida = [];
            let totalPerda = 0;
            let totalSobra = 0;
            let diasCriticos = 0;
            let diasFaltaMedida = 0;
            let totalEntradas = 0;
            let totalSaidaBomba = 0;
            let totalSaidaTanque = 0;
            
            // Processa cada linha
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i].trim();
                
                // Procura por informações da empresa
                if (linha.includes("Empresa:") && linha.includes("DP")) {
                    console.log('Encontrou linha da empresa:', linha);
                    const match = linha.match(/Empresa:\s*(\d+)\s*-\s*(DP[^|]+)/i);
                    if (match) {
                        empresaCodigo = match[1].trim();
                        empresaNome = empresasNomes[empresaCodigo] || match[2].trim();
                        empresaInfo.nome = empresaNome;
                        console.log('Empresa encontrada:', empresaNome);
                    }
                }
                
                // Procura por informação de período
                else if (linha.includes("Período:")) {
                    periodoInfo = linha.replace("Período:", "").trim();
                    empresaInfo.periodo = periodoInfo;
                    console.log('Período encontrado:', periodoInfo);
                }
                
                // Procura por informação de combustível
                else if (linha.includes("Combustível:")) {
                    const combustivelMatch = linha.match(/Combustível:\s*\d+\s*-\s*([^|]+)/i);
                    if (combustivelMatch) {
                        combustivelInfo = combustivelMatch[1].trim();
                        empresaInfo.combustivel = combustivelInfo;
                        console.log('Combustível encontrado:', combustivelInfo);
                    }
                }
                
                // Procura por tanques vinculados
                else if (linha.includes("Tanques vinculados:")) {
                    const tanquesMatch = linha.match(/Tanques vinculados:\s*(\d+)/i);
                    if (tanquesMatch) {
                        tanquesVinculados = tanquesMatch[1].trim();
                        empresaInfo.tanques = tanquesVinculados;
                        console.log('Tanques encontrados:', tanquesVinculados);
                    }
                }
                
                // Procura por linhas de dados (começam com | e tem data no formato DD/MM/AAAA)
                else if (linha.startsWith('|') && /\d{2}\/\d{2}\/\d{4}/.test(linha)) {
                    console.log('Encontrou linha de dados:', linha.substring(0, 50) + '...');
                    
                    // Remove os pipes das extremidades
                    const linhaLimpa = linha.replace(/^\||\|$/g, '').trim();
                    const partes = linhaLimpa.split('|').map(p => p.trim());
                    
                    if (partes.length >= 9) { // Mínimo necessário
                        const data = partes[0];
                        
                        if (!primeiroDia) primeiroDia = data;
                        ultimoDia = data;
                        
                        // Parse dos valores
                        const medInicial = partes[1] || '0';
                        const litragemInicial = parseNumber(partes[2]);
                        const entrada = parseNumber(partes[3]);
                        const estoque = parseNumber(partes[4]);
                        const medFinal = partes[5] || '0';
                        const litragemFinal = parseNumber(partes[6]);
                        const saidaBomba = parseNumber(partes[7]);
                        const saidaTanque = parseNumber(partes[8]);
                        const diferencaRelatorio = partes.length > 9 ? parseNumber(partes[9]) : 0;
                        const acumulado = partes.length > 10 ? parseNumber(partes[10]) : 0;
                        const difAcum = partes.length > 11 ? parseNumber(partes[11]) : 0;
                        
                        // Calcula a diferença correta
                        const diferencaCalculada = saidaBomba - saidaTanque;
                        
                        // Verifica falta de medida
                        const faltaMedida = litragemFinal === 0;
                        
                        // Verifica perda crítica
                        const perdaCritica = diferencaCalculada < -2000;
                        
                        // Classifica
                        let tipo = '';
                        let cor = '';
                        let status = '';
                        
                        if (faltaMedida) {
                            tipo = 'FALTA MEDIDA';
                            cor = 'falta-medida-alerta';
                            status = 'Litragem Final = 0,000';
                            diasFaltaMedida++;
                            alertasFaltaMedida.push({ data: data });
                        } else if (diferencaCalculada > 0) {
                            tipo = 'SOBRA';
                            cor = 'verde-forte';
                            status = `Bomba > Tanque em ${formatNumber(diferencaCalculada)} L`;
                            totalSobra += diferencaCalculada;
                        } else if (diferencaCalculada < 0) {
                            tipo = 'PERDA';
                            cor = 'vermelho-forte';
                            status = `Tanque > Bomba em ${formatNumber(Math.abs(diferencaCalculada))} L`;
                            totalPerda += Math.abs(diferencaCalculada);
                            
                            if (perdaCritica) {
                                diasCriticos++;
                                alertasCriticos.push({ data: data, perda: Math.abs(diferencaCalculada) });
                            }
                        } else {
                            tipo = 'ZERO';
                            status = 'Sem diferença';
                        }
                        
                        // Atualiza totais
                        totalEntradas += entrada;
                        totalSaidaBomba += saidaBomba;
                        totalSaidaTanque += saidaTanque;
                        
                        // Armazena dados
                        dailyData.push({
                            data,
                            medInicial,
                            litragemInicial: litragemInicial,
                            entrada,
                            estoque,
                            medFinal,
                            litragemFinal,
                            saidaBomba,
                            saidaTanque,
                            diferenca: diferencaCalculada,
                            diferencaRelatorio,
                            acumulado,
                            difAcum,
                            tipo,
                            cor,
                            status,
                            faltaMedida,
                            perdaCritica
                        });
                        
                        console.log(`Dia ${data} processado: ${tipo} ${formatNumber(diferencaCalculada)}L`);
                    }
                }
            }
            
            // Verifica se encontrou dados
            if (dailyData.length === 0) {
                tabelaContainer.innerHTML = `
                    <div class="alerta-panel">
                        <h4><i class="fas fa-exclamation-circle"></i> Nenhum dado encontrado</h4>
                        <p>Verifique se:</p>
                        <ol>
                            <li>Os dados foram colados completamente</li>
                            <li>O formato corresponde ao exemplo mostrado</li>
                            <li>As linhas começam com | e contém datas no formato DD/MM/AAAA</li>
                        </ol>
                    </div>
                `;
                return;
            }
            
            console.log(`Processados ${dailyData.length} dias`);
            
            // Calcula totais finais
            const totalDiferenca = totalSaidaBomba - totalSaidaTanque;
            
            // Monta o HTML do resultado
            let html = '';
            
            // Adiciona cabeçalho de impressão (só aparece na impressão)
            html += `
                <div class="print-header">
                    <h1>RELATÓRIO DE ANÁLISE DE PERDAS</h1>
                    <div class="subtitle">
                        Rede Dom Pedro | ${empresaNome || 'Empresa não identificada'} | 
                        ${periodoInfo || ''} | Data: ${new Date().toLocaleDateString('pt-BR')}
                    </div>
                </div>
            `;
            
            // Cabeçalho da empresa
            html += `<div class="empresa-section">`;
            html += `<h3><i class="fas fa-building"></i> ${empresaNome || 'Empresa não identificada'}</h3>`;
            
            // Informações
            html += `<div class="info-combustivel">`;
            if (periodoInfo) html += `<div><strong>Período:</strong> ${periodoInfo}</div>`;
            if (combustivelInfo) html += `<div><strong>Combustível:</strong> ${combustivelInfo}</div>`;
            if (tanquesVinculados) html += `<div><strong>Tanques:</strong> ${tanquesVinculados}</div>`;
            html += `<div><strong>Dias analisados:</strong> ${dailyData.length}</div>`;
            html += `<div><strong>Data da análise:</strong> ${new Date().toLocaleDateString('pt-BR')}</div>`;
            html += `</div>`;
            
            // Painel de alertas - Falta de Medida
            if (alertasFaltaMedida.length > 0) {
                html += `<div class="alerta-panel falta-medida">`;
                html += `<h4><i class="fas fa-exclamation-triangle"></i> FALTA DE LANÇAMENTO DE MEDIDA</h4>`;
                html += `<p><strong>${alertasFaltaMedida.length} dia(s) com litragem final = 0,000</strong></p>`;
                html += `<p><em>Ação necessária: Lançar a medida do tanque para estes dias.</em></p>`;
                html += `</div>`;
            }
            
            // Painel de alertas - Perdas Críticas
            if (alertasCriticos.length > 0) {
                html += `<div class="alerta-panel critico">`;
                html += `<h4><i class="fas fa-exclamation-triangle"></i> PERDAS CRÍTICAS (> 2.000 L)</h4>`;
                html += `<p><strong>${alertasCriticos.length} dia(s) com perda crítica</strong></p>`;
                html += `<ul>`;
                alertasCriticos.forEach(a => {
                    html += `<li><strong>${a.data}</strong>: ${formatNumber(a.perda)} L de perda</li>`;
                });
                html += `</ul>`;
                html += `<p><em>Ação necessária: Investigar possíveis vazamentos ou erros de medição.</em></p>`;
                html += `</div>`;
            }
            
            // Estatísticas
            html += `<div class="estatisticas">`;
            html += `
                <div class="estatistica-item">
                    <div class="estatistica-valor">${dailyData.length}</div>
                    <div class="estatistica-label">Dias Analisados</div>
                </div>
                <div class="estatistica-item">
                    <div class="estatistica-valor ${totalDiferenca > 0 ? 'verde-forte' : 'vermelho-forte'}">
                        ${formatNumber(totalDiferenca)}
                    </div>
                    <div class="estatistica-label">Diferença Total (L)</div>
                </div>
                <div class="estatistica-item">
                    <div class="estatistica-valor falta-medida-alerta">${diasFaltaMedida}</div>
                    <div class="estatistica-label">Falta Medida</div>
                </div>
                <div class="estatistica-item">
                    <div class="estatistica-valor vermelho-forte">${diasCriticos}</div>
                    <div class="estatistica-label">Dias Críticos</div>
                </div>
            `;
            html += `</div>`;
            
            // Tabela de dados
            html += `<table>`;
            html += `
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Med.I</th>
                        <th>Lit.Ini</th>
                        <th>Entrada</th>
                        <th>Estoque</th>
                        <th>Med.F</th>
                        <th>Lit.Fin</th>
                        <th>Bomba</th>
                        <th>Tanque</th>
                        <th>Diferença</th>
                        <th>Acum.</th>
                        <th>Dif.Acum</th>
                        <th>Tipo</th>
                        <th>Observações</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // Adiciona cada linha de dados
            dailyData.forEach(d => {
                const classeLitragemFinal = d.faltaMedida ? 'falta-medida-alerta' : '';
                
                html += `<tr>`;
                html += `<td>${d.data}</td>`;
                html += `<td>${d.medInicial}</td>`;
                html += `<td>${formatNumber(d.litragemInicial)}</td>`;
                html += `<td>${formatNumber(d.entrada)}</td>`;
                html += `<td>${formatNumber(d.estoque)}</td>`;
                html += `<td>${d.medFinal}</td>`;
                html += `<td class="${classeLitragemFinal}">${formatNumber(d.litragemFinal)}</td>`;
                html += `<td>${formatNumber(d.saidaBomba)}</td>`;
                html += `<td>${formatNumber(d.saidaTanque)}</td>`;
                html += `<td class="${d.cor}">${formatNumber(d.diferenca)}</td>`;
                html += `<td>${formatNumber(d.acumulado)}</td>`;
                html += `<td>${formatNumber(d.difAcum)}</td>`;
                html += `<td class="${d.cor}"><strong>${d.tipo}</strong></td>`;
                html += `<td style="text-align: left; font-size: 10px;">${d.status}</td>`;
                html += `</tr>`;
            });
            
            // Linha de totais
            html += `<tr class="total-row">`;
            html += `<td><strong>TOTAIS</strong></td>`;
            html += `<td colspan="2"></td>`;
            html += `<td><strong>${formatNumber(totalEntradas)}</strong></td>`;
            html += `<td></td>`;
            html += `<td colspan="2"></td>`;
            html += `<td><strong>${formatNumber(totalSaidaBomba)}</strong></td>`;
            html += `<td><strong>${formatNumber(totalSaidaTanque)}</strong></td>`;
            html += `<td class="${totalDiferenca > 0 ? 'verde-forte' : 'vermelho-forte'}"><strong>${formatNumber(totalDiferenca)}</strong></td>`;
            html += `<td colspan="4"></td>`;
            html += `</tr>`;
            
            html += `</tbody></table>`;
            
            // Resumo final
            html += `<div class="info-combustivel" style="margin-top: 20px;">`;
            html += `<h4><i class="fas fa-chart-bar"></i> RESUMO FINAL</h4>`;
            html += `<p><strong>Diferença Total do Período:</strong> `;
            if (totalDiferenca > 0) {
                html += `<span class="verde-forte" style="padding: 2px 5px;">SOBRA de ${formatNumber(totalDiferenca)} L</span>`;
            } else if (totalDiferenca < 0) {
                html += `<span class="vermelho-forte" style="padding: 2px 5px;">PERDA de ${formatNumber(Math.abs(totalDiferenca))} L</span>`;
            } else {
                html += `<span>Sem diferença</span>`;
            }
            html += `</p>`;
            
            html += `<p><strong>Interpretação das Cores:</strong> `;
            html += `<span class="verde-forte" style="padding: 2px 5px;">VERDE = SOBRA</span> | `;
            html += `<span class="vermelho-forte" style="padding: 2px 5px;">VERMELHO = PERDA</span> | `;
            html += `<span class="falta-medida-alerta" style="padding: 2px 5px;">AZUL = FALTA MEDIDA</span></p>`;
            
            if (diasFaltaMedida > 0) {
                html += `<p><strong>Atenção:</strong> ${diasFaltaMedida} dia(s) sem lançamento de medida do tanque.</p>`;
            }
            
            html += `</div>`;
            
            // Atualiza o container
            tabelaContainer.innerHTML = html;
            
            console.log('Processamento concluído com sucesso!');
        }

        // Funções auxiliares (mantidas do código anterior que funcionava)
        function parseNumber(valor) {
            if (!valor || valor === '0,000' || valor === '0.000' || valor === '0') return 0;
            let texto = valor.toString().trim();
            texto = texto.replace(/\./g, '').replace(',', '.');
            return parseFloat(texto) || 0;
        }

        function formatNumber(num) {
            return num.toLocaleString('pt-BR', {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            });
        }

        function clearData() {
            document.getElementById('data-input').value = '';
            document.getElementById('tabela-container').innerHTML = '';
            dailyData = [];
            empresaInfo = {};
        }

        function filterResults() {
            const input = document.getElementById('search-input').value.toLowerCase();
            const empresas = document.querySelectorAll('.empresa-section h3');
            
            empresas.forEach(empresaHeader => {
                const empresa = empresaHeader.textContent.toLowerCase();
                const empresaSection = empresaHeader.closest('.empresa-section');
                if (empresaSection) {
                    empresaSection.style.display = empresa.includes(input) ? '' : 'none';
                }
            });
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function exportData() {
            if (dailyData.length === 0) {
                alert('Não há dados para exportar! Analise os dados primeiro.');
                return;
            }
            
            let texto = `RELATÓRIO DE ANÁLISE DE PERDAS - REDE DOM PEDRO\n`;
            texto += `==================================================\n\n`;
            texto += `Empresa: ${empresaInfo.nome || 'Não identificada'}\n`;
            texto += `Período: ${empresaInfo.periodo || 'Não informado'}\n`;
            texto += `Data da análise: ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            
            texto += `DETALHAMENTO DIÁRIO:\n`;
            texto += `-------------------\n`;
            texto += `Data       | Lit.Final | Bomba     | Tanque    | Diferença | Tipo\n`;
            texto += `--------------------------------------------------------------\n`;
            
            dailyData.forEach(d => {
                texto += `${d.data} | ${formatNumber(d.litragemFinal).padStart(9)} | ${formatNumber(d.saidaBomba).padStart(9)} | ${formatNumber(d.saidaTanque).padStart(9)} | ${formatNumber(d.diferenca).padStart(9)} | ${d.tipo}\n`;
            });
            
            const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Analise_Perdas_${(empresaInfo.nome || 'Empresa').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
