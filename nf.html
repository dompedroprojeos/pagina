<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador Profissional NF-e · Waldeci Ramos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(145deg, #0d1b2a 0%, #1b2b3f 50%, #2a3b4f 100%);
            min-height: 100vh;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, rgba(100, 150, 255, 0.15) 0%, transparent 30%),
                        radial-gradient(circle at 80% 70%, rgba(150, 100, 255, 0.15) 0%, transparent 30%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            padding: 2rem;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 1rem;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            width: 60px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            transform: rotate(5deg);
            transition: transform 0.3s;
        }

        .logo-icon:hover {
            transform: rotate(0deg) scale(1.05);
        }

        .logo-text h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(145deg, #1e293b, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .logo-text span {
            font-size: 0.9rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-sistema {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 60px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        /* Card de Busca Inteligente */
        .search-smart-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 40px;
            padding: 2rem;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .search-smart-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1.5rem;
        }

        .search-smart-title i {
            font-size: 2rem;
            color: #2563eb;
            background: rgba(37, 99, 235, 0.1);
            padding: 15px;
            border-radius: 20px;
        }

        .search-smart-title h2 {
            font-size: 1.8rem;
            color: #0f172a;
        }

        .search-smart-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-smart-input {
            flex: 1;
            padding: 1.2rem 2rem;
            border: 3px solid #e2e8f0;
            border-radius: 60px;
            font-size: 1.1rem;
            transition: all 0.3s;
            background: white;
        }

        .search-smart-input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 5px rgba(37, 99, 235, 0.1);
        }

        .search-smart-btn {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            padding: 1.2rem 3rem;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
        }

        .search-smart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.4);
        }

        .search-examples {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .search-examples span {
            background: #f1f5f9;
            padding: 5px 15px;
            border-radius: 30px;
            margin: 0 5px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }

        .search-examples span:hover {
            background: #2563eb;
            color: white;
        }

        .result-card {
            background: white;
            border-radius: 30px;
            padding: 2rem;
            border: 2px solid #e2e8f0;
            margin-top: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-count {
            background: #2563eb;
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .result-item {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border-radius: 25px;
            padding: 1.8rem;
            margin-bottom: 1.5rem;
            border-left: 10px solid;
            transition: all 0.3s;
            border-left-color: #2563eb;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .result-item.ativo { border-left-color: #059669; }
        .result-item.combustivel { border-left-color: #7c3aed; }
        .result-item.revenda { border-left-color: #2563eb; }
        .result-item.transferencia { border-left-color: #0891b2; }
        .result-item.consumo { border-left-color: #f97316; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-field {
            background: white;
            padding: 1rem;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .info-field .label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-field .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0f172a;
            margin-top: 5px;
        }

        .info-field .value small {
            font-size: 0.9rem;
            color: #64748b;
        }

        .tag-natureza {
            background: #2563eb;
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            display: inline-block;
        }

        .obs-tag {
            background: #f97316;
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .destaque-ativo {
            background: linear-gradient(145deg, #059669, #047857);
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card {
            background: white;
            border-radius: 40px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.5rem;
            color: #0f172a;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 3px solid #e2e8f0;
            padding-bottom: 1rem;
        }

        textarea {
            width: 100%;
            height: 350px;
            padding: 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            background: #f8fafc;
            transition: all 0.3s;
        }

        textarea:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .btn-consultar {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            padding: 1.3rem 3.5rem;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.4);
            margin: 2rem 0;
        }

        .btn-consultar:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.5);
        }

        .btn-novo {
            background: linear-gradient(145deg, #f97316, #ea580c);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
        }

        .tabela-produtos {
            width: 100%;
            border-collapse: collapse;
            border-radius: 20px;
            overflow: hidden;
        }

        .tabela-produtos th {
            background: linear-gradient(145deg, #0f172a, #1e293b);
            color: white;
            padding: 16px 8px;
        }

        .tabela-produtos td {
            padding: 14px 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .conta-sugerida {
            background: linear-gradient(145deg, #059669, #047857);
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            display: inline-block;
        }

        .grid-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .footer {
            margin-top: 3rem;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border-radius: 40px;
        }

        .footer .assinatura {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #2563eb;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo-area">
            <div class="logo-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="logo-text">
                <h1>Analisador Profissional NF-e</h1>
                <span><i class="fas fa-code"></i> Criação: Waldeci Ramos <i class="fas fa-heart" style="color: #ef4444;"></i></span>
            </div>
        </div>
        <div class="badge-sistema">
            <i class="fas fa-crown"></i> Versão Enterprise
            <i class="fas fa-shield-alt"></i>
        </div>
    </div>

    <!-- BUSCA INTELIGENTE - ÚNICA -->
    <div class="search-smart-card">
        <div class="search-smart-title">
            <i class="fas fa-brain"></i>
            <h2>Busca Inteligente <span style="font-size: 1rem; color: #64748b;">(digite qualquer código)</span></h2>
        </div>
        
        <div class="search-smart-container">
            <input type="text" id="smartSearch" class="search-smart-input" 
                   placeholder="Digite CFOP origem, CFOP lançamento, conta... ex: 5908, 1.556, 5101, 1551, 2.652">
            <button class="search-smart-btn" onclick="buscaInteligente()">
                <i class="fas fa-search"></i> Consultar
            </button>
        </div>
        
        <div class="search-examples">
            <span onclick="document.getElementById('smartSearch').value='5908'; buscaInteligente()">5908 (Remessa)</span>
            <span onclick="document.getElementById('smartSearch').value='1.556'; buscaInteligente()">1.556 (Consumo)</span>
            <span onclick="document.getElementById('smartSearch').value='1551'; buscaInteligente()">1551 (Ativo)</span>
            <span onclick="document.getElementById('smartSearch').value='5656'; buscaInteligente()">5656 (Combustível)</span>
            <span onclick="document.getElementById('smartSearch').value='1.102'; buscaInteligente()">1.102 (Revenda)</span>
            <span onclick="document.getElementById('smartSearch').value='5152'; buscaInteligente()">5152 (Arla)</span>
        </div>

        <div id="resultadoSmart" class="hidden">
            <!-- Resultados aparecem aqui -->
        </div>
    </div>

    <!-- ÁREA PARA COLAR A NF -->
    <div id="areaColagem" class="card">
        <h2><i class="fas fa-paste"></i> Cole a NF-e para análise completa</h2>
        <textarea id="inputNF" placeholder="Cole aqui a NF-e completa...">RECEBEMOS DE ABC EQUIPAMENTOS LTDA OS PRODUTOS CONSTANTES DA NOTA FISCAL INDICADA AO LADO.

NF-e
Nº 000.001.208
SÉRIE 1

ABC EQUIPAMENTOS LTDA
RUA MATIAS BARBOSA, 289 - FLORESTA
CEP: 31015160 - BELO HORIZONTE - MG

DANFE
Nº 000.001.208 SÉRIE 1

CHAVE DE ACESSO: 3124 1154 1474 0800 0110 5500 1000 0012 0810 0001 2098

NATUREZA DA OPERAÇÃO: VENDAS

DESTINATÁRIO: REDE DOM PEDRO DE POSTOS LTDA
CNPJ: 20.415.295/0071-87

CÁLCULO DO IMPOSTO
BASE DE CÁLCULO DO ICMS: 0,00
VALOR DO ICMS: 0,00
VALOR TOTAL DOS PRODUTOS: 295,00
VALOR DO FRETE: 60,00
VALOR TOTAL DA NOTA: 355,00

DADOS DOS PRODUTOS / SERVIÇOS
CÓD. PROD. DESCRIÇÃO DO PRODUTO/SERVIÇO CÓD. NCM CST CFOP UND QUANT. V. UNIT. V. TOTAL BC ICMS V. ICMS V. IPI ALIQ. ICMS
009 BICO ABASTECIMENTO 3/4 IMPORTADO 84818099 000 5102 UN 2 125,00 250,00 0,00 0,00 0,00 0,00
124 FUNIL DIVERSOS 84798999 000 5102 UN 1 45,00 45,00 0,00 0,00 0,00 0,00

DADOS ADICIONAIS</textarea>
        
        <div style="display: flex; justify-content: center;">
            <button class="btn-consultar" onclick="analisarNF()">
                <i class="fas fa-magic"></i> ANALISAR NOTA FISCAL COMPLETA
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ÁREA DE RESULTADOS DA NF -->
    <div id="areaResultados" class="hidden">
        <div class="card">
            <h2><i class="fas fa-boxes"></i> Detalhamento dos Produtos</h2>
            <div style="overflow-x: auto;">
                <div id="tabelaProdutos"></div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-chart-pie"></i> Resumo por Conta</h2>
            <div id="resumoContabil" class="grid-info"></div>
        </div>

        <div class="card">
            <h2><i class="fas fa-calculator"></i> Totais da Nota</h2>
            <div id="totaisNF" class="grid-info"></div>
        </div>

        <div style="text-align: center;">
            <button class="btn-novo" onclick="novaConsulta()">
                <i class="fas fa-redo-alt"></i> ANALISAR OUTRA NOTA
            </button>
        </div>
    </div>

    <div class="footer">
        <i class="fas fa-code"></i> Criação: <span class="assinatura">Waldeci Ramos</span> 
        <i class="fas fa-heart"></i> Todos os direitos reservados • 
        <i class="fas fa-calendar-alt"></i> 2025
    </div>
</div>

<script>
// ============================================
// BASE DE DADOS COMPLETA (TODAS AS REGRAS)
// ============================================

const TABELA_COMPLETA = [
    // USO/CONSUMO
    { cfopOrig: '5101', cstOrig: ['000','020','040','041','090'], cfopLanc: '5101', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '5102', cstOrig: ['000','020','040','041','090'], cfopLanc: '5102', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '5108', cstOrig: ['000','020','040','041','090'], cfopLanc: '5108', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '6101', cstOrig: ['000','020','040','041','090'], cfopLanc: '6101', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '6102', cstOrig: ['000','020','040','041','090'], cfopLanc: '6102', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '6108', cstOrig: ['000','020','040','041','090'], cfopLanc: '6108', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    
    // ATIVO / CONSUMO (com decisão)
    { cfopOrig: '5403', cstOrig: ['010','060','110','160','510','560'], cfopLanc: '5403', cstLanc: '060', csosnLanc: '0500', contaConsumo: '1.407', contaAtivo: '1.551', natureza: 'ATIVO/CONSUMO', obs: 'Verificar se é ativo', tipo: 'ativo' },
    { cfopOrig: '5404', cstOrig: ['010','060','110','160','510','560'], cfopLanc: '5404', cstLanc: '060', csosnLanc: '0500', contaConsumo: '1.407', contaAtivo: '1.551', natureza: 'ATIVO/CONSUMO', obs: 'Verificar se é ativo', tipo: 'ativo' },
    { cfopOrig: '5405', cstOrig: ['010','060','110','160','510','560'], cfopLanc: '5405', cstLanc: '060', csosnLanc: '0500', contaConsumo: '1.407', contaAtivo: '1.551', natureza: 'ATIVO/CONSUMO', obs: 'Verificar se é ativo', tipo: 'ativo' },
    { cfopOrig: '6403', cstOrig: ['010','060','110','160','510','560'], cfopLanc: '6403', cstLanc: '060', csosnLanc: '0500', contaConsumo: '2.407', contaAtivo: '2.551', natureza: 'ATIVO/CONSUMO', obs: 'Verificar se é ativo', tipo: 'ativo' },
    { cfopOrig: '6404', cstOrig: ['010','060','110','160','510','560'], cfopLanc: '6404', cstLanc: '060', csosnLanc: '0500', contaConsumo: '2.407', contaAtivo: '2.551', natureza: 'ATIVO/CONSUMO', obs: 'Verificar se é ativo', tipo: 'ativo' },
    { cfopOrig: '6405', cstOrig: ['010','060','110','160','510','560'], cfopLanc: '6405', cstLanc: '060', csosnLanc: '0500', contaConsumo: '2.407', contaAtivo: '2.551', natureza: 'ATIVO/CONSUMO', obs: 'Verificar se é ativo', tipo: 'ativo' },
    
    // CFOP 5.929 / 6.929
    { cfopOrig: '5929', cstOrig: 'CONSUMO', cfopLanc: '5929', cstLanc: '090', conta: '1.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '5929', cstOrig: 'ATIVO', cfopLanc: '5929', cstLanc: '060', conta: '1.407', natureza: 'CONSUMO PADRÃO', obs: '', tipo: 'consumo' },
    { cfopOrig: '6929', cstOrig: 'CONSUMO', cfopLanc: '6929', cstLanc: '090', conta: '2.556', natureza: 'USO/CONSUMO', obs: '', tipo: 'consumo' },
    { cfopOrig: '6929', cstOrig: 'ATIVO', cfopLanc: '6929', cstLanc: '060', conta: '2.407', natureza: 'CONSUMO PADRÃO', obs: '', tipo: 'consumo' },
    
    // CFOP 5.949 / 6.949
    { cfopOrig: '5949', cstOrig: 'CONSUMO', cfopLanc: '5949', cstLanc: '090', conta: '1.949', natureza: 'CFOP 5.949', obs: 'Sem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '5949', cstOrig: 'ATIVO', cfopLanc: '5949', cstLanc: '060', conta: '', natureza: 'CFOP 5.949', obs: 'Verificar conta', tipo: 'consumo' },
    { cfopOrig: '6949', cstOrig: 'CONSUMO', cfopLanc: '6949', cstLanc: '090', conta: '2.949', natureza: 'CFOP 6.949', obs: 'Sem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '6949', cstOrig: 'ATIVO', cfopLanc: '6949', cstLanc: '060', conta: '', natureza: 'CFOP 6.949', obs: 'Verificar conta', tipo: 'consumo' },
    
    // CFOP 5.908 / 6.908
    { cfopOrig: '5908', cstOrig: ['040','041'], cfopLanc: '5908', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.908', natureza: 'REMESSA', obs: 'Não tem contas a pagar', tipo: 'transferencia' },
    { cfopOrig: '6908', cstOrig: ['040','041'], cfopLanc: '6908', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.908', natureza: 'REMESSA', obs: 'Não tem contas a pagar', tipo: 'transferencia' },
    
    // CFOP 5.910 / 6.910
    { cfopOrig: '5910', cstOrig: ['000','020','040','041','090'], cfopLanc: '5910', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.910', natureza: 'CFOP 5.910', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '6910', cstOrig: ['000','020','040','041','090'], cfopLanc: '6910', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.910', natureza: 'CFOP 6.910', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    
    // CFOP 5.916 / 6.916
    { cfopOrig: '5916', cstOrig: ['000','020','040','041','090'], cfopLanc: '5916', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.916', natureza: 'CFOP 5.916', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '6916', cstOrig: ['000','020','040','041','090'], cfopLanc: '6916', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.916', natureza: 'CFOP 6.916', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    
    // CFOP 5.922 / 6.922
    { cfopOrig: '5922', cstOrig: ['000','020','040','041','090'], cfopLanc: '5922', cstLanc: '090', csosnLanc: '0101/0102', conta: '1.922', natureza: 'CFOP 5.922', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '6922', cstOrig: ['000','020','040','041','090'], cfopLanc: '6922', cstLanc: '090', csosnLanc: '0101/0102', conta: '2.922', natureza: 'CFOP 6.922', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    
    // CFOP 5.117 / 6.117
    { cfopOrig: '5117', cstOrig: 'CONSUMO', cfopLanc: '5117', cstLanc: '090', conta: '1.556', natureza: 'USO/CONSUMO', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '5117', cstOrig: 'ATIVO', cfopLanc: '5117', cstLanc: '060', conta: '1.407', natureza: 'CONSUMO PADRÃO', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '6117', cstOrig: 'CONSUMO', cfopLanc: '6117', cstLanc: '090', conta: '2.556', natureza: 'USO/CONSUMO', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    { cfopOrig: '6117', cstOrig: 'ATIVO', cfopLanc: '6117', cstLanc: '060', conta: '2.407', natureza: 'CONSUMO PADRÃO', obs: 'Não tem contas a pagar', tipo: 'consumo' },
    
    // CONSUMO COMBUSTÍVEL
    { cfopOrig: '5656', cstOrig: ['061','060'], cfopLanc: '5656', cstLanc: '061', conta: '1.653', natureza: 'CONSUMO COMBUSTÍVEL', obs: '', tipo: 'combustivel' },
    { cfopOrig: '6656', cstOrig: ['061','060'], cfopLanc: '6656', cstLanc: '061', conta: '2.653', natureza: 'CONSUMO COMBUSTÍVEL', obs: '', tipo: 'combustivel' },
    { cfopOrig: '5929', cstOrig: ['061','060'], cfopLanc: '5929', cstLanc: '061', conta: '1.653', natureza: 'CONSUMO COMBUSTÍVEL', obs: '', tipo: 'combustivel' },
    { cfopOrig: '6929', cstOrig: ['061','060'], cfopLanc: '6929', cstLanc: '061', conta: '2.653', natureza: 'CONSUMO COMBUSTÍVEL', obs: '', tipo: 'combustivel' },
    
    // REVENDA
    { cfopOrig: '5101', cstOrig: ['000'], cfopLanc: '5101', cstLanc: '000', conta: '1.102', natureza: 'REVENDA', obs: '', tipo: 'revenda' },
    { cfopOrig: '5102', cstOrig: ['000'], cfopLanc: '5102', cstLanc: '000', conta: '1.102', natureza: 'REVENDA', obs: '', tipo: 'revenda' },
    { cfopOrig: '6101', cstOrig: ['000'], cfopLanc: '6101', cstLanc: '000', conta: '2.102', natureza: 'REVENDA', obs: '', tipo: 'revenda' },
    { cfopOrig: '6102', cstOrig: ['000'], cfopLanc: '6102', cstLanc: '000', conta: '2.102', natureza: 'REVENDA', obs: '', tipo: 'revenda' },
    
    // CFOP 5.405 com CST específico
    { cfopOrig: '5405', cstOrig: ['060','160','360','560'], cfopLanc: '5405', cstLanc: '060', conta: '1.403', natureza: 'CFOP 5.405', obs: '', tipo: 'consumo' },
    { cfopOrig: '6405', cstOrig: ['060','160','360','560'], cfopLanc: '6405', cstLanc: '060', conta: '2.403', natureza: 'CFOP 6.405', obs: '', tipo: 'consumo' },
    
    // COMBUSTÍVEL com variações de CST
    { cfopOrig: '5655', cstOrig: ['010','110','510'], cfopLanc: '5655', cstLanc: '010', conta: '1.652', natureza: 'COMBUSTÍVEL', obs: 'CST 010', tipo: 'combustivel' },
    { cfopOrig: '5656', cstOrig: ['010','110','510'], cfopLanc: '5656', cstLanc: '010', conta: '1.652', natureza: 'COMBUSTÍVEL', obs: 'CST 010', tipo: 'combustivel' },
    { cfopOrig: '5655', cstOrig: ['030','130','530'], cfopLanc: '5655', cstLanc: '030', conta: '1.652', natureza: 'COMBUSTÍVEL', obs: 'CST 030', tipo: 'combustivel' },
    { cfopOrig: '5656', cstOrig: ['030','130','530'], cfopLanc: '5656', cstLanc: '030', conta: '1.652', natureza: 'COMBUSTÍVEL', obs: 'CST 030', tipo: 'combustivel' },
    { cfopOrig: '5655', cstOrig: ['060','160','560'], cfopLanc: '5655', cstLanc: '060', conta: '1.652', natureza: 'COMBUSTÍVEL', obs: 'CST 060', tipo: 'combustivel' },
    { cfopOrig: '5656', cstOrig: ['060','160','560'], cfopLanc: '5656', cstLanc: '060', conta: '1.652', natureza: 'COMBUSTÍVEL', obs: 'CST 060', tipo: 'combustivel' },
    { cfopOrig: '6655', cstOrig: ['010','110','510'], cfopLanc: '6655', cstLanc: '010', conta: '2.652', natureza: 'COMBUSTÍVEL', obs: 'CST 010', tipo: 'combustivel' },
    { cfopOrig: '6656', cstOrig: ['010','110','510'], cfopLanc: '6656', cstLanc: '010', conta: '2.652', natureza: 'COMBUSTÍVEL', obs: 'CST 010', tipo: 'combustivel' },
    { cfopOrig: '6655', cstOrig: ['030','130','530'], cfopLanc: '6655', cstLanc: '030', conta: '2.652', natureza: 'COMBUSTÍVEL', obs: 'CST 030', tipo: 'combustivel' },
    { cfopOrig: '6656', cstOrig: ['030','130','530'], cfopLanc: '6656', cstLanc: '030', conta: '2.652', natureza: 'COMBUSTÍVEL', obs: 'CST 030', tipo: 'combustivel' },
    { cfopOrig: '6655', cstOrig: ['060','160','560'], cfopLanc: '6655', cstLanc: '060', conta: '2.652', natureza: 'COMBUSTÍVEL', obs: 'CST 060', tipo: 'combustivel' },
    { cfopOrig: '6656', cstOrig: ['060','160','560'], cfopLanc: '6656', cstLanc: '060', conta: '2.652', natureza: 'COMBUSTÍVEL', obs: 'CST 060', tipo: 'combustivel' },
    
    // NOTAS RV
    { cfopOrig: '5949', cstOrig: ['090'], cfopLanc: '5949', cstLanc: '090', conta: '1.102', natureza: 'NOTAS RV', obs: '', tipo: 'revenda' },
    { cfopOrig: '6949', cstOrig: ['090'], cfopLanc: '6949', cstLanc: '090', conta: '2.102', natureza: 'NOTAS RV', obs: '', tipo: 'revenda' },
    
    // TRANSFERÊNCIA ARLA
    { cfopOrig: '5152', cstOrig: ['000'], cfopLanc: '5152', cstLanc: '000', conta: '1.152', natureza: 'TRANSFERÊNCIA ARLA', obs: '', tipo: 'transferencia' },
    { cfopOrig: '6152', cstOrig: ['000'], cfopLanc: '6152', cstLanc: '000', conta: '2.152', natureza: 'TRANSFERÊNCIA ARLA', obs: '', tipo: 'transferencia' },
    
    // TRANSFERÊNCIA LUBRIFICANTE
    { cfopOrig: '5659', cstOrig: ['060'], cfopLanc: '5659', cstLanc: '060', conta: '1.659', natureza: 'TRANSFERÊNCIA LUBRIFICANTE', obs: '', tipo: 'transferencia' },
    { cfopOrig: '6659', cstOrig: ['060'], cfopLanc: '6659', cstLanc: '060', conta: '2.659', natureza: 'TRANSFERÊNCIA LUBRIFICANTE', obs: '', tipo: 'transferencia' }
];

// Função para formatar CFOP
function formatarCFOP(cfop) {
    if (!cfop) return '';
    const cfopStr = String(cfop).replace(/[^\d]/g, '');
    if (cfopStr.length === 4) {
        return cfopStr.charAt(0) + '.' + cfopStr.slice(1);
    }
    return cfop;
}

// Função de busca inteligente
function buscaInteligente() {
    const termo = document.getElementById('smartSearch').value.trim();
    if (!termo) {
        alert('Digite um código para consultar');
        return;
    }

    const divResultado = document.getElementById('resultadoSmart');
    divResultado.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
    divResultado.classList.remove('hidden');

    // Limpa o termo de busca (remove pontos e espaços)
    const termoLimpo = termo.replace(/[^\d]/g, '');
    
    // Busca em todos os campos relevantes
    const resultados = TABELA_COMPLETA.filter(item => {
        // Busca por CFOP origem
        if (item.cfopOrig.includes(termoLimpo)) return true;
        if (formatarCFOP(item.cfopOrig).includes(termo)) return true;
        
        // Busca por CFOP lançamento
        if (item.cfopLanc.includes(termoLimpo)) return true;
        if (formatarCFOP(item.cfopLanc).includes(termo)) return true;
        
        // Busca por conta
        if (item.conta && item.conta.replace(/[^\d]/g, '').includes(termoLimpo)) return true;
        if (item.contaConsumo && item.contaConsumo.replace(/[^\d]/g, '').includes(termoLimpo)) return true;
        if (item.contaAtivo && item.contaAtivo.replace(/[^\d]/g, '').includes(termoLimpo)) return true;
        
        // Busca por CST
        if (Array.isArray(item.cstOrig)) {
            if (item.cstOrig.some(cst => cst.includes(termoLimpo))) return true;
        } else if (typeof item.cstOrig === 'string') {
            if (item.cstOrig.includes(termo)) return true;
        }
        
        return false;
    });

    if (resultados.length === 0) {
        divResultado.innerHTML = `
            <div class="result-card">
                <div style="text-align: center; padding: 3rem; color: #ef4444;">
                    <i class="fas fa-search fa-3x" style="margin-bottom: 1rem;"></i>
                    <h3>Nenhum resultado encontrado para "${termo}"</h3>
                    <p style="color: #64748b; margin-top: 1rem;">Tente: 5908, 1.556, 1551, 5101, 5656...</p>
                </div>
            </div>
        `;
        return;
    }

    let html = `
        <div class="result-card">
            <div class="result-header">
                <h3><i class="fas fa-check-circle" style="color: #059669;"></i> Resultados para "${termo}"</h3>
                <span class="result-count">${resultados.length} registro(s)</span>
            </div>
    `;

    resultados.forEach(item => {
        const temAtivo = item.contaAtivo || item.contaConsumo;
        const tipoClasse = item.tipo || 'consumo';
        
        html += `
            <div class="result-item ${tipoClasse}">
                <div class="info-grid">
                    <div class="info-field">
                        <div class="label">CFOP Origem</div>
                        <div class="value">${formatarCFOP(item.cfopOrig)}</div>
                    </div>
                    <div class="info-field">
                        <div class="label">CST Origem</div>
                        <div class="value">
                            ${Array.isArray(item.cstOrig) ? item.cstOrig.join(', ') : item.cstOrig}
                        </div>
                    </div>
                    <div class="info-field">
                        <div class="label">CFOP Lançamento</div>
                        <div class="value">${formatarCFOP(item.cfopLanc)}</div>
                    </div>
                    <div class="info-field">
                        <div class="label">CST Lançamento</div>
                        <div class="value">${item.cstLanc}</div>
                    </div>
                    <div class="info-field">
                        <div class="label">CSOSN</div>
                        <div class="value">${item.csosnLanc || '-'}</div>
                    </div>
                    <div class="info-field">
                        <div class="label">Conta Débito</div>
                        <div class="value">
                            ${item.conta ? `<span class="conta-sugerida">${item.conta}</span>` : ''}
                            ${item.contaConsumo ? `<div><small>Consumo: ${item.contaConsumo}</small></div>` : ''}
                            ${item.contaAtivo ? `<div><small>Ativo: ${item.contaAtivo}</small></div>` : ''}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <span class="tag-natureza">${item.natureza}</span>
                    ${item.obs ? `<span class="obs-tag">${item.obs}</span>` : ''}
                </div>
            </div>
        `;
    });

    // Verifica se é conta de ativo imobilizado
    if (termo.includes('1551') || termo.includes('1.551') || termo.includes('2551') || termo.includes('2.551') ||
        termo.includes('1406') || termo.includes('1.406') || termo.includes('2406') || termo.includes('2.406')) {
        html += `
            <div class="destaque-ativo">
                <i class="fas fa-info-circle fa-2x"></i>
                <div>
                    <strong>ATENÇÃO - CONTA DE ATIVO IMOBILIZADO:</strong><br>
                    Para CFOPs 5.403, 5.404, 5.405, 6.403, 6.404, 6.405 com CST 010,060,110,160,510,560:<br>
                    • Se for ATIVO → use ${termo.includes('1') ? '1.551' : '2.551'}<br>
                    • Se for CONSUMO → use ${termo.includes('1') ? '1.407' : '2.407'}<br>
                    CST Lançamento permanece 060 em ambos os casos.
                </div>
            </div>
        `;
    }

    html += '</div>';
    divResultado.innerHTML = html;
}

// Permitir busca com Enter
document.getElementById('smartSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        buscaInteligente();
    }
});

function analisarNF() {
    const textoNF = document.getElementById('inputNF').value;
    
    if (!textoNF.trim()) {
        alert('Cole a NF-e para análise.');
        return;
    }

    const produtos = extrairProdutos(textoNF);
    const produtosAnalisados = aplicarRegras(produtos);
    
    document.getElementById('tabelaProdutos').innerHTML = gerarTabelaProdutos(produtosAnalisados);
    document.getElementById('resumoContabil').innerHTML = gerarResumoContabil(produtosAnalisados);
    document.getElementById('totaisNF').innerHTML = gerarTotaisNF(calcularTotais(produtosAnalisados));
    
    document.getElementById('areaColagem').classList.add('hidden');
    document.getElementById('areaResultados').classList.remove('hidden');
}

function extrairProdutos(texto) {
    const linhas = texto.split('\n');
    const produtos = [];
    let dentroTabela = false;
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i].trim();
        
        if (linha.includes('DADOS DOS PRODUTOS')) {
            dentroTabela = true;
            continue;
        }
        
        if (dentroTabela && (linha.includes('DADOS ADICIONAIS') || linha.includes('INFORMAÇÕES COMPLEMENTARES'))) {
            break;
        }
        
        if (dentroTabela && linha.length > 20 && !linha.includes('CÓD. PROD.')) {
            const cfopMatch = linha.match(/\b([1-7]\.?\d{3})\b/);
            if (!cfopMatch) continue;
            
            const cfop = cfopMatch[1].replace('.', '');
            
            const partes = linha.split(/\s+/);
            let descricao = '';
            let ncm = '';
            let cst = '000';
            let quantidade = 0;
            let valorUnit = 0;
            let valorTotal = 0;
            
            for (let j = 0; j < partes.length; j++) {
                if (partes[j].match(/^\d{8}$/)) {
                    ncm = partes[j];
                    descricao = partes.slice(1, j).join(' ').replace(/^\d+\s*/, '');
                    
                    if (j + 1 < partes.length && partes[j+1].match(/^\d{2,3}$/)) {
                        cst = partes[j+1].padStart(3, '0');
                    }
                    break;
                }
            }
            
            const numeros = linha.match(/(\d+[,.]?\d*)/g);
            if (numeros && numeros.length >= 3) {
                quantidade = parseFloat(numeros[numeros.length-3].replace(',', '.'));
                valorUnit = parseFloat(numeros[numeros.length-2].replace(',', '.'));
                valorTotal = parseFloat(numeros[numeros.length-1].replace(',', '.'));
            }
            
            produtos.push({
                cfop: cfop,
                cst: cst,
                descricao: descricao || 'Produto',
                ncm: ncm,
                und: 'UN',
                quantidade: quantidade,
                valorUnit: valorUnit,
                valorTotal: valorTotal
            });
        }
    }
    
    return produtos;
}

function aplicarRegras(produtos) {
    return produtos.map(prod => {
        const regrasEncontradas = TABELA_COMPLETA.filter(item => item.cfopOrig === prod.cfop);
        
        if (regrasEncontradas.length === 0) {
            return {
                ...prod,
                contaSugerida: prod.cfop.charAt(0) === '5' ? '1.556' : '2.556',
                cstLancamento: '090',
                natureza: 'USO/CONSUMO (padrão)'
            };
        }

        let regraAplicada = null;
        for (const regra of regrasEncontradas) {
            if (Array.isArray(regra.cstOrig)) {
                if (regra.cstOrig.includes(prod.cst)) {
                    regraAplicada = regra;
                    break;
                }
            } else if (typeof regra.cstOrig === 'string') {
                if (regra.cstOrig === 'CONSUMO' && ['000','020','040','041','090'].includes(prod.cst)) {
                    regraAplicada = regra;
                    break;
                }
                if (regra.cstOrig === 'ATIVO' && ['010','060','110','160','510','560'].includes(prod.cst)) {
                    regraAplicada = regra;
                    break;
                }
            }
        }

        if (!regraAplicada) {
            regraAplicada = regrasEncontradas[0];
        }

        if (regraAplicada.contaAtivo && regraAplicada.contaConsumo) {
            const isAtivo = confirm(`Produto: ${prod.descricao}\nCFOP: ${formatarCFOP(prod.cfop)}\nCST: ${prod.cst}\n\nDeseja lançar como ATIVO IMOBILIZADO?`);
            return {
                ...prod,
                contaSugerida: isAtivo ? regraAplicada.contaAtivo : regraAplicada.contaConsumo,
                cstLancamento: regraAplicada.cstLanc,
                natureza: isAtivo ? 'ATIVO IMOBILIZADO' : 'CONSUMO'
            };
        }

        return {
            ...prod,
            contaSugerida: regraAplicada.conta || 'NÃO MAPEADO',
            cstLancamento: regraAplicada.cstLanc,
            natureza: regraAplicada.natureza
        };
    });
}

function gerarTabelaProdutos(produtos) {
    let html = `
        <table class="tabela-produtos">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Descrição</th>
                    <th>CFOP</th>
                    <th>CST</th>
                    <th>Qtde</th>
                    <th>Valor</th>
                    <th>Conta</th>
                    <th>CST Lanc</th>
                    <th>Natureza</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    produtos.forEach((prod, index) => {
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>${prod.descricao.substring(0, 30)}</td>
                <td>${formatarCFOP(prod.cfop)}</td>
                <td>${prod.cst}</td>
                <td>${prod.quantidade}</td>
                <td>R$ ${prod.valorTotal.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</td>
                <td><span class="conta-sugerida">${prod.contaSugerida}</span></td>
                <td>${prod.cstLancamento}</td>
                <td>${prod.natureza}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    return html;
}

function gerarResumoContabil(produtos) {
    const contas = {};
    
    produtos.forEach(prod => {
        const conta = prod.contaSugerida;
        if (!contas[conta]) {
            contas[conta] = {
                natureza: prod.natureza,
                total: 0
            };
        }
        contas[conta].total += prod.valorTotal;
    });
    
    let html = '';
    
    Object.keys(contas).sort().forEach(conta => {
        html += `
            <div class="info-box" style="border-left-color: #2563eb;">
                <div style="font-size: 1.2rem; font-weight: 600;">Conta ${conta}</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #059669; margin: 10px 0;">
                    R$ ${contas[conta].total.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
                </div>
                <div>${contas[conta].natureza}</div>
            </div>
        `;
    });
    
    return html;
}

function calcularTotais(produtos) {
    return {
        totalProdutos: produtos.reduce((acc, p) => acc + p.valorTotal, 0),
        quantidadeItens: produtos.length
    };
}

function gerarTotaisNF(totais) {
    return `
        <div class="info-box" style="border-left-color: #f97316;">
            <div style="font-size: 1rem; color: #64748b;">Total dos Produtos</div>
            <div style="font-size: 2rem; font-weight: 700; color: #2563eb;">
                R$ ${totais.totalProdutos.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
            </div>
            <div style="margin-top: 10px;">${totais.quantidadeItens} itens</div>
        </div>
    `;
}

function novaConsulta() {
    document.getElementById('inputNF').value = '';
    document.getElementById('areaColagem').classList.remove('hidden');
    document.getElementById('areaResultados').classList.add('hidden');
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sistema pronto - Busca inteligente ativada');
});
</script>
</body>
</html>
