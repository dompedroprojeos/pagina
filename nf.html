<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Analisador de NF ¬∑ Rede Dom Pedro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge-sistema {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 60px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .card {
            background: white;
            border-radius: 30px;
            padding: 1.8rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.3rem;
            color: #1e293b;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 3px solid #e2e8f0;
            padding-bottom: 0.8rem;
        }

        textarea {
            width: 100%;
            height: 250px;
            padding: 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            background: #f8fafc;
            transition: all 0.3s;
        }

        textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn-consultar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1.2rem 3rem;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            margin: 1.5rem 0;
        }

        .btn-consultar:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-consultar:active {
            transform: translateY(2px);
        }

        .btn-novo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 60px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        /* Estilo da NF visual */
        .nf-visual {
            background: #f1f5f9;
            border-radius: 24px;
            padding: 2rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 2px solid #cbd5e1;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        .nf-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 16px;
        }

        .nf-titulo {
            font-size: 1.4rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .tabela-produtos {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.8rem;
        }

        .tabela-produtos th {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 12px 6px;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tabela-produtos td {
            padding: 10px 6px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .tabela-produtos tr:hover td {
            background: #f8fafc;
        }

        .cfop-destaque {
            background: #1e293b;
            color: white;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 30px;
            display: inline-block;
            font-size: 0.8rem;
        }

        .conta-sugerida {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-block;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(5, 150, 105, 0.3);
        }

        .cst-origem {
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .card-resultado {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 24px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .grid-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-box {
            background: white;
            border-radius: 20px;
            padding: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 6px solid;
        }

        .info-box.venda { border-left-color: #3b82f6; }
        .info-box.ativo { border-left-color: #059669; }
        .info-box.consumo { border-left-color: #f59e0b; }

        .badge {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .footer {
            margin-top: 2rem;
            color: #94a3b8;
            font-size: 0.8rem;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .animacao-entrada {
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alerta-icms {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 8px solid #f59e0b;
            padding: 1.2rem;
            border-radius: 16px;
            margin: 1.2rem 0;
            font-weight: 600;
            color: #92400e;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>
        üìã Analisador Inteligente de NF-e
        <span class="badge-sistema">Rede Dom Pedro ¬∑ Valen√ßa</span>
    </h1>

    <!-- √ÅREA PARA COLAR A NF (ser√° ocultada ap√≥s processar) -->
    <div id="areaColagem" class="card">
        <h2>üìã 1. Cole a NF-e para an√°lise</h2>
        <textarea id="inputNF" placeholder="Cole aqui a NF-e completa...">RECEBEMOS DE ABC EQUIPAMENTOS LTDA OS PRODUTOS CONSTANTES DA NOTA FISCAL INDICADA AO LADO.
DATA DO RECEBIMENTO IDENTIFICA√á√ÉO E ASSINATURA DO RECEBEDOR

NF-e
N¬∫ 000.001.208
S√âRIE 1

ABC EQUIPAMENTOS LTDA
RUA MATIAS BARBOSA, 289 - FLORESTA
CEP: 31015160 - BELO HORIZONTE - MG
31986917777

DANFE
DOCUMENTO AUXILIAR DA NOTA
FISCAL ELETR√îNICA
0 - ENTRADA
1 - SA√çDA
1
N¬∫ 000.001.208
S√âRIE 1
CONTROLE DO FISCO

CHAVE DE ACESSO
3124 1154 1474 0800 0110 5500 1000 0012 0810 0001 2098

NATUREZA DA OPERA√á√ÉO:
VENDAS
PROTOCOLO DE AUTORIZA√á√ÉO DE USO:
131246312304784 22/11/2024 11:13:45
INSCRI√á√ÉO ESTADUAL:
0048356370060
CNPJ:
54.147.408/0001-10

DESTINAT√ÅRIO / REMETENTE
NOME/RAZ√ÉO SOCIAL:
REDE DOM PEDRO DE POSTOS LTDA
CNPJ/CPF:
20.415.295/0071-87
DATA DE EMISS√ÉO:
22/11/2024 00:00:00
ENDERE√áO:
RODOVIA BR-040, 23730
BAIRRO/DISTRITO:
BARREIRA
CEP:
36407-430
DATA DE SA√çDA/ENTRADA:
22/11/2024
MUNIC√çPIO:
CONSELHEIRO LAFAIETE
UF:
MG
INSCRI√á√ÉO ESTADUAL:
2450683035492

C√ÅLCULO DO IMPOSTO
BASE DE C√ÅLCULO DO ICMS:
0,00
VALOR DO ICMS:
0,00
VALOR TOTAL DOS PRODUTOS:
295,00
VALOR DO FRETE:
60,00
VALOR TOTAL DA NOTA:
355,00

DADOS DOS PRODUTOS / SERVI√áOS
C√ìD. PROD. DESCRI√á√ÉO DO PRODUTO/SERVI√áO C√ìD. NCM CST CFOP UND QUANT. V. UNIT. V. TOTAL
009 BICO ABASTECIMENTO 3/4 IMPORTADO 84818099 5.102 UN 2 125 250
124 FUNIL DIVERSOS 84798999 5.102 UN 1 45 45

DADOS ADICIONAIS
INFORMA√á√ïES COMPLEMENTARES:
EMPRESA ENQUADRADA NO SIMPLES NACIONAL</textarea>
        
        <div style="display: flex; justify-content: center;">
            <button class="btn-consultar" onclick="analisarNF()">
                üîç ANALISAR NOTA FISCAL
                <span style="font-size: 1.2rem;">‚Üí</span>
            </button>
        </div>
    </div>

    <!-- √ÅREA DE RESULTADOS (aparece ap√≥s processar) -->
    <div id="areaResultados" class="hidden">
        <!-- NF VISUAL (igual ao original) -->
        <div class="card">
            <h2>üìÑ 2. NF-e Processada</h2>
            <div id="nfVisual" class="nf-visual"></div>
            
            <!-- Bot√£o para nova consulta -->
            <div style="text-align: center;">
                <button class="btn-novo" onclick="novaConsulta()">
                    ‚ü≤ ANALISAR OUTRA NOTA
                </button>
            </div>
        </div>

        <!-- DETALHAMENTO DOS PRODUTOS -->
        <div class="card">
            <h2>üì¶ 3. Detalhamento dos Produtos</h2>
            <div id="tabelaProdutos"></div>
        </div>

        <!-- ALERTA ESPEC√çFICO (quando CFOP 5102) -->
        <div id="alertaEspecial" class="alerta-icms hidden">
            ‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Esta NF possui produtos com <strong>CFOP 5.102</strong>.
            O lan√ßamento correto √© na conta <strong style="font-size: 1.2rem;">1.551</strong> (cr√©dito de ICMS de ativo), N√ÉO na 1.406!
        </div>

        <!-- RESUMO CONT√ÅBIL -->
        <div class="card">
            <h2>üí∞ 4. Resumo dos Lan√ßamentos Cont√°beis</h2>
            <div id="resumoContabil" class="grid-info"></div>
        </div>

        <!-- TABELA DE CORRESPOND√äNCIA CFOP X CONTA -->
        <div class="card">
            <h2>üìö 5. Tabela de Correspond√™ncia CFOP ‚Üí Conta</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #1e293b; color: white;">
                        <th style="padding: 12px;">CFOP</th>
                        <th style="padding: 12px;">CST</th>
                        <th style="padding: 12px;">Natureza</th>
                        <th style="padding: 12px;">Conta D√©bito</th>
                        <th style="padding: 12px;">Conta Cr√©dito</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #dcfce7;">
                        <td style="padding: 10px; text-align: center;"><strong>5.102</strong></td>
                        <td style="padding: 10px; text-align: center;">000/020/040/041/090</td>
                        <td style="padding: 10px;">Ativo Imobilizado (com ICMS)</td>
                        <td style="padding: 10px; text-align: center;"><span class="conta-sugerida" style="background: #059669;">1.551</span></td>
                        <td style="padding: 10px; text-align: center;">1.1.01</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; text-align: center;"><strong>5.101</strong></td>
                        <td style="padding: 10px; text-align: center;">000/020/040/041/090</td>
                        <td style="padding: 10px;">Revenda (com ICMS)</td>
                        <td style="padding: 10px; text-align: center;"><span class="conta-sugerida" style="background: #2563eb;">1.102</span></td>
                        <td style="padding: 10px; text-align: center;">2.1.01</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; text-align: center;"><strong>5.405</strong></td>
                        <td style="padding: 10px; text-align: center;">060/110/160/510/560</td>
                        <td style="padding: 10px;">Uso/Consumo (sem ICMS)</td>
                        <td style="padding: 10px; text-align: center;"><span class="conta-sugerida" style="background: #7c3aed;">1.407</span></td>
                        <td style="padding: 10px; text-align: center;">2.1.02</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; text-align: center;"><strong>5.403</strong></td>
                        <td style="padding: 10px; text-align: center;">060/110/160/510/560</td>
                        <td style="padding: 10px;">Ativo Imobilizado (sem ICMS)</td>
                        <td style="padding: 10px; text-align: center;"><span class="conta-sugerida" style="background: #b45309;">1.406</span></td>
                        <td style="padding: 10px; text-align: center;">2.1.03</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; text-align: center;"><strong>5.656</strong></td>
                        <td style="padding: 10px; text-align: center;">060/061</td>
                        <td style="padding: 10px;">Combust√≠vel (consumo)</td>
                        <td style="padding: 10px; text-align: center;"><span class="conta-sugerida" style="background: #854d0e;">1.653</span></td>
                        <td style="padding: 10px; text-align: center;">2.1.04</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        ‚öôÔ∏è Sistema de An√°lise Fiscal ¬∑ Rede Dom Pedro ¬∑ v2.0
    </div>
</div>

<script>
// TABELA DE CONTAS POR CFOP (baseado na sua planilha)
const TABELA_CONTAS = {
    "5102": { 
        conta: "1.551", 
        descricao: "ATIVO IMOBILIZADO - ICMS a recuperar",
        natureza: "Ativo Imobilizado",
        icms: true,
        alerta: "Lan√ßar em 1551 (cr√©dito de ICMS de ativo)"
    },
    "6102": { 
        conta: "2.551", 
        descricao: "ATIVO IMOBILIZADO - ICMS a recuperar (interestadual)",
        natureza: "Ativo Imobilizado",
        icms: true
    },
    "5101": { 
        conta: "1.102", 
        descricao: "ESTOQUE - Mercadorias para revenda",
        natureza: "Revenda",
        icms: true
    },
    "1102": { 
        conta: "1.102", 
        descricao: "ESTOQUE - Compra para comercializa√ß√£o",
        natureza: "Revenda",
        icms: true
    },
    "5405": { 
        conta: "1.407", 
        descricao: "USO/CONSUMO - Material de consumo",
        natureza: "Consumo",
        icms: false
    },
    "6405": { 
        conta: "2.407", 
        descricao: "USO/CONSUMO - Material de consumo (interestadual)",
        natureza: "Consumo",
        icms: false
    },
    "5403": { 
        conta: "1.406", 
        descricao: "ATIVO IMOBILIZADO - Sem ICMS",
        natureza: "Ativo Imobilizado",
        icms: false
    },
    "5404": { 
        conta: "1.406", 
        descricao: "ATIVO IMOBILIZADO - Sem ICMS",
        natureza: "Ativo Imobilizado",
        icms: false
    },
    "5656": { 
        conta: "1.653", 
        descricao: "COMBUST√çVEL - Consumo",
        natureza: "Combust√≠vel",
        icms: false
    },
    "1556": { 
        conta: "1.556", 
        descricao: "MATERIAL DE USO/CONSUMO",
        natureza: "Consumo",
        icms: false
    }
};

function analisarNF() {
    const textoNF = document.getElementById('inputNF').value;
    
    if (!textoNF.trim()) {
        alert('Cole a NF-e para an√°lise.');
        return;
    }

    // Extrair produtos da se√ß√£o DADOS DOS PRODUTOS / SERVI√áOS
    const produtos = extrairProdutos(textoNF);
    
    // Extrair dados do cabe√ßalho da NF
    const cabecalho = extrairCabecalho(textoNF);
    
    // Gerar visualiza√ß√£o da NF
    const nfVisual = gerarNFVisual(textoNF, produtos);
    document.getElementById('nfVisual').innerHTML = nfVisual;
    
    // Gerar tabela de produtos com an√°lises
    const tabelaHTML = gerarTabelaProdutos(produtos);
    document.getElementById('tabelaProdutos').innerHTML = tabelaHTML;
    
    // Verificar alerta especial (CFOP 5102)
    const tem5102 = produtos.some(p => p.cfop === '5102');
    if (tem5102) {
        document.getElementById('alertaEspecial').classList.remove('hidden');
    } else {
        document.getElementById('alertaEspecial').classList.add('hidden');
    }
    
    // Gerar resumo cont√°bil
    const resumoHTML = gerarResumoContabil(produtos);
    document.getElementById('resumoContabil').innerHTML = resumoHTML;
    
    // Ocultar √°rea de colagem e mostrar resultados
    document.getElementById('areaColagem').classList.add('hidden');
    document.getElementById('areaResultados').classList.remove('hidden');
}

function extrairCabecalho(texto) {
    const linhas = texto.split('\n');
    let cabecalho = {
        numero: '',
        serie: '',
        dataEmissao: '',
        destinatario: '',
        cnpj: '',
        valorTotal: ''
    };
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i];
        
        if (linha.includes('N¬∫ 000.')) {
            const match = linha.match(/N¬∫\s+([0-9.]+)/);
            if (match) cabecalho.numero = match[1];
        }
        if (linha.includes('REDE DOM PEDRO')) {
            cabecalho.destinatario = 'REDE DOM PEDRO DE POSTOS LTDA';
        }
        if (linha.includes('CNPJ/CPF:')) {
            const match = linha.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/);
            if (match) cabecalho.cnpj = match[1];
        }
        if (linha.includes('VALOR TOTAL DA NOTA:')) {
            const match = linha.match(/(\d+,\d{2})/);
            if (match) cabecalho.valorTotal = match[1];
        }
    }
    
    return cabecalho;
}

function extrairProdutos(texto) {
    const linhas = texto.split('\n');
    const produtos = [];
    let dentroTabela = false;
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i].trim();
        
        // Detectar in√≠cio da tabela de produtos
        if (linha.includes('DADOS DOS PRODUTOS') || linha.includes('DADOS DOS PRODUTOS / SERVI√áOS')) {
            dentroTabela = true;
            continue;
        }
        
        // Sair da tabela quando encontrar DADOS ADICIONAIS
        if (dentroTabela && (linha.includes('DADOS ADICIONAIS') || linha.includes('INFORMA√á√ïES COMPLEMENTARES'))) {
            break;
        }
        
        // Processar linhas dentro da tabela
        if (dentroTabela && linha.length > 20 && !linha.includes('C√ìD. PROD.')) {
            // Procurar padr√£o: c√≥digo + descri√ß√£o + NCM + CST + CFOP + UND + quantidade + valor
            const partes = linha.split(/\s+/);
            
            // Encontrar CFOP (4 d√≠gitos, podendo ter ponto)
            let cfop = '';
            let cst = '';
            let descricao = '';
            let ncm = '';
            let und = '';
            let quantidade = 0;
            let valorUnit = 0;
            let valorTotal = 0;
            
            // Buscar CFOP (padr√£o: 5.102, 5.102, 5102, etc)
            for (let j = 0; j < partes.length; j++) {
                const parte = partes[j];
                // Verificar se √© CFOP (4 d√≠gitos com ou sem ponto)
                if (parte.match(/^[1-7]\.?\d{3}$/)) {
                    cfop = parte.replace('.', '');
                    // CST geralmente est√° antes do CFOP
                    if (j > 0 && partes[j-1].match(/^\d{2,3}$/)) {
                        cst = partes[j-1];
                    }
                    // NCM geralmente est√° antes do CST
                    if (j > 1 && partes[j-2].match(/^\d{8}$/)) {
                        ncm = partes[j-2];
                    }
                    // Descri√ß√£o √© tudo antes do NCM
                    descricao = partes.slice(1, j-2).join(' ').replace(/^\d+\s*/, '');
                    break;
                }
            }
            
            // Encontrar quantidade e valores (√∫ltimos n√∫meros)
            const numeros = linha.match(/(\d+[,.]?\d*)/g);
            if (numeros && numeros.length >= 3) {
                // √öltimos n√∫meros s√£o: quantidade, valor unit√°rio, valor total
                quantidade = parseFloat(numeros[numeros.length-3].replace(',', '.'));
                valorUnit = parseFloat(numeros[numeros.length-2].replace(',', '.'));
                valorTotal = parseFloat(numeros[numeros.length-1].replace(',', '.'));
            }
            
            if (cfop) {
                produtos.push({
                    cfop: cfop,
                    cst: cst || '000',
                    descricao: descricao || 'Produto',
                    ncm: ncm || '',
                    und: und || 'UN',
                    quantidade: quantidade,
                    valorUnit: valorUnit,
                    valorTotal: valorTotal,
                    conta: TABELA_CONTAS[cfop]?.conta || 'N√ÉO MAPEADO',
                    natureza: TABELA_CONTAS[cfop]?.natureza || 'N√£o classificado',
                    alerta: TABELA_CONTAS[cfop]?.alerta || ''
                });
            }
        }
    }
    
    return produtos;
}

function gerarNFVisual(textoOriginal, produtos) {
    let texto = textoOriginal;
    
    // Adicionar marca√ß√£o visual para os produtos
    const linhas = texto.split('\n');
    let dentroTabela = false;
    let linhasProcessadas = [];
    
    for (let i = 0; i < linhas.length; i++) {
        let linha = linhas[i];
        
        if (linha.includes('DADOS DOS PRODUTOS')) {
            dentroTabela = true;
        }
        
        if (dentroTabela && linha.includes('DADOS ADICIONAIS')) {
            dentroTabela = false;
        }
        
        // Destacar CFOPs na linha
        if (dentroTabela && !linha.includes('C√ìD. PROD.')) {
            produtos.forEach(prod => {
                if (linha.includes(prod.cfop) || linha.includes(prod.cfop.replace(/(\d)(\d{3})/, '$1.$2'))) {
                    const cfopFormatado = prod.cfop.replace(/(\d)(\d{3})/, '$1.$2');
                    const destaque = `<span style="background: #1e293b; color: white; padding: 2px 8px; border-radius: 30px; font-weight: 700;">${cfopFormatado}</span>`;
                    linha = linha.replace(new RegExp(cfopFormatado.replace('.', '\\.'), 'g'), destaque);
                }
            });
        }
        
        linhasProcessadas.push(linha);
    }
    
    return linhasProcessadas.join('<br>');
}

function gerarTabelaProdutos(produtos) {
    let html = `
        <table class="tabela-produtos">
            <thead>
                <tr>
                    <th>C√≥digo</th>
                    <th>Descri√ß√£o</th>
                    <th>NCM</th>
                    <th>CST</th>
                    <th>CFOP</th>
                    <th>UND</th>
                    <th>Qtde</th>
                    <th>Valor Unit</th>
                    <th>Valor Total</th>
                    <th>Conta D√©bito</th>
                    <th>Natureza</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    produtos.forEach((prod, index) => {
        const cfopFormatado = prod.cfop.replace(/(\d)(\d{3})/, '$1.$2');
        const valorUnitFormat = prod.valorUnit.toFixed(2).replace('.', ',');
        const valorTotalFormat = prod.valorTotal.toFixed(2).replace('.', ',');
        
        // Definir cor da linha baseado na natureza
        let corLinha = '';
        if (prod.natureza === 'Ativo Imobilizado') corLinha = 'style="background: #dcfce7;"';
        else if (prod.natureza === 'Consumo') corLinha = 'style="background: #fff3cd;"';
        else if (prod.natureza === 'Revenda') corLinha = 'style="background: #dbeafe;"';
        
        html += `
            <tr ${corLinha}>
                <td>${index + 1}</td>
                <td>${prod.descricao}</td>
                <td>${prod.ncm}</td>
                <td><span class="cst-origem">${prod.cst}</span></td>
                <td><span class="cfop-destaque">${cfopFormatado}</span></td>
                <td>${prod.und}</td>
                <td>${prod.quantidade}</td>
                <td>R$ ${valorUnitFormat}</td>
                <td><strong>R$ ${valorTotalFormat}</strong></td>
                <td><span class="conta-sugerida">${prod.conta}</span></td>
                <td>${prod.natureza}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    return html;
}

function gerarResumoContabil(produtos) {
    // Agrupar por conta
    const contas = {};
    let totalGeral = 0;
    
    produtos.forEach(prod => {
        const conta = prod.conta;
        if (!contas[conta]) {
            contas[conta] = {
                natureza: prod.natureza,
                total: 0,
                itens: []
            };
        }
        contas[conta].total += prod.valorTotal;
        contas[conta].itens.push(prod.descricao);
        totalGeral += prod.valorTotal;
    });
    
    let html = '';
    
    Object.keys(contas).sort().forEach(conta => {
        const item = contas[conta];
        const corClasse = item.natureza === 'Ativo Imobilizado' ? 'ativo' : 
                         item.natureza === 'Consumo' ? 'consumo' : 'venda';
        
        html += `
            <div class="info-box ${corClasse}">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="badge">Conta</span>
                    <span style="font-weight: 700; color: #64748b;">${item.natureza}</span>
                </div>
                <div style="font-size: 2.5rem; font-weight: 800; margin: 10px 0;">${conta}</div>
                <div style="font-size: 1.8rem; font-weight: 700; color: #059669;">
                    R$ ${item.total.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #64748b;">
                    ${item.itens.length} item(ns): ${item.itens.join(', ').substring(0, 60)}...
                </div>
            </div>
        `;
    });
    
    // Adicionar total geral
    html += `
        <div class="info-box" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border-left-color: white;">
            <div style="font-size: 0.9rem;">TOTAL DA NOTA</div>
            <div style="font-size: 2.5rem; font-weight: 800; margin: 10px 0;">
                R$ ${totalGeral.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
            </div>
            <div style="font-size: 0.8rem;">${produtos.length} produto(s) analisado(s)</div>
        </div>
    `;
    
    return html;
}

function novaConsulta() {
    // Limpar campos
    document.getElementById('inputNF').value = '';
    
    // Mostrar √°rea de colagem e ocultar resultados
    document.getElementById('areaColagem').classList.remove('hidden');
    document.getElementById('areaResultados').classList.add('hidden');
}

// Inicializar com exemplo
window.onload = function() {
    // O textarea j√° tem o exemplo
};
</script>

</body>
</html>