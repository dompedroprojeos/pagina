
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador Profissional NF-e · Waldeci Ramos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Poppins', sans-serif;
            background: linear-gradient(145deg, #0d1b2a 0%, #1b2b3f 50%, #2a3b4f 100%);
            min-height: 100vh;
            padding: 2rem 1.5rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 50px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            width: 60px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .logo-text h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(145deg, #1e293b, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge-sistema {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 60px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .painel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Card de Consulta */
        .consulta-card {
            background: white;
            border-radius: 40px;
            padding: 1.8rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .consulta-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1.5rem;
            color: #2563eb;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .consulta-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 60px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .consulta-input:focus {
            border-color: #2563eb;
            outline: none;
        }

        .examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .example-tag {
            background: #f1f5f9;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
        }

        .example-tag:hover {
            background: #2563eb;
            color: white;
        }

        /* Card da NF */
        .nf-card {
            background: white;
            border-radius: 40px;
            padding: 1.8rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .nf-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1.5rem;
            color: #2563eb;
            font-size: 1.3rem;
            font-weight: 600;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .btn-analyze {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
        }

        /* Resultado da Consulta */
        .resultado-consulta {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tabela-regras {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tabela-regras th {
            background: #1e293b;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .tabela-regras td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .tabela-regras tr:last-child td {
            border-bottom: none;
        }

        .tabela-regras tr:hover td {
            background: #f8fafc;
        }

        .cst-group {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .cst-tag {
            background: #f97316;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .conta-lanc {
            background: #059669;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }

        .mensagem {
            background: #fff3cd;
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            border-left: 5px solid #f97316;
            color: #854d0e;
        }

        /* Resultado da Análise NF */
        .resultado-nf {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 3px dashed #2563eb;
        }

        .info-header {
            background: linear-gradient(145deg, #0f172a, #1e293b);
            color: white;
            padding: 1.8rem;
            border-radius: 25px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-header-item .label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-header-item .value {
            font-size: 1.1rem;
            font-weight: 600;
            word-break: break-word;
        }

        .tabela-produtos {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            font-size: 0.85rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin: 20px 0;
        }

        .tabela-produtos th {
            background: #2563eb;
            color: white;
            padding: 12px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .tabela-produtos td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .tabela-produtos tr:hover td {
            background: #f8fafc;
        }

        .resumo-contas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .resumo-conta {
            background: white;
            padding: 1.2rem;
            border-radius: 15px;
            border-left: 6px solid #2563eb;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .resumo-conta .conta {
            font-size: 0.9rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .resumo-conta .valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin: 5px 0;
        }

        .total-geral {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            padding: 1.5rem;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 20px;
        }

        .total-geral .valor {
            font-size: 1.8rem;
            color: #2563eb;
        }

        .hidden {
            display: none;
        }

        .btn-copy {
            background: #334155;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .btn-copy:hover {
            background: #1e293b;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #2563eb;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .detalhe-icms {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 3px;
        }

        .btn-limpar {
            background: #64748b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .btn-limpar:hover {
            background: #475569;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo-area">
            <div class="logo-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="logo-text">
                <h1>Analisador Profissional NF-e</h1>
                <span>Criação: Waldeci Ramos</span>
            </div>
        </div>
        <div class="badge-sistema">
            <i class="fas fa-database"></i> Tabela Completa v3.0
        </div>
    </div>

    <!-- Grid de dois painéis -->
    <div class="painel-grid">
        <!-- Painel 1: Consulta Rápida -->
        <div class="consulta-card">
            <div class="consulta-title">
                <i class="fas fa-search"></i>
                <span>Consulta de Regras CFOP</span>
                <button class="btn-limpar" onclick="limparConsulta()">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
            </div>
            
            <input type="text" id="consultaInput" class="consulta-input" 
                   placeholder="Digite CFOP (ex: 5908, 5929, 5949, 5117)" value="5102">
            
            <div class="examples">
                <span class="example-tag" onclick="consultarCFOPExemplo('5102')">5102</span>
                <span class="example-tag" onclick="consultarCFOPExemplo('5405')">5405</span>
                <span class="example-tag" onclick="consultarCFOPExemplo('5656')">5656</span>
                <span class="example-tag" onclick="consultarCFOPExemplo('5908')">5908</span>
                <span class="example-tag" onclick="consultarCFOPExemplo('5929')">5929</span>
                <span class="example-tag" onclick="consultarCFOPExemplo('5949')">5949</span>
                <span class="example-tag" onclick="consultarCFOPExemplo('5152')">5152</span>
            </div>

            <div id="resultadoConsulta" class="resultado-consulta">
                <!-- Resultado da consulta aparece aqui -->
            </div>
        </div>

        <!-- Painel 2: Análise de NF -->
        <div class="nf-card">
            <div class="consulta-title">
                <i class="fas fa-file-alt"></i>
                <span>Cole a Nota Fiscal Completa</span>
                <button class="btn-limpar" onclick="limparNF()">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
            </div>
            
            <textarea id="nfInput" placeholder="Cole a NF-e completa aqui... (Control + C + Control + V)"></textarea>
            
            <button class="btn-analyze" onclick="analisarNF()">
                <i class="fas fa-chart-bar"></i>
                Analisar Nota Fiscal Agora
            </button>
        </div>
    </div>

    <!-- Área de Resultado da Análise -->
    <div id="resultadoNF" class="resultado-nf">
        <!-- O resultado da análise aparecerá aqui -->
    </div>
</div>

<script>
// ============================================
// TABELA COMPLETA COM TODOS OS DADOS (ATUALIZADA)
// ============================================

const TABELA_COMPLETA = {
    // ========== USO/CONSUMO ==========
    '5101': { cfop: '5.101', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.556', cstLanc: '090', csosnLanc: '0101/0102', pisCofins: '70/70', observacao: 'USO E CONSUMO - Conta 1.556' }] },
    '5102': { cfop: '5.102', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.556', cstLanc: '090', csosnLanc: '0101/0102', pisCofins: '70/70', observacao: 'USO E CONSUMO - Conta 1.556' }] },
    '5108': { cfop: '5.108', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.556', cstLanc: '090', csosnLanc: '0101/0102', pisCofins: '70/70', observacao: 'USO E CONSUMO - Conta 1.556' }] },
    '6101': { cfop: '6.101', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.556', cstLanc: '090', csosnLanc: '0101/0102', pisCofins: '70/70', observacao: 'USO E CONSUMO - Conta 2.556' }] },
    '6102': { cfop: '6.102', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.556', cstLanc: '090', csosnLanc: '0101/0102', pisCofins: '70/70', observacao: 'USO E CONSUMO - Conta 2.556' }] },
    '6108': { cfop: '6.108', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.556', cstLanc: '090', csosnLanc: '0101/0102', pisCofins: '70/70', observacao: 'USO E CONSUMO - Conta 2.556' }] },

    // ========== ATIVO IMOBILIZADO ==========
    '5403': { cfop: '5.403', regras: [{ cstOrigem: ['010','060','110','160','510','560'], cfopLanc: '1.407', cstLanc: '060', csosnLanc: '0500', pisCofins: '70/70', observacao: 'ATIVO IMOBILIZADO - Conta 1.407' }] },
    '5404': { cfop: '5.404', regras: [{ cstOrigem: ['010','060','110','160','510','560'], cfopLanc: '1.407', cstLanc: '060', csosnLanc: '0500', pisCofins: '70/70', observacao: 'ATIVO IMOBILIZADO - Conta 1.407' }] },
    '5405': { cfop: '5.405', regras: [{ cstOrigem: ['010','060','110','160','510','560'], cfopLanc: '1.407', cstLanc: '060', csosnLanc: '0500', pisCofins: '70/70', observacao: 'ATIVO IMOBILIZADO - Conta 1.407' }] },
    '6403': { cfop: '6.403', regras: [{ cstOrigem: ['010','060','110','160','510','560'], cfopLanc: '2.407', cstLanc: '060', csosnLanc: '0500', pisCofins: '70/70', observacao: 'ATIVO IMOBILIZADO - Conta 2.407' }] },
    '6404': { cfop: '6.404', regras: [{ cstOrigem: ['010','060','110','160','510','560'], cfopLanc: '2.407', cstLanc: '060', csosnLanc: '0500', pisCofins: '70/70', observacao: 'ATIVO IMOBILIZADO - Conta 2.407' }] },
    '6405': { cfop: '6.405', regras: [{ cstOrigem: ['010','060','110','160','510','560'], cfopLanc: '2.407', cstLanc: '060', csosnLanc: '0500', pisCofins: '70/70', observacao: 'ATIVO IMOBILIZADO - Conta 2.407' }] },
    // Observação para Ativo: VERIFICAR SE A NOTA SERÁ ATIVO CASO SIM LANÇAR NO 1.551 – 2.551 OU 1.406 – 2.406 (usar a mesma regra para CST / CSOSN acima)
    // Isso pode ser tratado como uma observação extra ou regra futura.

    // ========== CFOP 5.929 (MÚLTIPLAS REGRAS) ==========
    '5929': { cfop: '5.929', regras: [
        { cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.556', cstLanc: '090', pisCofins: '70/70', observacao: 'USO/CONSUMO - Conta 1.556' },
        { cstOrigem: ['060','110','160','510','560'], cfopLanc: '1.407', cstLanc: '060', pisCofins: '70/70', observacao: 'CONSUMO PADRÃO - Conta 1.407' },
        { cstOrigem: ['061','060'], cfopLanc: '1.653', cstLanc: '061', pisCofins: '70/70', observacao: 'CONSUMO COMBUSTÍVEL - Conta 1.653' } // Regra específica da tabela de consumo combustível
    ]},
    '6929': { cfop: '6.929', regras: [
        { cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.556', cstLanc: '090', pisCofins: '70/70', observacao: 'USO/CONSUMO - Conta 2.556' },
        { cstOrigem: ['060','110','160','510','560'], cfopLanc: '2.407', cstLanc: '060', pisCofins: '70/70', observacao: 'CONSUMO PADRÃO - Conta 2.407' },
        { cstOrigem: ['061','060'], cfopLanc: '2.653', cstLanc: '061', pisCofins: '70/70', observacao: 'CONSUMO COMBUSTÍVEL - Conta 2.653' } // Regra específica
    ]},

    // ========== CFOP 5.949 ==========
    '5949': { cfop: '5.949', regras: [
        { cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.949', cstLanc: '090', observacao: 'NÃO TEM CONTAS A PAGAR - Conta 1.949' },
        { cstOrigem: ['060','110','160','510','560'], cfopLanc: '1.407', cstLanc: '060', observacao: 'Verificar - NÃO TEM CONTAS A PAGAR' },
        { cstOrigem: ['090'], cfopLanc: '1.102', cstLanc: '090', observacao: 'NOTAS RV - Conta 1.102' } // Regra específica RV
    ]},
    '6949': { cfop: '6.949', regras: [
        { cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.949', cstLanc: '090', observacao: 'NÃO TEM CONTAS A PAGAR - Conta 2.949' },
        { cstOrigem: ['060','110','160','510','560'], cfopLanc: '2.407', cstLanc: '060', observacao: 'Verificar - NÃO TEM CONTAS A PAGAR' },
        { cstOrigem: ['090'], cfopLanc: '2.102', cstLanc: '090', observacao: 'NOTAS RV - Conta 2.102' } // Regra específica RV
    ]},

    // ========== REMESSAS ==========
    '5908': { cfop: '5.908', regras: [{ cstOrigem: ['040','041'], cfopLanc: '1.908', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA POR COMODATO - Conta 1.908 (Não tem contas a pagar)' }] },
    '6908': { cfop: '6.908', regras: [{ cstOrigem: ['040','041'], cfopLanc: '2.908', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA POR COMODATO - Conta 2.908' }] },
    '5910': { cfop: '5.910', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.910', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA EM CONSERTO - Conta 1.910 (Não tem contas a pagar)' }] },
    '6910': { cfop: '6.910', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.910', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA EM CONSERTO - Conta 2.910' }] },
    '5916': { cfop: '5.916', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.916', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA - Conta 1.916 (Não tem contas a pagar)' }] },
    '6916': { cfop: '6.916', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.916', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA - Conta 2.916' }] },
    '5922': { cfop: '5.922', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.922', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA - Conta 1.922 (Não tem contas a pagar)' }] },
    '6922': { cfop: '6.922', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.922', cstLanc: '090', csosnLanc: '0101/0102', observacao: 'REMESSA - Conta 2.922' }] },

    // ========== CFOP 5.117 / 6.117 ==========
    '5117': { cfop: '5.117', regras: [
        { cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.556', cstLanc: '090', observacao: 'Conta 1.556 (Registrar contas a pagar para validar e depois excluir)' },
        { cstOrigem: ['060','110','160','510','560'], cfopLanc: '1.407', cstLanc: '060', observacao: 'Conta 1.407 (Registrar contas a pagar para validar e depois excluir)' }
    ]},
    '6117': { cfop: '6.117', regras: [
        { cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.556', cstLanc: '090', observacao: 'Conta 2.556 (Registrar contas a pagar para validar e depois excluir)' },
        { cstOrigem: ['060','110','160','510','560'], cfopLanc: '2.407', cstLanc: '060', observacao: 'Conta 2.407 (Registrar contas a pagar para validar e depois excluir)' }
    ]},

    // ========== COMBUSTÍVEIS ==========
    '5656': { cfop: '5.656', regras: [
        { cstOrigem: ['061','060'], cfopLanc: '1.653', cstLanc: '061', pisCofins: '70/70', observacao: 'CONSUMO COMBUSTÍVEL - Conta 1.653' },
        { cstOrigem: ['010','110','510'], cfopLanc: '1.652', cstLanc: '010', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 1.652' },
        { cstOrigem: ['030','130','530'], cfopLanc: '1.652', cstLanc: '030', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 1.652' },
        { cstOrigem: ['060','160','560'], cfopLanc: '1.652', cstLanc: '060', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 1.652' }
    ]},
    '6656': { cfop: '6.656', regras: [
        { cstOrigem: ['061','060'], cfopLanc: '2.653', cstLanc: '061', pisCofins: '70/70', observacao: 'CONSUMO COMBUSTÍVEL - Conta 2.653' },
        { cstOrigem: ['010','110','510'], cfopLanc: '2.652', cstLanc: '010', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 2.652' },
        { cstOrigem: ['030','130','530'], cfopLanc: '2.652', cstLanc: '030', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 2.652' },
        { cstOrigem: ['060','160','560'], cfopLanc: '2.652', cstLanc: '060', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 2.652' }
    ]},
    '5655': { cfop: '5.655', regras: [ // Adicionando 5.655 com a mesma lógica de 5.656, se aplicável
        { cstOrigem: ['010','110','510'], cfopLanc: '1.652', cstLanc: '010', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 1.652' },
        { cstOrigem: ['030','130','530'], cfopLanc: '1.652', cstLanc: '030', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 1.652' },
        { cstOrigem: ['060','160','560'], cfopLanc: '1.652', cstLanc: '060', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 1.652' }
    ]},
    '6655': { cfop: '6.655', regras: [ // Adicionando 6.655
        { cstOrigem: ['010','110','510'], cfopLanc: '2.652', cstLanc: '010', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 2.652' },
        { cstOrigem: ['030','130','530'], cfopLanc: '2.652', cstLanc: '030', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 2.652' },
        { cstOrigem: ['060','160','560'], cfopLanc: '2.652', cstLanc: '060', pisCofins: '70/70', observacao: 'COMBUSTÍVEL - Conta 2.652' }
    ]},

    // ========== TRANSFERÊNCIAS ==========
    '5152': { cfop: '5.152', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '1.152', cstLanc: '000', pisCofins: '50/50', observacao: 'TRANSFERÊNCIA ARLA - Conta 1.152' }] },
    '6152': { cfop: '6.152', regras: [{ cstOrigem: ['000','020','040','041','090'], cfopLanc: '2.152', cstLanc: '000', pisCofins: '50/50', observacao: 'TRANSFERÊNCIA ARLA - Conta 2.152' }] },
    '5659': { cfop: '5.659', regras: [{ cstOrigem: ['060','160','560'], cfopLanc: '1.659', cstLanc: '060', pisCofins: '98/98', observacao: 'TRANSFERÊNCIA LUBRIFICANTE - Conta 1.659' }] },
    '6659': { cfop: '6.659', regras: [{ cstOrigem: ['060','160','560'], cfopLanc: '2.659', cstLanc: '060', pisCofins: '98/98', observacao: 'TRANSFERÊNCIA LUBRIFICANTE - Conta 2.659' }] }
};

// ============================================
// FUNÇÕES DE CONSULTA
// ============================================

function formatarCFOP(cfop) {
    if (!cfop) return '';
    const num = cfop.toString().replace(/[^\d]/g, '');
    if (num.length === 4) {
        return num.charAt(0) + '.' + num.slice(1);
    }
    return cfop;
}

function consultarCFOP() {
    const termo = document.getElementById('consultaInput').value.trim();
    const termoLimpo = termo.replace(/[^\d]/g, '');
    const divResultado = document.getElementById('resultadoConsulta');
    
    if (!termoLimpo) {
        divResultado.innerHTML = '';
        return;
    }

    const regra = TABELA_COMPLETA[termoLimpo];

    if (!regra) {
        divResultado.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <i class="fas fa-times-circle fa-3x"></i>
                <p style="margin-top: 10px;">CFOP ${formatarCFOP(termoLimpo)} não encontrado</p>
                <p style="font-size:0.9rem;">Use um dos CFOPs disponíveis ou digite corretamente</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="tabela-regras">
            <thead>
                <tr>
                    <th>CFOP ORIG.</th>
                    <th>CST ORIGEM</th>
                    <th>CFOP LANC</th>
                    <th>CST LANC</th>
                    <th>CSOSN LANC</th>
                    <th>PIS/COFINS</th>
                    <th>OBSERVAÇÃO</th>
                </tr>
            </thead>
            <tbody>
    `;

    regra.regras.forEach(r => {
        html += `<tr>`;
        html += `<td><strong>${regra.cfop}</strong></td>`;
        html += `<td>
            <div class="cst-group">
                ${r.cstOrigem.map(cst => `<span class="cst-tag">${cst}</span>`).join('')}
            </div>
        </td>`;
        html += `<td><span class="conta-lanc">${r.cfopLanc || '?'}</span></td>`;
        html += `<td><strong>${r.cstLanc}</strong></td>`;
        html += `<td>${r.csosnLanc || '—'}</td>`;
        html += `<td>${r.pisCofins || '—'}</td>`;
        html += `<td><small style="color:#2563eb;">${r.observacao || ''}</small></td>`;
        html += `</tr>`;
    });

    html += `</tbody></table>`;

    divResultado.innerHTML = html;
}

function consultarCFOPExemplo(cfop) {
    document.getElementById('consultaInput').value = cfop;
    consultarCFOP();
}

function limparConsulta() {
    document.getElementById('consultaInput').value = '';
    document.getElementById('resultadoConsulta').innerHTML = '';
}

function limparNF() {
    document.getElementById('nfInput').value = '';
    document.getElementById('resultadoNF').innerHTML = '';
}

// ============================================
// FUNÇÕES DE ANÁLISE DA NF (PARSER CORRIGIDO)
// ============================================

function analisarNF() {
    const textoNF = document.getElementById('nfInput').value;
    
    if (!textoNF.trim()) {
        alert('Por favor, cole a nota fiscal primeiro!');
        return;
    }

    // Mostrar loading
    const divResultado = document.getElementById('resultadoNF');
    divResultado.innerHTML = `
        <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Analisando nota fiscal...</p>
        </div>
    `;

    // Pequeno delay para mostrar o loading
    setTimeout(() => {
        try {
            // Extrair dados da NF
            const dadosNF = extrairDadosNF(textoNF);
            const produtos = extrairProdutosNF(textoNF);
            
            if (produtos.length === 0) {
                divResultado.innerHTML = `
                    <div class="mensagem" style="background: #fee2e2; border-left-color: #ef4444; color: #991b1b;">
                        <i class="fas fa-exclamation-triangle"></i> Nenhum produto encontrado na nota fiscal. Verifique se o texto foi colado corretamente.
                    </div>
                `;
                return;
            }
            
            // Analisar produtos com base nas regras
            const produtosAnalisados = produtos.map(prod => {
                const regra = TABELA_COMPLETA[prod.cfop];
                let conta = '';
                let cstLanc = '';
                let observacao = '';
                let pisCofins = '';
                
                if (regra) {
                    // Procura a regra que corresponda ao CST do produto
                    const regraAplicavel = regra.regras.find(r => 
                        r.cstOrigem.includes(prod.cst)
                    );
                    
                    if (regraAplicavel) {
                        conta = regraAplicavel.cfopLanc;
                        cstLanc = regraAplicavel.cstLanc;
                        observacao = regraAplicavel.observacao;
                        pisCofins = regraAplicavel.pisCofins || '';
                    } else {
                        // Se não encontrar, usa a primeira regra como fallback, mas avisa
                        conta = regra.regras[0].cfopLanc;
                        cstLanc = regra.regras[0].cstLanc;
                        observacao = regra.regras[0].observacao + ' (CST não mapeado, regra padrão aplicada)';
                        pisCofins = regra.regras[0].pisCofins || '';
                    }
                } else {
                    // Regra padrão para CFOP não mapeado
                    const prefixo = prod.cfop ? prod.cfop.charAt(0) : '5';
                    conta = prefixo === '5' ? '1.556' : '2.556';
                    cstLanc = '090';
                    observacao = 'CFOP não mapeado - USO/CONSUMO padrão';
                }
                
                return {
                    ...prod,
                    contaSugerida: conta,
                    cstLanc: cstLanc,
                    pisCofins: pisCofins,
                    observacao: observacao
                };
            });

            // Agrupar por conta
            const contas = {};
            produtosAnalisados.forEach(p => {
                if (!contas[p.contaSugerida]) {
                    contas[p.contaSugerida] = {
                        total: 0,
                        itens: []
                    };
                }
                contas[p.contaSugerida].total += p.valorTotal;
                contas[p.contaSugerida].itens.push(p.descricao);
            });

            // Calcular totais
            const totalProdutos = produtosAnalisados.reduce((acc, p) => acc + p.valorTotal, 0);

            // Exibir resultado
            let html = `
                <div class="info-header">
                    <div class="info-header-item">
                        <div class="label">NÚMERO NF</div>
                        <div class="value">${dadosNF.numero}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">EMITENTE</div>
                        <div class="value">${dadosNF.emitente}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">CNPJ EMITENTE</div>
                        <div class="value">${dadosNF.cnpjEmitente}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">DESTINATÁRIO</div>
                        <div class="value">${dadosNF.destinatario}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">CNPJ DEST.</div>
                        <div class="value">${dadosNF.cnpjDestinatario}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">NATUREZA</div>
                        <div class="value">${dadosNF.natureza}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">DATA EMISSÃO</div>
                        <div class="value">${dadosNF.dataEmissao}</div>
                    </div>
                    <div class="info-header-item">
                        <div class="label">TOTAL NOTA</div>
                        <div class="value">R$ ${totalProdutos.toFixed(2).replace('.', ',')}</div>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px; display: flex; align-items: center;">
                    <i class="fas fa-boxes" style="color: #2563eb; margin-right: 10px;"></i>
                    Produtos Analisados (${produtosAnalisados.length} itens)
                </h3>
                
                <div style="overflow-x: auto;">
                    <table class="tabela-produtos">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Descrição</th>
                                <th>CFOP</th>
                                <th>CST</th>
                                <th>Quant.</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                                <th>CFOP LANÇAMENTOS</th>
                                <th>CST Lanc</th>
                                <th>PIS/COFINS</th>
                                <th>Observação</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            produtosAnalisados.forEach((prod, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${prod.descricao}</td>
                        <td><strong>${formatarCFOP(prod.cfop)}</strong></td>
                        <td><span class="cst-tag">${prod.cst || '000'}</span></td>
                        <td>${prod.quantidade}</td>
                        <td>R$ ${prod.valorUnit.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${prod.valorTotal.toFixed(2).replace('.', ',')}</td>
                        <td><span class="conta-lanc">${prod.contaSugerida || '?'}</span></td>
                        <td>${prod.cstLanc}</td>
                        <td>${prod.pisCofins || '—'}</td>
                        <td><small>${prod.observacao}</small></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <h3 style="margin: 30px 0 10px; display: flex; align-items: center;">
                    <i class="fas fa-chart-pie" style="color: #2563eb; margin-right: 10px;"></i>
                    Resumo por Conta Contábil
                </h3>
                <div class="resumo-contas">
            `;

            Object.keys(contas).sort().forEach(conta => {
                html += `
                    <div class="resumo-conta">
                        <div class="conta">Conta ${conta}</div>
                        <div class="valor">R$ ${contas[conta].total.toFixed(2).replace('.', ',')}</div>
                        <div style="font-size:0.85rem; color:#64748b;">${contas[conta].itens.length} item(ns)</div>
                        <div style="font-size:0.75rem; margin-top:5px; color:#475569;">
                            ${contas[conta].itens.slice(0, 2).join(', ')}${contas[conta].itens.length > 2 ? '...' : ''}
                        </div>
                    </div>
                `;
            });

            html += `
                </div>

                <div class="total-geral">
                    <span><i class="fas fa-calculator"></i> Total dos Produtos</span>
                    <span class="valor">R$ ${totalProdutos.toFixed(2).replace('.', ',')}</span>
                </div>
            `;

            divResultado.innerHTML = html;
            
            // Rolar até o resultado
            divResultado.scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            console.error('Erro na análise:', error);
            divResultado.innerHTML = `
                <div class="mensagem" style="background: #fee2e2; border-left-color: #ef4444; color: #991b1b;">
                    <i class="fas fa-exclamation-circle"></i> Erro ao analisar a nota fiscal: ${error.message}
                </div>
            `;
        }
    }, 300);
}

function extrairDadosNF(texto) {
    const dados = {
        numero: 'N/I',
        emitente: 'N/I',
        cnpjEmitente: 'N/I',
        municipio: 'N/I',
        destinatario: 'N/I',
        cnpjDestinatario: 'N/I',
        natureza: 'N/I',
        dataEmissao: 'N/I'
    };

    const linhas = texto.split('\n');
    
    linhas.forEach(linha => {
        // Número da NF
        if (linha.includes('Nº000.') || linha.includes('Nº 000.')) {
            const match = linha.match(/Nº0*([\d.]+)/);
            if (match) dados.numero = match[1];
        }
        
        // Emitente
        if (linha.includes('ABC EQUIPAMENTOS') || linha.includes('RTI INDUSTRIA')) {
            dados.emitente = linha.trim();
        }
        
        // CNPJ Emitente
        const cnpjMatch = linha.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/g);
        if (cnpjMatch) {
            if (linha.includes('CNPJ:') && !dados.cnpjEmitente) {
                dados.cnpjEmitente = cnpjMatch[0];
            } else if (linha.includes('DESTINATÁRIO') || linha.includes('REDE DOM PEDRO')) {
                dados.cnpjDestinatario = cnpjMatch[0];
            }
        }
        
        // Destinatário
        if (linha.includes('REDE DOM PEDRO')) {
            dados.destinatario = linha.trim();
        }
        
        // Natureza
        if (linha.includes('NATUREZADAOPERAÇÃO:')) {
            dados.natureza = linha.replace('NATUREZADAOPERAÇÃO:', '').trim();
        }
        
        // Data de emissão
        if (linha.includes('DATADEEMISSÃO:')) {
            dados.dataEmissao = linha.replace('DATADEEMISSÃO:', '').trim();
        }
    });

    return dados;
}

function extrairProdutosNF(texto) {
    const produtos = [];
    const linhas = texto.split('\n');
    
    // Encontrar a seção "DADOS DOS PRODUTOS / SERVIÇOS"
    let inicioSecao = -1;
    for (let i = 0; i < linhas.length; i++) {
        if (linhas[i].includes('DADOS DOS PRODUTOS / SERVIÇOS')) {
            inicioSecao = i + 1;
            break;
        }
    }
    
    if (inicioSecao === -1) return produtos;
    
    // Pular o cabeçalho (próximas 1-2 linhas)
    let linhaAtual = inicioSecao;
    while (linhaAtual < linhas.length && 
           (linhas[linhaAtual].includes('CÓD. PROD.') || 
            linhas[linhaAtual].includes('DESCRIÇÃO') ||
            linhas[linhaAtual].trim() === '')) {
        linhaAtual++;
    }
    
    // Processar linhas de produtos
    for (let i = linhaAtual; i < linhas.length; i++) {
        const linha = linhas[i].trim();
        
        // Parar se encontrar fim da seção
        if (linha.includes('DADOS ADICIONAIS') || 
            linha.includes('INFORMAÇÕESCOMPLEMENTARES') ||
            linha.includes('RESERVADOAOFISCO') ||
            linha === '') {
            break;
        }
        
        // Dividir a linha em partes (separador é espaço)
        const partes = linha.split(/\s+/);
        
        // Precisa ter pelo menos 8 partes para ser um produto válido
        if (partes.length >= 8) {
            // Extrair código do produto (primeiro campo)
            let index = 0;
            const codProd = partes[index++];
            
            // Verificar se tem CÓD. ANP (pode ser um número ou não)
            let codANP = '';
            if (partes[index] && partes[index].match(/^\d+$/)) {
                codANP = partes[index++];
            }
            
            // Descrição do produto (até encontrar NCM)
            let descricao = '';
            let ncm = '';
            
            while (index < partes.length) {
                const parte = partes[index];
                // NCM tem 8 dígitos
                if (parte.match(/^\d{8}$/)) {
                    ncm = parte;
                    index++;
                    break;
                }
                descricao += (descricao ? ' ' : '') + parte;
                index++;
            }
            
            // CST (pode não existir)
            let cst = '000';
            if (index < partes.length && partes[index].match(/^\d{3}$/)) {
                cst = partes[index++];
            }
            
            // CFOP (formato x.xxx)
            let cfop = '';
            if (index < partes.length && partes[index].match(/^\d\.\d{3}$/)) {
                cfop = partes[index++].replace('.', '');
            }
            
            // UN (unidade)
            let un = '';
            if (index < partes.length) {
                un = partes[index++];
            }
            
            // Quantidade
            let quantidade = 1;
            if (index < partes.length) {
                quantidade = parseFloat(partes[index++].replace(',', '.'));
            }
            
            // Valor Unitário
            let valorUnit = 0;
            if (index < partes.length) {
                valorUnit = parseFloat(partes[index++].replace(',', '.'));
            }
            
            // Valor Total
            let valorTotal = 0;
            if (index < partes.length) {
                valorTotal = parseFloat(partes[index++].replace(',', '.'));
            }
            
            // Validar se extraiu corretamente
            if (cfop && valorTotal > 0) {
                produtos.push({
                    cfop: cfop,
                    cst: cst,
                    descricao: descricao.substring(0, 40) || ('Produto ' + (produtos.length + 1)),
                    quantidade: quantidade || 1,
                    valorUnit: valorUnit || (valorTotal / (quantidade || 1)),
                    valorTotal: valorTotal
                });
            }
        }
    }
    
    return produtos;
}

// Inicialização
document.getElementById('consultaInput').addEventListener('input', consultarCFOP);

// Exemplo de NF pré-preenchida com o novo formato
window.onload = function() {
    consultarCFOP();
    
    // Adicionar exemplo de NF para teste
    document.getElementById('nfInput').value = `RECEBEMOS DE ABC EQUIPAMENTOS LTDA OS PRODUTOSCONSTANTES DANOTAFISCALINDICADAAO
LADO.
DATADORECEBIMENTO IDENTIFICAÇÃOEASSINATURADORECEBEDOR
NF-e
Nº000.001.208
SÉRIE1
ABC EQUIPAMENTOS LTDA
RUAMATIASBARBOSA,289-FLORESTA
CEP: 31015160-BELOHORIZONTE-MG
31986917777
DANFE
DOCUMENTOAUXILIARDANOTA
FISCALELETRÔNICA
0-ENTRADA
1-SAÍDA
1
Nº 000.001.208
SÉRIE 1
CONTROLEDOFISCO
CHAVEDEACESSO
31241154147408000110550010000012081000012098
ConsultadaautenticidadenoportalnacionaldaNF-e.
www.nfe.fazenda.gov.br/portalounositedaSefazAutorizadora.
NATUREZADAOPERAÇÃO:
VENDAS
PROTOCOLODEAUTORIZAÇÃODEUSO:
131246312304784 22/11/2024 11:13:45
INSCRIÇÃOESTADUAL:
0048356370060
INSC. EST. DOSUBST. TRIB.: CNPJ:
54.147.408/0001-10
DESTINATÁRIO / REMETENTE
NOME/RAZÃOSOCIAL:
REDE DOM PEDRO DE POSTOS LTDA
CNPJ/CPF:
20.415.295/0071-87
DATADEEMISSÃO:
22/11/2024 00:00:00
ENDEREÇO:
RODOVIA BR-040, 23730
BAIRRO/DISTRITO:
BARREIRA
CEP:
36407-430
DATADESAÍDA/ENTRADA:
22/11/2024
MUNICÍPIO:
CONSELHEIRO LAFAIETE
FONE/FAX:
31989025412
UF:
MG
INSCRIÇÃOESTADUAL:
2450683035492
HORADESAÍDA:
00:00:00
FATURA
DOCUMENTO:
001
VALORBRUTO:
355,00
VALORDESCONTO:
0,00
VALORLÍQUIDO:
355,00
DATAVENCIMENTO:
10/12/2024
CÁLCULO DO IMPOSTO
BASEDECÁLCULODOICMS:
0,00
VALORDOICMS:
0,00
BASEDECÁLCULODOICMSSUBST.:
0,00
VALORDOICMSSUBSTITUIÇÃO:
0,00
VALORTOTALDOSPRODUTOS:
295,00
VALORDOFRETE:
60,00
VALORDOSEGURO:
0,00
DESCONTO:
0,00
OUT. DESP. ACESSÓRIAS:
0,00
VALORDOIPI:
0,00
VALORTOTALDANOTA:
355,00
TRANSPORTADOS / VOLUMES TRANSPORTADOS
RAZÃOSOCIAL:
O PROPRIO
FRETEPORCONTA:
0 - EMITENTE.
CÓDIGOANTT: PLACADOVEÍCULO:
-UF: CNPJ/CPF:
ENDEREÇO: MUNICIPIO: UF: INSCRIÇÃOESTADUAL:
QUANTIDADE:
0
ESPÉCIE:
VOLUME
MARCA: NUMERAÇÃO:
0
PESOBRUTO:
0
PESOLÍQUIDO:
0
DADOS DOS PRODUTOS / SERVIÇOS
CÓD. PROD. CÓD. ANP DESCRIÇÃO DO PRODUTO/SERVIÇO CÓD. NCM CST CFOP UND QUANT. V. UNIT. V. TOTAL BC ICMS V. ICMS V. IPI ALIQ. ICMS ALIQ. ICMS
009 BICO ABASTECIMENTO 3/4 IMPORTADO 84818099 5.102 UN 2 125 250 0,00 0,00 0,00 0,00 0,00
124 FUNIL DIVERSOS 84798999 5.102 UN 1 45 45 0,00 0,00 0,00 0,00 0,00
DADOS ADICIONAIS
INFORMAÇÕESCOMPLEMENTARES:
EMPRESA  ENQUADRADA  NO  SIMPLES  NACIONAL  -  NCO  GERA  DIREITO  A  CREDITO;DE  IPI,
ICMS E ISSQN.;
RESERVADOAOFISCO:`;
};
</script>
</body>
</html>
