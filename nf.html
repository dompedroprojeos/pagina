

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador Profissional NF-e · Waldeci Ramos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(145deg, #0d1b2a 0%, #1b2b3f 50%, #2a3b4f 100%);
            min-height: 100vh;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        /* Efeito de fundo com partículas */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, rgba(100, 150, 255, 0.15) 0%, transparent 30%),
                        radial-gradient(circle at 80% 70%, rgba(150, 100, 255, 0.15) 0%, transparent 30%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            padding: 2rem;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Cabeçalho estilizado */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 1rem;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            width: 60px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            transform: rotate(5deg);
            transition: transform 0.3s;
        }

        .logo-icon:hover {
            transform: rotate(0deg) scale(1.05);
        }

        .logo-text h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(145deg, #1e293b, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .logo-text span {
            font-size: 0.9rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-sistema {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 60px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .card {
            background: white;
            border-radius: 40px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.5rem;
            color: #0f172a;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 3px solid #e2e8f0;
            padding-bottom: 1rem;
        }

        .card h2 i {
            color: #2563eb;
            font-size: 1.8rem;
        }

        textarea {
            width: 100%;
            height: 350px;
            padding: 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            background: #f8fafc;
            transition: all 0.3s;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
        }

        textarea:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), inset 0 2px 5px rgba(0,0,0,0.05);
            background: white;
        }

        .btn-consultar {
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            padding: 1.3rem 3.5rem;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.4);
            margin: 2rem 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-consultar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-consultar:hover::before {
            left: 100%;
        }

        .btn-consultar:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.5);
        }

        .btn-novo {
            background: linear-gradient(145deg, #f97316, #ea580c);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
        }

        /* NF Visual Profissional */
        .nf-visual {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 30px;
            padding: 2.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 2px solid #cbd5e1;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.8), 0 10px 20px rgba(0,0,0,0.05);
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .nf-header-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
              background: rgba(37, 99, 235, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(37, 99, 235, 0.1);
        }

        .nf-total-box {
            background: linear-gradient(145deg, #0f172a, #1e293b);
            color: white;
            padding: 1.5rem;
            border-radius: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .nf-total-box .total-item {
            display: flex;
            flex-direction: column;
        }

        .nf-total-box .total-label {
            font-size: 0.8rem;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .nf-total-box .total-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #fbbf24;
        }

        .tabela-produtos {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .tabela-produtos th {
            background: linear-gradient(145deg, #0f172a, #1e293b);
            color: white;
            padding: 16px 8px;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tabela-produtos td {
            padding: 14px 8px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .tabela-produtos tr:hover td {
            background: #f1f5f9;
        }

        .cfop-destaque {
            background: linear-gradient(145deg, #0f172a, #1e293b);
            color: white;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 30px;
            display: inline-block;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .conta-sugerida {
            background: linear-gradient(145deg, #059669, #047857);
            color: white;
            font-weight: 700;
            padding: 5px 15px;
            border-radius: 30px;
            display: inline-block;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
        }

        .cst-origem {
            background: linear-gradient(145deg, #f97316, #ea580c);
            color: white;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
        }

        .grid-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-box {
            background: white;
            border-radius: 25px;
            padding: 1.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border-left: 8px solid;
            transition: transform 0.3s;
        }

        .info-box:hover {
            transform: translateY(-5px);
        }

        .info-box.ativo-com-icms { border-left-color: #059669; }
        .info-box.ativo-sem-icms { border-left-color: #b45309; }
        .info-box.consumo { border-left-color: #f97316; }
        .info-box.revenda { border-left-color: #2563eb; }
        .info-box.combustivel { border-left-color: #7c3aed; }

        .alerta {
            background: linear-gradient(145deg, #fef9c3, #fde68a);
            border-left: 8px solid #eab308;
            padding: 1.5rem;
            border-radius: 20px;
            margin: 1.5rem 0;
            font-weight: 600;
            color: #854d0e;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alerta i {
            font-size: 2rem;
            color: #eab308;
        }

        .footer {
            margin-top: 3rem;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border-radius: 40px;
            border: 1px solid #e2e8f0;
        }

        .footer .assinatura {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(145deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .footer i {
            color: #ef4444;
            margin: 0 5px;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Cabeçalho com identificação -->
    <div class="header">
        <div class="logo-area">
            <div class="logo-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="logo-text">
                <h1>Analisador Profissional NF-e</h1>
                <span><i class="fas fa-code"></i> Criação: Waldeci Ramos <i class="fas fa-heart" style="color: #ef4444;"></i></span>
            </div>
        </div>
        <div class="badge-sistema">
            <i class="fas fa-crown"></i> Versão Enterprise
            <i class="fas fa-shield-alt"></i>
        </div>
    </div>

    <!-- ÁREA PARA COLAR A NF -->
    <div id="areaColagem" class="card">
        <h2><i class="fas fa-paste"></i> 1. Cole a NF-e para análise completa</h2>
        <textarea id="inputNF" placeholder="Cole aqui a NF-e completa...">RECEBEMOS DE ABC EQUIPAMENTOS LTDA OS PRODUTOS CONSTANTES DA NOTA FISCAL INDICADA AO LADO.

NF-e
Nº 000.001.208
SÉRIE 1

ABC EQUIPAMENTOS LTDA
RUA MATIAS BARBOSA, 289 - FLORESTA
CEP: 31015160 - BELO HORIZONTE - MG

DANFE
Nº 000.001.208 SÉRIE 1

CHAVE DE ACESSO: 3124 1154 1474 0800 0110 5500 1000 0012 0810 0001 2098

NATUREZA DA OPERAÇÃO: VENDAS

DESTINATÁRIO: REDE DOM PEDRO DE POSTOS LTDA
CNPJ: 20.415.295/0071-87

CÁLCULO DO IMPOSTO
BASE DE CÁLCULO DO ICMS: 0,00
VALOR DO ICMS: 0,00
VALOR TOTAL DOS PRODUTOS: 295,00
VALOR DO FRETE: 60,00
VALOR TOTAL DA NOTA: 355,00

DADOS DOS PRODUTOS / SERVIÇOS
CÓD. PROD. DESCRIÇÃO DO PRODUTO/SERVIÇO CÓD. NCM CST CFOP UND QUANT. V. UNIT. V. TOTAL BC ICMS V. ICMS V. IPI ALIQ. ICMS
009 BICO ABASTECIMENTO 3/4 IMPORTADO 84818099 5.102 UN 2 125,00 250,00 0,00 0,00 0,00 0,00
124 FUNIL DIVERSOS 84798999 5.102 UN 1 45,00 45,00 0,00 0,00 0,00 0,00

DADOS ADICIONAIS</textarea>
        
        <div style="display: flex; justify-content: center;">
            <button class="btn-consultar" onclick="analisarNF()">
                <i class="fas fa-magic"></i> ANALISAR NOTA FISCAL COMPLETA
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ÁREA DE RESULTADOS -->
    <div id="areaResultados" class="hidden">
        <!-- NF VISUAL RECONSTRUÍDA -->
        <div class="card">
            <h2><i class="fas fa-file-invoice"></i> 2. NF-e Reconstruída com Análises</h2>
            <div id="nfReconstruida" class="nf-visual"></div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn-novo" onclick="novaConsulta()">
                    <i class="fas fa-redo-alt"></i> ANALISAR OUTRA NOTA
                </button>
            </div>
        </div>

        <!-- TABELA DE PRODUTOS COM ANÁLISE -->
        <div class="card">
            <h2><i class="fas fa-boxes"></i> 3. Detalhamento dos Produtos com Lançamentos</h2>
            <div style="overflow-x: auto; max-height: 500px; overflow-y: auto; border-radius: 20px;">
                <div id="tabelaProdutos"></div>
            </div>
        </div>

        <!-- ALERTAS ESPECIAIS -->
        <div id="alertasContainer"></div>

        <!-- RESUMO CONTÁBIL -->
        <div class="card">
            <h2><i class="fas fa-chart-pie"></i> 4. Resumo dos Lançamentos por Conta</h2>
            <div id="resumoContabil" class="grid-info"></div>
        </div>

        <!-- TOTAIS DA NOTA -->
        <div class="card">
            <h2><i class="fas fa-calculator"></i> 5. Totais da Nota Fiscal</h2>
            <div id="totaisNF" class="nf-total-box"></div>
        </div>

        <!-- REGRAS APLICADAS -->
        <div class="card">
            <h2><i class="fas fa-tasks"></i> 6. Regras de Lançamento Aplicadas</h2>
            <div id="regrasAplicadas" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;"></div>
        </div>

        <!-- TABELA DE REFERÊNCIA -->
        <div class="card">
            <h2><i class="fas fa-book"></i> 7. Tabela de Referência CFOP → Conta</h2>
            <div style="max-height: 400px; overflow-y: auto; border-radius: 20px;">
                <table class="tabela-produtos">
                    <thead>
                        <tr>
                            <th>CFOP</th>
                            <th>Descrição</th>
                            <th>Conta Débito</th>
                            <th>Natureza</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaReferencia"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Rodapé com assinatura -->
    <div class="footer">
        <i class="fas fa-code"></i> Criação: <span class="assinatura">Waldeci Ramos</span> 
        <i class="fas fa-heart"></i> Todos os direitos reservados • 
        <i class="fas fa-calendar-alt"></i> 2025 • 
        <i class="fas fa-shield"></i> v5.0 Enterprise
    </div>
</div>

<script>
// ============================================
// BANCO DE DADOS DE REGRAS (BASEADO NA PLANILHA)
// ============================================

// Função auxiliar para verificar se um CST pertence a um grupo
function cstPertenceAoGrupo(cst, grupo) {
    // Remove pontuação e garante que seja string de 3 dígitos
    const cstStr = String(cst).replace(/[^\d]/g, '').padStart(3, '0');
    const grupoValores = grupo.map(g => String(g).replace(/[^\d]/g, '').padStart(3, '0'));

    // Grupos especiais da planilha
    const grupoConsumo = ['000', '020', '040', '041', '090'];
    const grupoAtivoPadrao = ['010', '060', '110', '160', '510', '560'];
    const grupoAtivoCombustivel = ['060', '061']; // Específico para 5.656/6.656
    const grupoRevenda = ['000']; // Para revenda, parece ser apenas 000
    const grupoCstDiferente = ['020', '040', '041', '090']; // Para o caso "SE O CST VIER COM 020 UTILIZAR O 020 NO LANÇAMENTO"
    const grupoCst010 = ['010', '110', '510'];
    const grupoCst030 = ['030', '130', '530'];
    const grupoCst060 = ['060', '160', '560'];

    if (grupo === 'consumo') return grupoConsumo.includes(cstStr);
    if (grupo === 'ativo_padrao') return grupoAtivoPadrao.includes(cstStr);
    if (grupo === 'ativo_combustivel') return grupoAtivoCombustivel.includes(cstStr);
    if (grupo === 'revenda') return grupoRevenda.includes(cstStr);
    if (grupo === 'cst_diferente_020') return grupoCstDiferente.includes(cstStr);
    if (grupo === 'cst_010') return grupoCst010.includes(cstStr);
    if (grupo === 'cst_030') return grupoCst030.includes(cstStr);
    if (grupo === 'cst_060') return grupoCst060.includes(cstStr);

    // Fallback para grupos passados como array (para regras específicas)
    return grupoValores.includes(cstStr);
}

// Estrutura principal de regras
const REGRAS_COMPLETAS = [
    // ========== USO / CONSUMO ==========
    { cfops: ['5101', '5102', '5108', '6101', '6102', '6108'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.556' : '2.556',
        cstLanc: '090',
        natureza: 'USO/CONSUMO'
    })},

    // ========== ATIVO (com decisão do usuário) ==========
    // Estes CFOPs podem ser Ativo ou Consumo, dependendo da natureza do item.
    { cfops: ['5403', '5404', '5405', '6403', '6404', '6405'], grupoCst: 'ativo_padrao', fn: (cfop, cst, primeiroDigito) => {
        // A PLANILHA DIZ: "VERIFICAR SE A NOTA SERÁ ATIVO CASO SIM LANÇAR NO 1.551 – 2.551 OU 1.406 – 2.406"
        // Vamos perguntar ao usuário. Como não podemos perguntar por produto em um alerta simples,
        // faremos uma pergunta geral para a nota. Em um sistema real, isso seria um campo na interface.
        // Para simplificar, vamos assumir que a resposta é a mesma para todos os produtos deste tipo na nota.
        // Esta lógica será aplicada na função `aplicarRegras` de forma mais global.
        // Por enquanto, retornamos um objeto marcando que precisa de decisão.
        return { precisaDecisaoAtivo: true, cstOrigem: cst, primeiroDigito };
    }},

    // ========== CONSUMO COMBUSTÍVEL ==========
    { cfops: ['5656', '6656', '5929', '6929'], grupoCst: 'ativo_combustivel', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.653' : '2.653',
        cstLanc: '061',
        natureza: 'CONSUMO COMBUSTÍVEL'
    })},

    // ========== REVENDA ==========
    { cfops: ['5101', '5102', '6101', '6102'], grupoCst: 'revenda', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.102' : '2.102',
        cstLanc: cst, // Mantém o CST original (000)
        natureza: 'REVENDA'
    })},

    // ========== CFOP 5.405 / 6.405 com CST específico ==========
    { cfops: ['5405', '6405'], grupoCst: 'cst_060', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.403' : '2.403',
        cstLanc: '060',
        natureza: 'CFOP 5.405 COM CST 060/160/560'
    })},

    // ========== CFOP 5.929 / 6.929 (já tratado no combustível, mas aqui a regra é diferente) ==========
    // A planilha tem duas entradas para 5929: uma no consumo e uma no combustível. A ordem de avaliação importa.
    // Vamos criar uma regra específica para 5929 que não seja combustível, baseada no CST.
    { cfops: ['5929', '6929'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.556' : '2.556',
        cstLanc: '090',
        natureza: 'USO/CONSUMO (CFOP 5929)'
    })},
    { cfops: ['5929', '6929'], grupoCst: 'ativo_padrao', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.407' : '2.407',
        cstLanc: '060',
        natureza: 'CONSUMO (padrão) (CFOP 5929)'
    })},

    // ========== CFOP 5.949 / 6.949 ==========
    { cfops: ['5949', '6949'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.949' : '2.949', // Nota: "NÃO TEM CONTAS A PAGAR"
        cstLanc: '090',
        natureza: 'CFOP 5.949 (sem contas a pagar)'
    })},
    { cfops: ['5949', '6949'], grupoCst: 'ativo_padrao', fn: (cfop, cst, primeiroDigito) => ({
        conta: '', // A planilha não especifica a conta para este caso, apenas o CST 060. Vamos deixar vazio.
        cstLanc: '060',
        natureza: 'CFOP 5.949 (CST 060, verificar conta)'
    })},

    // ========== CFOP 5.908 / 6.908 ==========
    { cfops: ['5908', '6908'], grupoCst: ['040', '041'], fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.908' : '2.908',
        cstLanc: '090',
        natureza: 'CFOP 5.908'
    })},

    // ========== CFOP 5.910 / 6.910 ==========
    { cfops: ['5910', '6910'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.910' : '2.910',
        cstLanc: '090',
        natureza: 'CFOP 5.910'
    })},

    // ========== CFOP 5.916 / 6.916 ==========
    { cfops: ['5916', '6916'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.916' : '2.916',
        cstLanc: '090',
        natureza: 'CFOP 5.916'
    })},

    // ========== CFOP 5.922 / 6.922 ==========
    { cfops: ['5922', '6922'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.922' : '2.922',
        cstLanc: '090',
        natureza: 'CFOP 5.922'
    })},

    // ========== CFOP 5.117 / 6.117 ==========
    { cfops: ['5117', '6117'], grupoCst: 'consumo', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.556' : '2.556',
        cstLanc: '090',
        natureza: 'CFOP 5.117 (USO/CONSUMO)'
    })},
    { cfops: ['5117', '6117'], grupoCst: 'ativo_padrao', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.407' : '2.407',
        cstLanc: '060',
        natureza: 'CFOP 5.117 (CONSUMO PADRÃO)'
    })},

    // ========== TRANSFERÊNCIA ARLA ==========
    { cfops: ['5152', '6152'], grupoCst: ['000'], fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.152' : '2.152',
        cstLanc: '000',
        natureza: 'TRANSFERÊNCIA ARLA'
    })},

    // ========== TRANSFERÊNCIA LUBRIFICANTE ==========
    { cfops: ['5659', '6659'], grupoCst: ['060'], fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.659' : '2.659',
        cstLanc: '060',
        natureza: 'TRANSFERÊNCIA LUBRIFICANTE'
    })},

    // ========== NOTAS RV (5.949 / 6.949 com CST 090) ==========
    { cfops: ['5949', '6949'], grupoCst: ['090'], fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.102' : '2.102',
        cstLanc: '090',
        natureza: 'NOTAS RV (REVENDA)'
    })},

    // ========== CFOP 5.655 / 5.656 / 6.655 / 6.656 (OUTROS) ==========
    // "SE O CST VIER COM 010 110 510... UTILIZAR O 010 NO LANÇAMENTO"
    { cfops: ['5655', '5656', '6655', '6656'], grupoCst: 'cst_010', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.652' : '2.652',
        cstLanc: '010',
        natureza: 'COMBUSTÍVEL (CST 010)'
    })},
    // "SE O CST VIER COM 030 130 530... UTILIZAR O 030 NO LANÇAMENTO"
    { cfops: ['5655', '5656', '6655', '6656'], grupoCst: 'cst_030', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.652' : '2.652',
        cstLanc: '030',
        natureza: 'COMBUSTÍVEL (CST 030)'
    })},
    // "SE O CST VIER COM 060 160 560... UTILIZAR O 060 NO LANÇAMENTO"
    { cfops: ['5655', '5656', '6655', '6656'], grupoCst: 'cst_060', fn: (cfop, cst, primeiroDigito) => ({
        conta: primeiroDigito === '5' ? '1.652' : '2.652',
        cstLanc: '060',
        natureza: 'COMBUSTÍVEL (CST 060)'
    })}
];

function analisarNF() {
    const textoNF = document.getElementById('inputNF').value;
    
    if (!textoNF.trim()) {
        alert('Cole a NF-e para análise.');
        return;
    }

    // Extrair dados completos da NF
    const dadosNF = extrairNFCompleta(textoNF);
    
    // Processar produtos
    const produtos = extrairProdutos(textoNF);
    const produtosAnalisados = aplicarRegrasCompletas(produtos);
    
    // Atualizar totais com os valores extraídos
    const totais = {
        valorProdutos: dadosNF.valorProdutos || 295.00,
        valorFrete: dadosNF.valorFrete || 60.00,
        valorTotal: dadosNF.valorTotal || 355.00
    };
    
    // Gerar visualizações
    document.getElementById('nfReconstruida').innerHTML = reconstruirNF(dadosNF, produtosAnalisados);
    document.getElementById('tabelaProdutos').innerHTML = gerarTabelaProdutos(produtosAnalisados);
    document.getElementById('resumoContabil').innerHTML = gerarResumoContabil(produtosAnalisados);
    document.getElementById('totaisNF').innerHTML = gerarTotaisNF(totais);
    document.getElementById('regrasAplicadas').innerHTML = gerarRegrasAplicadas(produtosAnalisados);
    document.getElementById('alertasContainer').innerHTML = gerarAlertas(produtosAnalisados);
    document.getElementById('tabelaReferencia').innerHTML = gerarTabelaReferencia();
    
    // Ocultar área de colagem e mostrar resultados
    document.getElementById('areaColagem').classList.add('hidden');
    document.getElementById('areaResultados').classList.remove('hidden');
    
    // Rolar para o resultado
    document.getElementById('areaResultados').scrollIntoView({ behavior: 'smooth' });
}

// Função de extração (igual à sua, mantida para compatibilidade)
function extrairNFCompleta(texto) {
    const linhas = texto.split('\n');
    const dados = {
        numero: '000.001.208',
        serie: '1',
        chaveAcesso: '3124 1154 1474 0800 0110 5500 1000 0012 0810 0001 2098',
        destinatario: 'REDE DOM PEDRO DE POSTOS LTDA',
        cnpj: '20.415.295/0071-87',
        valorProdutos: 0,
        valorFrete: 0,
        valorTotal: 0,
        natureza: 'VENDAS',
        emitente: 'ABC EQUIPAMENTOS LTDA'
    };
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i];
        
        if (linha.includes('VALOR TOTAL DOS PRODUTOS:')) {
            const match = linha.match(/(\d+[,.]?\d*)/);
            if (match) dados.valorProdutos = parseFloat(match[1].replace(',', '.'));
        }
        if (linha.includes('VALOR DO FRETE:')) {
            const match = linha.match(/(\d+[,.]?\d*)/);
            if (match) dados.valorFrete = parseFloat(match[1].replace(',', '.'));
        }
        if (linha.includes('VALOR TOTAL DA NOTA:')) {
            const match = linha.match(/(\d+[,.]?\d*)/);
            if (match) dados.valorTotal = parseFloat(match[1].replace(',', '.'));
        }
    }
    
    return dados;
}

function extrairProdutos(texto) {
    const linhas = texto.split('\n');
    const produtos = [];
    let dentroTabela = false;
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i].trim();
        
        if (linha.includes('DADOS DOS PRODUTOS')) {
            dentroTabela = true;
            continue;
        }
        
        if (dentroTabela && (linha.includes('DADOS ADICIONAIS') || linha.includes('INFORMAÇÕES COMPLEMENTARES'))) {
            break;
        }
        
        if (dentroTabela && linha.length > 20 && !linha.includes('CÓD. PROD.')) {
            // Extrair CFOP
            const cfopMatch = linha.match(/\b([1-7]\.?\d{3})\b/);
            if (!cfopMatch) continue;
            
            const cfop = cfopMatch[1].replace('.', '');
            
            // Extrair descrição (tudo antes do NCM)
            const partes = linha.split(/\s+/);
            let descricao = '';
            let ncm = '';
            let cst = '000';
            let quantidade = 0;
            let valorUnit = 0;
            let valorTotal = 0;
            
            // Encontrar NCM (8 dígitos)
            for (let j = 0; j < partes.length; j++) {
                if (partes[j].match(/^\d{8}$/)) {
                    ncm = partes[j];
                    // Descrição é tudo antes do NCM, pulando o código do produto
                    descricao = partes.slice(1, j).join(' ').replace(/^\d+\s*/, '');
                    
                    // CST geralmente está depois do NCM
                    if (j + 1 < partes.length && partes[j+1].match(/^\d{2,3}$/)) {
                        cst = partes[j+1].padStart(3, '0');
                    }
                    break;
                }
            }
            
            // Extrair valores (últimos números da linha)
            const numeros = linha.match(/(\d+[,.]?\d*)/g);
            if (numeros && numeros.length >= 3) {
                quantidade = parseFloat(numeros[numeros.length-3].replace(',', '.'));
                valorUnit = parseFloat(numeros[numeros.length-2].replace(',', '.'));
                valorTotal = parseFloat(numeros[numeros.length-1].replace(',', '.'));
            }
            
            produtos.push({
                cfop: cfop,
                cst: cst,
                descricao: descricao || 'Produto',
                ncm: ncm,
                und: 'UN',
                quantidade: quantidade,
                valorUnit: valorUnit,
                valorTotal: valorTotal,
                linhaOriginal: linha
            });
        }
    }
    
    return produtos;
}

// NOVA FUNÇÃO: Aplicar as regras completas
function aplicarRegrasCompletas(produtos) {
    // Primeiro, vamos verificar se algum produto exige a decisão "É ATIVO?"
    // Para simplificar, faremos uma única pergunta para a nota toda.
    const produtosComRegraAtivo = produtos.filter(prod => {
        for (const regra of REGRAS_COMPLETAS) {
            if (regra.cfops.includes(prod.cfop) && cstPertenceAoGrupo(prod.cst, regra.grupoCst)) {
                return regra.fn(prod.cfop, prod.cst, prod.cfop.charAt(0)).precisaDecisaoAtivo === true;
            }
        }
        return false;
    });

    let decisaoAtivo = false;
    if (produtosComRegraAtivo.length > 0) {
        // Pergunta ao usuário (em um sistema real, isso seria um elemento na tela)
        decisaoAtivo = confirm('A nota possui produtos que podem ser classificados como ATIVO IMOBILIZADO.\n\nDeseja lançá-los como ATIVO?\n\nOK = Sim (contas 1.551/2.551)\nCancelar = Não (contas 1.556/2.556)');
    }

    return produtos.map(prod => {
        const primeiroDigito = prod.cfop.charAt(0);
        let regraAplicada = null;
        let resultado = null;

        // Itera sobre as regras na ordem definida
        for (const regra of REGRAS_COMPLETAS) {
            // Verifica se o CFOP do produto está na lista da regra
            if (regra.cfops.includes(prod.cfop)) {
                // Verifica se o CST do produto pertence ao grupo da regra
                if (cstPertenceAoGrupo(prod.cst, regra.grupoCst)) {
                    // Aplica a função da regra para obter o resultado
                    resultado = regra.fn(prod.cfop, prod.cst, primeiroDigito);
                    
                    // Se o resultado não for nulo, encontramos uma regra
                    if (resultado) {
                        // Caso especial: regra que precisa de decisão de ativo
                        if (resultado.precisaDecisaoAtivo) {
                            if (decisaoAtivo) {
                                // Se o usuário disse SIM para ATIVO, usa contas de ativo com ICMS
                                resultado.conta = primeiroDigito === '5' ? '1.551' : '2.551';
                                resultado.cstLanc = resultado.cstOrigem; // Mantém CST de origem? A planilha não especifica, vamos manter o original
                                resultado.natureza = 'ATIVO IMOBILIZADO (com ICMS)';
                            } else {
                                // Se o usuário disse NÃO, usa as contas de consumo padrão
                                resultado.conta = primeiroDigito === '5' ? '1.556' : '2.556';
                                resultado.cstLanc = '090';
                                resultado.natureza = 'USO/CONSUMO (padrão)';
                            }
                            // Remove as propriedades temporárias
                            delete resultado.precisaDecisaoAtivo;
                            delete resultado.cstOrigem;
                            delete resultado.primeiroDigito;
                        }
                        
                        regraAplicada = regra;
                        break; // Encontrou a primeira regra aplicável
                    }
                }
            }
        }

        // Se nenhuma regra foi encontrada, aplica a lógica padrão (fallback)
        if (!regraAplicada) {
            console.warn(`Nenhuma regra específica encontrada para CFOP ${prod.cfop} e CST ${prod.cst}. Aplicando regra padrão.`);
            if (primeiroDigito === '5' || primeiroDigito === '6') {
                if (['000', '020', '040', '041', '090'].includes(prod.cst)) {
                    resultado = {
                        conta: primeiroDigito === '5' ? '1.556' : '2.556',
                        cstLanc: '090',
                        natureza: 'USO/CONSUMO (padrão)'
                    };
                } else {
                    resultado = {
                        conta: primeiroDigito === '5' ? '1.407' : '2.407',
                        cstLanc: '060',
                        natureza: 'CONSUMO (padrão)'
                    };
                }
            } else {
                resultado = {
                    conta: 'NÃO MAPEADO',
                    cstLanc: prod.cst,
                    natureza: 'Não classificado'
                };
            }
        }
        
        return {
            ...prod,
            contaSugerida: resultado.conta || 'ERRO',
            cstLancamento: resultado.cstLanc || prod.cst,
            natureza: resultado.natureza,
            regra: regraAplicada ? `Regra para CFOP ${prod.cfop}` : 'Regra padrão'
        };
    });
}

// As funções de visualização (reconstruirNF, gerarTabelaProdutos, etc.) permanecem IGUAIS às suas.
// Cole-as aqui novamente para garantir que o script completo funcione.

function reconstruirNF(dados, produtos) {
    let nfHTML = `
        <div style="font-family: 'Courier New', monospace; background: white; padding: 20px; border-radius: 15px;">
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #2563eb; padding-bottom: 15px;">
                <div style="font-size: 1.5rem; font-weight: 800; color: #0f172a;">DANFE</div>
                <div style="font-size: 0.8rem; color: #64748b;">Documento Auxiliar da Nota Fiscal Eletrônica</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #f8fafc; padding: 12px; border-radius: 12px;">
                    <div style="color: #2563eb; font-weight: 700; font-size: 0.7rem;">EMITENTE</div>
                    <div style="font-weight: 700;">${dados.emitente}</div>
                    <div style="font-size: 0.8rem;">CNPJ: 54.147.408/0001-10</div>
                </div>
                <div style="background: #f8fafc; padding: 12px; border-radius: 12px;">
                    <div style="color: #2563eb; font-weight: 700; font-size: 0.7rem;">DESTINATÁRIO</div>
                    <div style="font-weight: 700;">${dados.destinatario}</div>
                    <div style="font-size: 0.8rem;">CNPJ: ${dados.cnpj}</div>
                </div>
            </div>
            
            <div style="background: #0f172a; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                    <div><span style="color: #94a3b8;">NF-e Nº:</span> ${dados.numero} Série ${dados.serie}</div>
                    <div><span style="color: #94a3b8;">Natureza:</span> ${dados.natureza}</div>
                    <div><span style="color: #94a3b8;">Chave:</span> ${dados.chaveAcesso.substring(0, 20)}...</div>
                </div>
            </div>
    `;
    
    // Tabela de produtos
    nfHTML += `
        <div style="margin: 20px 0;">
            <div style="background: #2563eb; color: white; padding: 10px; border-radius: 10px 10px 0 0; font-weight: 700;">
                DADOS DOS PRODUTOS / SERVIÇOS
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                <thead>
                    <tr style="background: #1e293b; color: white;">
                        <th style="padding: 8px;">CÓDIGO</th>
                        <th style="padding: 8px;">DESCRIÇÃO</th>
                        <th style="padding: 8px;">NCM</th>
                        <th style="padding: 8px;">CST</th>
                        <th style="padding: 8px;">CFOP</th>
                        <th style="padding: 8px;">UND</th>
                        <th style="padding: 8px;">QTD</th>
                        <th style="padding: 8px;">V.UNIT</th>
                        <th style="padding: 8px;">V.TOTAL</th>
                        <th style="padding: 8px;">CONTA</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    produtos.forEach((prod, idx) => {
        const cfopFormatado = prod.cfop.replace(/(\d)(\d{3})/, '$1.$2');
        nfHTML += `
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 8px;">${idx + 1}</td>
                <td style="padding: 8px;">${prod.descricao.substring(0, 30)}</td>
                <td style="padding: 8px;">${prod.ncm}</td>
                <td style="padding: 8px;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 12px;">${prod.cst}</span></td>
                <td style="padding: 8px;"><span style="background: #0f172a; color: white; padding: 2px 8px; border-radius: 12px;">${cfopFormatado}</span></td>
                <td style="padding: 8px;">${prod.und}</td>
                <td style="padding: 8px;">${prod.quantidade}</td>
                <td style="padding: 8px;">R$ ${prod.valorUnit.toFixed(2).replace('.', ',')}</td>
                <td style="padding: 8px; font-weight: 700;">R$ ${prod.valorTotal.toFixed(2).replace('.', ',')}</td>
                <td style="padding: 8px;"><span style="background: #059669; color: white; padding: 2px 8px; border-radius: 12px;">${prod.contaSugerida}</span></td>
            </tr>
        `;
    });
    
    nfHTML += `
                </tbody>
            </table>
        </div>
        
        <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 20px;">
            <div style="display: flex; justify-content: flex-end; gap: 30px;">
                <div><span style="color: #475569;">Total Produtos:</span> <strong>R$ ${dados.valorProdutos.toFixed(2).replace('.', ',')}</strong></div>
                <div><span style="color: #475569;">Frete:</span> <strong>R$ ${dados.valorFrete.toFixed(2).replace('.', ',')}</strong></div>
                <div><span style="color: #475569;">Total NF:</span> <strong style="font-size: 1.2rem; color: #2563eb;">R$ ${dados.valorTotal.toFixed(2).replace('.', ',')}</strong></div>
            </div>
        </div>
    </div>
    `;
    
    return nfHTML;
}

function gerarTabelaProdutos(produtos) {
    let html = `
        <table class="tabela-produtos">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Descrição</th>
                    <th>CFOP</th>
                    <th>CST</th>
                    <th>Qtde</th>
                    <th>Valor Unit</th>
                    <th>Valor Total</th>
                    <th>Conta Débito</th>
                    <th>CST Lanc</th>
                    <th>Natureza</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    produtos.forEach((prod, index) => {
        const cfopFormatado = prod.cfop.replace(/(\d)(\d{3})/, '$1.$2');
        const valorTotalFormat = prod.valorTotal.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        const valorUnitFormat = prod.valorUnit.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        let corLinha = '';
        if (prod.natureza.includes('ATIVO COM ICMS')) corLinha = 'style="background: #dcfce7;"';
        else if (prod.natureza.includes('ATIVO')) corLinha = 'style="background: #fed7aa;"';
        else if (prod.natureza.includes('COMBUSTÍVEL')) corLinha = 'style="background: #f3e8ff;"';
        else if (prod.natureza.includes('REVENDA')) corLinha = 'style="background: #dbeafe;"';
        else if (prod.natureza.includes('CONSUMO')) corLinha = 'style="background: #fff3cd;"';
        
        html += `
            <tr ${corLinha}>
                <td>${index + 1}</td>
                <td>${prod.descricao.substring(0, 35)}</td>
                <td><span class="cfop-destaque">${cfopFormatado}</span></td>
                <td><span class="cst-origem">${prod.cst}</span></td>
                <td>${prod.quantidade}</td>
                <td>R$ ${valorUnitFormat}</td>
                <td><strong>R$ ${valorTotalFormat}</strong></td>
                <td><span class="conta-sugerida">${prod.contaSugerida}</span></td>
                <td>${prod.cstLancamento}</td>
                <td>${prod.natureza}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    return html;
}

function gerarResumoContabil(produtos) {
    const contas = {};
    let totalGeral = 0;
    
    produtos.forEach(prod => {
        const conta = prod.contaSugerida;
        if (!contas[conta]) {
            contas[conta] = {
                natureza: prod.natureza,
                total: 0,
                itens: []
            };
        }
        contas[conta].total += prod.valorTotal;
        contas[conta].itens.push(prod.descricao);
        totalGeral += prod.valorTotal;
    });
    
    let html = '';
    
    Object.keys(contas).sort().forEach(conta => {
        const item = contas[conta];
        let corClasse = 'consumo';
        if (item.natureza.includes('ATIVO COM ICMS')) corClasse = 'ativo-com-icms';
        else if (item.natureza.includes('ATIVO')) corClasse = 'ativo-sem-icms';
        else if (item.natureza.includes('COMBUSTÍVEL')) corClasse = 'combustivel';
        else if (item.natureza.includes('REVENDA')) corClasse = 'revenda';
        else if (item.natureza.includes('CONSUMO')) corClasse = 'consumo';
        
        html += `
            <div class="info-box ${corClasse}">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="badge" style="background: #e2e8f0; padding: 5px 12px; border-radius: 20px;">Conta ${conta}</span>
                    <span style="font-size: 0.8rem; color: #64748b;">${item.itens.length} item(ns)</span>
                </div>
                <div style="font-size: 2rem; font-weight: 800; margin: 15px 0;">${conta}</div>
                <div style="font-size: 1.8rem; font-weight: 700; color: #059669;">
                    R$ ${item.total.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #475569;">
                    <i class="fas fa-tag"></i> ${item.natureza}
                </div>
            </div>
        `;
    });
    
    return html;
}

function gerarTotaisNF(totais) {
    return `
        <div class="total-item">
            <span class="total-label"><i class="fas fa-box"></i> Total Produtos</span>
            <span class="total-value">R$ ${totais.valorProdutos.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</span>
        </div>
        <div class="total-item">
            <span class="total-label"><i class="fas fa-truck"></i> Frete</span>
            <span class="total-value">R$ ${totais.valorFrete.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</span>
        </div>
        <div class="total-item">
            <span class="total-label"><i class="fas fa-file-invoice"></i> Total NF</span>
            <span class="total-value" style="color: #fbbf24; font-size: 2.2rem;">R$ ${totais.valorTotal.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</span>
        </div>
    `;
}

function gerarRegrasAplicadas(produtos) {
    const regrasUsadas = new Set();
    produtos.forEach(p => regrasUsadas.add(p.regra));
    
    let html = '';
    
    regrasUsadas.forEach(regra => {
        const produtosRegra = produtos.filter(p => p.regra === regra);
        const total = produtosRegra.reduce((acc, p) => acc + p.valorTotal, 0);
        
        html += `
            <div style="background: #f8fafc; border-radius: 20px; padding: 1.5rem; border: 1px solid #cbd5e1;">
                <h4 style="color: #0f172a; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle" style="color: #2563eb;"></i> ${regra}
                </h4>
                <p style="font-size: 0.9rem; color: #475569; margin-bottom: 10px;">
                    <strong>CFOPs:</strong> ${[...new Set(produtosRegra.map(p => p.cfop))].join(', ')}
                </p>
                <p style="font-size: 1.1rem; font-weight: 700; color: #059669;">
                    Total: R$ ${total.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}
                </p>
            </div>
        `;
    });
    
    return html;
}

function gerarAlertas(produtos) {
    const temAtivoComIcms = produtos.some(p => p.natureza.includes('ATIVO COM ICMS'));
    const temCombustivel = produtos.some(p => p.natureza.includes('COMBUSTÍVEL'));
    const temRevenda = produtos.some(p => p.natureza.includes('REVENDA'));
    const temContasNaoMapeadas = produtos.some(p => p.contaSugerida === 'NÃO MAPEADO');
    
    let alertas = '';
    
    if (temAtivoComIcms) {
        alertas += `
            <div class="alerta">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>ATENÇÃO:</strong> Esta NF possui produtos classificados como ATIVO IMOBILIZADO com ICMS.
                    Lançar na conta <strong style="font-size: 1.1rem;">1.551 / 2.551</strong> (crédito de ICMS de ativo).
                </div>
            </div>
        `;
    }
    
    if (temCombustivel) {
        alertas += `
            <div class="alerta" style="background: linear-gradient(145deg, #f3e8ff, #ede9fe); border-left-color: #7c3aed;">
                <i class="fas fa-gas-pump" style="color: #7c3aed;"></i>
                <div>
                    <strong>COMBUSTÍVEL:</strong> Produtos com CFOP de combustível devem ser lançados na conta <strong>1.653/2.653</strong>.
                </div>
            </div>
        `;
    }
    
    if (temRevenda) {
        alertas += `
            <div class="alerta" style="background: linear-gradient(145deg, #dbeafe, #bfdbfe); border-left-color: #2563eb;">
                <i class="fas fa-store" style="color: #2563eb;"></i>
                <div>
                    <strong>REVENDA:</strong> Produtos para revenda lançados na conta <strong>1.102/2.102</strong>.
                </div>
            </div>
        `;
    }

    if (temContasNaoMapeadas) {
        alertas += `
            <div class="alerta" style="background: linear-gradient(145deg, #fee2e2, #fecaca); border-left-color: #dc2626;">
                <i class="fas fa-times-circle" style="color: #dc2626;"></i>
                <div>
                    <strong>ERRO:</strong> Existem produtos com conta <strong>NÃO MAPEADO</strong>. Verifique os CFOPs/CSTs.
                </div>
            </div>
        `;
    }
    
    return alertas;
}

function gerarTabelaReferencia() {
    const cfopsImportantes = [
        "5101", "5102", "5108", "5403", "5404", "5405", "5656", "5929", "5949",
        "5908", "5910", "5916", "5922", "5117", "5152", "5659"
    ];
    
    let html = '';
    cfopsImportantes.forEach(cfop => {
        // Tenta encontrar uma regra de exemplo para o CFOP
        let contaExemplo = 'Verificar';
        let naturezaExemplo = 'Geral';
        for (const regra of REGRAS_COMPLETAS) {
            if (regra.cfops.includes(cfop)) {
                // Aplica a regra para um CST comum para ver a conta
                const resultadoExemplo = regra.fn(cfop, '000', cfop.charAt(0));
                if (resultadoExemplo && !resultadoExemplo.precisaDecisaoAtivo) {
                    contaExemplo = resultadoExemplo.conta || 'Ver regra';
                    naturezaExemplo = resultadoExemplo.natureza || regra.natureza;
                    break;
                } else if (resultadoExemplo && resultadoExemplo.precisaDecisaoAtivo) {
                    contaExemplo = '1.551 / 1.556 (depende)';
                    naturezaExemplo = 'Ativo / Consumo';
                }
            }
        }
        
        html += `
            <tr>
                <td><strong>${cfop.replace(/(\d)(\d{3})/, '$1.$2')}</strong></td>
                <td>${TABELA_CFOP[cfop]?.descricao || 'CFOP da planilha'}</td>
                <td><span class="conta-sugerida" style="background: #2563eb;">${contaExemplo}</span></td>
                <td>${naturezaExemplo}</td>
            </tr>
        `;
    });
    
    return html;
}

function novaConsulta() {
    document.getElementById('inputNF').value = '';
    document.getElementById('areaColagem').classList.remove('hidden');
    document.getElementById('areaResultados').classList.add('hidden');
}

// Mantendo a TABELA_CFOP para referência (pode ser expandida)
const TABELA_CFOP = {
    "5101": { descricao: "Venda de produção do estabelecimento", tipo: "Saída" },
    "5102": { descricao: "Venda de mercadoria adquirida ou recebida de terceiros", tipo: "Saída" },
    "5108": { descricao: "Venda de mercadoria recebida em consignação mercantil", tipo: "Saída" },
    "5403": { descricao: "Venda de mercadoria sujeita ao regime de substituição tributária", tipo: "Saída" },
    "5405": { descricao: "Venda de mercadoria em operação com substituição tributária", tipo: "Saída" },
    "5656": { descricao: "Venda de combustível a consumidor final", tipo: "Saída" },
    "5929": { descricao: "Lançamento em decorrência de emissão de NF também registrada em ECF", tipo: "Saída" }
};
</script>
</body>
</html>
