<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NFE XML</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            --border-radius-sm: 6px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-full: 50%;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-circle {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .logo-circle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .logo-circle i {
            font-size: 1.8rem;
            color: white;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius-md);
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .card-icon.upload {
            background: var(--accent-gradient);
        }

        .card-icon.search {
            background: var(--secondary-gradient);
        }

        .card-icon.process {
            background: var(--success-gradient);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* File Upload Styles */
        .file-upload-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #fileInput {
            display: none;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: var(--transition);
            background: #f8fafc;
            text-align: center;
            padding: 1rem;
        }

        .file-upload-label:hover {
            border-color: #667eea;
            background: #f1f5f9;
        }

        .file-upload-label.active {
            border-color: #667eea;
            background: #eff6ff;
        }

        .file-upload-icon {
            font-size: 2rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .file-count {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            background: #f1f5f9;
            border-radius: var(--border-radius-md);
        }

        /* Search Styles */
        .search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 0.9rem;
            transition: var(--transition);
            position: relative;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-group {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 1;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Process Button */
        #processButton {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            margin-top: 1rem;
        }

        /* Navigation Buttons */
        .nav-buttons {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }

        .nav-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-full);
            background: var(--primary-gradient);
            color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            transform: scale(1.1);
        }

        /* Table Styles */
        .table-container, .summary-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin: 2rem 0;
        }

        .table-header {
            padding: 1.5rem;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .nfe-table, .summary-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Garante que as colunas sejam distribuídas uniformemente */
        }

        .nfe-table th, .nfe-table td,
        .summary-table th, .summary-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            overflow-wrap: break-word; /* Permite quebra de texto em colunas longas */
            word-break: break-word; /* Garante quebra de palavras longas */
        }

        .nfe-table th, .summary-table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .nfe-table tr:hover, .summary-table tr:hover {
            background: #f8fafc;
        }

        .align-center {
            text-align: center;
        }

        .align-right {
            text-align: right;
        }

        .total-cell {
            text-align: right;
            font-weight: 600;
        }

        /* Ajuste para a coluna de Informação Adicional Fiscal */
        .nfe-table th:nth-child(13), .nfe-table td:nth-child(13),
        .summary-table th:nth-child(4), .summary-table td:nth-child(4) {
            max-width: 200px; /* Limita a largura para evitar desbordamento */
        }

        /* Responsividade para tabelas */
        @media (max-width: 768px) {
            .table-container, .summary-section {
                overflow-x: auto; /* Adiciona rolagem horizontal em telas pequenas */
            }

            .nfe-table, .summary-table {
                min-width: 1000px; /* Garante que a tabela tenha uma largura mínima */
            }
        }

        /* Footer */
        .footer {
            background: var(--text-primary);
            color: white;
            padding: 2rem;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-section p {
            font-size: 0.9rem;
            opacity: 0.8;
            line-height: 1.6;
        }

        .developer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .developer-avatar {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-full);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-link {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-full);
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .social-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Output Styles */
        #output {
            margin-top: 2rem;
        }

        .summary-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: var(--shadow-md);
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .summary-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-actions {
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                flex-direction: column;
            }

            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .developer-info {
                justify-content: center;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success Animation */
        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .checkmark {
            animation: checkmark 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-circle">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <div>
                    <div class="header-title">Dashboard NFE XML</div>
                    <div class="header-subtitle">Processamento Inteligente de Notas Fiscais</div>
                </div>
            </div>
            <div class="header-actions">
                <a href="#" class="header-btn">
                    <i class="fas fa-download"></i>
                    Exportar
                </a>
                <a href="#" class="header-btn">
                    <i class="fas fa-cog"></i>
                    Configurações
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
            <!-- Upload Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon upload">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div>
                        <div class="card-title">Upload de Arquivos</div>
                        <div class="card-description">Selecione os arquivos XML das NFEs</div>
                    </div>
                </div>
                <div class="file-upload-container">
                    <label for="fileInput" class="file-upload-label">
                        <div class="file-upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <strong>Clique para selecionar arquivos</strong>
                        <span>ou arraste e solte aqui</span>
                    </label>
                    <input type="file" id="fileInput" multiple accept=".xml">
                    <div class="file-count" id="fileCountDisplay">Nenhum arquivo selecionado</div>
                </div>
            </div>

            <!-- Search Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon search">
                        <i class="fas fa-search"></i>
                    </div>
                    <div>
                        <div class="card-title">Filtros de Busca</div>
                        <div class="card-description">Filtre os resultados por critérios específicos</div>
                    </div>
                </div>
                <div class="search-container">
                    <div class="search-group">
                        <i class="fas fa-building"></i>
                        <input type="search" id="searchInput" placeholder="Buscar por CNPJ..." class="search-input" />
                    </div>
                    <div class="search-group">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="search" id="stateInput" placeholder="Buscar por Estado (UF)..." class="search-input" />
                    </div>
                    <div class="search-group">
                        <i class="fas fa-barcode"></i>
                        <input type="search" id="productCodeInput" placeholder="Código do Produto..." class="search-input" />
                    </div>
                </div>
            </div>

            <!-- Process Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon process">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <div class="card-title">Processamento</div>
                        <div class="card-description">Execute o processamento dos arquivos</div>
                    </div>
                </div>
                <button id="processButton" class="btn btn-success">
                    <i class="fas fa-play"></i>
                    Processar Arquivos
                </button>
            </div>
        </div>

        <!-- Output Area -->
        <div id="output"></div>
    </main>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
        <button onclick="scrollToTop()" id="topButton" class="nav-btn" title="Voltar ao topo">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button onclick="scrollToBottom()" id="bottomButton" class="nav-btn" title="Ir para o fim">
            <i class="fas fa-chevron-down"></i>
        </button>
        <button onclick="printTotals()" id="printTotalsButton" class="nav-btn" title="Imprimir">
            <i class="fas fa-print"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>
                    <i class="fas fa-code"></i>
                    Desenvolvedor
                </h3>
                <div class="developer-info">
                    <div class="developer-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div>
                        <p><strong>WAR</strong></p>
                        <p></p>
                        <p>Sistemas Fiscais</p>
                    </div>
                </div>
                <div class="social-links">
                    <a href="#" class="social-link" title="LinkedIn">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="#" class="social-link" title="GitHub">
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="#" class="social-link" title="E-mail">
                        <i class="fas fa-envelope"></i>
                    </a>
                </div>
            </div>

            <div class="footer-section">
                <h3>
                    <i class="fas fa-info-circle"></i>
                    Sobre o Sistema
                </h3>
                <p>Sistema desenvolvido para processamento automatizado de arquivos XML de Notas Fiscais Eletrônicas (NFE), com foco em análise de créditos de ICMS e relatórios gerenciais.</p>
                <p><strong>Versão:</strong> 2.0.0</p>
                <p><strong>Última Atualização:</strong> Julho 2025</p>
            </div>

            <div class="footer-section">
                <h3>
                    <i class="fas fa-shield-alt"></i>
                    Tecnologias
                </h3>
                <p>• HTML5 & CSS3 Moderno</p>
                <p>• JavaScript ES6+</p>
                <p>• DOM Parser para XML</p>
                <p>• Responsive Design</p>
                <p>• Font Awesome Icons</p>
                <p>• Inter Typography</p>
            </div>

            <div class="footer-section">
                <h3>
                 
               
                <p><i class="fas fa-envelope"></i>waldeci.ramos@rededompedro</p>
                
                <p><i class="fas fa-clock"></i> Seg-21/07/2025 Atualização</p>
            </div>
        </div>
 </h3>
        <div class="footer-bottom">
            <p>© 2025 Dashboard NFE XML. Todos os direitos reservados. | Desenvolvido com <i class="fas fa-heart" style="color: #ff6b6b;"></i>Waldeci Ramos</p>
        </div>
    </footer>

    <script>
        // Navigation functions
        function scrollToBottom() {
            window.scrollTo({
                top: document.documentElement.scrollHeight,
                behavior: 'smooth'
            });
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function printTotals() {
            window.print();
        }

        // Show/hide navigation buttons based on scroll position
        window.addEventListener('scroll', function() {
            const topButton = document.getElementById('topButton');
            const bottomButton = document.getElementById('bottomButton');
            
            if (window.scrollY > 200) {
                topButton.style.display = 'flex';
            } else {
                topButton.style.display = 'none';
            }
            
            if (window.scrollY + window.innerHeight >= document.documentElement.scrollHeight - 200) {
                bottomButton.style.display = 'none';
            } else {
                bottomButton.style.display = 'flex';
            }
        });

        // File input handling
        const searchInput = document.getElementById('searchInput');
        const stateInput = document.getElementById('stateInput');
        const productCodeInput = document.getElementById('productCodeInput');
        const fileInput = document.getElementById('fileInput');
        const fileCountDisplay = document.getElementById('fileCountDisplay');
        const outputDiv = document.getElementById('output');
        const fileUploadLabel = document.querySelector('.file-upload-label');

        fileInput.addEventListener('change', function() {
            const fileCount = this.files.length;
            if (fileCount > 0) {
                fileCountDisplay.innerHTML = `<i class="fas fa-check-circle" style="color: #10b981;"></i> ${fileCount} arquivo(s) selecionado(s)`;
                fileUploadLabel.classList.add('active');
            } else {
                fileCountDisplay.innerHTML = `<i class="fas fa-info-circle"></i> Nenhum arquivo selecionado`;
                fileUploadLabel.classList.remove('active');
            }
        });

        // Drag and drop functionality
        fileUploadLabel.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('active');
        });

        fileUploadLabel.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('active');
        });

        fileUploadLabel.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('active');
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        });

        // Process button functionality
        document.getElementById('processButton').addEventListener('click', function() {
            const files = fileInput.files;
            const button = this;
            const originalContent = button.innerHTML;

            if (files.length === 0) {
                outputDiv.innerHTML = `
                    <div class="card" style="border-left: 4px solid #ef4444;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 1.5rem;"></i>
                            <div>
                                <h3 style="color: #ef4444; margin-bottom: 0.25rem;">Nenhum arquivo selecionado</h3>
                                <p style="color: #64748b; margin: 0;">Por favor, selecione ao menos um arquivo XML para processar.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Show loading state
            button.innerHTML = '<div class="loading"></div> Processando...';
            button.disabled = true;

            const searchTerm = searchInput.value.trim().toLowerCase();
            const stateTerm = stateInput.value.trim().toUpperCase();
            const productCodeTerm = productCodeInput.value.trim();

            let tableHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-table"></i>
                        <h2>Entradas Processadas</h2>
                    </div>
                    <table class="nfe-table">
                        <thead>
                            <tr>
                                <th class="align-center">Nome do Posto</th>
                                <th class="align-center">CNPJ</th>
                                <th class="align-center">Estado</th>
                                <th class="align-center">Numero NFE</th>
                                <th class="align-center">Serie</th>
                                <th class="align-center">Data Emissao</th>
                                <th class="align-center">Produto</th>
                                <th class="align-center">Codigo do Produto</th>
                                <th class="align-right">Valor Total</th>
                                <th class="align-right">Aliquota</th>
                                <th class="align-right">Base de Calculo</th>
                                <th class="align-right">Valor de Credito</th>
                                <th class="align-center">Informação Adicional Fiscal</th>
                            </tr>
                        </thead>
                        <tbody>
                    </table>
                </div>
            `;

            let estornoTableHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-ban"></i>
                        <h2>Notas Ignoradas (Estorno ou Referenciadas)</h2>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th class="align-center">Numero NFE</th>
                                <th class="align-center">Serie</th>
                                <th class="align-center">CNPJ</th>
                                <th class="align-center">Informação Adicional Fiscal</th>
                                <th class="align-center">Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                    </table>
                </div>
            `;

            let totalBC = 0;
            let totalCredito = 0;
            let totalBC_ICMS61 = 0;
            let totalCredito_ICMS61 = 0;
            let totalBC_ICMS00 = 0;
            let totalCredito_ICMS00 = 0;
            let processedFiles = 0;
            let ignoredNotes = new Set();
            let estornoNotes = [];
            let referencedNotes = [];

            const produtosPorAliquotaICMS61 = {};
            const produtosPorAliquotaICMS00 = {};

            // Primeira passagem: identificar notas com estorno e suas referências
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

                    const getElementValue = (xmlDoc, tagName) => {
                        const element = xmlDoc.getElementsByTagName(tagName)[0];
                        return element ? element.textContent.trim() : '0';
                    };

                    const infAdFisco = getElementValue(xmlDoc, 'infAdFisco');
                    const nNF = getElementValue(xmlDoc, 'nNF');
                    const serie = getElementValue(xmlDoc, 'serie');
                    const cnpj = getElementValue(xmlDoc, 'CNPJ');

                    if (infAdFisco.toLowerCase().includes('estorno')) {
                        ignoredNotes.add(nNF);
                        estornoNotes.push({ nNF, serie, cnpj, infAdFisco, motivo: 'Contém Estorno' });
                        // Extrair número da NF-e referenciada após "NFe"
                        const match = infAdFisco.match(/NFe\s+(\d+)/i);
                        if (match && match[1]) {
                            ignoredNotes.add(match[1]);
                            referencedNotes.push({ nNF: match[1], serie: 'N/A', cnpj: 'N/A', infAdFisco: 'Referenciada em nota com estorno', motivo: 'Nota Referenciada' });
                        }
                    }

                    processedFiles++;
                    if (processedFiles === files.length) {
                        processFiles();
                    }
                };
                reader.readAsText(file);
            });

            function processFiles() {
                processedFiles = 0;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

                        const getElementValue = (xmlDoc, tagName) => {
                            const element = xmlDoc.getElementsByTagName(tagName)[0];
                            return element ? element.textContent.trim() : '0';
                        };

                        const nNF = getElementValue(xmlDoc, 'nNF');
                        if (ignoredNotes.has(nNF)) {
                            processedFiles++;
                            if (processedFiles === files.length) {
                                finalizeTable();
                            }
                            return;
                        }

                        const infAdFisco = getElementValue(xmlDoc, 'infAdFisco');
                        const nomePosto = getElementValue(xmlDoc, 'xFant');
                        const cnpj = getElementValue(xmlDoc, 'CNPJ');
                        const uf = getElementValue(xmlDoc, 'UF');
                        const serie = getElementValue(xmlDoc, 'serie');
                        const dhEmi = new Date(getElementValue(xmlDoc, 'dhEmi')).toLocaleDateString('pt-BR');
                        const produtos = xmlDoc.getElementsByTagName('det');

                        for (let i = 0; i < produtos.length; i++) {
                            const produto = produtos[i];
                            const xProd = getElementValue(produto.getElementsByTagName('prod')[0], 'xProd');
                            const cProd = getElementValue(produto.getElementsByTagName('prod')[0], 'cProd');
                            const vProd = getElementValue(produto.getElementsByTagName('prod')[0], 'vProd');
                            const cfop = getElementValue(produto.getElementsByTagName('prod')[0], 'CFOP');

                            if (cfop === '2949') {
                                continue;
                            }

                            if (
                                cProd === "2" || 
                                cProd === "12204" || 
                                cProd === "12565" || 
                                cProd === "11127" || 
                                cProd === "3461" || 
                                cProd === "9493" || 
                                ((cProd === "11855" || cProd === "9445") && uf !== "BA")
                            ) {
                                continue;
                            }

                            let aliquota61 = 0;
                            let baseCalculo61 = 0;
                            let valorCredito61 = 0;

                            const icms61 = produto.getElementsByTagName('ICMS61')[0];
                            if (icms61) {
                                aliquota61 = getElementValue(icms61, 'adRemICMSRet');
                                baseCalculo61 = getElementValue(icms61, 'qBCMonoRet');
                                valorCredito61 = getElementValue(icms61, 'vICMSMonoRet');
                            }

                            let aliquota00 = 0;
                            let baseCalculo00 = 0;
                            let valorCredito00 = 0;

                            const icms00 = produto.getElementsByTagName('ICMS00')[0];
                            if (icms00) {
                                aliquota00 = getElementValue(icms00, 'pICMS');
                                baseCalculo00 = getElementValue(icms00, 'vBC');
                                valorCredito00 = getElementValue(icms00, 'vICMS');
                            }

                            if ((searchTerm === '' || cnpj.toLowerCase().includes(searchTerm)) &&
                                (stateTerm === '' || uf.includes(stateTerm)) &&
                                (productCodeTerm === '' || cProd === productCodeTerm)) {
                                
                                tableHTML += `
                                    <tr>
                                        <td class="align-center">${nomePosto}</td>
                                        <td class="align-center">${cnpj}</td>
                                        <td class="align-center">${uf}</td>
                                        <td class="align-center">${nNF}</td>
                                        <td class="align-center">${serie}</td>
                                        <td class="align-center">${dhEmi}</td>
                                        <td class="align-center">${xProd}</td>
                                        <td class="align-center">${cProd}</td>
                                        <td class="align-right">${parseFloat(vProd).toFixed(2).replace('.', ',')}</td>
                                        <td class="align-right">${parseFloat(aliquota61 || aliquota00).toFixed(4)}</td>
                                        <td class="align-right">${parseFloat(baseCalculo61 || baseCalculo00).toFixed(2).replace('.', ',')}</td>
                                        <td class="align-right">R$ ${parseFloat(valorCredito61 || valorCredito00).toFixed(2).replace('.', ',')}</td>
                                        <td class="align-center">${infAdFisco}</td>
                                    </tr>
                                `;

                                totalBC += parseFloat(baseCalculo61 || baseCalculo00) || 0;
                                totalCredito += parseFloat(valorCredito61 || valorCredito00) || 0;

                                if (icms61) {
                                    totalBC_ICMS61 += parseFloat(baseCalculo61) || 0;
                                    totalCredito_ICMS61 += parseFloat(valorCredito61) || 0;

                                    const key61 = `${xProd}|${aliquota61}`;
                                    if (!produtosPorAliquotaICMS61[key61]) {
                                        produtosPorAliquotaICMS61[key61] = { produto: xProd, aliquota: aliquota61, totalBC: 0, totalCredito: 0 };
                                    }
                                    produtosPorAliquotaICMS61[key61].totalBC += parseFloat(baseCalculo61) || 0;
                                    produtosPorAliquotaICMS61[key61].totalCredito += parseFloat(valorCredito61) || 0;
                                }

                                if (icms00) {
                                    totalBC_ICMS00 += parseFloat(baseCalculo00) || 0;
                                    totalCredito_ICMS00 += parseFloat(valorCredito00) || 0;

                                    const key00 = `${xProd}|${aliquota00}`;
                                    if (!produtosPorAliquotaICMS00[key00]) {
                                        produtosPorAliquotaICMS00[key00] = { produto: xProd, aliquota: aliquota00, totalBC: 0, totalCredito: 0 };
                                    }
                                    produtosPorAliquotaICMS00[key00].totalBC += parseFloat(baseCalculo00) || 0;
                                    produtosPorAliquotaICMS00[key00].totalCredito += parseFloat(valorCredito00) || 0;
                                }
                            }
                        }

                        processedFiles++;
                        if (processedFiles === files.length) {
                            finalizeTable();
                        }
                    };
                    reader.readAsText(file);
                });
            }

            function finalizeTable() {
                tableHTML += `
                        </tbody>
                    </table>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-gas-pump"></i>
                        <h2>Resumo para Combustíveis</h2>
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Aliquota</th>
                                <th>Total Base de Cálculo</th>
                                <th>Total Valor de Crédito</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                for (const { produto, aliquota, totalBC, totalCredito } of Object.values(produtosPorAliquotaICMS61)) {
                    if (totalBC > 0 || totalCredito > 0) {
                        tableHTML += `
                            <tr>
                                <td>${produto}</td>
                                <td class="total-cell">${aliquota}</td>
                                <td class="total-cell">${totalBC.toFixed(2).replace('.', ',')}</td>
                                <td class="total-cell">R$ ${totalCredito.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        `;
                    }
                }

                tableHTML += `
                    <tr>
                        <td colspan="2" class="align-right"><strong>Total Combustíveis:</strong></td>
                        <td class="total-cell">${totalBC_ICMS61.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="total-cell">R$ ${totalCredito_ICMS61.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                </tbody>
                </table>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <i class="fas fa-box-open"></i>
                    <h2>Resumo para Arla e Outros Produtos</h2>
                </div>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Escolher</th>
                            <th>Produto</th>
                            <th>Aliquota</th>
                            <th>Total Base de Cálculo</th>
                            <th>Total Valor de Crédito</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                const produtosICMS00 = Object.values(produtosPorAliquotaICMS00);
                produtosICMS00.sort((a, b) => a.produto.localeCompare(b.produto));

                for (const { produto, aliquota, totalBC, totalCredito } of produtosICMS00) {
                    if (totalBC > 0 || totalCredito > 0) {
                        tableHTML += `
                            <tr>
                                <td><input type="checkbox" class="produto-checkbox" data-produto="${produto}" data-totalBC="${totalBC}" data-totalCredito="${totalCredito}"></td>
                                <td>${produto}</td>
                                <td class="total-cell">${aliquota}</td>
                                <td class="total-cell">${totalBC.toFixed(2).replace('.', ',')}</td>
                                <td class="total-cell">R$ ${totalCredito.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        `;
                    }
                }

                const formatNumber = (value) => {
                    if (!value) return '0,00';
                    return Number(value).toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };

                tableHTML += `
                    <tr>
                        <td colspan="3" class="align-right"><strong>Total Arla e Outros Produtos:</strong></td>
                        <td class="total-cell">${formatNumber(totalBC_ICMS00)}</td>
                        <td class="total-cell">R$ ${formatNumber(totalCredito_ICMS00)}</td>
                    </tr>
                </tbody>
                </table>
            </div>
            `;

                // Adicionar notas ignoradas à tabela
                const allIgnoredNotes = [...estornoNotes, ...referencedNotes];
                if (allIgnoredNotes.length > 0) {
                    allIgnoredNotes.forEach(note => {
                        estornoTableHTML += `
                            <tr>
                                <td class="align-center">${note.nNF}</td>
                                <td class="align-center">${note.serie}</td>
                                <td class="align-center">${note.cnpj}</td>
                                <td class="align-center">${note.infAdFisco}</td>
                                <td class="align-center">${note.motivo}</td>
                            </tr>
                        `;
                    });
                    estornoTableHTML += `</tbody></table></div>`;
                } else {
                    estornoTableHTML = `
                        <div class="table-container">
                            <div class="table-header">
                                <i class="fas fa-ban"></i>
                                <h2>Notas Ignoradas (Estorno ou Referenciadas)</h2>
                            </div>
                            <p style="text-align: center; color: #64748b; padding: 1rem;">Nenhuma nota ignorada por estorno ou referência.</p>
                        </div>
                    `;
                }

                // Adicionar resumo de processamento
                tableHTML += `
                    ${estornoTableHTML}
                    <div class="table-container">
                        <div class="table-header">
                            <i class="fas fa-chart-pie"></i>
                            <h2>Resumo de Processamento</h2>
                        </div>
                        <table class="summary-table">
                            <tbody>
                                <tr>
                                    <td><strong>Total de Arquivos Processados:</strong></td>
                                    <td class="align-right">${processedFiles}</td>
                                </tr>
                                <tr>
                                    <td><strong>Notas Ignoradas (Estorno ou Referenciadas):</strong></td>
                                    <td class="align-right">${allIgnoredNotes.length}</td>
                                </tr>
                                <tr>
                                    <td><strong>Notas Aproveitadas:</strong></td>
                                    <td class="align-right">${processedFiles - allIgnoredNotes.length}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button id="calculateButton" class="btn btn-primary">
                        <i class="fas fa-calculator"></i>
                        Calcular Totais
                    </button>
                    <div id="result" class="table-container" style="display: none;">
                        <div class="table-header">
                            <i class="fas fa-filter"></i>
                            <h2>Totais Ignorando Produtos Marcados</h2>
                        </div>
                    </div>
                    <div id="markedTotals" class="table-container" style="display: none;">
                        <div class="table-header">
                            <i class="fas fa-check-square"></i>
                            <h2>Totais dos Produtos Marcados</h2>
                        </div>
                    </div>
                `;

                outputDiv.innerHTML = tableHTML;

                // Restore button state
                button.innerHTML = originalContent;
                button.disabled = false;

                document.getElementById('calculateButton').addEventListener('click', function() {
                    let totalBCFinal = 0;
                    let totalCreditoFinal = 0;
                    let totalBCMarked = 0;
                    let totalCreditoMarked = 0;

                    const checkboxes = document.querySelectorAll('.produto-checkbox');

                    checkboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            totalBCFinal += parseFloat(checkbox.getAttribute('data-totalBC'));
                            totalCreditoFinal += parseFloat(checkbox.getAttribute('data-totalCredito'));
                        } else {
                            totalBCMarked += parseFloat(checkbox.getAttribute('data-totalBC'));
                            totalCreditoMarked += parseFloat(checkbox.getAttribute('data-totalCredito'));
                        }
                    });

                    document.getElementById('result').innerHTML = `
                        <div class="table-header">
                            <i class="fas fa-filter"></i>
                            <h2>Totais Ignorando Produtos Marcados</h2>
                        </div>
                        <table class="summary-table">
                            <tbody>
                                <tr>
                                    <td><strong>Total Base de Cálculo:</strong></td>
                                    <td class="align-right">${totalBCFinal.toFixed(2).replace('.', ',')}</td>
                                </tr>
                                <tr>
                                    <td><strong>Total Valor de Crédito:</strong></td>
                                    <td class="align-right">R$ ${totalCreditoFinal.toFixed(2).replace('.', ',')}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    document.getElementById('result').style.display = 'block';

                    document.getElementById('markedTotals').innerHTML = `
                        <div class="table-header">
                            <i class="fas fa-check-square"></i>
                            <h2>Totais dos Produtos Marcados</h2>
                        </div>
                        <table class="summary-table">
                            <tbody>
                                <tr>
                                    <td><strong>Total Base de Cálculo:</strong></td>
                                    <td class="align-right">${totalBCMarked.toFixed(2).replace('.', ',')}</td>
                                </tr>
                                <tr>
                                    <td><strong>Total Valor de Crédito:</strong></td>
                                    <td class="align-right">R$ ${totalCreditoMarked.toFixed(2).replace('.', ',')}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    document.getElementById('markedTotals').style.display = 'block';
                });
            }
        });
    </script>
</body>
</html>
