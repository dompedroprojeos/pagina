<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NFE XML</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
/* Reset and Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
}

body {
    background-color: #f5f6f5;
    color: #333;
    transition: background-color 0.3s, color 0.3s;
}

/* Dark Mode */
body.dark-mode {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

/* Header Styles */
.header {
    background: linear-gradient(135deg, #0288d1, #01579b);
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: all 0.3s ease;
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.logo-circle {
    width: 140px;
    height: 140px;
    background-color: #fff;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
    overflow: hidden; /* Ensure image stays within circular bounds */
}

.logo-circle:hover {
    transform: scale(1.1);
}

.logo-image {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ensure image fits without distortion */
    border-radius: 50%; /* Maintain circular shape */
}




.header-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #fff;
}

.header-subtitle {
    font-size: 1rem;
    color: #b3e5fc;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.header-btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    background-color: #fff;
    color: #0288d1;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-btn:hover {
    background-color: #b3e5fc;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.header-btn:active {
    transform: translateY(0);
    box-shadow: none;
}

#themeToggleButton i {
    transition: transform 0.3s ease;
}

body.dark-mode #themeToggleButton i {
    transform: rotate(180deg);
}

body.dark-mode #themeToggleButton i::before {
    content: "\f185"; /* Sun icon for dark mode */
}

/* Main Content */
.main-content {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

body.dark-mode .card {
    background: #2a2a2a;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.card-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    transition: all 0.3s ease;
}

.card-icon.upload { background-color: #b3e5fc; color: #0288d1; }
.card-icon.search { background-color: #b2dfdb; color: #00796b; }
.card-icon.process { background-color: #c8e6c9; color: #388e3c; }

.card-title {
    font-size: 1.4rem;
    font-weight: 600;
}

.card-description {
    font-size: 0.9rem;
    color: #666;
}

body.dark-mode .card-description {
    color: #b0b0b0;
}

/* File Upload */
.file-upload-container {
    text-align: center;
    padding: 1.5rem;
    border: 2px dashed #0288d1;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.file-upload-container:hover {
    border-color: #01579b;
    background-color: #e1f5fe;
}

body.dark-mode .file-upload-container {
    border-color: #29b6f6;
}

body.dark-mode .file-upload-container:hover {
    background-color: #003c8f;
}

.file-upload-label {
    display: block;
    cursor: pointer;
}

.file-upload-icon i {
    font-size: 2rem;
    color: #0288d1;
    margin-bottom: 0.5rem;
}

.file-upload-label strong {
    display: block;
    font-size: 1.1rem;
    color: #333;
}

body.dark-mode .file-upload-label strong {
    color: #e0e0e0;
}

.file-upload-label span {
    font-size: 0.9rem;
    color: #666;
}

body.dark-mode .file-upload-label span {
    color: #b0b0b0;
}

.file-count {
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #666;
}

body.dark-mode .file-count {
    color: #b0b0b0;
}

/* Search Container */
.search-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.search-group {
    position: relative;
    display: flex;
    align-items: center;
}

.search-group i {
    position: absolute;
    left: 1rem;
    color: #0288d1;
    font-size: 1.2rem;
}

.search-input {
    width: 100%;
    padding: 0.8rem 1rem 0.8rem 2.5rem;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #0288d1;
    box-shadow: 0 0 8px rgba(2, 136, 209, 0.3);
}

body.dark-mode .search-input {
    background-color: #333;
    border-color: #555;
    color: #e0e0e0;
}

body.dark-mode .search-input:focus {
    border-color: #29b6f6;
}

/* Buttons */
.btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-success {
    background-color: #4caf50;
    color: #fff;
}

.btn-success:hover {
    background-color: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.btn-success:active {
    transform: translateY(0);
    box-shadow: none;
}

#calculateButton {
    display: block;
    margin: 20px auto;
    padding: 0.8rem 2rem;
    background-color: #0288d1;
    color: #fff;
    border: none;
    border-radius: 25px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

#calculateButton:hover {
    background-color: #01579b;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

#calculateButton:active {
    transform: translateY(0);
    box-shadow: none;
}

body.dark-mode #calculateButton {
    background-color: #29b6f6;
}

body.dark-mode #calculateButton:hover {
    background-color: #0288d1;
}

.nav-buttons {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.nav-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background-color: #0288d1;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.nav-btn:hover {
    background-color: #01579b;
    transform: scale(1.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.nav-btn:active {
    transform: scale(1);
    box-shadow: none;
}

/* Table Styles */
.nfe-table, .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

body.dark-mode .nfe-table,
body.dark-mode .summary-table {
    background: #2a2a2a;
}

.nfe-table th,
.summary-table th {
    background: #0288d1;
    color: #fff;
    padding: 1rem;
    font-weight: 600;
    text-align: left;
}

.nfe-table td,
.summary-table td {
    padding: 0.8rem;
    border-bottom: 1px solid #ddd;
}

body.dark-mode .nfe-table td,
body.dark-mode .summary-table td {
    border-bottom: 1px solid #444;
}

.align-center {
    text-align: center;
}

.align-right {
    text-align: right;
}

.total-cell {
    font-weight: 600;
}

/* Footer Styles */
.footer {
    background: linear-gradient(135deg, #0288d1, #01579b);
    color: #fff;
    padding: 2rem 1rem;
    margin-top: 2rem;
}

.footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.footer-section {
    padding: 1rem;
}

.footer-section h3 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.developer-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.developer-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #b3e5fc;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    color: #0288d1;
}

.social-links {
    display: flex;
    gap: 1rem;
}

.social-link {
    color: #fff;
    font-size: 1.5rem;
    transition: all 0.3s ease;
}

.social-link:hover {
    color: #b3e5fc;
    transform: scale(1.2);
}

.footer-bottom {
    text-align: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #b3e5fc;
}

/* Dark Mode Specific Styles */
body.dark-mode .header,
body.dark-mode .footer {
    background: linear-gradient(135deg, #333, #555);
}

body.dark-mode .header-btn {
    background-color: #444;
    color: #29b6f6;
}

body.dark-mode .header-btn:hover {
    background-color: #555;
}

body.dark-mode .nav-btn {
    background-color: #29b6f6;
}

body.dark-mode .nfe-table th,
body.dark-mode .summary-table th {
    background: #29b6f6;
}

/* Responsive Design */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }

    .dashboard-grid {
        grid-template-columns: 1fr;
    }

    .nav-buttons {
        right: 0.5rem;
        bottom: 0.5rem;
    }

    .nav-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
}
    </style>
</head>
<body>
  <!-- Header -->
<header class="header">
    <div class="header-content">
        <div class="logo-section">
            <div class="logo-circle">
                <img src="cabecalho.png" alt="Logotipo da Empresa" class="logo-image">
            </div>
                <div>
                    <div class="header-title">Dashboard NFE XML</div>
                    <div class="header-subtitle">Processamento Inteligente de Notas Fiscais</div>
                </div>
            </div>
            <div class="header-actions">
                <button id="exportButton" class="header-btn">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <button id="themeToggleButton" class="header-btn">
                    <i class="fas fa-moon"></i>
                    Modo Escuro
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
            <!-- Upload Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon upload">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div>
                        <div class="card-title">Upload de Arquivos</div>
                        <div class="card-description">Selecione os arquivos XML das NFEs</div>
                    </div>
                </div>
                <div class="file-upload-container">
                    <label for="fileInput" class="file-upload-label">
                        <div class="file-upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <strong>Clique para selecionar arquivos</strong>
                        <span>ou arraste e solte aqui</span>
                    </label>
                    <input type="file" id="fileInput" multiple accept=".xml">
                    <div class="file-count" id="fileCountDisplay">Nenhum arquivo selecionado</div>
                </div>
            </div>

            <!-- Search Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon search">
                        <i class="fas fa-search"></i>
                    </div>
                    <div>
                        <div class="card-title">Filtros de Busca</div>
                        <div class="card-description">Filtre os resultados por critérios específicos</div>
                    </div>
                </div>
                <div class="search-container">
                    <div class="search-group">
                        <i class="fas fa-building"></i>
                        <input type="search" id="searchInput" placeholder="Buscar por CNPJ..." class="search-input" />
                    </div>
                    <div class="search-group">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="search" id="stateInput" placeholder="Buscar por Estado (UF)..." class="search-input" />
                    </div>
                    <div class="search-group">
                        <i class="fas fa-barcode"></i>
                        <input type="search" id="productCodeInput" placeholder="Código do Produto..." class="search-input" />
                    </div>
                </div>
            </div>

            <!-- Process Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon process">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <div class="card-title">Processamento</div>
                        <div class="card-description">Execute o processamento dos arquivos</div>
                    </div>
                </div>
                <button id="processButton" class="btn btn-success">
                    <i class="fas fa-play"></i>
                    Processar Arquivos
                </button>
            </div>
        </div>

        <!-- Output Area -->
        <div id="output"></div>
    </main>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
        <button onclick="scrollToTop()" id="topButton" class="nav-btn" title="Voltar ao topo">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button onclick="scrollToBottom()" id="bottomButton" class="nav-btn" title="Ir para o fim">
            <i class="fas fa-chevron-down"></i>
        </button>
        <button onclick="printTotals()" id="printTotalsButton" class="nav-btn" title="Imprimir">
            <i class="fas fa-print"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>
                    <i class="fas fa-code"></i>
                    Desenvolvedor
                </h3>
                <div class="developer-info">
                    <div class="developer-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div>
                        <p><strong>Waldeci Ramos</strong></p>
                        <p>Leitor de Xml Créditos</p>
                        <p>Sistemas Fiscais</p>
                    </div>
                </div>
                <div class="social-links">
    <a href="#" class="social-link" title="LinkedIn">
        <i class="fab fa-linkedin"></i>
    </a>
    <a href="#" class="social-link" title="GitHub">
        <i class="fab fa-github"></i>
    </a>
    <a href="#" class="social-link email-link" title="E-mail">
        <i class="fas fa-envelope"></i>
    </a>
</div>
                
            </div>

            <div class="footer-section">
                <h3>
                    <i class="fas fa-info-circle"></i>
                    Sobre o Sistema
                </h3>
                <p>Sistema desenvolvido para processamento automatizado de arquivos XML de Notas Fiscais Eletrônicas (NFE), com foco em análise de créditos de ICMS e relatórios gerenciais.</p>
                <p><strong>Versão:</strong> 2.0.0</p>
                <p><strong>Última Atualização:</strong> 21 de Julho 2025</p>
            </div>

            <div class="footer-section">
                <h3>
                    <i class="fas fa-shield-alt"></i>
                    Tecnologias
                </h3>
                <p>• HTML5 & CSS3 Moderno</p>
                <p>• JavaScript ES6+</p>
                <p>• DOM Parser para XML</p>
                <p>• Responsive Design</p>
                <p>• Font Awesome Icons</p>
                <p>• Inter Typography</p>
            </div>

            <div class="footer-section">
                <h3>
                    <i class="fas fa-phone"></i>
                    Contato & Suporte
                </h3>
                <p><i class="fas fa-envelope"></i> waldeci.ramos@rededompedro.com</p>
                <p><i class="fas fa-phone"></i>CA-(35)3462-2100</p>
                <p><i class="fas fa-map-marker-alt"></i> Rod.F.Dias, Km 880 -Estiva,MG</p>
                <p><i class="fas fa-clock"></i> Seg-Sex: 8h às 18h</p>
            </div>
        </div>

       <div class="footer-bottom">
    <p>© 2025 Dashboard NFE XML. Todos os direitos reservados. | Dv <i class="fas fa-code" style="color: #28a745;"></i>war@2025</p>
</div>
    </footer>

    <script>
       function scrollToBottom() {
            window.scrollTo({
                top: document.documentElement.scrollHeight,
                behavior: 'smooth'
            });
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        window.addEventListener('scroll', function() {
            const topButton = document.getElementById('topButton');
            const bottomButton = document.getElementById('bottomButton');
            
            if (window.scrollY > 200) {
                topButton.style.display = 'block';
            } else {
                topButton.style.display = 'none';
            }
            
            if (window.scrollY + window.innerHeight >= document.documentElement.scrollHeight - 200) {
                bottomButton.style.display = 'none';
            } else {
                bottomButton.style.display = 'block';
            }
        });

        const searchInput = document.getElementById('searchInput');
        const stateInput = document.getElementById('stateInput');
        const productCodeInput = document.getElementById('productCodeInput');
        const fileInput = document.getElementById('fileInput');
        const fileCountDisplay = document.getElementById('fileCountDisplay');
        const outputDiv = document.getElementById('output');

        fileInput.addEventListener('change', function() {
            const fileCount = this.files.length;
            fileCountDisplay.textContent = fileCount > 0 
                ? `${fileCount} arquivo(s) selecionado(s)` 
                : 'Nenhum arquivo selecionado';
        });

document.getElementById('processButton').addEventListener('click', function() {
    const files = fileInput.files;
    outputDiv.innerHTML = '';

    if (files.length === 0) {
        outputDiv.innerHTML = '<p style="color: red; text-align: center;">Nenhum arquivo selecionado.</p>';
        return;
    }

    const searchTerm = searchInput.value.trim().toLowerCase();
    const stateTerm = stateInput.value.trim().toUpperCase();
    const productCodeTerm = productCodeInput.value.trim();

    let tableHTML = `
        <h2 style="text-align: center;">Entradas</h2>
        <table class="nfe-table">
            <thead>
                <tr>
                    <th class="align-center">Nome do Posto</th>
                    <th class="align-center">CNPJ</th>
                    <th class="align-center">Estado</th>
                    <th class="align-center">Numero NFE</th>
                    <th class="align-center">Serie</th>
                    <th class="align-center">Data Emissao</th>
                    <th class="align-center">Produto</th>
                    <th class="align-center">Codigo do Produto</th>
                    <th class="align-right">Valor Total</th>
                    <th class="align-right">Aliquota</th>
                    <th class="align-right">Base de Calculo</th>
                    <th class="align-right">Valor de Credito</th>
                    <th class="align-center">Informação Adicional Fiscal</th>
                </tr>
            </thead>
            <tbody>
    `;

    let estornoTableHTML = `
        <h2 style="text-align: center; margin-top: 30px;">Notas Ignoradas (Estorno ou Referenciadas)</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th class="align-center">Numero NFE</th>
                    <th class="align-center">Serie</th>
                    <th class="align-center">CNPJ</th>
                    <th class="align-center">Informação Adicional Fiscal</th>
                    <th class="align-center">Motivo</th>
                </tr>
            </thead>
            <tbody>
    `;

    let totalBC = 0;
    let totalCredito = 0;
    let totalBC_ICMS61 = 0;
    let totalCredito_ICMS61 = 0;
    let totalBC_ICMS00 = 0;
    let totalCredito_ICMS00 = 0;
    let processedFiles = 0;
    let ignoredNotes = new Set();
    let estornoNotes = [];
    let referencedNotes = [];

    const produtosPorAliquotaICMS61 = {};
    const produtosPorAliquotaICMS00 = {};

    // Primeira passagem: identificar notas com estorno e suas referências
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

            const getElementValue = (xmlDoc, tagName) => {
                const element = xmlDoc.getElementsByTagName(tagName)[0];
                return element ? element.textContent.trim() : '0';
            };

            const infAdFisco = getElementValue(xmlDoc, 'infAdFisco');
            const nNF = getElementValue(xmlDoc, 'nNF');
            const serie = getElementValue(xmlDoc, 'serie');
            const cnpj = getElementValue(xmlDoc, 'CNPJ');

            if (infAdFisco.toLowerCase().includes('estorno')) {
                ignoredNotes.add(nNF);
                estornoNotes.push({ nNF, serie, cnpj, infAdFisco, motivo: 'Contém Estorno' });
                // Extrair número da NF-e referenciada após "NFe"
                const match = infAdFisco.match(/NFe\s+(\d+)/i);
                if (match && match[1]) {
                    ignoredNotes.add(match[1]);
                    // Use the same serie and CNPJ as the estorno note
                    referencedNotes.push({
                        nNF: match[1],
                        serie: serie,
                        cnpj: cnpj,
                        infAdFisco: 'Referenciada em nota com estorno',
                        motivo: 'Nota Referenciada'
                    });
                }
            }

            processedFiles++;
            if (processedFiles === files.length) {
                processFiles();
            }
        };
        reader.readAsText(file);
    });


            function processFiles() {
                processedFiles = 0;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

                        const getElementValue = (xmlDoc, tagName) => {
                            const element = xmlDoc.getElementsByTagName(tagName)[0];
                            return element ? element.textContent.trim() : '0';
                        };

                        const nNF = getElementValue(xmlDoc, 'nNF');
                        if (ignoredNotes.has(nNF)) {
                            processedFiles++;
                            if (processedFiles === files.length) {
                                finalizeTable();
                            }
                            return;
                        }

                        const infAdFisco = getElementValue(xmlDoc, 'infAdFisco');
                        const nomePosto = getElementValue(xmlDoc, 'xFant');
                        const cnpj = getElementValue(xmlDoc, 'CNPJ');
                        const uf = getElementValue(xmlDoc, 'UF');
                        const serie = getElementValue(xmlDoc, 'serie');
                        const dhEmi = new Date(getElementValue(xmlDoc, 'dhEmi')).toLocaleDateString('pt-BR');
                        const produtos = xmlDoc.getElementsByTagName('det');

                        for (let i = 0; i < produtos.length; i++) {
                            const produto = produtos[i];
                            const xProd = getElementValue(produto.getElementsByTagName('prod')[0], 'xProd');
                            const cProd = getElementValue(produto.getElementsByTagName('prod')[0], 'cProd');
                            const vProd = getElementValue(produto.getElementsByTagName('prod')[0], 'vProd');
                            const cfop = getElementValue(produto.getElementsByTagName('prod')[0], 'CFOP');

                            if (cfop === '2949') {
                                continue;
                            }

                            if (
                                cProd === "2" || 
                                cProd === "12204" || 
                                cProd === "12565" || 
                                cProd === "11127" || 
                                cProd === "3461" || 
                                cProd === "9493" || 
                                ((cProd === "11855" || cProd === "9445") && uf !== "BA")
                            ) {
                                continue;
                            }

                            let aliquota61 = 0;
                            let baseCalculo61 = 0;
                            let valorCredito61 = 0;

                            const icms61 = produto.getElementsByTagName('ICMS61')[0];
                            if (icms61) {
                                aliquota61 = getElementValue(icms61, 'adRemICMSRet');
                                baseCalculo61 = getElementValue(icms61, 'qBCMonoRet');
                                valorCredito61 = getElementValue(icms61, 'vICMSMonoRet');
                            }

                            let aliquota00 = 0;
                            let baseCalculo00 = 0;
                            let valorCredito00 = 0;

                            const icms00 = produto.getElementsByTagName('ICMS00')[0];
                            if (icms00) {
                                aliquota00 = getElementValue(icms00, 'pICMS');
                                baseCalculo00 = getElementValue(icms00, 'vBC');
                                valorCredito00 = getElementValue(icms00, 'vICMS');
                            }

                            if ((searchTerm === '' || cnpj.toLowerCase().includes(searchTerm)) &&
                                (stateTerm === '' || uf.includes(stateTerm)) &&
                                (productCodeTerm === '' || cProd === productCodeTerm)) {
                                
                                tableHTML += `
                                    <tr>
                                        <td class="align-center">${nomePosto}</td>
                                        <td class="align-center">${cnpj}</td>
                                        <td class="align-center">${uf}</td>
                                        <td class="align-center">${nNF}</td>
                                        <td class="align-center">${serie}</td>
                                        <td class="align-center">${dhEmi}</td>
                                        <td class="align-center">${xProd}</td>
                                        <td class="align-center">${cProd}</td>
                                        <td class="align-right">${parseFloat(vProd).toFixed(2).replace('.', ',')}</td>
                                        <td class="align-right">${parseFloat(aliquota61 || aliquota00).toFixed(4)}</td>
                                        <td class="align-right">${parseFloat(baseCalculo61 || baseCalculo00).toFixed(2).replace('.', ',')}</td>
                                        <td class="align-right">R$ ${parseFloat(valorCredito61 || valorCredito00).toFixed(2).replace('.', ',')}</td>
                                        <td class="align-center">${infAdFisco}</td>
                                    </tr>
                                `;

                                totalBC += parseFloat(baseCalculo61 || baseCalculo00) || 0;
                                totalCredito += parseFloat(valorCredito61 || valorCredito00) || 0;

                                if (icms61) {
                                    totalBC_ICMS61 += parseFloat(baseCalculo61) || 0;
                                    totalCredito_ICMS61 += parseFloat(valorCredito61) || 0;

                                    const key61 = `${xProd}|${aliquota61}`;
                                    if (!produtosPorAliquotaICMS61[key61]) {
                                        produtosPorAliquotaICMS61[key61] = { produto: xProd, aliquota: aliquota61, totalBC: 0, totalCredito: 0 };
                                    }
                                    produtosPorAliquotaICMS61[key61].totalBC += parseFloat(baseCalculo61) || 0;
                                    produtosPorAliquotaICMS61[key61].totalCredito += parseFloat(valorCredito61) || 0;
                                }

                                if (icms00) {
                                    totalBC_ICMS00 += parseFloat(baseCalculo00) || 0;
                                    totalCredito_ICMS00 += parseFloat(valorCredito00) || 0;

                                    const key00 = `${xProd}|${aliquota00}`;
                                    if (!produtosPorAliquotaICMS00[key00]) {
                                        produtosPorAliquotaICMS00[key00] = { produto: xProd, aliquota: aliquota00, totalBC: 0, totalCredito: 0 };
                                    }
                                    produtosPorAliquotaICMS00[key00].totalBC += parseFloat(baseCalculo00) || 0;
                                    produtosPorAliquotaICMS00[key00].totalCredito += parseFloat(valorCredito00) || 0;
                                }
                            }
                        }

                        processedFiles++;
                        if (processedFiles === files.length) {
                            finalizeTable();
                        }
                    };
                    reader.readAsText(file);
                });
            }

            function finalizeTable() {
                tableHTML += `
                    </tbody>
                </table>

                <h2 style="text-align: center;">Resumo para Combustiveis</h2>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Aliquota</th>
                            <th>Total Base de Calculo</th>
                            <th>Total Valor de Credito</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                for (const { produto, aliquota, totalBC, totalCredito } of Object.values(produtosPorAliquotaICMS61)) {
                    if (totalBC > 0 || totalCredito > 0) {
                        tableHTML += `
                            <tr>
                                <td>${produto}</td>
                                <td class="total-cell">${aliquota}</td>
                                <td class="total-cell">${totalBC.toFixed(2).replace('.', ',')}</td>
                                <td class="total-cell">R$ ${totalCredito.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        `;
                    }
                }

                tableHTML += `
                    <tr>
                        <td colspan="2" class="align-right"><strong>Total Combustiveis:</strong></td>
                        <td class="total-cell">${totalBC_ICMS61.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="total-cell">R$ ${totalCredito_ICMS61.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                </tbody>
                </table>

                <h2 style="text-align: center;">Resumo para Arla e Outros Produtos</h2>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Escolher</th>
                            <th>Produto</th>
                            <th>Aliquota</th>
                            <th>Total Base de Calculo</th>
                            <th>Total Valor de Credito</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                const produtosICMS00 = Object.values(produtosPorAliquotaICMS00);
                produtosICMS00.sort((a, b) => a.produto.localeCompare(b.produto));

                for (const { produto, aliquota, totalBC, totalCredito } of produtosICMS00) {
                    if (totalBC > 0 || totalCredito > 0) {
                        tableHTML += `
                            <tr>
                                <td><input type="checkbox" class="produto-checkbox" data-produto="${produto}" data-totalBC="${totalBC}" data-totalCredito="${totalCredito}"></td>
                                <td>${produto}</td>
                                <td class="total-cell">${aliquota}</td>
                                <td class="total-cell">${totalBC.toFixed(2).replace('.', ',')}</td>
                                <td class="total-cell">R$ ${totalCredito.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        `;
                    }
                }

                const formatNumber = (value) => {
                    if (!value) return '0,00';
                    return Number(value).toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };

                tableHTML += `
                    <tr>
                        <td colspan="3" class="align-right"><strong>Total Arla e Outros Produtos:</strong></td>
                        <td class="total-cell">${formatNumber(totalBC_ICMS00)}</td>
                        <td class="total-cell">R$ ${formatNumber(totalCredito_ICMS00)}</td>
                    </tr>
                </tbody>
                </table>
                `;

                // Adicionar notas ignoradas à tabela
                const allIgnoredNotes = [...estornoNotes, ...referencedNotes];
                if (allIgnoredNotes.length > 0) {
                    allIgnoredNotes.forEach(note => {
                        estornoTableHTML += `
                            <tr>
                                <td class="align-center">${note.nNF}</td>
                                <td class="align-center">${note.serie}</td>
                                <td class="align-center">${note.cnpj}</td>
                                <td class="align-center">${note.infAdFisco}</td>
                                <td class="align-center">${note.motivo}</td>
                            </tr>
                        `;
                    });
                    estornoTableHTML += `</tbody></table>`;
                } else {
                    estornoTableHTML = '<p style="text-align: center; margin-top: 30px;">Nenhuma nota ignorada por estorno ou referência.</p>';
                }

                // Adicionar resumo de processamento
                tableHTML += `
                    ${estornoTableHTML}
                    <h2 style="text-align: center; margin-top: 30px;">Resumo de Processamento</h2>
                    <p style="text-align: center;">Total de Arquivos Processados: ${processedFiles}</p>
                    <p style="text-align: center;">Notas Ignoradas (Estorno ou Referenciadas): ${allIgnoredNotes.length}</p>
                    <p style="text-align: center;">Notas Aproveitadas: ${processedFiles - allIgnoredNotes.length}</p>
                    <button id="calculateButton" style="margin-top: 20px;">Calcular Totais</button>
                    <div id="result"></div>
                    <div id="markedTotals"></div>
                `;

                outputDiv.innerHTML = tableHTML;

                document.getElementById('calculateButton').addEventListener('click', function() {
                    let totalBCFinal = 0;
                    let totalCreditoFinal = 0;
                    let totalBCMarked = 0;
                    let totalCreditoMarked = 0;

                    const checkboxes = document.querySelectorAll('.produto-checkbox');

                    checkboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            totalBCFinal += parseFloat(checkbox.getAttribute('data-totalBC'));
                            totalCreditoFinal += parseFloat(checkbox.getAttribute('data-totalCredito'));
                        } else {
                            totalBCMarked += parseFloat(checkbox.getAttribute('data-totalBC'));
                            totalCreditoMarked += parseFloat(checkbox.getAttribute('data-totalCredito'));
                        }
                    });

                    document.getElementById('result').innerHTML = `
                        <h3>Totais Ignorando Produtos Marcados</h3>
                        <p>Total Base de Calculo: ${totalBCFinal.toFixed(2).replace('.', ',')}</p>
                        <p>Total Valor de Credito: R$ ${totalCreditoFinal.toFixed(2).replace('.', ',')}</p>
                    `;

                    document.getElementById('markedTotals').innerHTML = `
                        <h3>Totais dos Produtos Marcados</h3>
                        <p>Total Base de Calculo: ${totalBCMarked.toFixed(2).replace('.', ',')}</p>
                        <p>Total Valor de Credito: R$ ${totalCreditoMarked.toFixed(2).replace('.', ',')}</p>
                    `;
                });
            }
        });

        function updateFileCount(files) {
            const fileCountDisplay = document.getElementById('fileCountDisplay');
            fileCountDisplay.textContent = `${files.length} arquivo(s) selecionado(s)`;
        }

        function printTotals() {
            window.print();
        }
// Add dark mode toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const themeToggleButton = document.getElementById('themeToggleButton');
    if (themeToggleButton) {
        themeToggleButton.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            this.innerHTML = document.body.classList.contains('dark-mode')
                ? '<i class="fas fa-sun"></i> Modo Claro'
                : '<i class="fas fa-moon"></i> Modo Escuro';
        });
    } else {
        console.error('Theme toggle button with ID "themeToggleButton" not found.');
    }
});

// Add email link functionality
document.addEventListener('DOMContentLoaded', function() {
    const emailLink = document.querySelector('.email-link');
    if (emailLink) {
        emailLink.addEventListener('click', function(event) {
            event.preventDefault();
            const now = new Date();
            const hour = now.getHours();
            let greeting = hour >= 6 && hour < 12 ? 'Bom dia' : hour >= 12 && hour < 18 ? 'Boa tarde' : 'Boa noite';
            const email = 'waldeciramos@gmail.com';
            const subject = 'Auxílio para Suporte Técnico';
            const body = `${greeting}!\nEstamos necessitando de suporte técnico! Descrever abaixo sua solicitação:\n`;
            this.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        });
    } else {
        console.error('Email link element with class "email-link" not found.');
    }
});

// Add export functionality (CSV for Excel)
document.addEventListener('DOMContentLoaded', function() {
    const exportButton = document.getElementById('exportButton');
    if (exportButton) {
        exportButton.addEventListener('click', function() {
            const tables = document.querySelectorAll('#output table');
            if (tables.length === 0) {
                alert('Nenhuma tabela para exportar. Processe os arquivos primeiro.');
                return;
            }

            let csvContent = '\uFEFF'; // BOM for UTF-8
            tables.forEach((table, index) => {
                if (index === 0) csvContent += 'Entradas\n';
                else if (index === 1) csvContent += '\nResumo para Combustíveis\n';
                else if (index === 2) csvContent += '\nResumo para Arla e Outros Produtos\n';
                else if (index === 3) csvContent += '\nNotas Ignoradas (Estorno ou Referenciadas)\n';

                const rows = table.querySelectorAll('tr');
                const headers = Array.from(rows[0].querySelectorAll('th')).map(th => `"${th.textContent.trim().replace(/"/g, '""')}"`).join(';');
                csvContent += headers + '\n';

                for (let i = 1; i < rows.length; i++) {
                    const cells = Array.from(rows[i].querySelectorAll('td')).map(td => `"${td.textContent.trim().replace(/"/g, '""')}"`).join(';');
                    csvContent += cells + '\n';
                }
                csvContent += '\n';
            });

            // Add summary data
            csvContent += '\nResumo de Processamento\n';
            csvContent += '"Total de Arquivos Processados";"' + document.querySelector('#output p:nth-of-type(1)').textContent.split(': ')[1] + '"\n';
            csvContent += '"Notas Ignoradas (Estorno ou Referenciadas)";"' + document.querySelector('#output p:nth-of-type(2)').textContent.split(': ')[1] + '"\n';
            csvContent += '"Notas Aproveitadas";"' + document.querySelector('#output p:nth-of-type(3)').textContent.split(': ')[1] + '"\n';

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio_nfe.csv';
            a.click();
            URL.revokeObjectURL(url);
        });
    } else {
        console.error('Export button with ID "exportButton" not found.');
    }
});

    </script>
</body>
</html>
